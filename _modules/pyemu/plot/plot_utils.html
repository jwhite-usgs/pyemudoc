

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyemu.plot.plot_utils &mdash; pyEMU 0.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyEMU
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.html">pyemu</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyEMU</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyemu.plot.plot_utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyemu.plot.plot_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Plotting functions for various PEST(++) and pyemu operations&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">pyemu.logger</span> <span class="k">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">pyemu.pst</span> <span class="k">import</span> <span class="n">pst_utils</span>
<span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span>   <span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;font&quot;</span><span class="p">,</span><span class="o">**</span><span class="n">font</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="k">import</span> <span class="n">PdfPages</span>
    <span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="k">import</span> <span class="n">GridSpec</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error importing matplotlib: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

<span class="kn">import</span> <span class="nn">pyemu</span>
<span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mf">10.5</span><span class="p">)</span>
<span class="n">nr</span><span class="p">,</span><span class="n">nc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span><span class="mi">2</span>
<span class="c1">#page_gs = GridSpec(nr,nc)</span>

<span class="n">abet</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span>

<div class="viewcode-block" id="plot_summary_distributions"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.plot_summary_distributions">[docs]</a><span class="k">def</span> <span class="nf">plot_summary_distributions</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">label_post</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">label_prior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">subplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mf">8.5</span><span class="p">),</span><span class="n">pt_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper function to plot gaussian distrbutions from prior and posterior</span>
<span class="sd">    means and standard deviations</span>

<span class="sd">    Args:</span>
<span class="sd">        df (`pandas.DataFrame`): a dataframe and csv file.  Must have columns named:</span>
<span class="sd">            &#39;prior_mean&#39;,&#39;prior_stdev&#39;,&#39;post_mean&#39;,&#39;post_stdev&#39;.  If loaded</span>
<span class="sd">            from a csv file, column 0 is assumed to tbe the index</span>
<span class="sd">        ax (`atplotlib.pyplot.axis`): If None, and not subplots, then one is created</span>
<span class="sd">            and all distributions are plotted on a single plot</span>
<span class="sd">        label_post (`bool`): flag to add text labels to the peak of the posterior</span>
<span class="sd">        label_prior (`bool`): flag to add text labels to the peak of the prior</span>
<span class="sd">        subplots (`bool`): flag to use subplots.  If True, then 6 axes per page</span>
<span class="sd">            are used and a single prior and posterior is plotted on each</span>
<span class="sd">        figsize (`tuple`): matplotlib figure size</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing:</span>

<span class="sd">        - **[`matplotlib.figure`]**: list of figures</span>
<span class="sd">        - **[`matplotlib.axis`]**: list of axes</span>

<span class="sd">    Note:</span>
<span class="sd">        This is useful for demystifying FOSM results</span>

<span class="sd">        if subplots is False, a single axis is returned</span>

<span class="sd">    Example::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        import pyemu</span>
<span class="sd">        pyemu.plot_utils.plot_summary_distributions(&quot;pest.par.usum.csv&quot;)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">subplots</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>


    <span class="k">if</span> <span class="s2">&quot;post_stdev&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;post_var&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;post_stdev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">post_var</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;prior_stdev&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;prior_var&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prior_stdev&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">prior_var</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;prior_expt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;prior_mean&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prior_expt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">prior_mean</span>
    <span class="k">if</span> <span class="s2">&quot;post_expt&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;post_mean&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;post_expt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">post_mean</span>

    <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax_per_page</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">gaussian_distribution</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;post_expt&quot;</span><span class="p">],</span>
                                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;post_stdev&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="n">pt_color</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label_post</span><span class="p">:</span>
            <span class="n">mx_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">xtxt</span><span class="p">,</span><span class="n">ytxt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mx_idx</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">mx_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.001</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xtxt</span><span class="p">,</span><span class="n">ytxt</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">gaussian_distribution</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;prior_expt&quot;</span><span class="p">],</span>
                                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;prior_stdev&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">label_prior</span><span class="p">:</span>
            <span class="n">mx_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">xtxt</span><span class="p">,</span><span class="n">ytxt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mx_idx</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">mx_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.001</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xtxt</span><span class="p">,</span><span class="n">ytxt</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c1">#ylim = list(ax.get_ylim())</span>
        <span class="c1">#ylim[1] *= 1.2</span>
        <span class="c1">#ylim[0] = 0.0</span>
        <span class="c1">#ax.set_ylim(ylim)</span>
        <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">ax_count</span> <span class="o">&gt;=</span> <span class="n">ax_per_page</span><span class="p">:</span>
                <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">ax_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span>
        <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span><span class="p">,</span> <span class="n">axes</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
    <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.2</span>
    <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="gaussian_distribution"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.gaussian_distribution">[docs]</a><span class="k">def</span> <span class="nf">gaussian_distribution</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span><span class="p">,</span> <span class="n">num_pts</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; get an x and y numpy.ndarray that spans the +/- 4</span>
<span class="sd">    standard deviation range of a gaussian distribution with</span>
<span class="sd">    a given mean and standard deviation. useful for plotting</span>

<span class="sd">    Args:</span>
<span class="sd">        mean (`float`): the mean of the distribution</span>
<span class="sd">        stdev (`float`): the standard deviation of the distribution</span>
<span class="sd">        num_pts (`int`): the number of points in the returned ndarrays.</span>
<span class="sd">            Default is 50</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing:</span>

<span class="sd">        - **numpy.ndarray**: the x-values of the distribution</span>
<span class="sd">        - **numpy.ndarray**: the y-values of the distribution</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xstart</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">-</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">stdev</span><span class="p">)</span>
    <span class="n">xend</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">stdev</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xstart</span><span class="p">,</span><span class="n">xend</span><span class="p">,</span><span class="n">num_pts</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">stdev</span><span class="o">*</span><span class="n">stdev</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stdev</span><span class="o">*</span><span class="n">stdev</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span></div>

<div class="viewcode-block" id="pst_helper"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.pst_helper">[docs]</a><span class="k">def</span> <span class="nf">pst_helper</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;`pyemu.Pst` plot helper - takes the</span>
<span class="sd">    handoff from `pyemu.Pst.plot()`</span>

<span class="sd">    Args:</span>
<span class="sd">        kind (`str`): the kind of plot to make</span>
<span class="sd">        **kargs (`dict`): keyword arguments to pass to the</span>
<span class="sd">            plotting function and ultimately to `matplotlib`</span>

<span class="sd">    Returns:</span>
<span class="sd">        varies: usually a combination of `matplotlib.figure` (s) and/or</span>
<span class="sd">        `matplotlib.axis` (s)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">echo</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;plot_pst_helper.log&quot;</span><span class="p">,</span><span class="n">echo</span><span class="o">=</span><span class="n">echo</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;plot_utils.pst_helper()&quot;</span><span class="p">)</span>

    <span class="n">kinds</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prior&quot;</span><span class="p">:</span><span class="n">pst_prior</span><span class="p">,</span><span class="s2">&quot;1to1&quot;</span><span class="p">:</span><span class="n">res_1to1</span><span class="p">,</span>
             <span class="s2">&quot;phi_pie&quot;</span><span class="p">:</span><span class="n">res_phi_pie</span><span class="p">,</span>
             <span class="s2">&quot;phi_progress&quot;</span><span class="p">:</span><span class="n">phi_progress</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">base_filename</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">pst</span><span class="o">.</span><span class="n">new_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_filename</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">new_filename</span>
        <span class="n">base_filename</span> <span class="o">=</span> <span class="n">base_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.pst&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">func</span> <span class="ow">in</span> <span class="n">kinds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">plt_name</span> <span class="o">=</span> <span class="n">base_filename</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.pdf&quot;</span>
            <span class="n">returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="n">plt_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">returns</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kinds</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;unrecognized kind:</span><span class="si">{0}</span><span class="s2">, should one of </span><span class="si">{1}</span><span class="s2">&quot;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">kinds</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
    <span class="k">return</span> <span class="n">kinds</span><span class="p">[</span><span class="n">kind</span><span class="p">](</span><span class="n">pst</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="phi_progress"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.phi_progress">[docs]</a><span class="k">def</span> <span class="nf">phi_progress</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; make plot of phi vs number of model runs - requires</span>
<span class="sd">    available  &quot;.iobj&quot; file generated by a PESTPP-GLM run.</span>

<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): a control file instance</span>
<span class="sd">        logger (`pyemu.Logger`):  if None, a generic one is created.  Default is None</span>
<span class="sd">        filename (`str`): PDF filename to save figures to.  If None, figures</span>
<span class="sd">            are returned.  Default is None</span>
<span class="sd">        kwargs (`dict`): optional keyword args to pass to plotting function</span>

<span class="sd">    Returns:</span>
<span class="sd">        `matplotlib.axis`: the axis the plot was made on</span>

<span class="sd">    Example::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        import pyemu</span>
<span class="sd">        pst = pyemu.Pst(&quot;my.pst&quot;)</span>
<span class="sd">        pyemu.plot_utils.phi_progress(pst)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="s1">&#39;Default_Loggger.log&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot phi_progress&quot;</span><span class="p">)</span>

    <span class="n">iobj_file</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.pst&quot;</span><span class="p">,</span><span class="s2">&quot;.iobj&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iobj_file</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find iobj file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iobj_file</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">iobj_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;ax&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ax&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">model_runs_completed</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">total_phi</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;model runs&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\phi$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot phi_progress&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>


<span class="k">def</span> <span class="nf">_get_page_axes</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">):</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span><span class="n">nc</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="n">nr</span><span class="o">*</span><span class="n">nc</span><span class="p">))]</span>
    <span class="c1">#[ax.set_yticks([]) for ax in axes]</span>
    <span class="k">return</span> <span class="n">axes</span>

<div class="viewcode-block" id="res_1to1"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.res_1to1">[docs]</a><span class="k">def</span> <span class="nf">res_1to1</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">plot_hexbin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">histogram</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; make 1-to-1 plots and also observed vs residual by observation group</span>

<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): a control file instance</span>
<span class="sd">        logger (`pyemu.Logger`):  if None, a generic one is created.  Default is None</span>
<span class="sd">        filename (`str`): PDF filename to save figures to.  If None, figures</span>
<span class="sd">            are returned.  Default is None</span>
<span class="sd">        hexbin (`bool`): flag to use the hexbinning for large numbers of residuals.</span>
<span class="sd">            Default is False</span>
<span class="sd">        histogram (`bool`): flag to plot residual histograms instead of obs vs residual.</span>
<span class="sd">            Default is False (use `matplotlib.pyplot.scatter` )</span>
<span class="sd">        kwargs (`dict`): optional keyword args to pass to plotting function</span>

<span class="sd">    Returns:</span>
<span class="sd">        `matplotlib.axis`: the axis the plot was made on</span>

<span class="sd">    Example::</span>

<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        import pyemu</span>
<span class="sd">        pst = pyemu.Pst(&quot;my.pst&quot;)</span>
<span class="sd">        pyemu.plot_utils.phi_progress(pst)</span>
<span class="sd">        plt.show()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">Logger</span><span class="p">(</span><span class="s1">&#39;Default_Loggger.log&#39;</span><span class="p">,</span><span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot res_1to1&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;ensemble&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pst_utils</span><span class="o">.</span><span class="n">res_from_en</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ensemble&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span><span class="o">=</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">res_from_en</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ensemble&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;res_1to1: error loading ensemble file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">res</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;res_phi_pie: pst.res is None, couldn&#39;t find residuals file&quot;</span><span class="p">)</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">observation_data</span>

    <span class="k">if</span> <span class="s2">&quot;grouper&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grouper</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">obgnme</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;fig_title&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fig_title&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;pyemu.Pst.plot(kind=&#39;1to1&#39;)</span><span class="se">\n</span><span class="s2">from pest control file &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2"> at </span><span class="si">{1}</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="c1">#if plot_hexbin:</span>
    <span class="c1">#    pdfname = pst.filename.replace(&quot;.pst&quot;, &quot;.1to1.hexbin.pdf&quot;)</span>
    <span class="c1">#else:</span>
    <span class="c1">#    pdfname = pst.filename.replace(&quot;.pst&quot;, &quot;.1to1.pdf&quot;)</span>
    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">grouper</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting 1to1 for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

        <span class="n">obs_g</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">names</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">obs_g</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;sim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">names</span><span class="p">,</span> <span class="s2">&quot;modelled&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;using control file obsvals to calculate residuals&quot;</span><span class="p">)</span>
        <span class="n">obs_g</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">sim</span> <span class="o">-</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span>
        <span class="k">if</span> <span class="s2">&quot;include_zero&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;include_zero&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">obs_g</span> <span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obs_g</span><span class="o">.</span><span class="n">weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;no non-zero obs for group &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting 1to1 for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">ax_count</span> <span class="o">%</span> <span class="p">(</span><span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="c1">#pdf.savefig()</span>
            <span class="c1">#plt.close(fig)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">_get_page_axes</span><span class="p">()</span>
            <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span>

        <span class="c1">#if obs_g.shape[0] == 1:</span>
        <span class="c1">#    ax.scatter(list(obs_g.sim),list(obs_g.obsval),marker=&#39;.&#39;,s=30,color=&#39;b&#39;)</span>
        <span class="c1">#else:</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

        <span class="c1">#if obs_g.shape[0] == 1:</span>
        <span class="n">mx</span> <span class="o">*=</span> <span class="mf">1.1</span>
        <span class="n">mn</span> <span class="o">*=</span> <span class="mf">0.9</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;square&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_hexbin</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hexbin</span><span class="p">(</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">mincnt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gridsize</span><span class="o">=</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
                      <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="n">mx</span><span class="p">,</span> <span class="n">mn</span><span class="p">,</span> <span class="n">mx</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1">#               plt.colorbar(ax=ax)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="p">],</span> <span class="p">[</span><span class="n">obs_g</span><span class="o">.</span><span class="n">sim</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>



        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">],[</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">],</span><span class="s1">&#39;k--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;observed&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;simulated&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) group:</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2"> observations&quot;</span><span class="o">.</span>
                                 <span class="nb">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">histogram</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="p">,</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mx</span> <span class="o">*=</span> <span class="mf">1.1</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">mx</span><span class="p">,</span> <span class="n">mx</span><span class="p">)</span>
            <span class="c1">#show a zero residuals line</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlim</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">meanres</span><span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="c1"># show mean residuals line</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlim</span><span class="p">,[</span><span class="n">meanres</span><span class="p">,</span><span class="n">meanres</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;residual&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;observed&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) group:</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2"> observations&quot;</span><span class="o">.</span>
                         <span class="nb">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#need max and min res to set xlim, otherwise wonky figsize</span>
            <span class="n">mxr</span> <span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">mnr</span> <span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="c1">#if obs_g.shape[0] == 1:</span>
            <span class="n">mxr</span> <span class="o">*=</span> <span class="mf">1.1</span>
            <span class="n">mnr</span> <span class="o">*=</span> <span class="mf">0.9</span>
            <span class="n">rlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">mnr</span><span class="p">,</span><span class="n">mxr</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">obs_g</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">meanres</span><span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">meanres</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">b</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">meanres</span> <span class="o">+</span> <span class="n">meanres</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span>
                     <span class="n">t</span> <span class="o">-</span> <span class="n">t</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span>
                     <span class="s1">&#39;Mean: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meanres</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">rlim</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;residual&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) group:</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2"> observations&quot;</span><span class="o">.</span>
                         <span class="nb">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting 1to1 for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax_count</span><span class="p">,</span> <span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1">#pdf.savefig()</span>
    <span class="c1">#plt.close(fig)</span>
    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
                <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot res_1to1&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot res_1to1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span></div>

<div class="viewcode-block" id="plot_id_bar"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.plot_id_bar">[docs]</a><span class="k">def</span> <span class="nf">plot_id_bar</span><span class="p">(</span><span class="n">id_df</span><span class="p">,</span> <span class="n">nsv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot a stacked bar chart of identifiability based on</span>
<span class="sd">    a the `pyemu.ErrVar.get_identifiability()` dataframe</span>

<span class="sd">    Args:</span>
<span class="sd">        id_df (`pandas.DataFrame`) : dataframe of identifiability</span>
<span class="sd">        nsv (`int`): number of singular values to consider</span>
<span class="sd">        logger (`pyemu.Logger`, optonal): a logger.  If None, a generic</span>
<span class="sd">            one is created</span>
<span class="sd">        kwargs (`dict`): a dict of keyword arguments to pass to the</span>
<span class="sd">            plotting function</span>

<span class="sd">    Returns:</span>
<span class="sd">        `matplotlib.Axis`: the axis with the plot</span>

<span class="sd">    Example::</span>

<span class="sd">        import pyemu</span>
<span class="sd">        pest_obj = pyemu.Pst(pest_control_file)</span>
<span class="sd">        ev = pyemu.ErrVar(jco=&#39;freyberg_jac.jcb&#39;))</span>
<span class="sd">        id_df = ev.get_identifiability_dataframe(singular_value=48)</span>
<span class="sd">        pyemu.plot_utils.plot_id_bar(id_df, nsv=12, figsize=(12,4)</span>

<span class="sd">     &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">Logger</span><span class="p">(</span><span class="s1">&#39;Default_Loggger.log&#39;</span><span class="p">,</span><span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot id bar&quot;</span><span class="p">)</span>


    <span class="n">df</span> <span class="o">=</span> <span class="n">id_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># drop the final `ident` column</span>
    <span class="k">if</span> <span class="s1">&#39;ident&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;ident&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nsv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nsv</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">nsv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;set number of SVs and number in the dataframe&#39;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="n">nsv</span><span class="p">]]</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ident&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;ident&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;ident&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;figsize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">figsize</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;figsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;ax&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ax&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># plto the stacked bar chart (the easy part!)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet_r&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># horrible shenanigans to make a colorbar rather than a legend</span>
    <span class="c1">#</span>

    <span class="c1"># special case colormap just dark red if one SV</span>
    <span class="k">if</span> <span class="n">nsv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">tcm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;one_sv&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet_r&#39;</span><span class="p">)(</span><span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">tcm</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">nsv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c1"># or typically just rock the jet_r colormap over the range of SVs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet_r&#39;</span><span class="p">),</span> <span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">nsv</span><span class="p">))</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">_A</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># now, if too many ticks for the colorbar, summarize them</span>
    <span class="k">if</span> <span class="n">nsv</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">nsv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">30</span><span class="p">))</span>

    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;plot id bar&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="res_phi_pie"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.res_phi_pie">[docs]</a><span class="k">def</span> <span class="nf">res_phi_pie</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;plot current phi components as a pie chart.</span>

<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): a control file instance with the residual datafrane</span>
<span class="sd">            instance available.</span>
<span class="sd">        logger (`pyemu.Logger`): a logger.  If None, a generic one is created</span>
<span class="sd">        kwargs (`dict`): a dict of plotting options. Accepts &#39;include_zero&#39;</span>
<span class="sd">            as a flag to include phi groups with only zero-weight obs (not</span>
<span class="sd">            sure why anyone would do this, but whatevs). Any additional</span>
<span class="sd">            args are passed to `matplotlib`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `matplotlib.Axis`: the axis with the plot.</span>

<span class="sd">    Example::</span>

<span class="sd">        import pyemu</span>
<span class="sd">        pst = pyemu.Pst(&quot;my.pst&quot;)</span>
<span class="sd">        pyemu.plot_utils.res_phi_pie(pst,figsize=(12,4))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">Logger</span><span class="p">(</span><span class="s1">&#39;Default_Loggger.log&#39;</span><span class="p">,</span><span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot res_phi_pie&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;ensemble&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span><span class="o">=</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">res_from_en</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ensemble&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;res_1to1: could not find ensemble file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ensemble&#39;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">res</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;res_phi_pie: pst.res is None, couldn&#39;t find residuals file&quot;</span><span class="p">)</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">observation_data</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">phi</span>
    <span class="n">phi_comps</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">phi_components</span>
    <span class="n">norm_phi_comps</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">phi_components_normalized</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phi_comps</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;include_zero&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;include_zero&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">phi_comps</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">phi_comps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">phi_comps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">}</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phi_comps</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">norm_phi_comps</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">norm_phi_comps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
    <span class="k">if</span> <span class="s2">&quot;ax&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ax&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="si">{1:4G}</span><span class="se">\n</span><span class="s2">(</span><span class="si">{2:3.1f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">phi_comps</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="mf">100.</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi_comps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">phi</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">norm_phi_comps</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">],</span><span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot res_phi_pie&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;filename&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="pst_prior"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.pst_prior">[docs]</a><span class="k">def</span> <span class="nf">pst_prior</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper to plot prior parameter histograms implied by</span>
<span class="sd">    parameter bounds. Saves a multipage pdf named &lt;case&gt;.prior.pdf</span>

<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): control file</span>
<span class="sd">        logger (`pyemu.Logger`): a logger.  If None, a generic one is created.</span>
<span class="sd">        filename (`str`):  PDF filename to save plots to.</span>
<span class="sd">            If None, return figs without saving.  Default is None.</span>
<span class="sd">        kwargs (`dict`): additional plotting options. Accepts &#39;grouper&#39; as</span>
<span class="sd">            dict to group parameters on to a single axis (use</span>
<span class="sd">            parameter groups if not passed),&#39;unqiue_only&#39; to only show unique</span>
<span class="sd">            mean-stdev combinations within a given group.  Any additional args</span>
<span class="sd">            are passed to `matplotlib`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        [`matplotlib.Figure`]: a list of figures created.</span>

<span class="sd">    TODO:</span>
<span class="sd">        external parcov, unique mean-std pairs</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">Logger</span><span class="p">(</span><span class="s1">&#39;Default_Loggger.log&#39;</span><span class="p">,</span><span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot pst_prior&quot;</span><span class="p">)</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>

    <span class="k">if</span> <span class="s2">&quot;parcov_filename&quot;</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">pestpp_options</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;ignoring parcov_filename, using parameter bounds for prior cov&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading cov from parameter data&quot;</span><span class="p">)</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading cov from parameter data&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building mean parameter values&quot;</span><span class="p">)</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">partrans</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">names</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cov</span><span class="o">.</span><span class="n">names</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span>
    <span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">,</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building mean parameter values&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building stdev parameter values&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cov</span><span class="o">.</span><span class="n">isdiagonal</span><span class="p">:</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prior_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building stdev parameter values&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">std</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;mean.shape </span><span class="si">{0}</span><span class="s2"> != std.shape </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                      <span class="nb">format</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">std</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;grouper&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
        <span class="c1">#check for consistency here</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">par_adj</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">partrans</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">]),:]</span>
        <span class="n">grouper</span> <span class="o">=</span> <span class="n">par_adj</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">par_adj</span><span class="o">.</span><span class="n">pargp</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
        <span class="c1">#grouper = par.groupby(par.pargp).groups</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grouper</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no adustable parameters to plot&quot;</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;fig_title&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fig_title&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="s2">&quot;pyemu.Pst.plot(kind=&#39;prior&#39;)</span><span class="se">\n</span><span class="s2">from pest control file &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2"> at </span><span class="si">{1}</span><span class="s2">&quot;</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())),</span><span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">grps_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">grouper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">grps_names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grps_names</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">grouper</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting priors for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                   <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">ax_count</span> <span class="o">%</span> <span class="p">(</span><span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="c1">#pdf.savefig()</span>
            <span class="c1">#plt.close(fig)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">fig</span>  <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">_get_page_axes</span><span class="p">()</span>
            <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">islog</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">partrans</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;mixed partrans for group </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s2">&quot;log&quot;</span> <span class="ow">in</span> <span class="n">vc</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">islog</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;unique_only&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;unique_only&quot;</span><span class="p">]:</span>


            <span class="n">ms</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">names</span><span class="p">,:]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;prior_std&quot;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ms</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">gaussian_distribution</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">names</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span><span class="n">info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">names</span><span class="p">,</span><span class="s1">&#39;prior_std&#39;</span><span class="p">]):</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">gaussian_distribution</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) group:</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2"> parameters&quot;</span><span class="o">.</span>
                                 <span class="nb">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span><span class="n">g</span><span class="p">,</span><span class="n">names</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">islog</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$log_</span><span class="si">{10}</span><span class="s2">$ parameter value&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;parameter value&quot;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting priors for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                   <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">))))</span>

        <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax_count</span><span class="p">,</span><span class="n">nr</span><span class="o">*</span><span class="n">nc</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1">#pdf.savefig()</span>
    <span class="c1">#plt.close(fig)</span>
    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot pst_prior&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot pst_prior&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span></div>


<div class="viewcode-block" id="ensemble_helper"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.ensemble_helper">[docs]</a><span class="k">def</span> <span class="nf">ensemble_helper</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span><span class="n">plot_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">func_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">sync_bins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">deter_vals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">std_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">deter_range</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper function to plot ensemble histograms</span>

<span class="sd">    Args:</span>
<span class="sd">        ensemble : varies</span>
<span class="sd">            the ensemble argument can be a pandas.DataFrame or derived type or a str, which</span>
<span class="sd">            is treated as a filename.  Optionally, ensemble can be a list of these types or</span>
<span class="sd">            a dict, in which case, the keys are treated as facecolor str (e.g., &#39;b&#39;, &#39;y&#39;, etc).</span>
<span class="sd">        facecolor : str</span>
<span class="sd">            the histogram facecolor.  Only applies if ensemble is a single thing</span>
<span class="sd">        plot_cols : enumerable</span>
<span class="sd">            a collection of columns (in form of a list of parameters, or a dict with keys for</span>
<span class="sd">            parsing plot axes and values of parameters) from the ensemble(s) to plot.  If None,</span>
<span class="sd">            (the union of) all cols are plotted. Default is None</span>
<span class="sd">        filename : str</span>
<span class="sd">            the name of the pdf to create.  If None, return figs without saving.  Default is None.</span>
<span class="sd">        func_dict : dict</span>
<span class="sd">            a dictionary of unary functions (e.g., `np.log10` to apply to columns.  Key is</span>
<span class="sd">            column name.  Default is None</span>
<span class="sd">        sync_bins : bool</span>
<span class="sd">            flag to use the same bin edges for all ensembles. Only applies if more than</span>
<span class="sd">            one ensemble is being plotted.  Default is True</span>
<span class="sd">        deter_vals : dict</span>
<span class="sd">            dict of deterministic values to plot as a vertical line. key is ensemble columnn name</span>
<span class="sd">        std_window : float</span>
<span class="sd">            the number of standard deviations around the mean to mark as vertical lines.  If None,</span>
<span class="sd">            nothing happens.  Default is None</span>
<span class="sd">        deter_range : bool</span>
<span class="sd">            flag to set xlims to deterministic value +/- std window.  If True, std_window must not be None.</span>
<span class="sd">            Default is False</span>

<span class="sd">    Example::</span>

<span class="sd">        pst = pyemu.Pst(&quot;my.pst&quot;)</span>
<span class="sd">        prior = pyemu.ParameterEnsemble.from_binary(pst=pst, filename=&quot;prior.jcb&quot;)</span>
<span class="sd">        post = pyemu.ParameterEnsemble.from_binary(pst=pst, filename=&quot;my.3.par.jcb&quot;)</span>
<span class="sd">        pyemu.plot_utils.ensemble_helper(ensemble={&quot;0.5&quot;:prior, &quot;b&quot;:post},filename=&quot;ensemble.pdf&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;ensemble_helper.log&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;pyemu.plot_utils.ensemble_helper()&quot;</span><span class="p">)</span>
    <span class="n">ensembles</span> <span class="o">=</span> <span class="n">_process_ensemble_arg</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span><span class="n">facecolor</span><span class="p">,</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;plot_uitls.ensemble_helper() error processing `ensemble` arg&quot;</span><span class="p">)</span>
    <span class="c1">#apply any functions</span>
    <span class="k">if</span> <span class="n">func_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;applying functions&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">func</span> <span class="ow">in</span> <span class="n">func_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">fc</span><span class="p">,</span><span class="n">en</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">en</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;applying functions&quot;</span><span class="p">)</span>


    <span class="c1">#get a list of all cols (union)</span>
    <span class="n">all_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">fc</span><span class="p">,</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">en</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">all_cols</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_cols</span><span class="p">,</span> <span class="n">all_cols</span><span class="p">))}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">splot_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">)</span>
            <span class="n">plot_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">,</span> <span class="n">plot_cols</span><span class="p">))}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="n">splot_cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span><span class="n">pcols</span> <span class="ow">in</span> <span class="n">plot_cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">splot_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pcols</span><span class="p">))</span>
            <span class="n">splot_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">splot_cols</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;unrecognized plot_cols type: </span><span class="si">{0}</span><span class="s2">, should be list or dict&quot;</span><span class="o">.</span>
                          <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">)))</span>

        <span class="n">missing</span> <span class="o">=</span> <span class="n">splot_cols</span> <span class="o">-</span> <span class="n">all_cols</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;the following plot_cols are missing: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                          <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;plotting </span><span class="si">{0}</span><span class="s2"> histograms&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_cols</span><span class="p">)))</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;fig_title&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fig_title&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;pyemu.plot_utils.ensemble_helper()</span><span class="se">\n</span><span class="s2"> at </span><span class="si">{0}</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="c1">#plot_cols = list(plot_cols)</span>
    <span class="c1">#plot_cols.sort()</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plot_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;saving pdf to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#for label,plot_col in plot_cols.items():</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">plot_col</span> <span class="o">=</span> <span class="n">plot_cols</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting reals for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ax_count</span> <span class="o">%</span> <span class="p">(</span><span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="c1">#pdf.savefig()</span>
            <span class="c1">#plt.close(fig)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">_get_page_axes</span><span class="p">()</span>
            <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span>
            <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sync_bins</span><span class="p">:</span>
            <span class="n">mx</span><span class="p">,</span><span class="n">mn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0e+30</span><span class="p">,</span><span class="mf">1.0e+30</span>
            <span class="k">for</span> <span class="n">fc</span><span class="p">,</span><span class="n">en</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># for pc in plot_col:</span>
                <span class="c1">#     if pc in en.columns:</span>
                <span class="c1">#         emx,emn = en.loc[:,pc].max(),en.loc[:,pc].min()</span>
                <span class="c1">#         mx = max(mx,emx)</span>
                <span class="c1">#         mn = min(mn,emn)</span>
                <span class="n">emn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">plot_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">emx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">plot_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">mx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="n">emx</span><span class="p">)</span>
                <span class="n">mn</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span><span class="n">emn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mx</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0e+30</span> <span class="ow">and</span> <span class="n">mn</span> <span class="o">==</span> <span class="mf">1.0e+30</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;all NaNs for label: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) </span><span class="si">{1}</span><span class="s2">, count:</span><span class="si">{2}</span><span class="s2"> - all NaN&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span>
                                                                    <span class="n">label</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_col</span><span class="p">)),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">plot_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> min:</span><span class="si">{1:5G}</span><span class="s2">, max:</span><span class="si">{2:5G}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_bins</span><span class="o">=</span><span class="n">bins</span>
        <span class="k">for</span> <span class="n">fc</span><span class="p">,</span><span class="n">en</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#for pc in plot_col:</span>
            <span class="c1">#    if pc in en.columns:</span>
            <span class="c1">#        try:</span>
            <span class="c1">#            en.loc[:,pc].hist(bins=plot_bins,facecolor=fc,</span>
            <span class="c1">#                                    edgecolor=&quot;none&quot;,alpha=0.5,</span>
            <span class="c1">#                                    normed=True,ax=ax)</span>
            <span class="c1">#        except Exception as e:</span>
            <span class="c1">#            logger.warn(&quot;error plotting histogram for {0}:{1}&quot;.</span>
            <span class="c1">#                        format(pc,str(e)))</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">plot_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c1">#print(plot_bins)</span>
            <span class="c1">#print(vals)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">plot_bins</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">normed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="n">fc</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">deter_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">plot_col</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">deter_vals</span><span class="p">:</span>
                        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">deter_vals</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">],</span><span class="n">ylim</span><span class="p">,</span><span class="s2">&quot;k--&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">std_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
                    <span class="n">mn</span><span class="p">,</span> <span class="n">st</span> <span class="o">=</span> <span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">pc</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">pc</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">std_window</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">mn</span> <span class="o">-</span> <span class="n">st</span><span class="p">,</span> <span class="n">mn</span> <span class="o">-</span> <span class="n">st</span><span class="p">],</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">fc</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">mn</span> <span class="o">+</span> <span class="n">st</span><span class="p">,</span> <span class="n">mn</span> <span class="o">+</span> <span class="n">st</span><span class="p">],</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">fc</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">deter_range</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">xmn</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="n">st</span>
                        <span class="n">xmx</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">st</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmn</span><span class="p">,</span><span class="n">xmx</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;error plotting std window for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                                <span class="nb">format</span><span class="p">(</span><span class="n">pc</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensembles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) </span><span class="si">{1}</span><span class="s2">, count: </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span> <span class="n">label</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_col</span><span class="p">)),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) </span><span class="si">{1}</span><span class="s2">, count:</span><span class="si">{2}</span><span class="se">\n</span><span class="s2">min:</span><span class="si">{3:3.1E}</span><span class="s2">, max:</span><span class="si">{4:3.1E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span>
                                                                       <span class="n">label</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_col</span><span class="p">),</span>
                                                                       <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span>
                                                                       <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">vals</span><span class="p">)),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax_count</span><span class="p">,</span> <span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1">#pdf.savefig()</span>
    <span class="c1">#plt.close(fig)</span>
    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
                <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;pyemu.plot_utils.ensemble_helper()&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ensemble_change_summary"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.ensemble_change_summary">[docs]</a><span class="k">def</span> <span class="nf">ensemble_change_summary</span><span class="p">(</span><span class="n">ensemble1</span><span class="p">,</span> <span class="n">ensemble2</span><span class="p">,</span> <span class="n">pst</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper function to plot first and second moment change histograms between two</span>
<span class="sd">    ensembles</span>

<span class="sd">    Args:</span>
<span class="sd">        ensemble1 (varies): filename or `pandas.DataFrame` or `pyemu.Ensemble`</span>
<span class="sd">        ensemble2 (varies): filename or `pandas.DataFrame` or `pyemu.Ensemble`</span>
<span class="sd">        pst (`pyemu.Pst`): control file</span>
<span class="sd">        facecolor (`str`): the histogram facecolor.</span>
<span class="sd">        filename (`str`): the name of the multi-pdf to create. If None, return figs without saving.  Default is None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        [`matplotlib.Figure`]: a list of figures.  Returns None is</span>
<span class="sd">        `filename` is not None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">Logger</span><span class="p">(</span><span class="s1">&#39;Default_Loggger.log&#39;</span><span class="p">,</span><span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot ensemble change&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble1</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ensemble1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ensemble1</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ensemble1</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ensemble1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble2</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ensemble2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ensemble2</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ensemble2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ensemble2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># better to ensure this is caught by pestpp-ies ensemble csvs</span>
    <span class="n">unnamed1</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ensemble1</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;unnamed:&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unnamed1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ensemble1</span> <span class="o">=</span> <span class="n">ensemble1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># ensure unnamed col result of poor csv read only (ie last col)</span>
    <span class="n">unnamed2</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ensemble2</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;unnamed:&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unnamed2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ensemble2</span> <span class="o">=</span> <span class="n">ensemble2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># ensure unnamed col result of poor csv read only (ie last col)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ensemble1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ensemble2</span><span class="o">.</span> <span class="n">columns</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;ensemble1 does not have the same columns as ensemble2: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                      <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
    <span class="k">if</span> <span class="s2">&quot;grouper&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">en_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ensemble1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">en_cols</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">par_names</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">en_cols</span><span class="p">,:]</span>
            <span class="n">grouper</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">pargp</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
            <span class="n">grouper</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span>
            <span class="n">li</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">partrans</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
            <span class="n">ensemble1</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble1</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
            <span class="n">ensemble2</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble2</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">en_cols</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">observation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">en_cols</span><span class="p">,:]</span>
            <span class="n">grouper</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">obgnme</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
            <span class="n">grouper</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">nnz_obs_names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;could not match ensemble cols with par or obs...&quot;</span><span class="p">)</span>

    <span class="n">en1_mn</span><span class="p">,</span> <span class="n">en1_std</span> <span class="o">=</span> <span class="n">ensemble1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">ensemble1</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">en2_mn</span><span class="p">,</span> <span class="n">en2_std</span> <span class="o">=</span> <span class="n">ensemble2</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">ensemble2</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># mn_diff = 100.0 * ((en1_mn - en2_mn) / en1_mn)</span>
    <span class="c1"># std_diff = 100 * ((en1_std - en2_std) / en1_std)</span>

    <span class="n">mn_diff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">en2_mn</span> <span class="o">-</span> <span class="n">en1_mn</span><span class="p">)</span>
    <span class="n">std_diff</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(((</span><span class="n">en1_std</span> <span class="o">-</span> <span class="n">en2_std</span><span class="p">)</span> <span class="o">/</span> <span class="n">en1_std</span><span class="p">))</span>
    <span class="c1">#set en1_std==0 to nan</span>
    <span class="c1">#std_diff[en1_std.index[en1_std==0]] = np.nan</span>



    <span class="c1">#diff = ensemble1 - ensemble2</span>
    <span class="c1">#mn_diff = diff.mean(axis=0)</span>
    <span class="c1">#std_diff = diff.std(axis=0)</span>


    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;fig_title&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fig_title&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;pyemu.Pst.plot(kind=&#39;1to1&#39;)</span><span class="se">\n</span><span class="s2">from pest control file &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2"> at </span><span class="si">{1}</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="c1">#if plot_hexbin:</span>
    <span class="c1">#    pdfname = pst.filename.replace(&quot;.pst&quot;, &quot;.1to1.hexbin.pdf&quot;)</span>
    <span class="c1">#else:</span>
    <span class="c1">#    pdfname = pst.filename.replace(&quot;.pst&quot;, &quot;.1to1.pdf&quot;)</span>
    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">grouper</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting change for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

        <span class="n">mn_g</span> <span class="o">=</span> <span class="n">mn_diff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">names</span><span class="p">]</span>
        <span class="n">std_g</span> <span class="o">=</span> <span class="n">std_diff</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">names</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mn_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;no entries for group &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting change for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">ax_count</span> <span class="o">%</span> <span class="p">(</span><span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="c1">#pdf.savefig()</span>
            <span class="c1">#plt.close(fig)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">_get_page_axes</span><span class="p">()</span>
            <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span>
        <span class="n">mn_g</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="c1">#mx = max(mn_g.max(), mn_g.min(),np.abs(mn_g.max()),np.abs(mn_g.min())) * 1.2</span>
        <span class="c1">#ax.set_xlim(-mx,mx)</span>

        <span class="c1">#std_g.hist(ax=ax,facecolor=&#39;b&#39;,alpha=0.5,edgecolor=None)</span>



        <span class="c1">#ax.set_xlim(xlim)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;mean change&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) mean change group:</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2"> entries</span><span class="se">\n</span><span class="s2">max:</span><span class="si">{3:10G}</span><span class="s2">, min:</span><span class="si">{4:10G}</span><span class="s2">&quot;</span><span class="o">.</span>
                     <span class="nb">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">mn_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mn_g</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">mn_g</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span>
        <span class="n">std_g</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="c1"># std_g.hist(ax=ax,facecolor=&#39;b&#39;,alpha=0.5,edgecolor=None)</span>



        <span class="c1"># ax.set_xlim(xlim)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;sigma percent reduction&quot;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) sigma change group:</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2"> entries</span><span class="se">\n</span><span class="s2">max:</span><span class="si">{3:10G}</span><span class="s2">, min:</span><span class="si">{4:10G}</span><span class="s2">&quot;</span><span class="o">.</span>
                     <span class="nb">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">mn_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">std_g</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">std_g</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting change for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax_count</span><span class="p">,</span> <span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1">#pdf.savefig()</span>
    <span class="c1">#plt.close(fig)</span>
    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
                <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot ensemble change&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot ensemble change&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span></div>

<span class="k">def</span> <span class="nf">_process_ensemble_arg</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="n">ensembles</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Ensemble</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">facecolor</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;facecolor must be str&quot;</span><span class="p">)</span>
        <span class="n">ensembles</span><span class="p">[</span><span class="n">facecolor</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensemble</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">facecolor</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;facecolor must be str&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;loading ensemble from csv file </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ensemble</span><span class="p">))</span>
        <span class="n">en</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> shape: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="n">en</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">ensembles</span><span class="p">[</span><span class="n">facecolor</span><span class="p">]</span> <span class="o">=</span> <span class="n">en</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;loading ensemble from csv file </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ensemble</span><span class="p">))</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">facecolor</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">facecolor</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;facecolor list len != ensemble list len&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>

            <span class="n">facecolor</span> <span class="o">=</span> <span class="p">[</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ensemble</span><span class="p">))]</span>
        <span class="n">ensembles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fc</span><span class="p">,</span> <span class="n">en_arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">facecolor</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">en_arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading ensemble from csv file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">en_arg</span><span class="p">))</span>
                <span class="n">en</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">en_arg</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading ensemble from csv file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">en_arg</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;ensemble </span><span class="si">{0}</span><span class="s2"> gets facecolor </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">en_arg</span><span class="p">,</span> <span class="n">fc</span><span class="p">))</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">en_arg</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">en_arg</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Ensemble</span><span class="p">):</span>
                <span class="n">en</span> <span class="o">=</span> <span class="n">en_arg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;unrecognized ensemble list arg:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">en_arg</span><span class="p">))</span>
            <span class="n">ensembles</span><span class="p">[</span><span class="n">fc</span><span class="p">]</span> <span class="o">=</span> <span class="n">en</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fc</span><span class="p">,</span> <span class="n">en_arg</span> <span class="ow">in</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">en_arg</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">en_arg</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Ensemble</span><span class="p">):</span>
                <span class="n">ensembles</span><span class="p">[</span><span class="n">fc</span><span class="p">]</span> <span class="o">=</span> <span class="n">en_arg</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">en_arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading ensemble from csv file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">en_arg</span><span class="p">))</span>
                <span class="n">en</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">en_arg</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading ensemble from csv file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">en_arg</span><span class="p">))</span>
                <span class="n">ensembles</span><span class="p">[</span><span class="n">fc</span><span class="p">]</span> <span class="o">=</span> <span class="n">en</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;unrecognized ensemble list arg:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">en_arg</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="p">:</span>
            <span class="n">ensembles</span><span class="p">[</span><span class="n">fc</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ensembles</span><span class="p">[</span><span class="n">fc</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error processing ensemble&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ensembles</span>

<div class="viewcode-block" id="ensemble_res_1to1"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.ensemble_res_1to1">[docs]</a><span class="k">def</span> <span class="nf">ensemble_res_1to1</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span> <span class="n">pst</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">skip_groups</span><span class="o">=</span><span class="p">[],</span><span class="n">base_ensemble</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper function to plot ensemble 1-to-1 plots sbowing the simulated range</span>

<span class="sd">    Args:</span>
<span class="sd">        ensemble (varies):  the ensemble argument can be a pandas.DataFrame or derived type or a str, which</span>
<span class="sd">            is treated as a fileanme.  Optionally, ensemble can be a list of these types or</span>
<span class="sd">            a dict, in which case, the keys are treated as facecolor str (e.g., &#39;b&#39;, &#39;y&#39;, etc).</span>
<span class="sd">        pst (`pyemu.Pst`): a control file instance</span>
<span class="sd">        facecolor (`str`): the histogram facecolor.  Only applies if `ensemble` is a single thing</span>
<span class="sd">        filename (`str`): the name of the pdf to create. If None, return figs</span>
<span class="sd">            without saving.  Default is None.</span>
<span class="sd">        base_ensemble (`varies`): an optional ensemble argument for the observations + noise ensemble.</span>
<span class="sd">            This will be plotted as a transparent red bar on the 1to1 plot.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">Logger</span><span class="p">(</span><span class="s1">&#39;Default_Loggger.log&#39;</span><span class="p">,</span><span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot res_1to1&quot;</span><span class="p">)</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">observation_data</span>
    <span class="n">ensembles</span> <span class="o">=</span> <span class="n">_process_ensemble_arg</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span><span class="n">facecolor</span><span class="p">,</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">base_ensemble</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base_ensemble</span> <span class="o">=</span> <span class="n">_process_ensemble_arg</span><span class="p">(</span><span class="n">base_ensemble</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;grouper&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grouper</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">obgnme</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
        <span class="k">for</span> <span class="n">skip_group</span> <span class="ow">in</span> <span class="n">skip_groups</span><span class="p">:</span>
            <span class="n">grouper</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">skip_group</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;fig_title&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fig_title&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;pyemu.Pst.plot(kind=&#39;1to1&#39;)</span><span class="se">\n</span><span class="s2">from pest control file &#39;</span><span class="si">{0}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2"> at </span><span class="si">{1}</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
    <span class="c1">#if plot_hexbin:</span>
    <span class="c1">#    pdfname = pst.filename.replace(&quot;.pst&quot;, &quot;.1to1.hexbin.pdf&quot;)</span>
    <span class="c1">#else:</span>
    <span class="c1">#    pdfname = pst.filename.replace(&quot;.pst&quot;, &quot;.1to1.pdf&quot;)</span>
    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">grouper</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting 1to1 for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

        <span class="n">obs_g</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">names</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;using control file obsvals to calculate residuals&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;include_zero&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;include_zero&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">obs_g</span> <span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obs_g</span><span class="o">.</span><span class="n">weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;no non-zero obs for group &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting 1to1 for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">ax_count</span> <span class="o">%</span> <span class="p">(</span><span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="c1">#pdf.savefig()</span>
            <span class="c1">#plt.close(fig)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">_get_page_axes</span><span class="p">()</span>
            <span class="n">ax_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">base_ensemble</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">mn</span> <span class="o">=</span>  <span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mn</span> <span class="o">=</span> <span class="n">base_ensemble</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">names</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="n">base_ensemble</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">names</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1">#if obs_g.shape[0] == 1:</span>
        <span class="n">mx</span> <span class="o">*=</span> <span class="mf">1.1</span>
        <span class="n">mn</span> <span class="o">*=</span> <span class="mf">0.9</span>
        <span class="c1">#ax.axis(&#39;square&#39;)</span>
        <span class="k">if</span> <span class="n">base_ensemble</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obs_gg</span> <span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;obsval&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">base_ensemble</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">en_g</span> <span class="o">=</span> <span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">obs_gg</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">en_g</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">en</span> <span class="o">=</span> <span class="n">en_g</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="c1">#[ax.plot([ov, ov], [een, eex], color=c,alpha=0.3) for ov, een, eex in zip(obs_g.obsval.values, en.values, ex.values)]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">obs_gg</span><span class="o">.</span><span class="n">obsval</span><span class="p">,</span><span class="n">en</span><span class="p">,</span><span class="n">ex</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="c1">#ax.scatter([obs_g.sim], [obs_g.obsval], marker=&#39;.&#39;, s=10, color=&#39;b&#39;)</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">en</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">en_g</span> <span class="o">=</span> <span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">en_g</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">en</span> <span class="o">=</span> <span class="n">en_g</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ov</span><span class="p">,</span><span class="n">ov</span><span class="p">],[</span><span class="n">een</span><span class="p">,</span><span class="n">eex</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">ov</span><span class="p">,</span><span class="n">een</span><span class="p">,</span><span class="n">eex</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">en</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">ex</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">],[</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">],</span><span class="s1">&#39;k--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span><span class="n">mx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mx</span> <span class="o">&gt;</span> <span class="mf">1.0e5</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%1.0e</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%1.0e</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;observed&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;simulated&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) group:</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2"> observations&quot;</span><span class="o">.</span>
                                 <span class="nb">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">ax_count</span><span class="p">]</span>
        <span class="c1">#ax.scatter(obs_g.obsval, obs_g.res, marker=&#39;.&#39;, s=10, color=&#39;b&#39;)</span>

        <span class="k">if</span> <span class="n">base_ensemble</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obs_gg</span> <span class="o">=</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;obsval&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">base_ensemble</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">en_g</span> <span class="o">=</span> <span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">obs_gg</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">obs_gg</span><span class="o">.</span><span class="n">obsval</span><span class="p">)</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">en_g</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">en</span> <span class="o">=</span> <span class="n">en_g</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="c1">#[ax.plot([ov, ov], [een, eex], color=c,alpha=0.3) for ov, een, eex in zip(obs_g.obsval.values, en.values, ex.values)]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">obs_gg</span><span class="o">.</span><span class="n">obsval</span><span class="p">,</span><span class="n">en</span><span class="p">,</span><span class="n">ex</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">en</span> <span class="ow">in</span> <span class="n">ensembles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">en_g</span> <span class="o">=</span> <span class="n">en</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">en_g</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">en</span> <span class="o">=</span> <span class="n">en_g</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ov</span><span class="p">,</span><span class="n">ov</span><span class="p">],[</span><span class="n">een</span><span class="p">,</span><span class="n">eex</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">ov</span><span class="p">,</span><span class="n">een</span><span class="p">,</span><span class="n">eex</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_g</span><span class="o">.</span><span class="n">obsval</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">en</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">ex</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
        <span class="c1"># if base_ensemble is not None:</span>
        <span class="c1">#     if base_ensemble is not None:</span>
        <span class="c1">#         for c, en in base_ensemble.items():</span>
        <span class="c1">#             en_g = en.loc[:, obs_g.obsnme].subtract(obs_g.obsval,axis=1)</span>
        <span class="c1">#             ex = en_g.max()</span>
        <span class="c1">#             en = en_g.min()</span>
        <span class="c1">#             [ax.plot([ov, ov], [een, eex], color=c, alpha=0.3) for ov, een, eex in</span>
        <span class="c1">#              zip(obs_g.obsval.values, en.values, ex.values)]</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mx</span> <span class="o">*=</span> <span class="mf">1.1</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">mx</span><span class="p">,</span> <span class="n">mx</span><span class="p">)</span>
        <span class="c1">#show a zero residuals line</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlim</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;residual&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;observed&quot;</span><span class="p">,</span><span class="n">labelpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">) group:</span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2"> observations&quot;</span><span class="o">.</span>
                     <span class="nb">format</span><span class="p">(</span><span class="n">abet</span><span class="p">[</span><span class="n">ax_count</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">obs_g</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0e5</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%1.0e</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="n">ax_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plotting 1to1 for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ax_count</span><span class="p">,</span> <span class="n">nr</span> <span class="o">*</span> <span class="n">nc</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1">#pdf.savefig()</span>
    <span class="c1">#plt.close(fig)</span>
    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
                <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot res_1to1&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;plot res_1to1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span></div>





<div class="viewcode-block" id="plot_jac_test"><a class="viewcode-back" href="../../../index.html#pyemu.plot.plot_utils.plot_jac_test">[docs]</a><span class="k">def</span> <span class="nf">plot_jac_test</span><span class="p">(</span><span class="n">csvin</span><span class="p">,</span> <span class="n">csvout</span><span class="p">,</span> <span class="n">targetobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxoutputpages</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">outputdirectory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; helper function to plot results of the Jacobian test performed using the pest++</span>
<span class="sd">    program pestpp-swp.</span>

<span class="sd">    Args:</span>
<span class="sd">        csvin (`str`): name of csv file used as input to sweep, typically developed with</span>
<span class="sd">            static method pyemu.helpers.build_jac_test_csv()</span>
<span class="sd">        csvout (`str`): name of csv file with output generated by sweep, both input</span>
<span class="sd">            and output files can be specified in the pest++ control file</span>
<span class="sd">            with pyemu using: pest_object.pestpp_options[&quot;sweep_parameter_csv_file&quot;] = jactest_in_file.csv</span>
<span class="sd">            pest_object.pestpp_options[&quot;sweep_output_csv_file&quot;] = jactest_out_file.csv</span>
<span class="sd">        targetobs ([`str`]): list of observation file names to plot, each parameter used for jactest can</span>
<span class="sd">            have up to 32 observations plotted per page, throws a warning if more tha</span>
<span class="sd">            10 pages of output are requested per parameter. If none, all observations in</span>
<span class="sd">            the output csv file are used.</span>
<span class="sd">        filetype (`str`): file type to store output, if None, plt.show() is called.</span>
<span class="sd">        maxoutputpages (`int`): maximum number of pages of output per parameter.  Each page can</span>
<span class="sd">            hold up to 32 observation derivatives.  If value &gt; 10, set it to</span>
<span class="sd">            10 and throw a warning.  If observations in targetobs &gt; 32*maxoutputpages,</span>
<span class="sd">            then a random set is selected from the targetobs list (or all observations</span>
<span class="sd">            in the csv file if targetobs=None).</span>
<span class="sd">        outputdirectory (`str`):  directory to store results, if None, current working directory is used.</span>
<span class="sd">            If string is passed, it is joined to the current working directory and</span>
<span class="sd">            created if needed. If os.path is passed, it is used directly.</span>

<span class="sd">    Note:</span>
<span class="sd">        Used in conjunction with pyemu.helpers.build_jac_test_csv() and sweep to perform</span>
<span class="sd">        a Jacobian Test and then view the results. Can generate a lot of plots so easiest</span>
<span class="sd">        to put into a separate directory and view the files.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">localhome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="c1"># check if the output directory exists, if not make it</span>
    <span class="k">if</span> <span class="n">outputdirectory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">localhome</span><span class="p">,</span> <span class="n">outputdirectory</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">localhome</span><span class="p">,</span> <span class="n">outputdirectory</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">outputdirectory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">figures_dir</span> <span class="o">=</span> <span class="n">localhome</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">figures_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">localhome</span><span class="p">,</span> <span class="n">outputdirectory</span><span class="p">)</span>

    <span class="c1"># read the input and output files into pandas dataframes</span>
    <span class="n">jactest_in_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvin</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">jactest_in_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;input_run_id&#39;</span>
    <span class="n">jactest_out_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csvout</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># subtract the base run from every row, leaves the one parameter that</span>
    <span class="c1"># was perturbed in any row as only non-zero value. Set zeros to nan</span>
    <span class="c1"># so round-off doesn&#39;t get us and sum across rows to get a column of</span>
    <span class="c1"># the perturbation for each row, finally extract to a series. First</span>
    <span class="c1"># the input csv and then the output.</span>
    <span class="n">base_par</span> <span class="o">=</span> <span class="n">jactest_in_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">]</span>
    <span class="n">delta_par_df</span> <span class="o">=</span> <span class="n">jactest_in_df</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">base_par</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
    <span class="n">delta_par_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">delta_par_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">delta_par_df</span><span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_par_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
    <span class="n">delta_par</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">delta_par_df</span><span class="p">[</span><span class="s1">&#39;change&#39;</span><span class="p">])</span>

    <span class="n">base_obs</span> <span class="o">=</span> <span class="n">jactest_out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">]</span>
    <span class="n">delta_obs</span> <span class="o">=</span> <span class="n">jactest_out_df</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">base_obs</span><span class="p">)</span>
    <span class="n">delta_obs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># if targetobs is None, then reset it to all the observations.</span>
    <span class="k">if</span> <span class="n">targetobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">targetobs</span> <span class="o">=</span> <span class="n">jactest_out_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">8</span><span class="p">:]</span>
    <span class="n">delta_obs</span> <span class="o">=</span> <span class="n">delta_obs</span><span class="p">[</span><span class="n">targetobs</span><span class="p">]</span>

    <span class="c1"># get the Jacobian by dividing the change in observation by the change in parameter</span>
    <span class="c1"># for the perturbed parameters</span>
    <span class="n">jacobian</span> <span class="o">=</span> <span class="n">delta_obs</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">delta_par</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

    <span class="c1"># use the index created by build_jac_test_csv to get a column of parameter names</span>
    <span class="c1"># and increments, then we can plot derivative vs. increment for each parameter</span>
    <span class="n">extr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">jacobian</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s2">&quot;(.+)(_\d+$)&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">extr_df</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">extr_df</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">extr_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;increment&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">extr_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">jacobian</span><span class="o">.</span><span class="n">index</span>

    <span class="c1"># make a dataframe for plotting the Jacobian by combining the parameter name</span>
    <span class="c1"># and increments frame with the Jacobian frame</span>
    <span class="n">plotframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">extr_df</span><span class="p">,</span> <span class="n">jacobian</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

    <span class="c1"># get a list of observations to keep based on maxoutputpages.</span>
    <span class="k">if</span> <span class="n">maxoutputpages</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING, more than 10 pages of output requested per parameter&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;maxoutputpage reset to 10.&quot;</span><span class="p">)</span>
        <span class="n">maxoutputpages</span><span class="o">=</span><span class="mi">10</span>
    <span class="n">num_obs_plotted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">maxoutputpages</span><span class="o">*</span><span class="mi">32</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">targetobs</span><span class="p">)]))</span>
    <span class="k">if</span> <span class="n">num_obs_plotted</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">targetobs</span><span class="p">):</span>
        <span class="c1"># get random sample</span>
        <span class="n">index_plotted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targetobs</span><span class="p">),</span> <span class="n">num_obs_plotted</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">obs_plotted</span> <span class="o">=</span> <span class="p">[</span><span class="n">targetobs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">index_plotted</span><span class="p">]</span>
        <span class="n">real_pages</span> <span class="o">=</span> <span class="n">maxoutputpages</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obs_plotted</span> <span class="o">=</span> <span class="n">targetobs</span>
        <span class="n">real_pages</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">targetobs</span><span class="o">/</span><span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># make a subplot of derivative vs. increment one plot for each of the</span>
    <span class="c1"># observations in targetobs, and outputs grouped by parameter.</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">plotframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">real_pages</span><span class="p">):</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">page</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">row</span> <span class="o">+</span> <span class="n">col</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">num_obs_plotted</span><span class="p">:</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;increment&#39;</span><span class="p">],</span> <span class="n">group</span><span class="p">[</span><span class="n">obs_plotted</span><span class="p">[</span><span class="n">count</span><span class="p">]])</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;increment&#39;</span><span class="p">],</span> <span class="n">group</span><span class="p">[</span><span class="n">obs_plotted</span><span class="p">[</span><span class="n">count</span><span class="p">]],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">obs_plotted</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">axes</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Increment&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">filetype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figures_dir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_jactest_</span><span class="si">{1}</span><span class="s2">.</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">filetype</span><span class="p">)))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, pyEMU development team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>