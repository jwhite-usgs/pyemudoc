

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyemu.utils.geostats &mdash; pyEMU 0.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyEMU
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.html">pyemu</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyEMU</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyemu.utils.geostats</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyemu.utils.geostats</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Geostatistics in the PEST(++) realm</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pyemu.mat.mat_handler</span> <span class="k">import</span> <span class="n">Cov</span>
<span class="kn">from</span> <span class="nn">pyemu.utils.pp_utils</span> <span class="k">import</span> <span class="n">pp_file_to_dataframe</span>
<span class="kn">from</span> <span class="nn">..pyemu_warnings</span> <span class="k">import</span> <span class="n">PyemuWarning</span>

<span class="n">EPSILON</span> <span class="o">=</span> <span class="mf">1.0e-7</span>

<span class="c1"># class KrigeFactors(pd.DataFrame):</span>
<span class="c1">#     def __init__(self,*args,**kwargs):</span>
<span class="c1">#         super(KrigeFactors,self).__init__(*args,**kwargs)</span>
<span class="c1">#</span>
<span class="c1">#     def to_factors(self,filename,nrow,ncol,</span>
<span class="c1">#                    points_file=&quot;points.junk&quot;,</span>
<span class="c1">#                    zone_file=&quot;zone.junk&quot;):</span>
<span class="c1">#         with open(filename,&#39;w&#39;) as f:</span>
<span class="c1">#             f.write(points_file+&#39;\n&#39;)</span>
<span class="c1">#             f.write(zone_file+&#39;\n&#39;)</span>
<span class="c1">#             f.write(&quot;{0} {1}\n&quot;.format(ncol,nrow))</span>
<span class="c1">#             f.write(&quot;{0}\n&quot;.format(self.shape[0]))</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     def from_factors(self,filename):</span>
<span class="c1">#         raise NotImplementedError()</span>





<div class="viewcode-block" id="GeoStruct"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.GeoStruct">[docs]</a><span class="k">class</span> <span class="nc">GeoStruct</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a geostatistical structure object that mimics the behavior of a PEST</span>
<span class="sd">    geostatistical structure.  The object contains variogram instances and</span>
<span class="sd">    (optionally) nugget information.</span>

<span class="sd">    Args:</span>
<span class="sd">        nugget (`float` (optional)): nugget contribution. Default is 0.0</span>
<span class="sd">        variograms : ([`pyemu.Vario2d`] (optional)): variogram(s) associated</span>
<span class="sd">            with this GeoStruct instance. Default is empty list</span>
<span class="sd">        name (`str` (optional)): name to assign the structure.  Default</span>
<span class="sd">            is &quot;struct1&quot;.</span>
<span class="sd">        transform  (`str` (optional)): the transformation to apply to</span>
<span class="sd">            the GeoStruct.  Can be &quot;none&quot; or &quot;log&quot;, depending on the</span>
<span class="sd">            transformation of the property being represented by the `GeoStruct`.</span>
<span class="sd">            Default is &quot;none&quot;</span>

<span class="sd">    Example::</span>

<span class="sd">        v = pyemu.utils.geostats.ExpVario(a=1000,contribution=1.0)</span>
<span class="sd">        gs = pyemu.utils.geostats.GeoStruct(variograms=v,nugget=0.5)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nugget</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">variograms</span><span class="o">=</span><span class="p">[],</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;struct1&quot;</span><span class="p">,</span>
                 <span class="n">transform</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nugget</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;`float`: the nugget effect contribution&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variograms</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">variograms</span> <span class="o">=</span> <span class="p">[</span><span class="n">variograms</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vario</span> <span class="ow">in</span> <span class="n">variograms</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vario</span><span class="p">,</span><span class="n">Vario2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span> <span class="o">=</span> <span class="n">variograms</span>
        <span class="sd">&quot;&quot;&quot;[`pyemu.utils.geostats.Vario2d`]: a list of variogram instances&quot;&quot;&quot;</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">transform</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="s2">&quot;log&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="sd">&quot;&quot;&quot;`str`: the transformation of the `GeoStruct`.  Can be &#39;log&#39; or &#39;none&#39;&quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>


    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="GeoStruct.to_struct_file"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.GeoStruct.to_struct_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_struct_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a PEST-style structure file</span>

<span class="sd">        Args:</span>
<span class="sd">            f (`str`): file to write the GeoStruct information in to.  Can</span>
<span class="sd">                also be an open file handle</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;STRUCTURE </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  NUGGET </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nugget</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  NUMVARIOGRAM </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  VARIOGRAM </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">contribution</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  TRANSFORM </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END STRUCTURE</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">to_struct_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoStruct.covariance_matrix"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.GeoStruct.covariance_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cov</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;build a `pyemu.Cov` instance from `GeoStruct`</span>

<span class="sd">        Args:</span>
<span class="sd">            x ([`floats`]): x-coordinate locations</span>
<span class="sd">            y ([`float`]): y-coordinate locations</span>
<span class="sd">            names ([`str`] (optional)): names of location. If None,</span>
<span class="sd">                cov must not be None.  Default is None.</span>
<span class="sd">            cov (`pyemu.Cov`): an existing Cov instance.  The contribution</span>
<span class="sd">                of this GeoStruct is added to cov.  If cov is None,</span>
<span class="sd">                names must not be None. Default is None</span>

<span class="sd">        Returns:</span>
<span class="sd">            `pyemu.Cov`: the covariance matrix implied by this</span>
<span class="sd">            GeoStruct for the x,y pairs. `cov` has row and column</span>
<span class="sd">            names supplied by the names argument unless the &quot;cov&quot;</span>
<span class="sd">            argument was passed.</span>

<span class="sd">        Note:</span>
<span class="sd">            either &quot;names&quot; or &quot;cov&quot; must be passed.  If &quot;cov&quot; is passed, cov.shape</span>
<span class="sd">            must equal len(x) and len(y).</span>

<span class="sd">        Example::</span>

<span class="sd">            pp_df = pyemu.pp_utils.pp_file_to_dataframe(&quot;hkpp.dat&quot;)</span>
<span class="sd">            cov = gs.covariance_matrix(pp_df.x,pp_df.y,pp_df.name)</span>
<span class="sd">            cov.to_binary(&quot;cov.jcb&quot;)</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nugget</span><span class="p">)</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">row_names</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span><span class="n">isdiagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cov</span> <span class="o">+=</span> <span class="n">cont</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;GeoStruct.covariance_matrix() requires either &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;names or cov arg&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cov</span></div>

<div class="viewcode-block" id="GeoStruct.covariance"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.GeoStruct.covariance">[docs]</a>    <span class="k">def</span> <span class="nf">covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pt0</span><span class="p">,</span><span class="n">pt1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the covariance between two points implied by the `GeoStruct`.</span>
<span class="sd">        This is used during the ordinary kriging process to get the RHS</span>

<span class="sd">        Args:</span>
<span class="sd">            pt0 ([`float`]): xy-pair</span>
<span class="sd">            pt1 ([`float`]): xy-pair</span>

<span class="sd">        Returns:</span>
<span class="sd">            `float`: the covariance between pt0 and pt1 implied</span>
<span class="sd">            by the GeoStruct</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#raise Exception()</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
        <span class="k">for</span> <span class="n">vario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">+=</span> <span class="n">vario</span><span class="o">.</span><span class="n">covariance</span><span class="p">(</span><span class="n">pt0</span><span class="p">,</span><span class="n">pt1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cov</span></div>

<div class="viewcode-block" id="GeoStruct.covariance_points"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.GeoStruct.covariance_points">[docs]</a>    <span class="k">def</span> <span class="nf">covariance_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">xother</span><span class="p">,</span><span class="n">yother</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the covariance between point (x0,y0) and the points</span>
<span class="sd">        contained in xother, yother.</span>

<span class="sd">        Args:</span>
<span class="sd">            x0 (`float`): x-coordinate</span>
<span class="sd">            y0 (`float`): y-coordinate</span>
<span class="sd">            xother ([`float`]): x-coordinates of other points</span>
<span class="sd">            yother ([`float`]): y-coordinates of other points</span>

<span class="sd">        Returns:</span>
<span class="sd">            `numpy.ndarray`: a 1-D array of covariance between point x0,y0 and the</span>
<span class="sd">            points contained in xother, yother.  len(cov) = len(xother) =</span>
<span class="sd">            len(yother)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xother</span><span class="p">)))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">+=</span> <span class="n">v</span><span class="o">.</span><span class="n">covariance_points</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">xother</span><span class="p">,</span><span class="n">yother</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cov</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the sill of the `GeoStruct`</span>

<span class="sd">        Returns:</span>
<span class="sd">            `float`: the sill of the (nested) `GeoStruct`, including</span>
<span class="sd">            nugget and contribution from each variogram</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">sill</span> <span class="o">+=</span> <span class="n">v</span><span class="o">.</span><span class="n">contribution</span>
        <span class="k">return</span> <span class="n">sill</span>


<div class="viewcode-block" id="GeoStruct.plot"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.GeoStruct.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; make a cheap plot of the `GeoStruct`</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs : (dict)</span>
<span class="sd">                keyword arguments to use for plotting.</span>
<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib.pyplot.axis`: the axis with the GeoStruct plot</span>

<span class="sd">        Note:</span>
<span class="sd">            optional arguments include &quot;ax&quot; (an existing axis),</span>
<span class="sd">            &quot;individuals&quot; (plot each variogram on a separate axis),</span>
<span class="sd">            &quot;legend&quot; (add a legend to the plot(s)).  All other kwargs</span>
<span class="sd">            are passed to matplotlib.pyplot.plot()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s2">&quot;ax&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ax&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error importing matplotlib: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;legend&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">individuals</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;individuals&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">xmx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="mf">3.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xmx</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">yv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">inv_h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">individuals</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">yv</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">yv</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\gamma$&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; the `str` representation of the `GeoStruct`</span>

<span class="sd">        Returns:</span>
<span class="sd">            `str`: the string representation of the GeoStruct</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;name:</span><span class="si">{0}</span><span class="s1">,nugget:</span><span class="si">{1}</span><span class="s1">,structures:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nugget</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="SpecSim2d"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.SpecSim2d">[docs]</a><span class="k">class</span> <span class="nc">SpecSim2d</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;2-D unconditional spectral simulation for regular grids</span>

<span class="sd">    Args:</span>
<span class="sd">        delx (`numpy.ndarray`): a 1-D array of x-dimension cell centers</span>
<span class="sd">            (or leading/trailing edges).  Only the distance between points</span>
<span class="sd">            is important</span>
<span class="sd">        dely (`numpy.ndarray`): a 1-D array of y-dimension cell centers</span>
<span class="sd">            (or leading/trailing edges).  Only the distance between points</span>
<span class="sd">            is important</span>
<span class="sd">        geostruct (`pyemu.geostats.Geostruct`): geostatistical structure instance</span>

<span class="sd">    Example::</span>

<span class="sd">        v = pyemu.utils.geostats.ExpVario(a=1000,contribution=1.0)</span>
<span class="sd">        gs = pyemu.utils.geostats.GeoStruct(variograms=v,nugget=0.5)</span>
<span class="sd">        delx,dely = np.arange(100), np.arrange(100)</span>
<span class="sd">        ss = pyemu.utils.geostats.SpecSim2d(delx,dely,gs)</span>
<span class="sd">        arrays = ss.draw(num_reals=100)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">delx</span><span class="p">,</span><span class="n">dely</span><span class="p">,</span><span class="n">geostruct</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span> <span class="o">=</span> <span class="n">geostruct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delx</span> <span class="o">=</span> <span class="n">delx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dely</span> <span class="o">=</span> <span class="n">dely</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqrt_fftc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">effective_variograms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

<div class="viewcode-block" id="SpecSim2d.grid_is_regular"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.SpecSim2d.grid_is_regular">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">grid_is_regular</span><span class="p">(</span><span class="n">delx</span><span class="p">,</span> <span class="n">dely</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check that a grid is regular using delx and dely vectors</span>

<span class="sd">        Args:</span>
<span class="sd">            delx : `numpy.ndarray`</span>
<span class="sd">                a 1-D array of x-dimension cell centers (or leading/trailing edges).  Only the</span>
<span class="sd">                distance between points is important</span>
<span class="sd">            dely : `numpy.ndarray`</span>
<span class="sd">                a 1-D array of y-dimension cell centers (or leading/trailing edges).  Only the</span>
<span class="sd">                distance between points is important</span>
<span class="sd">            tol : `float` (optional)</span>
<span class="sd">                tolerance to determine grid regularity.  Default is 1.0e-6</span>

<span class="sd">        Returns:</span>
<span class="sd">            `bool`: flag indicating if the grid defined by `delx` and `dely` is regular</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delx</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">delx</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dely</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">dely</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delx</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">dely</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SpecSim2d.initialize"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.SpecSim2d.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;prepare for spectral simulation.</span>

<span class="sd">        Note:</span>
<span class="sd">            `initialize()` prepares for simulation by undertaking</span>
<span class="sd">            the fast FFT on the wave number matrix and should be called</span>
<span class="sd">            if the `SpecSim2d.geostruct` is changed.</span>

<span class="sd">            This method is called by the constructor.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SpecSim2d</span><span class="o">.</span><span class="n">grid_is_regular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dely</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;SpectSim2d() error: grid not regular&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">bearing</span> <span class="o">%</span> <span class="mf">90.0</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;SpecSim2d only supports grid-aligned anisotropy...&quot;</span><span class="p">)</span>

        <span class="c1"># since we checked for grid regularity, we now can work in unit space</span>
        <span class="c1"># and use effective variograms:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">effective_variograms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">eff_v</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)(</span><span class="n">contribution</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">a</span><span class="o">/</span><span class="n">dist</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">bearing</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">anisotropy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">effective_variograms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eff_v</span><span class="p">)</span>
        <span class="c1"># pad the grid with 3X max range</span>
        <span class="n">mx_a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0e10</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">effective_variograms</span><span class="p">:</span>
            <span class="n">mx_a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mx_a</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="n">mx_dim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dely</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">freq_pad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mx_a</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">freq_pad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">freq_pad</span> <span class="o">/</span> <span class="mf">8.</span><span class="p">)</span> <span class="o">*</span> <span class="mf">8.</span><span class="p">)</span>
        <span class="c1"># use the max dimension so that simulation grid is square</span>
        <span class="n">full_delx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">mx_dim</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">freq_pad</span><span class="p">)))</span>
        <span class="n">full_dely</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">full_delx</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SpecSim.initialize() summary: full_delx X full_dely: </span><span class="si">{0}</span><span class="s2"> X </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>\
              <span class="nb">format</span><span class="p">(</span><span class="n">full_delx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">full_dely</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">xdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">full_delx</span><span class="p">)</span>
        <span class="n">ydist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">full_dely</span><span class="p">)</span>
        <span class="n">xdist</span> <span class="o">-=</span> <span class="n">xdist</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ydist</span> <span class="o">-=</span> <span class="n">ydist</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ydist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xdist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xdist</span><span class="p">):</span>
            <span class="n">xgrid</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ydist</span><span class="p">):</span>
            <span class="n">ygrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">))</span>
        <span class="n">domainsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">full_dely</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">full_delx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">domainsize</span> <span class="o">=</span> <span class="n">domainsize</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">domainsize</span><span class="p">)</span> <span class="o">-</span> <span class="n">grid</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># work out the contribution from each effective variogram and nugget</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">effective_variograms</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="n">v</span><span class="o">.</span><span class="n">_specsim_grid_contrib</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">nugget</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="p">((</span><span class="n">grid</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">c</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">nugget</span>
        <span class="c1"># fft components</span>
        <span class="n">fftc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">xgrid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqrt_fftc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fftc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pts</span><span class="p">)</span></div>

<div class="viewcode-block" id="SpecSim2d.draw_arrays"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.SpecSim2d.draw_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">draw_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mean_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;draw realizations</span>

<span class="sd">        Args:</span>
<span class="sd">            num_reals (`int`): number of realizations to generate</span>
<span class="sd">            mean_value (`float`): the mean value of the realizations</span>

<span class="sd">        Returns:</span>
<span class="sd">            `numpy.ndarray`: a 3-D array of realizations.  Shape</span>
<span class="sd">            is (num_reals,self.dely.shape[0],self.delx.shape[0])</span>
<span class="sd">        Note:</span>
<span class="sd">            log transformation is respected and the returned `reals` array is</span>
<span class="sd">            in arithmatic space</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ireal</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_reals</span><span class="p">):</span>
            <span class="n">real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sqrt_fftc</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">imag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sqrt_fftc</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">real</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">imag</span>
            <span class="n">rand</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqrt_fftc</span>
            <span class="n">real</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">rand</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_pts</span>
            <span class="n">real</span> <span class="o">=</span> <span class="n">real</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">dely</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">delx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">reals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">real</span><span class="p">)</span>
        <span class="n">reals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reals</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">transform</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">reals</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mean_value</span><span class="p">)</span>
            <span class="n">reals</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">reals</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">reals</span> <span class="o">+=</span> <span class="n">mean_value</span>
        <span class="k">return</span> <span class="n">reals</span></div>

<div class="viewcode-block" id="SpecSim2d.grid_par_ensemble_helper"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.SpecSim2d.grid_par_ensemble_helper">[docs]</a>    <span class="k">def</span> <span class="nf">grid_par_ensemble_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pst</span><span class="p">,</span><span class="n">gr_df</span><span class="p">,</span><span class="n">num_reals</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper around `SpecSim2d.draw()` designed to support `pyemu.PstFromFlopy`</span>
<span class="sd">            grid-based parameters</span>

<span class="sd">        Args:</span>
<span class="sd">            pst (`pyemu.Pst`): a control file instance</span>
<span class="sd">            gr_df (`pandas.DataFrame`): a dataframe listing `parval1`,</span>
<span class="sd">                `pargp`, `i`, `j` for each grid based parameter</span>
<span class="sd">            num_reals (`int`): number of realizations to generate</span>
<span class="sd">            sigma_range (`float` (optional)): number of standard deviations</span>
<span class="sd">                implied by parameter bounds in control file. Default is 6</span>
<span class="sd">            logger (`pyemu.Logger` (optional)): a logger instance for logging</span>

<span class="sd">        Returns:</span>
<span class="sd">            `pyemu.ParameterEnsemble`: an untransformed parameter ensemble of</span>
<span class="sd">            realized grid-parameter values</span>

<span class="sd">        Note:</span>
<span class="sd">            the method processes each unique `pargp` value in `gr_df` and resets the sill of `self.geostruct` by</span>
<span class="sd">            the maximum bounds-implied variance of each `pargp`.  This method makes repeated calls to</span>
<span class="sd">            `self.initialize()` to deal with the geostruct changes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;i&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">gr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;SpecSim2d.grid_par_ensmeble_helper() error: &#39;i&#39; not in gr_df&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;j&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">gr_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;SpecSim2d.grid_par_ensmeble_helper() error: &#39;j&#39; not in gr_df&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">variograms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;SpecSim2D grid_par_ensemble_helper() error: only a single variogram can be used...&quot;</span><span class="p">)</span>

        <span class="c1"># scale the total contrib</span>
        <span class="n">org_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">variograms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contribution</span>
        <span class="n">org_nug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">nugget</span>
        <span class="n">new_var</span> <span class="o">=</span> <span class="n">org_var</span>
        <span class="n">new_nug</span> <span class="o">=</span> <span class="n">org_nug</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">sill</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SpecSim2d.grid_par_ensemble_helper() warning: scaling contribution and nugget to unity&quot;</span><span class="p">)</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="n">org_var</span> <span class="o">+</span> <span class="n">org_nug</span>
            <span class="n">new_var</span> <span class="o">=</span> <span class="n">org_var</span> <span class="o">/</span> <span class="n">tot</span>
            <span class="n">new_nug</span> <span class="o">=</span> <span class="n">org_nug</span> <span class="o">/</span> <span class="n">tot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">variograms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contribution</span> <span class="o">=</span> <span class="n">new_var</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">nugget</span> <span class="o">=</span> <span class="n">new_nug</span>

        <span class="n">gr_grps</span> <span class="o">=</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">add_transform_columns</span><span class="p">()</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>

        <span class="c1"># real and name containers</span>
        <span class="n">real_arrs</span><span class="p">,</span><span class="n">names</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="k">for</span> <span class="n">gr_grp</span> <span class="ow">in</span> <span class="n">gr_grps</span><span class="p">:</span>

            <span class="n">gp_df</span> <span class="o">=</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">gr_grp</span><span class="p">,:]</span>

            <span class="n">gp_par</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gp_df</span><span class="o">.</span><span class="n">parnme</span><span class="p">,:]</span>
            <span class="c1"># use the parval1 as the mean</span>
            <span class="n">mean_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dely</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">delx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">mean_arr</span><span class="p">[</span><span class="n">gp_df</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">gp_df</span><span class="o">.</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">gp_par</span><span class="o">.</span><span class="n">parval1</span>
            <span class="c1"># fill missing mean values</span>
            <span class="n">mean_arr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mean_arr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">gp_par</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="c1"># use the max upper and min lower (transformed) bounds for the variance</span>
            <span class="n">mx_ubnd</span> <span class="o">=</span> <span class="n">gp_par</span><span class="o">.</span><span class="n">parubnd_trans</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">mn_lbnd</span> <span class="o">=</span> <span class="n">gp_par</span><span class="o">.</span><span class="n">parlbnd_trans</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">var</span> <span class="o">=</span> <span class="p">((</span><span class="n">mx_ubnd</span> <span class="o">-</span> <span class="n">mn_lbnd</span><span class="p">)</span><span class="o">/</span><span class="n">sigma_range</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

            <span class="c1"># update the geostruct</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">variograms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contribution</span> <span class="o">=</span> <span class="n">var</span> <span class="o">*</span> <span class="n">new_var</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">nugget</span> <span class="o">=</span> <span class="n">var</span> <span class="o">*</span> <span class="n">new_nug</span>
            <span class="c1"># reinitialize and draw</span>
            <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;SpecSim: drawing </span><span class="si">{0}</span><span class="s2"> realization for group </span><span class="si">{1}</span><span class="s2"> with </span><span class="si">{4}</span><span class="s2"> pars, (log) variance </span><span class="si">{2}</span><span class="s2"> (sill </span><span class="si">{3}</span><span class="s2">)&quot;</span><span class="o">.</span>\
                  <span class="nb">format</span><span class="p">(</span><span class="n">num_reals</span><span class="p">,</span> <span class="n">gr_grp</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">sill</span><span class="p">,</span><span class="n">gp_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
            <span class="n">reals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_arrays</span><span class="p">(</span><span class="n">num_reals</span><span class="o">=</span><span class="n">num_reals</span><span class="p">,</span><span class="n">mean_value</span><span class="o">=</span><span class="n">mean_arr</span><span class="p">)</span>
            <span class="c1"># put the pieces into the par en</span>
            <span class="n">reals</span> <span class="o">=</span> <span class="n">reals</span><span class="p">[:,</span><span class="n">gp_df</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">gp_df</span><span class="o">.</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_reals</span><span class="p">,</span><span class="n">gp_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">real_arrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reals</span><span class="p">)</span>
            <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">gp_df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;SpecSim: drawing </span><span class="si">{0}</span><span class="s2"> realization for group </span><span class="si">{1}</span><span class="s2"> with </span><span class="si">{4}</span><span class="s2"> pars, (log) variance </span><span class="si">{2}</span><span class="s2"> (sill </span><span class="si">{3}</span><span class="s2">)&quot;</span><span class="o">.</span> \
                    <span class="nb">format</span><span class="p">(</span><span class="n">num_reals</span><span class="p">,</span> <span class="n">gr_grp</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">sill</span><span class="p">,</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># get into a dataframe</span>
        <span class="n">reals</span> <span class="o">=</span> <span class="n">real_arrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">real_arrs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">reals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reals</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">reals</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
        <span class="c1"># reset to org conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">nugget</span> <span class="o">=</span> <span class="n">org_nug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">variograms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contribution</span> <span class="o">=</span> <span class="n">org_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pe</span></div></div>


<div class="viewcode-block" id="OrdinaryKrige"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.OrdinaryKrige">[docs]</a><span class="k">class</span> <span class="nc">OrdinaryKrige</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Ordinary Kriging using Pandas and Numpy.</span>

<span class="sd">    Args:</span>
<span class="sd">        geostruct (`GeoStruct`): a pyemu.geostats.GeoStruct to use for the kriging</span>
<span class="sd">        point_data (`pandas.DataFrame`): the conditioning points to use for kriging.</span>
<span class="sd">            `point_data` must contain columns &quot;name&quot;, &quot;x&quot;, &quot;y&quot;.</span>

<span class="sd">    Note:</span>
<span class="sd">        if `point_data` is an `str`, then it is assumed to be a pilot points file</span>
<span class="sd">        and is loaded as such using `pyemu.pp_utils.pp_file_to_dataframe()`</span>

<span class="sd">        If zoned interpolation is used for grid-based interpolation, then</span>
<span class="sd">        `point_data` must also contain a &quot;zone&quot; column</span>


<span class="sd">    Example::</span>

<span class="sd">        import pyemu</span>
<span class="sd">        v = pyemu.utils.geostats.ExpVario(a=1000,contribution=1.0)</span>
<span class="sd">        gs = pyemu.utils.geostats.GeoStruct(variograms=v,nugget=0.5)</span>
<span class="sd">        pp_df = pyemu.pp_utils.pp_file_to_dataframe(&quot;hkpp.dat&quot;)</span>
<span class="sd">        ok = pyemu.utils.geostats.OrdinaryKrige(gs,pp_df)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">geostruct</span><span class="p">,</span><span class="n">point_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geostruct</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">geostruct</span> <span class="o">=</span> <span class="n">read_struct_file</span><span class="p">(</span><span class="n">geostruct</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geostruct</span><span class="p">,</span><span class="n">GeoStruct</span><span class="p">),</span><span class="s2">&quot;need a GeoStruct, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">geostruct</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span> <span class="o">=</span> <span class="n">geostruct</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_data</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">point_data</span> <span class="o">=</span> <span class="n">pp_file_to_dataframe</span><span class="p">(</span><span class="n">point_data</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_data</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">point_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="s2">&quot;point_data missing &#39;name&#39;&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">point_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;point_data missing &#39;x&#39;&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">point_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;point_data missing &#39;y&#39;&quot;</span>
        <span class="c1">#check for duplicates in point data</span>
        <span class="n">unique_name</span> <span class="o">=</span> <span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_name</span><span class="p">)</span> <span class="o">!=</span> <span class="n">point_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;duplicates detected in point_data..attempting to rectify&quot;</span><span class="p">,</span><span class="n">PyemuWarning</span><span class="p">)</span>
            <span class="n">ux_std</span> <span class="o">=</span> <span class="n">point_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ux_std</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;duplicate point_info entries with name </span><span class="si">{0}</span><span class="s2"> have different x values&quot;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uname</span><span class="p">))</span>
            <span class="n">uy_std</span> <span class="o">=</span> <span class="n">point_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">uy_std</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;duplicate point_info entries with name </span><span class="si">{0}</span><span class="s2"> have different y values&quot;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uname</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span> <span class="o">=</span> <span class="n">point_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span> <span class="o">=</span> <span class="n">point_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_point_data_dist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#X, Y = np.meshgrid(point_data.x,point_data.y)</span>
        <span class="c1">#self.point_data_dist = pd.DataFrame(data=np.sqrt((X - X.T) ** 2 + (Y - Y.T) ** 2),</span>
        <span class="c1">#                                    index=point_data.name,columns=point_data.name)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_cov_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="c1">#for name in self.point_cov_df.index:</span>
        <span class="c1">#    self.point_cov_df.loc[name,name] -= self.geostruct.nugget</span>

<div class="viewcode-block" id="OrdinaryKrige.check_point_data_dist"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.OrdinaryKrige.check_point_data_dist">[docs]</a>    <span class="k">def</span> <span class="nf">check_point_data_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rectify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; check for point_data entries that are closer than</span>
<span class="sd">        EPSILON distance - this will cause a singular kriging matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            rectify (`bool`): flag to fix the problems with point_data</span>
<span class="sd">                by dropping additional points that are</span>
<span class="sd">                closer than EPSILON distance.  Default is False</span>

<span class="sd">        Note:</span>
<span class="sd">            this method will issue warnings for points that are closer</span>
<span class="sd">            than EPSILON distance</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ptx_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span>
        <span class="n">pty_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span>
        <span class="n">ptnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span>
        <span class="n">drop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iname</span> <span class="o">=</span> <span class="n">ptx_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">pty_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ptnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">ptx_array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">pty_array</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">iy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ptnames</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">EPSILON</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">iname</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;points </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> are too close. This will cause a singular kriging matrix &quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="n">iname</span><span class="p">,</span><span class="n">dist</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">drop_idxs</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dist</span><span class="o">&lt;=</span><span class="n">EPSILON</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">drop</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">pt</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">drop_idxs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">rectify</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rectifying point data by removing the following points: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">drop</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop</span><span class="p">),:]</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></div>

    <span class="c1">#def prep_for_ppk2fac(self,struct_file=&quot;structure.dat&quot;,pp_file=&quot;points.dat&quot;,):</span>
    <span class="c1">#    pass</span>



<div class="viewcode-block" id="OrdinaryKrige.calc_factors_grid"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.OrdinaryKrige.calc_factors_grid">[docs]</a>    <span class="k">def</span> <span class="nf">calc_factors_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spatial_reference</span><span class="p">,</span><span class="n">zone_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">minpts_interp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">maxpts_interp</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">search_radius</span><span class="o">=</span><span class="mf">1.0e+10</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">var_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forgive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate kriging factors (weights) for a structured grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            spatial_reference (`flopy.utils.reference.SpatialReference`): a spatial</span>
<span class="sd">                reference that describes the orientation and</span>
<span class="sd">                spatail projection of the the structured grid</span>
<span class="sd">            zone_array (`numpy.ndarray`): an integer array of zones to use for kriging.</span>
<span class="sd">                If not None, then `point_data` must also contain a &quot;zone&quot; column.  `point_data`</span>
<span class="sd">                entries with a zone value not found in zone_array will be skipped.</span>
<span class="sd">                If None, then all `point_data` will (potentially) be used for</span>
<span class="sd">                interpolating each grid node. Default is None</span>
<span class="sd">            minpts_interp (`int`): minimum number of `point_data` entires to use for interpolation at</span>
<span class="sd">                a given grid node.  grid nodes with less than `minpts_interp`</span>
<span class="sd">                `point_data` found will be skipped (assigned np.NaN).  Defaut is 1</span>
<span class="sd">            maxpts_interp (`int`) maximum number of `point_data` entries to use for interpolation at</span>
<span class="sd">                a given grid node.  A larger `maxpts_interp` will yield &quot;smoother&quot;</span>
<span class="sd">                interplation, but using a large `maxpts_interp` will slow the</span>
<span class="sd">                (already) slow kriging solution process and may lead to</span>
<span class="sd">                memory errors. Default is 20.</span>
<span class="sd">            search_radius (`float`) the size of the region around a given grid node to search for</span>
<span class="sd">                `point_data` entries. Default is 1.0e+10</span>
<span class="sd">            verbose : (`bool`): a flag to  echo process to stdout during the interpolatino process.</span>
<span class="sd">                Default is False</span>
<span class="sd">            var_filename (`str`): a filename to save the kriging variance for each interpolated grid node.</span>
<span class="sd">                Default is None.</span>
<span class="sd">            forgive (`bool`):  flag to continue if inversion of the kriging matrix failes at one or more</span>
<span class="sd">                grid nodes.  Inversion usually fails if the kriging matrix is singular,</span>
<span class="sd">                resulting from `point_data` entries closer than EPSILON distance.  If True,</span>
<span class="sd">                warnings are issued for each failed inversion.  If False, an exception</span>
<span class="sd">                is raised for failed matrix inversion.</span>
<span class="sd">            num_threads (`int`): number of multiprocessing workers to use to try to speed up</span>
<span class="sd">                kriging in python.  Default is 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `pandas.DataFrame`: a dataframe with information summarizing the ordinary kriging</span>
<span class="sd">            process for each grid node</span>

<span class="sd">        Note:</span>
<span class="sd">            this method calls OrdinaryKrige.calc_factors()</span>

<span class="sd">            this method is the main entry point for grid-based kriging factor generation</span>


<span class="sd">        Example::</span>

<span class="sd">            import flopy</span>

<span class="sd">            import pyemu</span>
<span class="sd">            v = pyemu.utils.geostats.ExpVario(a=1000,contribution=1.0)</span>
<span class="sd">            gs = pyemu.utils.geostats.GeoStruct(variograms=v,nugget=0.5)</span>
<span class="sd">            pp_df = pyemu.pp_utils.pp_file_to_dataframe(&quot;hkpp.dat&quot;)</span>
<span class="sd">            ok = pyemu.utils.geostats.OrdinaryKrige(gs,pp_df)</span>
<span class="sd">            m = flopy.modflow.Modflow.load(&quot;mymodel.nam&quot;)</span>
<span class="sd">            df = ok.calc_factors_grid(m.sr,zone_array=m.bas6.ibound[0].array,</span>
<span class="sd">                                      var_filename=&quot;ok_var.dat&quot;)</span>
<span class="sd">            ok.to_grid_factor_file(&quot;factors.dat&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span> <span class="o">=</span> <span class="n">spatial_reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#assert isinstance(spatial_reference,SpatialReference)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">xcentergrid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">ycentergrid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;spatial_reference does not have proper attributes:</span><span class="si">{0}</span><span class="s2">&quot;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">var_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1.0e+30</span>

        <span class="c1"># the simple case of no zone array: ignore point_data zones</span>
        <span class="k">if</span> <span class="n">zone_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_factors</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                               <span class="n">minpts_interp</span><span class="o">=</span><span class="n">minpts_interp</span><span class="p">,</span>
                               <span class="n">maxpts_interp</span><span class="o">=</span><span class="n">maxpts_interp</span><span class="p">,</span>
                               <span class="n">search_radius</span><span class="o">=</span><span class="n">search_radius</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">forgive</span><span class="o">=</span><span class="n">forgive</span><span class="p">,</span>
                               <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">var_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">err_var</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">var_filename</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">zone_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">zone_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="s2">&quot;zone&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;zone&#39; columns not in point_data, assigning generic zone&quot;</span><span class="p">,</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">pt_data_zones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pt_data_zone</span> <span class="ow">in</span> <span class="n">pt_data_zones</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pt_data_zone</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zone_array</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pt zone </span><span class="si">{0}</span><span class="s2"> not in zone array </span><span class="si">{1}</span><span class="s2">, skipping&quot;</span><span class="o">.</span>\
                                  <span class="nb">format</span><span class="p">(</span><span class="n">pt_data_zone</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">zone_array</span><span class="p">)),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">xzone</span><span class="p">,</span><span class="n">yzone</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">xzone</span><span class="p">[</span><span class="n">zone_array</span><span class="o">!=</span><span class="n">pt_data_zone</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">yzone</span><span class="p">[</span><span class="n">zone_array</span><span class="o">!=</span><span class="n">pt_data_zone</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_factors</span><span class="p">(</span><span class="n">xzone</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">yzone</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                       <span class="n">minpts_interp</span><span class="o">=</span><span class="n">minpts_interp</span><span class="p">,</span>
                                       <span class="n">maxpts_interp</span><span class="o">=</span><span class="n">maxpts_interp</span><span class="p">,</span>
                                       <span class="n">search_radius</span><span class="o">=</span><span class="n">search_radius</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span><span class="n">pt_zone</span><span class="o">=</span><span class="n">pt_data_zone</span><span class="p">,</span>
                                       <span class="n">forgive</span><span class="o">=</span><span class="n">forgive</span><span class="p">,</span><span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">)</span>

                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">err_var</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">na_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">arr</span><span class="p">[</span><span class="n">na_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">na_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no interpolation took place...something is wrong&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">var_filename</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

    <span class="k">def</span> <span class="nf">_dist_calcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">ptx_array</span><span class="p">,</span> <span class="n">pty_array</span><span class="p">,</span> <span class="n">ptnames</span><span class="p">,</span> <span class="n">sqradius</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;private: find nearby points&quot;&quot;&quot;</span>
        <span class="c1">#  calc dist from this interp point to all point data...slow</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">ptx_array</span> <span class="o">-</span> <span class="n">ix</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">pty_array</span> <span class="o">-</span> <span class="n">iy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ptnames</span><span class="p">)</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">sqradius</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dist</span>

    <span class="k">def</span> <span class="nf">_cov_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">pt_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;private: get covariance between points&quot;&quot;&quot;</span>
        <span class="n">interp_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">covariance_points</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_names</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_names</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">interp_cov</span>

    <span class="k">def</span> <span class="nf">_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pt_names</span><span class="p">,</span> <span class="n">point_cov</span><span class="p">,</span> <span class="n">interp_cov</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;private: form the kriging equations&quot;&quot;&quot;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pt_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># +1 for lagrange mult</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
        <span class="n">A</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_cov</span><span class="o">.</span><span class="n">values</span>
        <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># unbiaised constraint</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">rhs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_cov</span>
        <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">rhs</span>

    <span class="k">def</span> <span class="nf">_solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>



<div class="viewcode-block" id="OrdinaryKrige.calc_factors"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.OrdinaryKrige.calc_factors">[docs]</a>    <span class="k">def</span> <span class="nf">calc_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">minpts_interp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">maxpts_interp</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                     <span class="n">search_radius</span><span class="o">=</span><span class="mf">1.0e+10</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">pt_zone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">forgive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; calculate ordinary kriging factors (weights) for the points</span>
<span class="sd">        represented by arguments x and y</span>

<span class="sd">        Args:</span>
<span class="sd">            x ([`float`]):  x-coordinates to calculate kriging factors for</span>
<span class="sd">            y (([`float`]): y-coordinates to calculate kriging factors for</span>
<span class="sd">            minpts_interp (`int`): minimum number of point_data entires to use for interpolation at</span>
<span class="sd">                a given x,y interplation point.  interpolation points with less</span>
<span class="sd">                than `minpts_interp` `point_data` found will be skipped</span>
<span class="sd">                (assigned np.NaN).  Defaut is 1</span>
<span class="sd">            maxpts_interp (`int`): maximum number of point_data entries to use for interpolation at</span>
<span class="sd">                a given x,y interpolation point.  A larger `maxpts_interp` will</span>
<span class="sd">                yield &quot;smoother&quot; interplation, but using a large `maxpts_interp`</span>
<span class="sd">                will slow the (already) slow kriging solution process and may</span>
<span class="sd">                lead to memory errors. Default is 20.</span>
<span class="sd">            search_radius (`float`): the size of the region around a given x,y</span>
<span class="sd">                interpolation point to search for `point_data` entries. Default is 1.0e+10</span>
<span class="sd">            verbose (`bool`): a flag to  echo process to stdout during the interpolatino process.</span>
<span class="sd">                Default is False</span>
<span class="sd">            forgive (`bool`): flag to continue if inversion of the kriging matrix failes at one or more</span>
<span class="sd">                interpolation points.  Inversion usually fails if the kriging matrix is singular,</span>
<span class="sd">                resulting from `point_data` entries closer than EPSILON distance.  If True,</span>
<span class="sd">                warnings are issued for each failed inversion.  If False, an exception</span>
<span class="sd">                is raised for failed matrix inversion.</span>
<span class="sd">            num_threads (`int`): number of multiprocessing workers to use to try to speed up</span>
<span class="sd">                kriging in python.  Default is 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `pandas.DataFrame`: a dataframe with information summarizing the ordinary kriging</span>
<span class="sd">            process for each interpolation points</span>

<span class="sd">        Note:</span>
<span class="sd">            this method calls either `OrdinaryKrige.calc_factors_org()` or</span>
<span class="sd">            `OrdinaryKrige.calc_factors_mp()` depending on the value of `num_threads`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">num_threads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_factors_org</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">minpts_interp</span><span class="p">,</span><span class="n">maxpts_interp</span><span class="p">,</span>
                                         <span class="n">search_radius</span><span class="p">,</span><span class="n">verbose</span><span class="p">,</span><span class="n">pt_zone</span><span class="p">,</span>
                                         <span class="n">forgive</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_factors_mp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">minpts_interp</span><span class="p">,</span><span class="n">maxpts_interp</span><span class="p">,</span>
                                         <span class="n">search_radius</span><span class="p">,</span><span class="n">verbose</span><span class="p">,</span><span class="n">pt_zone</span><span class="p">,</span>
                                         <span class="n">forgive</span><span class="p">,</span> <span class="n">num_threads</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_calc_factors_org</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">minpts_interp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">maxpts_interp</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                     <span class="n">search_radius</span><span class="o">=</span><span class="mf">1.0e+10</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">pt_zone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">forgive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="c1"># find the point data to use for each interp point</span>
        <span class="n">sqradius</span> <span class="o">=</span> <span class="n">search_radius</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="n">y</span><span class="p">})</span>
        <span class="n">inames</span><span class="p">,</span><span class="n">idist</span><span class="p">,</span><span class="n">ifacts</span><span class="p">,</span><span class="n">err_var</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
        <span class="n">sill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">sill</span>
        <span class="k">if</span> <span class="n">pt_zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ptx_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span>
            <span class="n">pty_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ptnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span>
            <span class="n">ptx_array</span> <span class="o">=</span> <span class="n">pt_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_data</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">pt_zone</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">pty_array</span> <span class="o">=</span> <span class="n">pt_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_data</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">pt_zone</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ptnames</span> <span class="o">=</span> <span class="n">pt_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_data</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">pt_zone</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1">#if verbose:</span>



        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting interp point loop for </span><span class="si">{0}</span><span class="s2"> points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">start_loop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">iy</span><span class="p">):</span> <span class="c1">#if nans, skip</span>
                <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing interp point:</span><span class="si">{0}</span><span class="s2"> of </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     start = datetime.now()</span>
            <span class="c1">#     print(&quot;calc ipoint dist...&quot;,end=&#39;&#39;)</span>

            <span class="c1">#  calc dist from this interp point to all point data...slow</span>
            <span class="c1">#dist = pd.Series((ptx_array-ix)**2 + (pty_array-iy)**2,ptnames)</span>
            <span class="c1">#dist.sort_values(inplace=True)</span>
            <span class="c1">#dist = dist.loc[dist &lt;= sqradius]</span>
            <span class="c1">#def _dist_calcs(self, ix, iy, ptx_array, pty_array, ptnames, sqradius):</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dist_calcs</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span> <span class="n">ptx_array</span><span class="p">,</span> <span class="n">pty_array</span><span class="p">,</span> <span class="n">ptnames</span><span class="p">,</span> <span class="n">sqradius</span><span class="p">)</span>

            <span class="c1"># if too few points were found, skip</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minpts_interp</span><span class="p">:</span>
                <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sill</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># only the maxpts_interp points</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">maxpts_interp</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>
            <span class="n">pt_names</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># if one of the points is super close, just use it and skip</span>
            <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">EPSILON</span><span class="p">:</span>
                <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
                <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">EPSILON</span><span class="p">])</span>
                <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dist</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()])</span>
                <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">nugget</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     td = (datetime.now()-start).total_seconds()</span>
            <span class="c1">#     print(&quot;...took {0}&quot;.format(td))</span>
            <span class="c1">#     start = datetime.now()</span>
            <span class="c1">#     print(&quot;extracting pt cov...&quot;,end=&#39;&#39;)</span>

            <span class="c1">#vextract the point-to-point covariance matrix</span>
            <span class="n">point_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_cov_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_names</span><span class="p">,</span><span class="n">pt_names</span><span class="p">]</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     td = (datetime.now()-start).total_seconds()</span>
            <span class="c1">#     print(&quot;...took {0}&quot;.format(td))</span>
            <span class="c1">#     print(&quot;forming ipt-to-point cov...&quot;,end=&#39;&#39;)</span>

            <span class="c1"># calc the interp point to points covariance</span>
            <span class="c1"># interp_cov = self.geostruct.covariance_points(ix,iy,self.point_data.loc[pt_names,&quot;x&quot;],</span>
            <span class="c1">#                                               self.point_data.loc[pt_names,&quot;y&quot;])</span>
            <span class="n">interp_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov_points</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">pt_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...took </span><span class="si">{0}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">td</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;forming lin alg components...&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># form the linear algebra parts and solve</span>
            <span class="c1"># d = len(pt_names) + 1 # +1 for lagrange mult</span>
            <span class="c1"># A = np.ones((d,d))</span>
            <span class="c1"># A[:-1,:-1] = point_cov.values</span>
            <span class="c1"># A[-1,-1] = 0.0 #unbiaised constraint</span>
            <span class="c1"># rhs = np.ones((d,1))</span>
            <span class="c1"># rhs[:-1,0] = interp_cov</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form</span><span class="p">(</span><span class="n">pt_names</span><span class="p">,</span><span class="n">point_cov</span><span class="p">,</span><span class="n">interp_cov</span><span class="p">)</span>

            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     td = (datetime.now()-start).total_seconds()</span>
            <span class="c1">#     print(&quot;...took {0}&quot;.format(td))</span>
            <span class="c1">#     print(&quot;solving...&quot;,end=&#39;&#39;)</span>
            <span class="c1"># # solve</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">facs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error solving for factors: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;point:&quot;</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dist:&quot;</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A:&quot;</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rhs:&quot;</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">forgive</span><span class="p">:</span>
                    <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error solving for factors:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">facs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

            <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sill</span> <span class="o">+</span> <span class="n">facs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="n">f</span><span class="o">*</span><span class="n">c</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">facs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">interp_cov</span><span class="p">)])))</span>
            <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt_names</span><span class="p">)</span>

            <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">facs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     td = (datetime.now()-start).total_seconds()</span>
            <span class="c1">#     print(&quot;...took {0}&quot;.format(td))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">istart</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;point took </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">td</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;idist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idist</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;inames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inames</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ifacts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifacts</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;err_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err_var</span>
        <span class="k">if</span> <span class="n">pt_zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_loop</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;took </span><span class="si">{0}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">td</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span>


    <span class="k">def</span> <span class="nf">_calc_factors_mp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">minpts_interp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">maxpts_interp</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                     <span class="n">search_radius</span><span class="o">=</span><span class="mf">1.0e+10</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">pt_zone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">forgive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">start_loop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting interp point loop for </span><span class="si">{0}</span><span class="s2"> points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>

            <span class="n">point_pairs</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
            <span class="n">idist</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
            <span class="n">inames</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
            <span class="n">ifacts</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
            <span class="n">err_var</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
            <span class="c1">#start = mp.Value(&#39;d&#39;,0)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
                <span class="n">point_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">))</span>
                <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
            <span class="n">procs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_threads</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">OrdinaryKrige</span><span class="o">.</span><span class="n">_worker</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="p">,</span><span class="n">point_pairs</span><span class="p">,</span><span class="n">inames</span><span class="p">,</span><span class="n">idist</span><span class="p">,</span><span class="n">ifacts</span><span class="p">,</span><span class="n">err_var</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">point_cov_df</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="p">,</span><span class="n">EPSILON</span><span class="p">,</span><span class="n">search_radius</span><span class="p">,</span>
                                                                 <span class="n">pt_zone</span><span class="p">,</span><span class="n">minpts_interp</span><span class="p">,</span><span class="n">maxpts_interp</span><span class="p">,</span><span class="n">lock</span><span class="p">))</span>
                <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;idist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idist</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;inames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inames</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ifacts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifacts</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;err_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err_var</span>
        <span class="k">if</span> <span class="n">pt_zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_loop</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;took </span><span class="si">{0}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">td</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_worker</span><span class="p">(</span><span class="n">ithread</span><span class="p">,</span><span class="n">point_data</span><span class="p">,</span><span class="n">point_pairs</span><span class="p">,</span><span class="n">inames</span><span class="p">,</span><span class="n">idist</span><span class="p">,</span><span class="n">ifacts</span><span class="p">,</span><span class="n">err_var</span><span class="p">,</span><span class="n">point_cov_df</span><span class="p">,</span>
               <span class="n">geostruct</span><span class="p">,</span><span class="n">epsilon</span><span class="p">,</span><span class="n">search_radius</span><span class="p">,</span><span class="n">pt_zone</span><span class="p">,</span><span class="n">minpts_interp</span><span class="p">,</span><span class="n">maxpts_interp</span><span class="p">,</span><span class="n">lock</span><span class="p">):</span>
        <span class="c1"># find the point data to use for each interp point</span>
        <span class="n">sqradius</span> <span class="o">=</span> <span class="n">search_radius</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">sill</span> <span class="o">=</span> <span class="n">geostruct</span><span class="o">.</span><span class="n">sill</span>
        <span class="k">if</span> <span class="n">pt_zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ptx_array</span> <span class="o">=</span> <span class="n">point_data</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span>
            <span class="n">pty_array</span> <span class="o">=</span> <span class="n">point_data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ptnames</span> <span class="o">=</span> <span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span>
            <span class="n">ptx_array</span> <span class="o">=</span> <span class="n">pt_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_data</span><span class="o">.</span><span class="n">zone</span> <span class="o">==</span> <span class="n">pt_zone</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">pty_array</span> <span class="o">=</span> <span class="n">pt_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_data</span><span class="o">.</span><span class="n">zone</span> <span class="o">==</span> <span class="n">pt_zone</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ptnames</span> <span class="o">=</span> <span class="n">pt_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_data</span><span class="o">.</span><span class="n">zone</span> <span class="o">==</span> <span class="n">pt_zone</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_pairs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">idx</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span><span class="n">iy</span> <span class="o">=</span> <span class="n">point_pairs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">return</span>

            <span class="c1">#if idx % 1000 == 0 and idx != 0:</span>
            <span class="c1">#    print (ithread, idx,&quot;done&quot;,datetime.now())</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">iy</span><span class="p">):</span> <span class="c1">#if nans, skip</span>
                <span class="c1">#inames.append([])</span>
                <span class="c1">#idist.append([])</span>
                <span class="c1">#ifacts.append([])</span>
                <span class="c1">#err_var.append(np.NaN)</span>
                <span class="c1">#err_var.insert(idx,np.NaN)</span>
                <span class="k">continue</span>

            <span class="c1">#  calc dist from this interp point to all point data...slow</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">ptx_array</span><span class="o">-</span><span class="n">ix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">pty_array</span><span class="o">-</span><span class="n">iy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">ptnames</span><span class="p">)</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">sqradius</span><span class="p">]</span>

            <span class="c1"># if too few points were found, skip</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minpts_interp</span><span class="p">:</span>
                <span class="c1">#inames.append([])</span>
                <span class="c1">#idist.append([])</span>
                <span class="c1">#ifacts.append([])</span>
                <span class="c1">#err_var.append(sill)</span>
                <span class="n">err_var</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sill</span>
                <span class="k">continue</span>

            <span class="c1"># only the maxpts_interp points</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">maxpts_interp</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>
            <span class="n">pt_names</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># if one of the points is super close, just use it and skip</span>
            <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="c1">#ifacts.append([1.0])</span>
                <span class="n">ifacts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
                <span class="c1">#idist.append([epsilon])</span>
                <span class="n">idist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">epsilon</span><span class="p">]</span>
                <span class="c1">#inames.append([dist.idxmin()])</span>
                <span class="n">inames</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()]</span>
                <span class="c1">#err_var.append(geostruct.nugget)</span>
                <span class="n">err_var</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">geostruct</span><span class="o">.</span><span class="n">nugget</span>
                <span class="k">continue</span>

            <span class="c1">#vextract the point-to-point covariance matrix</span>
            <span class="n">point_cov</span> <span class="o">=</span> <span class="n">point_cov_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_names</span><span class="p">,</span><span class="n">pt_names</span><span class="p">]</span>

            <span class="c1"># calc the interp point to points covariance</span>
            <span class="n">interp_cov</span> <span class="o">=</span> <span class="n">geostruct</span><span class="o">.</span><span class="n">covariance_points</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">point_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_names</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
                                                          <span class="n">point_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_names</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>

            <span class="c1"># form the linear algebra parts and solve</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pt_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># +1 for lagrange mult</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">d</span><span class="p">,</span><span class="n">d</span><span class="p">))</span>
            <span class="n">A</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_cov</span><span class="o">.</span><span class="n">values</span>
            <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#unbiaised constraint</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">d</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">rhs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_cov</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">facs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error solving for factors: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;point:&quot;</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dist:&quot;</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A:&quot;</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;rhs:&quot;</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

                <span class="c1">#inames.append([])</span>
                <span class="c1">#idist.append([])</span>
                <span class="c1">#ifacts.append([])</span>
                <span class="c1">#err_var.append(np.NaN)</span>
                <span class="c1">#err_var.insert(np.NaN)</span>
                <span class="k">continue</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">facs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

            <span class="c1">#err_var.append(float(sill + facs[-1] - sum([f*c for f,c in zip(facs[:-1],interp_cov)])))</span>
            <span class="n">err_var</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sill</span> <span class="o">+</span> <span class="n">facs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="n">f</span><span class="o">*</span><span class="n">c</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">facs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">interp_cov</span><span class="p">)]))</span>
            <span class="c1">#inames.append(pt_names)</span>
            <span class="n">inames</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt_names</span>

            <span class="c1">#idist.append(dist.values)</span>
            <span class="n">idist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">values</span>

            <span class="c1">#ifacts.append(facs[:-1,0])</span>
            <span class="n">ifacts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">facs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     td = (datetime.now()-start).total_seconds()</span>
            <span class="c1">#     print(&quot;...took {0}&quot;.format(td))</span>




<div class="viewcode-block" id="OrdinaryKrige.to_grid_factors_file"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.OrdinaryKrige.to_grid_factors_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_grid_factors_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span><span class="n">points_file</span><span class="o">=</span><span class="s2">&quot;points.junk&quot;</span><span class="p">,</span>
                             <span class="n">zone_file</span><span class="o">=</span><span class="s2">&quot;zone.junk&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a grid-based PEST-style factors file.  This file can be used with</span>
<span class="sd">        the fac2real() method to write an interpolated structured array</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (`str`): factor filename</span>
<span class="sd">            points_file (`str`): points filename to add to the header of the factors file.</span>
<span class="sd">                This is not used by the fac2real() method.  Default is &quot;points.junk&quot;</span>
<span class="sd">            zone_file (`str`): zone filename to add to the header of the factors file.</span>
<span class="sd">                This is notused by the fac2real() method.  Default is &quot;zone.junk&quot;</span>

<span class="sd">        Note:</span>
<span class="sd">            this method should be called after OrdinaryKirge.calc_factors_grid()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ok.interp_data is None, must call calc_factors_grid() first&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ok.spatial_reference is None, must call calc_factors_grid() first&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">points_file</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zone_file</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">ncol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">nrow</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">transform</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">pt_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">facts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">inames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">ifacts</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">facts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">n_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{3:8.5e}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">))</span>
                <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1:12.8g}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">n_idxs</span><span class="p">,</span> <span class="n">facts</span><span class="p">)]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Vario2d"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.Vario2d">[docs]</a><span class="k">class</span> <span class="nc">Vario2d</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;base class for 2-D variograms.</span>

<span class="sd">    Args:</span>
<span class="sd">        contribution (float): sill of the variogram</span>
<span class="sd">        a (`float`): (practical) range of correlation</span>
<span class="sd">        anisotropy (`float`, optional): Anisotropy ratio. Default is 1.0</span>
<span class="sd">        bearing : (`float`, optional): angle in degrees East of North corresponding</span>
<span class="sd">            to anisotropy ellipse. Default is 0.0</span>
<span class="sd">        name (`str`, optinoal): name of the variogram.  Default is &quot;var1&quot;</span>

<span class="sd">    Note:</span>
<span class="sd">        This base class should not be instantiated directly as it does not implement</span>
<span class="sd">        an h_function() method.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;var1&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">EPSILON</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contribution</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">anisotropy</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bearing</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bearing</span><span class="p">)</span>

<div class="viewcode-block" id="Vario2d.to_struct_file"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.Vario2d.to_struct_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_struct_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write the `Vario2d` to a PEST-style structure file</span>

<span class="sd">        Args:</span>
<span class="sd">            f (`str`): filename to write to.  `f` can also be an open</span>
<span class="sd">                file handle.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;VARIOGRAM </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  VARTYPE </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vartype</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  A </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  ANISOTROPY </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  BEARING </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END VARIOGRAM</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bearing_rads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the bearing of the Vario2d in radians</span>

<span class="sd">        Returns:</span>
<span class="sd">            `float`: the Vario2d bearing in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">90.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bearing</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rotation_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the rotation coefficents in radians</span>

<span class="sd">        Returns:</span>
<span class="sd">            [`float`]: the rotation coefficients implied by `Vario2d.bearing`</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing_rads</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing_rads</span><span class="p">),</span>
                <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing_rads</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing_rads</span><span class="p">)]</span>

<div class="viewcode-block" id="Vario2d.inv_h"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.Vario2d.inv_h">[docs]</a>    <span class="k">def</span> <span class="nf">inv_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; the inverse of the h_function.  Used for plotting</span>

<span class="sd">        Args:</span>
<span class="sd">            h (`float`): the value of h_function to invert</span>

<span class="sd">        Returns:</span>
<span class="sd">            `float`: the inverse of h</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_function</span><span class="p">(</span><span class="n">h</span><span class="p">)</span></div>

<div class="viewcode-block" id="Vario2d.plot"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.Vario2d.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get a cheap plot of the Vario2d</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs (`dict`): keyword arguments to use for plotting</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib.pyplot.axis`</span>

<span class="sd">        Note:</span>
<span class="sd">            optional arguments in kwargs include</span>
<span class="sd">            &quot;ax&quot; (existing `matplotlib.pyplot.axis`).  Other</span>
<span class="sd">            kwargs are passed to `matplotlib.pyplot.plot()`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error importing matplotlib: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ax&quot;</span><span class="p">,</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\gamma$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Vario2d.covariance_matrix"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.Vario2d.covariance_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cov</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;build a pyemu.Cov instance implied by Vario2d</span>

<span class="sd">        Args:</span>
<span class="sd">            x ([`float`]): x-coordinate locations</span>
<span class="sd">            y ([`float`]): y-coordinate locations</span>
<span class="sd">            names ([`str`]): names of locations. If None, cov must not be None</span>
<span class="sd">            cov (`pyemu.Cov`): an existing Cov instance.  Vario2d contribution is added to cov</span>
<span class="sd">            in place</span>

<span class="sd">        Returns:</span>
<span class="sd">            `pyemu.Cov`: the covariance matrix for `x`, `y` implied by `Vario2d`</span>

<span class="sd">        Note:</span>
<span class="sd">            either `names` or `cov` must not be None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contribution</span><span class="p">)</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">row_names</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span><span class="n">isdiagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cov</span> <span class="o">+=</span> <span class="n">cont</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Vario2d.covariance_matrix() requires either&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;names or cov arg&quot;</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_coefs</span>
        <span class="k">for</span> <span class="n">i1</span><span class="p">,(</span><span class="n">n1</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)):</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">dxx</span><span class="p">,</span><span class="n">dyy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rotation</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dxx</span><span class="o">*</span><span class="n">dxx</span> <span class="o">+</span> <span class="n">dyy</span><span class="o">*</span><span class="n">dyy</span><span class="p">)</span>

            <span class="n">h</span><span class="p">[</span><span class="n">h</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_function</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;nans in h for i1 </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i1</span><span class="p">))</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">h</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">cov</span></div>

    <span class="k">def</span> <span class="nf">_specsim_grid_contrib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">grid</span><span class="p">):</span>
        <span class="n">rot_grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bearing</span> <span class="o">%</span> <span class="mf">90.</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dx</span><span class="p">,</span><span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rotation</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:],</span><span class="n">grid</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:])</span>
            <span class="n">rot_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">))</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">((</span><span class="n">rot_grid</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_function</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">_apply_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; private method to rotate points</span>
<span class="sd">        according to Vario2d.bearing and Vario2d.anisotropy</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dx</span><span class="p">,</span><span class="n">dy</span>
        <span class="n">rcoefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_coefs</span>
        <span class="n">dxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">rcoefs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>\
             <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">rcoefs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dyy</span> <span class="o">=</span> <span class="p">((</span><span class="n">dx</span> <span class="o">*</span> <span class="n">rcoefs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>\
             <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">rcoefs</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">*</span>\
             <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span>
        <span class="k">return</span> <span class="n">dxx</span><span class="p">,</span><span class="n">dyy</span>

<div class="viewcode-block" id="Vario2d.covariance_points"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.Vario2d.covariance_points">[docs]</a>    <span class="k">def</span> <span class="nf">covariance_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">xother</span><span class="p">,</span><span class="n">yother</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the covariance between base point (x0,y0) and</span>
<span class="sd">        other points xother,yother implied by `Vario2d`</span>

<span class="sd">        Args:</span>
<span class="sd">            x0 (`float`): x-coordinate</span>
<span class="sd">            y0 (`float`): y-coordinate</span>
<span class="sd">            xother ([`float`]): x-coordinates of other points</span>
<span class="sd">            yother ([`float`]): y-coordinates of other points</span>

<span class="sd">        Returns:</span>
<span class="sd">            `numpy.ndarray`: a 1-D array of covariance between point x0,y0 and the</span>
<span class="sd">            points contained in xother, yother.  len(cov) = len(xother) =</span>
<span class="sd">            len(yother)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dxx</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">xother</span>
        <span class="n">dyy</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">yother</span>
        <span class="n">dxx</span><span class="p">,</span><span class="n">dyy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rotation</span><span class="p">(</span><span class="n">dxx</span><span class="p">,</span><span class="n">dyy</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dxx</span><span class="o">*</span><span class="n">dxx</span> <span class="o">+</span> <span class="n">dyy</span><span class="o">*</span><span class="n">dyy</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_function</span><span class="p">(</span><span class="n">h</span><span class="p">)</span></div>

<div class="viewcode-block" id="Vario2d.covariance"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.Vario2d.covariance">[docs]</a>    <span class="k">def</span> <span class="nf">covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pt0</span><span class="p">,</span><span class="n">pt1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the covarince between two points implied by Vario2d</span>

<span class="sd">        Args:</span>
<span class="sd">            pt0 : ([`float`]): first point x and y</span>
<span class="sd">            pt1 : ([`float`]): second point x and y</span>

<span class="sd">        Returns:</span>
<span class="sd">            `float`: covariance between pt0 and pt1</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pt0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pt0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pt1</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">,</span><span class="s2">&quot;n2&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the str representation of Vario2d</span>

<span class="sd">        Returns:</span>
<span class="sd">            `str`: string rep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;name:</span><span class="si">{0}</span><span class="s2">,contribution:</span><span class="si">{1}</span><span class="s2">,a:</span><span class="si">{2}</span><span class="s2">,anisotropy:</span><span class="si">{3}</span><span class="s2">,bearing:</span><span class="si">{4}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contribution</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>\
                   <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="ExpVario"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.ExpVario">[docs]</a><span class="k">class</span> <span class="nc">ExpVario</span><span class="p">(</span><span class="n">Vario2d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gaussian variogram derived type</span>

<span class="sd">    Args:</span>
<span class="sd">        contribution (float): sill of the variogram</span>
<span class="sd">        a (`float`): (practical) range of correlation</span>
<span class="sd">        anisotropy (`float`, optional): Anisotropy ratio. Default is 1.0</span>
<span class="sd">        bearing : (`float`, optional): angle in degrees East of North corresponding</span>
<span class="sd">            to anisotropy ellipse. Default is 0.0</span>
<span class="sd">        name (`str`, optinoal): name of the variogram.  Default is &quot;var1&quot;</span>

<span class="sd">    Example::</span>

<span class="sd">        v = pyemu.utils.geostats.ExpVario(a=1000,contribution=1.0)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;var1&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ExpVario</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="n">anisotropy</span><span class="p">,</span>
                                      <span class="n">bearing</span><span class="o">=</span><span class="n">bearing</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vartype</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_h_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; private method exponential variogram &quot;h&quot; function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span></div>

<div class="viewcode-block" id="GauVario"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.GauVario">[docs]</a><span class="k">class</span> <span class="nc">GauVario</span><span class="p">(</span><span class="n">Vario2d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gaussian variogram derived type</span>

<span class="sd">    Args:</span>
<span class="sd">        contribution (float): sill of the variogram</span>
<span class="sd">        a (`float`): (practical) range of correlation</span>
<span class="sd">        anisotropy (`float`, optional): Anisotropy ratio. Default is 1.0</span>
<span class="sd">        bearing : (`float`, optional): angle in degrees East of North corresponding</span>
<span class="sd">            to anisotropy ellipse. Default is 0.0</span>
<span class="sd">        name (`str`, optinoal): name of the variogram.  Default is &quot;var1&quot;</span>

<span class="sd">    Example::</span>

<span class="sd">        v = pyemu.utils.geostats.GauVario(a=1000,contribution=1.0)</span>

<span class="sd">    Note:</span>
<span class="sd">        the Gaussian variogram can be unstable (not invertible) for long ranges.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;var1&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GauVario</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="n">anisotropy</span><span class="p">,</span>
                                      <span class="n">bearing</span><span class="o">=</span><span class="n">bearing</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vartype</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">_h_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; private method for the gaussian variogram &quot;h&quot; function</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hh</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span></div>

<div class="viewcode-block" id="SphVario"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.SphVario">[docs]</a><span class="k">class</span> <span class="nc">SphVario</span><span class="p">(</span><span class="n">Vario2d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Spherical variogram derived type</span>

<span class="sd">   Args:</span>
<span class="sd">        contribution (float): sill of the variogram</span>
<span class="sd">        a (`float`): (practical) range of correlation</span>
<span class="sd">        anisotropy (`float`, optional): Anisotropy ratio. Default is 1.0</span>
<span class="sd">        bearing : (`float`, optional): angle in degrees East of North corresponding</span>
<span class="sd">            to anisotropy ellipse. Default is 0.0</span>
<span class="sd">        name (`str`, optinoal): name of the variogram.  Default is &quot;var1&quot;</span>

<span class="sd">    Example::</span>

<span class="sd">        v = pyemu.utils.geostats.SphVario(a=1000,contribution=1.0)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;var1&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SphVario</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="n">anisotropy</span><span class="p">,</span>
                                      <span class="n">bearing</span><span class="o">=</span><span class="n">bearing</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vartype</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_h_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; private method for the spherical variogram &quot;h&quot; function</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hh</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">hh</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">hh</span> <span class="o">*</span> <span class="n">hh</span><span class="p">))))</span>
        <span class="n">h</span><span class="p">[</span><span class="n">hh</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">h</span></div>
        <span class="c1"># try:</span>
        <span class="c1">#     h[hh &lt; 1.0] = 0.0</span>
        <span class="c1">#</span>
        <span class="c1"># except TypeError:</span>
        <span class="c1">#     if hh &gt; 0.0:</span>
        <span class="c1">#         h = 0.0</span>
        <span class="c1">#return h</span>
        <span class="c1"># if hh &lt; 1.0:</span>
        <span class="c1">#     return self.contribution * (1.0 - (hh * (1.5 - (0.5 * hh * hh))))</span>
        <span class="c1"># else:</span>
        <span class="c1">#     return 0.0</span>





<div class="viewcode-block" id="read_struct_file"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.read_struct_file">[docs]</a><span class="k">def</span> <span class="nf">read_struct_file</span><span class="p">(</span><span class="n">struct_file</span><span class="p">,</span><span class="n">return_type</span><span class="o">=</span><span class="n">GeoStruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read an existing PEST-type structure file into a GeoStruct instance</span>

<span class="sd">    Args:</span>
<span class="sd">        struct_file (`str`): existing pest-type structure file</span>
<span class="sd">        return_type (`object`): the instance type to return.  Default is GeoStruct</span>

<span class="sd">    Returns:</span>
<span class="sd">        [`pyemu.GeoStruct`]: list of `GeoStruct` instances.  If</span>
<span class="sd">        only one `GeoStruct` is in the file, then a `GeoStruct` is returned</span>


<span class="sd">    Example::</span>

<span class="sd">        gs = pyemu.utils.geostats.reads_struct_file(&quot;struct.dat&quot;)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">VARTYPE</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="n">SphVario</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="n">ExpVario</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="n">GauVario</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">struct_file</span><span class="p">)</span>
    <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">variograms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">struct_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">nugget</span><span class="p">,</span><span class="n">transform</span><span class="p">,</span><span class="n">variogram_info</span> <span class="o">=</span> <span class="n">_read_structure_attributes</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">return_type</span><span class="p">(</span><span class="n">nugget</span><span class="o">=</span><span class="n">nugget</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">variogram_info</span> <span class="o">=</span> <span class="n">variogram_info</span>
                <span class="c1"># not sure what is going on, but if I don&#39;t copy s here,</span>
                <span class="c1"># all the structures end up sharing all the variograms later</span>
                <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;variogram&quot;</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">vartype</span><span class="p">,</span><span class="n">bearing</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span> <span class="o">=</span> <span class="n">_read_variogram</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">variogram_info</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">VARTYPE</span><span class="p">[</span><span class="n">vartype</span><span class="p">](</span><span class="n">variogram_info</span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="n">anisotropy</span><span class="p">,</span>
                                         <span class="n">bearing</span><span class="o">=</span><span class="n">bearing</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">variograms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">structures</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">variogram_info</span><span class="p">:</span>
            <span class="n">vfound</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variograms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">vname</span><span class="p">:</span>
                    <span class="n">vfound</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">vfound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;variogram </span><span class="si">{0}</span><span class="s2"> not found for structure </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                <span class="nb">format</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="n">st</span><span class="o">.</span><span class="n">variograms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vfound</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">structures</span></div>



<span class="k">def</span> <span class="nf">_read_variogram</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to instantiate a Vario2d from a PEST-style structure file</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bearing</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">anisotropy</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">while</span> <span class="s2">&quot;end variogram&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;EOF while read variogram&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vartype&quot;</span><span class="p">:</span>
            <span class="n">vartype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bearing&quot;</span><span class="p">:</span>
            <span class="n">bearing</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;anisotropy&quot;</span><span class="p">:</span>
            <span class="n">anisotropy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unrecognized arg in variogram:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">vartype</span><span class="p">,</span><span class="n">bearing</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span>


<span class="k">def</span> <span class="nf">_read_structure_attributes</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; function to read information from a PEST-style structure file</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">variogram_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="s2">&quot;end structure&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;EOF while reading structure&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nugget&quot;</span><span class="p">:</span>
            <span class="n">nugget</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transform&quot;</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;numvariogram&quot;</span><span class="p">:</span>
            <span class="n">numvariograms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;variogram&quot;</span><span class="p">:</span>
            <span class="n">variogram_info</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;mean&#39; attribute not supported, skipping&quot;</span><span class="p">,</span><span class="n">PyemuWarning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unrecognized line in structure definition:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                            <span class="nb">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">assert</span> <span class="n">numvariograms</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">variogram_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nugget</span><span class="p">,</span><span class="n">transform</span><span class="p">,</span><span class="n">variogram_info</span>


<div class="viewcode-block" id="read_sgems_variogram_xml"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.read_sgems_variogram_xml">[docs]</a><span class="k">def</span> <span class="nf">read_sgems_variogram_xml</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span><span class="n">return_type</span><span class="o">=</span><span class="n">GeoStruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; function to read an SGEMS-type variogram XML file into</span>
<span class="sd">    a `GeoStruct`</span>

<span class="sd">    Args:</span>
<span class="sd">        xml_file (`str`): SGEMS variogram XML file</span>
<span class="sd">        return_type (`object`): the instance type to return.  Default is `GeoStruct`</span>

<span class="sd">    Returns:</span>
<span class="sd">        gs : `GeoStruct`</span>


<span class="sd">    Example::</span>

<span class="sd">        gs = pyemu.utils.geostats.read_sgems_variogram_xml(&quot;sgems.xml&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error import elementtree, skipping...&quot;</span><span class="p">)</span>
    <span class="n">VARTYPE</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">SphVario</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">ExpVario</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="n">GauVario</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span>
    <span class="n">gs_model</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">variograms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nugget</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">num_struct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">gs_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#print(key,val)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nugget&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nugget</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;structures_count&quot;</span><span class="p">:</span>
            <span class="n">num_struct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_struct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no structures found&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_struct</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">gs_model</span><span class="p">:</span>
        <span class="n">vtype</span><span class="p">,</span> <span class="n">contribution</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">mx_range</span><span class="p">,</span><span class="n">mn_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">x_angle</span><span class="p">,</span><span class="n">y_angle</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
        <span class="c1">#struct_name = structure.tag</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span>
                <span class="n">vtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">vtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sph&quot;</span><span class="p">):</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">SphVario</span>
                <span class="k">elif</span> <span class="n">vtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;exp&quot;</span><span class="p">):</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ExpVario</span>
                <span class="k">elif</span> <span class="n">vtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gau&quot;</span><span class="p">):</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">GauVario</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unrecognized variogram type:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vtype</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;contribution&quot;</span><span class="p">:</span>
                <span class="n">contribution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ranges&quot;</span><span class="p">:</span>
                    <span class="n">mx_range</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">])</span>
                    <span class="n">mn_range</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span>
                    <span class="n">x_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
                    <span class="n">y_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>

        <span class="k">assert</span> <span class="n">contribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">mn_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">mx_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">x_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">y_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">vtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">vtype</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">mx_range</span><span class="p">,</span>
                  <span class="n">anisotropy</span><span class="o">=</span><span class="n">mx_range</span><span class="o">/</span><span class="n">mn_range</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="p">(</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">x_angle</span><span class="p">,</span><span class="n">y_angle</span><span class="p">),</span>
                  <span class="n">name</span><span class="o">=</span><span class="n">structure</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">GeoStruct</span><span class="p">(</span><span class="n">nugget</span><span class="o">=</span><span class="n">nugget</span><span class="p">,</span><span class="n">variograms</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="p">])</span></div>


<div class="viewcode-block" id="gslib_2_dataframe"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.gslib_2_dataframe">[docs]</a><span class="k">def</span> <span class="nf">gslib_2_dataframe</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">attr_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">x_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">y_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; function to read a GSLIB point data file into a pandas.DataFrame</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (`str`): GSLIB file</span>
<span class="sd">        attr_name (`str`): the column name in the dataframe for the attribute.</span>
<span class="sd">            If None, GSLIB file can have only 3 columns.  `attr_name` must be in</span>
<span class="sd">            the GSLIB file header</span>
<span class="sd">        x_idx (`int`): the index of the x-coordinate information in the GSLIB file. Default is</span>
<span class="sd">            0 (first column)</span>
<span class="sd">        y_idx (`int`): the index of the y-coordinate information in the GSLIB file.</span>
<span class="sd">            Default is 1 (second column)</span>

<span class="sd">    Returns:</span>
<span class="sd">        `pandas.DataFrame`: a dataframe of info from the GSLIB file</span>

<span class="sd">    Note:</span>
<span class="sd">        assigns generic point names (&quot;pt0, pt1, etc)</span>

<span class="sd">    Example::</span>

<span class="sd">        df = pyemu.utiils.geostats.gslib_2_dataframe(&quot;prop.gslib&quot;,attr_name=&quot;hk&quot;)</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">num_attrs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_attrs</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> not in attrs:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span><span class="s2">&quot;propname is None but more than 3 attrs in gslib file&quot;</span>
            <span class="n">attr_name</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">x_idx</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">y_idx</span>
        <span class="n">a_idx</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="p">[],[],[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">x_idx</span><span class="p">]))</span>
                <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">y_idx</span><span class="p">]))</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">a_idx</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error paring line </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">a</span><span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pt</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="c1">#class ExperimentalVariogram(object):</span>
<span class="c1">#    def __init__(self,na)</span>

<div class="viewcode-block" id="load_sgems_exp_var"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.load_sgems_exp_var">[docs]</a><span class="k">def</span> <span class="nf">load_sgems_exp_var</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; read an SGEM experimental variogram into a sequence of</span>
<span class="sd">    pandas.DataFrames</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (`str`): an SGEMS experimental variogram XML file</span>

<span class="sd">    Returns:</span>
<span class="sd">        [`pandas.DataFrame`]: a list of pandas.DataFrames of x, y, pairs for each</span>
<span class="sd">        division in the experimental variogram</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">etree</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">variogram</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
        <span class="c1">#print(variogram.tag)</span>
        <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="n">variogram</span><span class="p">:</span>

            <span class="c1">#print(attrib.tag,attrib.text)</span>
            <span class="k">if</span> <span class="n">attrib</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">attrib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">attrib</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="n">attrib</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="n">attrib</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;pairs&quot;</span><span class="p">:</span>
                <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span><span class="s2">&quot;pairs&quot;</span><span class="p">:</span><span class="n">pairs</span><span class="p">})</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">dfs</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">return</span> <span class="n">dfs</span></div>



<div class="viewcode-block" id="fac2real"><a class="viewcode-back" href="../../../index.html#pyemu.utils.geostats.fac2real">[docs]</a><span class="k">def</span> <span class="nf">fac2real</span><span class="p">(</span><span class="n">pp_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">factors_file</span><span class="o">=</span><span class="s2">&quot;factors.dat&quot;</span><span class="p">,</span><span class="n">out_file</span><span class="o">=</span><span class="s2">&quot;test.ref&quot;</span><span class="p">,</span>
             <span class="n">upper_lim</span><span class="o">=</span><span class="mf">1.0e+30</span><span class="p">,</span><span class="n">lower_lim</span><span class="o">=-</span><span class="mf">1.0e+30</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0e+30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A python replication of the PEST fac2real utility for creating a</span>
<span class="sd">    structure grid array from previously calculated kriging factors (weights)</span>

<span class="sd">    Args:</span>
<span class="sd">        pp_file (`str`): PEST-type pilot points file</span>
<span class="sd">        factors_file (`str`): PEST-style factors file</span>
<span class="sd">        out_file (`str`): filename of array to write.  If None, array is returned, else</span>
<span class="sd">            value of out_file is returned.  Default is &quot;test.ref&quot;.</span>
<span class="sd">        upper_lim (`float`): maximum interpolated value in the array.  Values greater than</span>
<span class="sd">            `upper_lim` are set to fill_value</span>
<span class="sd">        lower_lim (`float`): minimum interpolated value in the array.  Values less than</span>
<span class="sd">            `lower_lim` are set to fill_value</span>
<span class="sd">        fill_value (`float`): the value to assign array nodes that are not interpolated</span>


<span class="sd">    Returns:</span>
<span class="sd">        `numpy.ndarray`: if out_file is None</span>

<span class="sd">        `str`: if out_file it not None</span>

<span class="sd">    Example::</span>

<span class="sd">        pyemu.utils.geostats.fac2real(&quot;hkpp.dat&quot;,out_file=&quot;hk_layer_1.ref&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">pp_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pp_file</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pp_file</span><span class="p">)</span>
        <span class="c1"># pp_data = pd.read_csv(pp_file,delim_whitespace=True,header=None,</span>
        <span class="c1">#                       names=[&quot;name&quot;,&quot;parval1&quot;],usecols=[0,4])</span>
        <span class="n">pp_data</span> <span class="o">=</span> <span class="n">pp_file_to_dataframe</span><span class="p">(</span><span class="n">pp_file</span><span class="p">)</span>
        <span class="n">pp_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">pp_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pp_file</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">pp_file</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s2">&quot;parval1&quot;</span> <span class="ow">in</span> <span class="n">pp_file</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">pp_data</span> <span class="o">=</span> <span class="n">pp_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unrecognized pp_file arg: must be str or pandas.DataFrame, not </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pp_file</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">factors_file</span><span class="p">)</span>
    <span class="n">f_fac</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">factors_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">fpp_file</span> <span class="o">=</span> <span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pp_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pp_data</span> <span class="o">=</span> <span class="n">pp_file_to_dataframe</span><span class="p">(</span><span class="n">fpp_file</span><span class="p">)</span>
        <span class="n">pp_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="n">fzone_file</span> <span class="o">=</span> <span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">ncol</span><span class="p">,</span><span class="n">nrow</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
    <span class="n">npp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">pp_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npp</span><span class="p">)]</span>

    <span class="c1"># check that pp_names is sync&#39;d with pp_data</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pp_data</span><span class="o">.</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pp_names</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;the following pilot point names are not common &quot;</span> <span class="o">+</span>\
                        <span class="s2">&quot;between the factors file and the pilot points file &quot;</span> <span class="o">+</span>\
                        <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">diff</span><span class="p">)))</span>

    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrow</span><span class="p">,</span><span class="n">ncol</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">fill_value</span>
    <span class="n">pp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">):</span><span class="n">val</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">pp_data</span><span class="o">.</span><span class="n">parval1</span><span class="p">)}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pp_dict_log</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">pp_data</span><span class="o">.</span><span class="n">parval1</span><span class="p">)}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pp_dict_log</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#for i in range(nrow):</span>
    <span class="c1">#    for j in range(ncol):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#raise Exception(&quot;unexpected EOF in factors file&quot;)</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inode</span><span class="p">,</span><span class="n">itrans</span><span class="p">,</span><span class="n">fac_data</span> <span class="o">=</span> <span class="n">_parse_factor_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error parsing factor line </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="c1">#fac_prods = [pp_data.loc[pp,&quot;value&quot;]*fac_data[pp] for pp in fac_data]</span>
        <span class="k">if</span> <span class="n">itrans</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fac_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pp_dict</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">*</span> <span class="n">fac_data</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">fac_data</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fac_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pp_dict_log</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">*</span> <span class="n">fac_data</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">fac_data</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">itrans</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fac_sum</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">fac_sum</span>
        <span class="c1">#col = ((inode - 1) // nrow) + 1</span>
        <span class="c1">#row = inode - ((col - 1) * nrow)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">((</span><span class="n">inode</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">inode</span> <span class="o">-</span> <span class="p">((</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">)</span>
        <span class="c1">#arr[row-1,col-1] = np.sum(np.array(fac_prods))</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_sum</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">arr</span><span class="o">&lt;</span><span class="n">lower_lim</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_lim</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">arr</span><span class="o">&gt;</span><span class="n">upper_lim</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_lim</span>

    <span class="c1">#print(out_file,arr.min(),pp_data.parval1.min(),lower_lim)</span>

    <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_file</span>
    <span class="k">return</span> <span class="n">arr</span></div>

<span class="k">def</span> <span class="nf">_parse_factor_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; function to parse a factor file line.  Used by fac2real()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">raw</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">inode</span><span class="p">,</span><span class="n">itrans</span><span class="p">,</span><span class="n">nfac</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
    <span class="n">fac_data</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">ifac</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">ifac</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">ifac</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="o">+</span><span class="n">nfac</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)}</span>
    <span class="c1"># fac_data = {}</span>
    <span class="c1"># for ifac in range(4,4+nfac*2,2):</span>
    <span class="c1">#     pnum = int(raw[ifac]) - 1 #zero based to sync with pandas</span>
    <span class="c1">#     fac = float(raw[ifac+1])</span>
    <span class="c1">#     fac_data[pnum] = fac</span>
    <span class="k">return</span> <span class="n">inode</span><span class="p">,</span><span class="n">itrans</span><span class="p">,</span><span class="n">fac_data</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, pyEMU development team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>