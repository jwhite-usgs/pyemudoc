

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyemu.utils.helpers &mdash; pyEMU 0.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyEMU
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.html">pyemu</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyEMU</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyemu.utils.helpers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyemu.utils.helpers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;High-level functions to help perform complex tasks</span>


<span class="sd">.. automodule:: helpers</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_colwidth</span> <span class="o">=</span> <span class="mi">100</span>
<span class="kn">from</span> <span class="nn">..pyemu_warnings</span> <span class="k">import</span> <span class="n">PyemuWarning</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">flopy</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">pyemu</span>
<span class="kn">from</span> <span class="nn">pyemu.utils.os_utils</span> <span class="k">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">start_workers</span>


<div class="viewcode-block" id="geostatistical_draws"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.geostatistical_draws">[docs]</a><span class="k">def</span> <span class="nf">geostatistical_draws</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">struct_dict</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;construct a parameter ensemble from a prior covariance matrix</span>
<span class="sd">    implied by geostatistical structure(s) and parameter bounds.</span>

<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): a control file (or the name of control file).  The</span>
<span class="sd">            parameter bounds in `pst` are used to define the variance of each</span>
<span class="sd">            parameter group.</span>
<span class="sd">        struct_dict (`dict`): a dict of GeoStruct (or structure file), and list of</span>
<span class="sd">            pilot point template files pairs. If the values in the dict are</span>
<span class="sd">            `pd.DataFrames`, then they must have an &#39;x&#39;,&#39;y&#39;, and &#39;parnme&#39; column.</span>
<span class="sd">            If the filename ends in &#39;.csv&#39;, then a pd.DataFrame is loaded,</span>
<span class="sd">            otherwise a pilot points file is loaded.</span>
<span class="sd">        num_reals (`int`, optional): number of realizations to draw.  Default is 100</span>
<span class="sd">        sigma_range (`float`): a float representing the number of standard deviations</span>
<span class="sd">            implied by parameter bounds. Default is 4.0, which implies 95% confidence parameter bounds.</span>
<span class="sd">        verbose (`bool`, optional): flag to control output to stdout.  Default is True.</span>
<span class="sd">            flag for stdout.</span>

<span class="sd">    Returns</span>
<span class="sd">        `pyemu.ParameterEnsemble`: the realized parameter ensemble.</span>

<span class="sd">    Notes:</span>
<span class="sd">        parameters are realized by parameter group.  The variance of each</span>
<span class="sd">        parameter group is used to scale the resulting geostatistical</span>
<span class="sd">        covariance matrix Therefore, the sill of the geostatistical structures</span>
<span class="sd">        in `struct_dict` should be 1.0</span>


<span class="sd">    Example::</span>

<span class="sd">        pst = pyemu.Pst(&quot;my.pst&quot;)</span>
<span class="sd">        sd = {&quot;struct.dat&quot;:[&quot;hkpp.dat.tpl&quot;,&quot;vka.dat.tpl&quot;]}</span>
<span class="sd">        pe = pyemu.helpers.geostatistical_draws(pst,struct_dict=sd}</span>
<span class="sd">        pe.to_csv(&quot;my_pe.csv&quot;)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">),</span><span class="s2">&quot;pst arg must be a Pst instance, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
        <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pst</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;building diagonal cov&quot;</span><span class="p">)</span>

    <span class="n">full_cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>
    <span class="n">full_cov_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">col_names</span><span class="p">,</span> <span class="n">full_cov</span><span class="o">.</span><span class="n">x</span><span class="p">)}</span>

    <span class="c1"># par_org = pst.parameter_data.copy  # not sure about the need or function of this line? (BH)</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="n">par_ens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pars_in_cov</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">gs</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">struct_dict</span><span class="p">[</span><span class="n">gs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing &quot;</span><span class="p">,</span><span class="n">gs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">gss</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">read_struct_file</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gss</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;using first geostat structure in file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="n">gs</span><span class="p">),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span>
        <span class="k">if</span> <span class="n">gs</span><span class="o">.</span><span class="n">sill</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;GeoStruct </span><span class="si">{0}</span><span class="s2"> sill != 1.0 - this is bad!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">]</span>
        <span class="c1">#items.sort()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">pp_tpl_to_dataframe</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">if</span> <span class="s2">&quot;pargp&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;working on pargroups </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;parnme&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not in the columns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="p">),</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the following parameters are not &quot;</span> <span class="o">+</span> \
                              <span class="s2">&quot;in the control file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">)]</span>
            <span class="k">if</span> <span class="s2">&quot;zone&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">zones</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">aset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
                <span class="n">df_zone</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">zone</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_zone</span> <span class="o">=</span> <span class="n">df_zone</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aset</span><span class="p">),:]</span>
                <span class="k">if</span> <span class="n">df_zone</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;all parameters in zone </span><span class="si">{0}</span><span class="s2"> tied and/or fixed, skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1">#df_zone.sort_values(by=&quot;parnme&quot;,inplace=True)</span>
                <span class="n">df_zone</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;build cov matrix&quot;</span><span class="p">)</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">df_zone</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting diag var cov&quot;</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#tpl_var = np.diag(full_cov.get(list(df_zone.parnme)).x).max()</span>
                <span class="n">tpl_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">full_cov_dict</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span> <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scaling full cov by diag var cov&quot;</span><span class="p">)</span>
                <span class="c1">#cov.x *= tpl_var</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                   <span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">*=</span> <span class="n">tpl_var</span>
                <span class="c1"># no fixed values here</span>
                <span class="n">pe</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">ParameterEnsemble</span><span class="o">.</span><span class="n">from_gaussian_draw</span><span class="p">(</span><span class="n">pst</span><span class="o">=</span><span class="n">pst</span><span class="p">,</span><span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="n">num_reals</span><span class="p">,</span>
                                                                <span class="n">by_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1">#df = pe.iloc[:,:]</span>
                <span class="n">par_ens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">_df</span><span class="p">)</span>
                <span class="n">pars_in_cov</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;adding remaining parameters to diagonal&quot;</span><span class="p">)</span>
    <span class="n">fset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fset</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">pars_in_cov</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">)}</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">full_cov</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">name_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">]))</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">vec</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span><span class="n">isdiagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#cov = full_cov.get(diff,diff)</span>
        <span class="c1"># here we fill in the fixed values</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">ParameterEnsemble</span><span class="o">.</span><span class="n">from_gaussian_draw</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="n">num_reals</span><span class="p">,</span>
                                                        <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">par_ens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">_df</span><span class="p">)</span>
    <span class="n">par_ens</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">par_ens</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">par_ens</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">ParameterEnsemble</span><span class="p">(</span><span class="n">pst</span><span class="o">=</span><span class="n">pst</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">par_ens</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">par_ens</span></div>


<div class="viewcode-block" id="geostatistical_prior_builder"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.geostatistical_prior_builder">[docs]</a><span class="k">def</span> <span class="nf">geostatistical_prior_builder</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">struct_dict</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;construct a full prior covariance matrix using geostastical structures</span>
<span class="sd">    and parameter bounds information.</span>

<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): a control file instance (or the name of control file)</span>
<span class="sd">        struct_dict (`dict`): a dict of GeoStruct (or structure file), and list of</span>
<span class="sd">            pilot point template files pairs. If the values in the dict are</span>
<span class="sd">            `pd.DataFrames`, then they must have an &#39;x&#39;,&#39;y&#39;, and &#39;parnme&#39; column.</span>
<span class="sd">             If the filename ends in &#39;.csv&#39;, then a pd.DataFrame is loaded,</span>
<span class="sd">             otherwise a pilot points file is loaded.</span>
<span class="sd">        sigma_range (`float`): a float representing the number of standard deviations</span>
<span class="sd">            implied by parameter bounds. Default is 4.0, which implies 95% confidence parameter bounds.</span>
<span class="sd">        verbose (`bool`, optional): flag to control output to stdout.  Default is True.</span>
<span class="sd">            flag for stdout.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `pyemu.Cov`: a covariance matrix that includes all adjustable parameters in the control</span>
<span class="sd">        file.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The covariance of parameters associated with geostatistical structures is defined</span>
<span class="sd">        as a mixture of GeoStruct and bounds.  That is, the GeoStruct is used to construct a</span>
<span class="sd">        pyemu.Cov, then the entire pyemu.Cov is scaled by the uncertainty implied by the bounds and</span>
<span class="sd">        sigma_range. Sounds complicated...</span>

<span class="sd">    Example::</span>

<span class="sd">        pst = pyemu.Pst(&quot;my.pst&quot;)</span>
<span class="sd">        sd = {&quot;struct.dat&quot;:[&quot;hkpp.dat.tpl&quot;,&quot;vka.dat.tpl&quot;]}</span>
<span class="sd">        cov = pyemu.helpers.geostatistical_draws(pst,struct_dict=sd}</span>
<span class="sd">        cov.to_binary(&quot;prior.jcb&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">),</span><span class="s2">&quot;pst arg must be a Pst instance, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
        <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pst</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;building diagonal cov&quot;</span><span class="p">)</span>
    <span class="n">full_cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>

    <span class="n">full_cov_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_cov</span><span class="o">.</span><span class="n">col_names</span><span class="p">,</span><span class="n">full_cov</span><span class="o">.</span><span class="n">x</span><span class="p">)}</span>
    <span class="c1">#full_cov = None</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="k">for</span> <span class="n">gs</span><span class="p">,</span><span class="n">items</span> <span class="ow">in</span> <span class="n">struct_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing &quot;</span><span class="p">,</span><span class="n">gs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">gss</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">read_struct_file</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gss</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;using first geostat structure in file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="n">gs</span><span class="p">),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gss</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="s2">&quot;file </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">pp_tpl_to_dataframe</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;parnme&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> is not in the columns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="p">),</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the following parameters are not &quot;</span> <span class="o">+</span> \
                              <span class="s2">&quot;in the control file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)),</span><span class="n">PyemuWarning</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">)]</span>
            <span class="k">if</span> <span class="s2">&quot;zone&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">zones</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">aset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
                <span class="n">df_zone</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">zone</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_zone</span> <span class="o">=</span> <span class="n">df_zone</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aset</span><span class="p">),</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="n">df_zone</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;all parameters in zone </span><span class="si">{0}</span><span class="s2"> tied and/or fixed, skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zone</span><span class="p">),</span>
                                  <span class="n">PyemuWarning</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1">#df_zone.sort_values(by=&quot;parnme&quot;,inplace=True)</span>
                <span class="n">df_zone</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;build cov matrix&quot;</span><span class="p">)</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">df_zone</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
                <span class="c1"># find the variance in the diagonal cov</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting diag var cov&quot;</span><span class="p">,</span><span class="n">df_zone</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#tpl_var = np.diag(full_cov.get(list(df_zone.parnme)).x).max()</span>
                <span class="n">tpl_var</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">full_cov_dict</span><span class="p">[</span><span class="n">pn</span><span class="p">]</span> <span class="k">for</span> <span class="n">pn</span> <span class="ow">in</span> <span class="n">df_zone</span><span class="o">.</span><span class="n">parnme</span><span class="p">])</span>
                <span class="c1">#if np.std(tpl_var) &gt; 1.0e-6:</span>
                <span class="c1">#    warnings.warn(&quot;pars have different ranges&quot; +\</span>
                <span class="c1">#                  &quot; , using max range as variance for all pars&quot;)</span>
                <span class="c1">#tpl_var = tpl_var.max()</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scaling full cov by diag var cov&quot;</span><span class="p">)</span>
                <span class="n">cov</span> <span class="o">*=</span> <span class="n">tpl_var</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test for inversion&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ci</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">inv</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">df_zone</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;prior_builder_crash.csv&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error inverting cov </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>

                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;replace in full cov&#39;</span><span class="p">)</span>
                <span class="n">full_cov</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
                <span class="c1"># d = np.diag(full_cov.x)</span>
                <span class="c1"># idx = np.argwhere(d==0.0)</span>
                <span class="c1"># for i in idx:</span>
                <span class="c1">#     print(full_cov.names[i])</span>
    <span class="k">return</span> <span class="n">full_cov</span></div>



<span class="k">def</span> <span class="nf">_condition_on_par_knowledge</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span><span class="n">par_knowledge_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  experimental function to include conditional prior information</span>
<span class="sd">    for one or more parameters in a full covariance matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">parnme</span> <span class="ow">in</span> <span class="n">par_knowledge_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">parnme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parnme</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;par knowledge dict parameters not found: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                        <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>
    <span class="c1"># build the selection matrix and sigma epsilon</span>
    <span class="c1">#sel = pyemu.Cov(x=np.identity(cov.shape[0]),names=cov.row_names)</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">zero2d</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">to_pearson</span><span class="p">()</span>
    <span class="n">new_cov_diag</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">as_2d</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()),</span><span class="n">names</span><span class="o">=</span><span class="n">cov</span><span class="o">.</span><span class="n">row_names</span><span class="p">)</span>
    <span class="c1">#new_cov_diag = cov.zero2d</span>

    <span class="k">for</span> <span class="n">parnme</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="n">par_knowledge_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">row_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parnme</span><span class="p">)</span>
        <span class="c1">#sel.x[idx,:] = 1.0</span>
        <span class="c1">#sel.x[idx,idx] = var</span>
        <span class="n">new_cov_diag</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>  <span class="n">var</span> <span class="c1">#cov.x[idx,idx]</span>
    <span class="n">new_cov_diag</span> <span class="o">=</span> <span class="n">sel</span> <span class="o">*</span> <span class="n">new_cov_diag</span> <span class="o">*</span> <span class="n">sel</span><span class="o">.</span><span class="n">T</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">parnme</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">par_knowledge_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">row_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parnme</span><span class="p">)</span>
            <span class="c1"># sel.x[idx,:] = 1.0</span>
            <span class="c1"># sel.x[idx,idx] = var</span>
            <span class="n">new_cov_diag</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>  <span class="c1"># cov.x[idx,idx]</span>
        <span class="n">new_cov_diag</span> <span class="o">=</span> <span class="n">sel</span> <span class="o">*</span> <span class="n">new_cov_diag</span> <span class="o">*</span> <span class="n">sel</span><span class="o">.</span><span class="n">T</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">new_cov_diag</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_cov_diag</span>



<div class="viewcode-block" id="kl_setup"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.kl_setup">[docs]</a><span class="k">def</span> <span class="nf">kl_setup</span><span class="p">(</span><span class="n">num_eig</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span><span class="n">struct</span><span class="p">,</span><span class="n">prefixes</span><span class="p">,</span>
             <span class="n">factors_file</span><span class="o">=</span><span class="s2">&quot;kl_factors.dat&quot;</span><span class="p">,</span>
             <span class="n">islog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">basis_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">tpl_dir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;setup a karhuenen-Loeve based parameterization for a given</span>
<span class="sd">    geostatistical structure.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_eig (`int`): the number of basis vectors to retain in the</span>
<span class="sd">            reduced basis</span>
<span class="sd">        sr (`flopy.reference.SpatialReference`): a spatial reference instance</span>
<span class="sd">        struct (`str`): a PEST-style structure file.  Can also be a</span>
<span class="sd">            `pyemu.geostats.Geostruct` instance.</span>
<span class="sd">        prefixes ([`str`]): a list of parameter prefixes to generate KL</span>
<span class="sd">            parameterization for.</span>
<span class="sd">        factors_file (`str`, optional): name of the PEST-style interpolation</span>
<span class="sd">            factors file to write (can be processed with FAC2REAL).</span>
<span class="sd">            Default is &quot;kl_factors.dat&quot;.</span>
<span class="sd">        islog (`bool`, optional): flag to indicate if the parameters are log transformed.</span>
<span class="sd">            Default is True</span>
<span class="sd">        basis_file (`str`, optional): the name of the PEST-style binary (e.g. jco)</span>
<span class="sd">            file to write the reduced basis vectors to.  Default is None (not saved).</span>
<span class="sd">        tpl_dir (`str`, optional): the directory to write the resulting</span>
<span class="sd">            template files to.  Default is &quot;.&quot; (current directory).</span>

<span class="sd">    Returns:</span>
<span class="sd">        `pandas.DataFrame`: a dataframe of parameter information.</span>

<span class="sd">    Notes:</span>
<span class="sd">        This is the companion function to `helpers.apply_kl()`</span>

<span class="sd">    Example::</span>

<span class="sd">        m = flopy.modflow.Modflow.load(&quot;mymodel.nam&quot;)</span>
<span class="sd">        prefixes = [&quot;hk&quot;,&quot;vka&quot;,&quot;ss&quot;]</span>
<span class="sd">        df = pyemu.helpers.kl_setup(10,m.sr,&quot;struct.dat&quot;,prefixes)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error import flopy: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">)</span>
    <span class="c1"># for name,array in array_dict.items():</span>
    <span class="c1">#     assert isinstance(array,np.ndarray)</span>
    <span class="c1">#     assert array.shape[0] == sr.nrow</span>
    <span class="c1">#     assert array.shape[1] == sr.ncol</span>
    <span class="c1">#     assert len(name) + len(str(num_eig)) &lt;= 12,&quot;name too long:{0}&quot;.\</span>
    <span class="c1">#         format(name)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">read_struct_file</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">struct</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
        <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;i</span><span class="si">{0:04d}</span><span class="s2">j</span><span class="si">{1:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">ncol</span><span class="p">)])</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                               <span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                               <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>

    <span class="n">eig_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;eig_</span><span class="si">{0:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">trunc_basis</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">u</span>
    <span class="n">trunc_basis</span><span class="o">.</span><span class="n">col_names</span> <span class="o">=</span> <span class="n">eig_names</span>
    <span class="c1">#trunc_basis.col_names = [&quot;&quot;]</span>
    <span class="k">if</span> <span class="n">basis_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trunc_basis</span><span class="o">.</span><span class="n">to_binary</span><span class="p">(</span><span class="n">basis_file</span><span class="p">)</span>
    <span class="n">trunc_basis</span> <span class="o">=</span> <span class="n">trunc_basis</span><span class="p">[:,:</span><span class="n">num_eig</span><span class="p">]</span>
    <span class="n">eig_names</span> <span class="o">=</span> <span class="n">eig_names</span><span class="p">[:</span><span class="n">num_eig</span><span class="p">]</span>

    <span class="n">pp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="n">eig_names</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">eig_names</span><span class="p">)</span>
    <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">sr</span><span class="o">.</span><span class="n">ncol</span>
    <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">sr</span><span class="o">.</span><span class="n">nrow</span>
    <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parval1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">write_pp_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;temp.dat&quot;</span><span class="p">),</span><span class="n">pp_df</span><span class="p">)</span>


    <span class="n">_eigen_basis_to_factor_file</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="n">sr</span><span class="o">.</span><span class="n">ncol</span><span class="p">,</span> <span class="n">trunc_basis</span><span class="p">,</span>
                                <span class="n">factors_file</span><span class="o">=</span><span class="n">factors_file</span><span class="p">,</span> <span class="n">islog</span><span class="o">=</span><span class="n">islog</span><span class="p">)</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefixes</span><span class="p">:</span>
        <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpl_dir</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.dat_kl.tpl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">pilot_points_to_tpl</span><span class="p">(</span><span class="s2">&quot;temp.dat&quot;</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="s2">&quot;temp.dat&quot;</span><span class="p">,</span><span class="n">tpl_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;in_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;kl_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c1">#arr = pyemu.geostats.fac2real(df,factors_file=factors_file,out_file=None)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span></div>

    <span class="c1"># back_array_dict = {}</span>
    <span class="c1"># f = open(tpl_file,&#39;w&#39;)</span>
    <span class="c1"># f.write(&quot;ptf ~\n&quot;)</span>
    <span class="c1"># f.write(&quot;name,org_val,new_val\n&quot;)</span>
    <span class="c1"># for name,array in array_dict.items():</span>
    <span class="c1">#     mname = name+&quot;mean&quot;</span>
    <span class="c1">#     f.write(&quot;{0},{1:20.8E},~   {2}    ~\n&quot;.format(mname,0.0,mname))</span>
    <span class="c1">#     #array -= array.mean()</span>
    <span class="c1">#     array_flat = pyemu.Matrix(x=np.atleast_2d(array.flatten()).transpose()</span>
    <span class="c1">#                               ,col_names=[&quot;flat&quot;],row_names=names,</span>
    <span class="c1">#                               isdiagonal=False)</span>
    <span class="c1">#     factors = trunc_basis * array_flat</span>
    <span class="c1">#     enames = [&quot;{0}{1:04d}&quot;.format(name,i) for i in range(num_eig)]</span>
    <span class="c1">#     for n,val in zip(enames,factors.x):</span>
    <span class="c1">#        f.write(&quot;{0},{1:20.8E},~    {0}    ~\n&quot;.format(n,val[0]))</span>
    <span class="c1">#     back_array_dict[name] = (factors.T * trunc_basis).x.reshape(array.shape)</span>
    <span class="c1">#     print(array_back)</span>
    <span class="c1">#     print(factors.shape)</span>
    <span class="c1">#</span>
    <span class="c1"># return back_array_dict</span>


<span class="k">def</span> <span class="nf">_eigen_basis_to_factor_file</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">factors_file</span><span class="p">,</span> <span class="n">islog</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">==</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">factors_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;junk.dat</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;junk.zone.dat</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ncol</span><span class="p">,</span><span class="n">nrow</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">basis</span><span class="o">.</span><span class="n">col_names</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">islog</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{3:8.5e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.0</span><span class="p">))</span>
            <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1:12.8g}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">basis</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,:])]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="kl_apply"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.kl_apply">[docs]</a><span class="k">def</span> <span class="nf">kl_apply</span><span class="p">(</span><span class="n">par_file</span><span class="p">,</span> <span class="n">basis_file</span><span class="p">,</span><span class="n">par_to_file_dict</span><span class="p">,</span><span class="n">arr_shape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Apply a KL parameterization transform from basis factors to model</span>
<span class="sd">    input arrays.</span>

<span class="sd">    Args:</span>
<span class="sd">        par_file (`str`): the csv file to get factor values from.  Must contain</span>
<span class="sd">            the following columns: &quot;name&quot;, &quot;new_val&quot;, &quot;org_val&quot;</span>
<span class="sd">        basis_file (`str`): the PEST-style binary file that contains the reduced</span>
<span class="sd">            basis</span>
<span class="sd">        par_to_file_dict (`dict`): a mapping from KL parameter prefixes to array</span>
<span class="sd">            file names.</span>
<span class="sd">        arr_shape (tuple): a length 2 tuple of number of rows and columns</span>
<span class="sd">            the resulting arrays should have.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This is the companion function to kl_setup.</span>
<span class="sd">            This function should be called during the forward run</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">assert</span> <span class="s2">&quot;org_val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">assert</span> <span class="s2">&quot;new_val&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">par_to_file_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="s2">&quot;missing prefix:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_binary</span><span class="p">(</span><span class="n">basis_file</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">basis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">arr_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">arr_min</span> <span class="o">=</span> <span class="mf">1.0e-10</span> <span class="c1"># a temp hack</span>

    <span class="c1">#means = df.loc[df.name.apply(lambda x: x.endswith(&quot;mean&quot;)),:]</span>
    <span class="c1">#print(means)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)),:]</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span><span class="n">filename</span> <span class="ow">in</span> <span class="n">par_to_file_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,[</span><span class="s2">&quot;new_val&quot;</span><span class="p">]])</span>
        <span class="n">factors</span><span class="o">.</span><span class="n">autoalign</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">basis_prefix</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[:</span><span class="n">factors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">factors</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">basis_prefix</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arr_shape</span><span class="p">)</span>
        <span class="c1">#arr += means.loc[means.prefix==prefix,&quot;new_val&quot;].values</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">arr</span><span class="o">&lt;</span><span class="n">arr_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_min</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%20.8E</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="zero_order_tikhonov"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.zero_order_tikhonov">[docs]</a><span class="k">def</span> <span class="nf">zero_order_tikhonov</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span> <span class="n">parbounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">par_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup preferred-value regularization in a pest control file.</span>

<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): the control file instance</span>
<span class="sd">        parbounds (`bool`, optional): flag to weight the new prior information</span>
<span class="sd">            equations according to parameter bound width - approx the KL</span>
<span class="sd">            transform. Default is True</span>
<span class="sd">        par_groups (`list`): a list of parameter groups to build PI equations for.</span>
<span class="sd">            If None, all adjustable parameters are used. Default is None</span>
<span class="sd">        reset (`bool`): a flag to remove any existing prior information equations</span>
<span class="sd">            in the control file.  Default is True</span>

<span class="sd">    Example::</span>

<span class="sd">        pst = pyemu.Pst(&quot;my.pst&quot;)</span>
<span class="sd">        pyemu.helpers.zero_order_tikhonov(pst)</span>
<span class="sd">        pst.write(&quot;my_reg.pst&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">par_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">par_groups</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">par_groups</span>

    <span class="n">pilbl</span><span class="p">,</span> <span class="n">obgnme</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">equation</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;partrans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tied&quot;</span><span class="p">,</span> <span class="s2">&quot;fixed&quot;</span><span class="p">]</span> <span class="ow">and</span>\
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">par_groups</span><span class="p">:</span>
            <span class="n">pilbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;parnme&quot;</span><span class="p">])</span>
            <span class="n">weight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">ogp_name</span> <span class="o">=</span> <span class="s2">&quot;regul&quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span>
            <span class="n">obgnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ogp_name</span><span class="p">[:</span><span class="mi">12</span><span class="p">])</span>
            <span class="n">parnme</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
            <span class="n">parval1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parval1&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pt</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">parnme</span> <span class="o">=</span> <span class="s2">&quot;log(&quot;</span> <span class="o">+</span> <span class="n">parnme</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="n">parval1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">parval1</span><span class="p">)</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="s2">&quot;1.0 * &quot;</span> <span class="o">+</span> <span class="n">parnme</span> <span class="o">+</span> <span class="s2">&quot; =</span><span class="si">{0:15.6E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parval1</span><span class="p">)</span>
            <span class="n">equation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pilbl&quot;</span><span class="p">:</span> <span class="n">pilbl</span><span class="p">,</span>
                                               <span class="s2">&quot;equation&quot;</span><span class="p">:</span> <span class="n">equation</span><span class="p">,</span>
                                               <span class="s2">&quot;obgnme&quot;</span><span class="p">:</span> <span class="n">obgnme</span><span class="p">,</span>
                                               <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pilbl&quot;</span><span class="p">:</span> <span class="n">pilbl</span><span class="p">,</span>
                          <span class="s2">&quot;equation&quot;</span><span class="p">:</span> <span class="n">equation</span><span class="p">,</span>
                          <span class="s2">&quot;obgnme&quot;</span><span class="p">:</span> <span class="n">obgnme</span><span class="p">,</span>
                          <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parbounds</span><span class="p">:</span>
        <span class="n">_regweight_from_parbound</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">pestmode</span> <span class="o">==</span> <span class="s2">&quot;estimation&quot;</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">pestmode</span> <span class="o">=</span> <span class="s2">&quot;regularization&quot;</span></div>


<span class="k">def</span> <span class="nf">_regweight_from_parbound</span><span class="p">(</span><span class="n">pst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;sets regularization weights from parameter bounds</span>
<span class="sd">    which approximates the KL expansion.  Called by</span>
<span class="sd">    zero_order_tikhonov().</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">parnme</span>
    <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">pilbl</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">parnme</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">pilbl</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parnme</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parnme</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">lbnd</span><span class="p">,</span><span class="n">ubnd</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;partrans&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ubnd</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lbnd</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">ubnd</span> <span class="o">-</span> <span class="n">lbnd</span><span class="p">)</span>
            <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parnme</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;prior information name does not correspond&quot;</span> <span class="o">+</span>\
                  <span class="s2">&quot; to a parameter: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">parnme</span><span class="p">))</span>


<div class="viewcode-block" id="first_order_pearson_tikhonov"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.first_order_pearson_tikhonov">[docs]</a><span class="k">def</span> <span class="nf">first_order_pearson_tikhonov</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">abs_drop_tol</span><span class="o">=</span><span class="mf">1.0e-3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup preferred-difference regularization from a covariance matrix.</span>


<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): the PEST control file</span>
<span class="sd">        cov (`pyemu.Cov`): a covariance matrix instance with</span>
<span class="sd">            some or all of the parameters listed in `pst`.</span>
<span class="sd">        reset (`bool`): a flag to remove any existing prior information equations</span>
<span class="sd">            in the control file.  Default is True</span>
<span class="sd">        abs_drop_tol (`float`, optional): tolerance to control how many pi equations</span>
<span class="sd">            are written. If the absolute value of the Pearson CC is less than</span>
<span class="sd">            abs_drop_tol, the prior information equation will not be included in</span>
<span class="sd">            the control file.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The weights on the prior information equations are the Pearson</span>
<span class="sd">        correlation coefficients implied by covariance matrix.</span>

<span class="sd">    Example::</span>

<span class="sd">        pst = pyemu.Pst(&quot;my.pst&quot;)</span>
<span class="sd">        cov = pyemu.Cov.from_ascii(&quot;my.cov&quot;)</span>
<span class="sd">        pyemu.helpers.first_order_pearson_tikhonov(pst,cov)</span>
<span class="sd">        pst.write(&quot;my_reg.pst&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span><span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting CC matrix&quot;</span><span class="p">)</span>
    <span class="n">cc_mat</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">to_pearson</span><span class="p">()</span>
    <span class="c1">#print(pst.parameter_data.dtypes)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ptrans</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">partrans</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ptrans</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">partrans</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">pi_num</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">pilbl</span><span class="p">,</span> <span class="n">obgnme</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">equation</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">sadj_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">iname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cc_mat</span><span class="o">.</span><span class="n">row_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sadj_names</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">jname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cc_mat</span><span class="o">.</span><span class="n">row_names</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">if</span> <span class="n">jname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sadj_names</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1">#print(i,iname,i+j+1,jname)</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">cc_mat</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cc</span> <span class="o">&lt;</span> <span class="n">abs_drop_tol</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">pilbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pcc_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pi_num</span><span class="p">))</span>
            <span class="n">iiname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">iname</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptrans</span><span class="p">[</span><span class="n">iname</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">iiname</span> <span class="o">=</span> <span class="s2">&quot;log(&quot;</span><span class="o">+</span><span class="n">iname</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
            <span class="n">jjname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jname</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptrans</span><span class="p">[</span><span class="n">jname</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">jjname</span> <span class="o">=</span> <span class="s2">&quot;log(&quot;</span><span class="o">+</span><span class="n">jname</span><span class="o">+</span><span class="s2">&quot;)&quot;</span>
            <span class="n">equation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;1.0 * </span><span class="si">{0}</span><span class="s2"> - 1.0 * </span><span class="si">{1}</span><span class="s2"> = 0.0&quot;</span><span class="o">.</span>\
                            <span class="nb">format</span><span class="p">(</span><span class="n">iiname</span><span class="p">,</span><span class="n">jjname</span><span class="p">))</span>
            <span class="n">weight</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="n">obgnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;regul_cc&quot;</span><span class="p">)</span>
            <span class="n">pi_num</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;pilbl&quot;</span><span class="p">:</span> <span class="n">pilbl</span><span class="p">,</span><span class="s2">&quot;equation&quot;</span><span class="p">:</span> <span class="n">equation</span><span class="p">,</span>
                       <span class="s2">&quot;obgnme&quot;</span><span class="p">:</span> <span class="n">obgnme</span><span class="p">,</span><span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span><span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pilbl</span>
    <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">prior_information</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">pestmode</span> <span class="o">==</span> <span class="s2">&quot;estimation&quot;</span><span class="p">:</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">pestmode</span> <span class="o">=</span> <span class="s2">&quot;regularization&quot;</span></div>


<div class="viewcode-block" id="simple_tpl_from_pars"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.simple_tpl_from_pars">[docs]</a><span class="k">def</span> <span class="nf">simple_tpl_from_pars</span><span class="p">(</span><span class="n">parnames</span><span class="p">,</span> <span class="n">tplfilename</span><span class="o">=</span><span class="s1">&#39;model.input.tpl&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a simple template file from a list of parameter names.</span>

<span class="sd">    Args:</span>
<span class="sd">        parnames ([`str`]): list of parameter names to put in the</span>
<span class="sd">            new template file</span>
<span class="sd">        tplfilename (`str`): Name of the template file to create.  Default</span>
<span class="sd">            is &quot;model.input.tpl&quot;</span>

<span class="sd">    Notes:</span>
<span class="sd">        writes a file `tplfilename` with each parameter name in `parnames` on a line</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tplfilename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofp</span><span class="p">:</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ptf ~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;~</span><span class="si">{0:^12}</span><span class="s1">~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cname</span><span class="p">))</span> <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="n">parnames</span><span class="p">]</span></div>


<div class="viewcode-block" id="simple_ins_from_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.simple_ins_from_obs">[docs]</a><span class="k">def</span> <span class="nf">simple_ins_from_obs</span><span class="p">(</span><span class="n">obsnames</span><span class="p">,</span> <span class="n">insfilename</span><span class="o">=</span><span class="s1">&#39;model.output.ins&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;write a simple instruction file that reads the values named</span>
<span class="sd">     in obsnames in order, one per line from a model output file</span>

<span class="sd">    Args:</span>
<span class="sd">        obsnames (`str`): list of observation names to put in the</span>
<span class="sd">            new instruction file</span>
<span class="sd">        insfilename (`str`): the name of the instruction file to</span>
<span class="sd">            create. Default is &quot;model.output.ins&quot;</span>

<span class="sd">    Notes:</span>
<span class="sd">        writes a file `insfilename` with each observation read off</span>
<span class="sd">        of a single line</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">insfilename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofp</span><span class="p">:</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pif ~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;!</span><span class="si">{0}</span><span class="s1">!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cob</span><span class="p">))</span> <span class="k">for</span> <span class="n">cob</span> <span class="ow">in</span> <span class="n">obsnames</span><span class="p">]</span></div>

<div class="viewcode-block" id="pst_from_parnames_obsnames"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.pst_from_parnames_obsnames">[docs]</a><span class="k">def</span> <span class="nf">pst_from_parnames_obsnames</span><span class="p">(</span><span class="n">parnames</span><span class="p">,</span> <span class="n">obsnames</span><span class="p">,</span>
                               <span class="n">tplfilename</span><span class="o">=</span><span class="s1">&#39;model.input.tpl&#39;</span><span class="p">,</span> <span class="n">insfilename</span><span class="o">=</span><span class="s1">&#39;model.output.ins&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a Pst object from a list of parameter names and a list of observation names.</span>

<span class="sd">    Args:</span>
<span class="sd">        parnames (`str`): list of parameter names</span>
<span class="sd">        obsnames (`str`): list of observation names</span>
<span class="sd">        tplfilename (`str`): template filename. Default is  &quot;model.input.tpl&quot;</span>
<span class="sd">        insfilename (`str`): instruction filename. Default is &quot;model.output.ins&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        `pyemu.Pst`: the generic control file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">simple_tpl_from_pars</span><span class="p">(</span><span class="n">parnames</span><span class="p">,</span> <span class="n">tplfilename</span><span class="p">)</span>
    <span class="n">simple_ins_from_obs</span><span class="p">(</span><span class="n">obsnames</span><span class="p">,</span> <span class="n">insfilename</span><span class="p">)</span>

    <span class="n">modelinputfilename</span> <span class="o">=</span> <span class="n">tplfilename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tpl&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">modeloutputfilename</span> <span class="o">=</span> <span class="n">insfilename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ins&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="o">.</span><span class="n">from_io_files</span><span class="p">(</span><span class="n">tplfilename</span><span class="p">,</span> <span class="n">modelinputfilename</span><span class="p">,</span> <span class="n">insfilename</span><span class="p">,</span> <span class="n">modeloutputfilename</span><span class="p">)</span></div>

<div class="viewcode-block" id="read_pestpp_runstorage"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.read_pestpp_runstorage">[docs]</a><span class="k">def</span> <span class="nf">read_pestpp_runstorage</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">irun</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">with_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read pars and obs from a specific run in a pest++ serialized</span>
<span class="sd">    run storage file into dataframes.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (`str`): the name of the run storage file</span>
<span class="sd">        irun (`int`): the run id to process. If &#39;all&#39;, then all runs are</span>
<span class="sd">            read. Default is 0</span>
<span class="sd">        with_metadata (`bool`): flag to return run stats and info txt as well</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>

<span class="sd">        - **pandas.DataFrame**: parameter information</span>
<span class="sd">        - **pandas.DataFrame**: observation information</span>
<span class="sd">        - **pandas.DataFrame**: optionally run status and info txt.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">header_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s2">&quot;n_runs&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;run_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;p_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;o_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">irun</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">irun</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">irun</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">irun</span> <span class="o">=</span> <span class="n">irun</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unrecognized &#39;irun&#39;: should be int or &#39;all&#39;, not &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span>
                            <span class="nb">format</span><span class="p">(</span><span class="n">irun</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">status_str</span><span class="p">(</span><span class="n">r_status</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;not completed&quot;</span>
        <span class="k">if</span> <span class="n">r_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;completed&quot;</span>
        <span class="k">if</span> <span class="n">r_status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">100</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;canceled&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;failed&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">header_dtype</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p_name_size</span><span class="p">,</span><span class="n">o_name_size</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;p_name_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;o_name_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">par_names</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_name_size</span><span class="p">),</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">p_name_size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">obs_names</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_name_size</span><span class="p">),</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">o_name_size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_runs</span><span class="p">,</span><span class="n">run_size</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;n_runs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;run_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">run_start</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_read_run</span><span class="p">(</span><span class="n">irun</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">run_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">irun</span> <span class="o">*</span> <span class="n">run_size</span><span class="p">))</span>
        <span class="n">r_status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">info_txt</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;41s&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">41</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">par_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">par_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">obs_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">par_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span> <span class="n">par_names</span><span class="p">,</span> <span class="s2">&quot;parval1&quot;</span><span class="p">:</span> <span class="n">par_vals</span><span class="p">})</span>

        <span class="n">par_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">par_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
        <span class="n">obs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;obsnme&quot;</span><span class="p">:</span> <span class="n">obs_names</span><span class="p">,</span> <span class="s2">&quot;obsval&quot;</span><span class="p">:</span> <span class="n">obs_vals</span><span class="p">})</span>
        <span class="n">obs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;obsnme&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r_status</span><span class="p">,</span><span class="n">info_txt</span><span class="p">,</span><span class="n">par_df</span><span class="p">,</span><span class="n">obs_df</span>

    <span class="k">if</span> <span class="n">irun</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">par_dfs</span><span class="p">,</span><span class="n">obs_dfs</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="n">r_stats</span><span class="p">,</span> <span class="n">txts</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="k">for</span> <span class="n">irun</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_runs</span><span class="p">):</span>
            <span class="c1">#print(irun)</span>
            <span class="n">r_status</span><span class="p">,</span> <span class="n">info_txt</span><span class="p">,</span> <span class="n">par_df</span><span class="p">,</span> <span class="n">obs_df</span> <span class="o">=</span> <span class="n">_read_run</span><span class="p">(</span><span class="n">irun</span><span class="p">)</span>
            <span class="n">par_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_df</span><span class="p">)</span>
            <span class="n">obs_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_df</span><span class="p">)</span>
            <span class="n">r_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_status</span><span class="p">)</span>
            <span class="n">txts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info_txt</span><span class="p">)</span>
        <span class="n">par_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">par_dfs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">par_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_runs</span><span class="p">)</span>
        <span class="n">obs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">obs_dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">obs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_runs</span><span class="p">)</span>
        <span class="n">meta_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;r_status&quot;</span><span class="p">:</span><span class="n">r_stats</span><span class="p">,</span><span class="s2">&quot;info_txt&quot;</span><span class="p">:</span><span class="n">txts</span><span class="p">})</span>
        <span class="n">meta_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta_data</span><span class="o">.</span><span class="n">r_status</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">status_str</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">irun</span> <span class="o">&lt;=</span> <span class="n">n_runs</span>
        <span class="n">r_status</span><span class="p">,</span><span class="n">info_txt</span><span class="p">,</span><span class="n">par_df</span><span class="p">,</span><span class="n">obs_df</span> <span class="o">=</span> <span class="n">_read_run</span><span class="p">(</span><span class="n">irun</span><span class="p">)</span>
        <span class="n">meta_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;r_status&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">r_status</span><span class="p">],</span> <span class="s2">&quot;info_txt&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">info_txt</span><span class="p">]})</span>
        <span class="n">meta_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta_data</span><span class="o">.</span><span class="n">r_status</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">status_str</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">with_metadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">par_df</span><span class="p">,</span><span class="n">obs_df</span><span class="p">,</span><span class="n">meta_data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">par_df</span><span class="p">,</span><span class="n">obs_df</span></div>

<div class="viewcode-block" id="jco_from_pestpp_runstorage"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.jco_from_pestpp_runstorage">[docs]</a><span class="k">def</span> <span class="nf">jco_from_pestpp_runstorage</span><span class="p">(</span><span class="n">rnj_filename</span><span class="p">,</span><span class="n">pst_filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; read pars and obs from a pest++ serialized run storage</span>
<span class="sd">    file (e.g., .rnj) and return jacobian matrix instance</span>

<span class="sd">    Args:</span>
<span class="sd">        rnj_filename (`str`): the name of the run storage file</span>
<span class="sd">        pst_filename (`str`): the name of the pst file</span>

<span class="sd">    Notes:</span>
<span class="sd">        This can then be passed to Jco.to_binary or Jco.to_coo, etc., to write jco</span>
<span class="sd">        file in a subsequent step to avoid memory resource issues associated</span>
<span class="sd">        with very large problems.</span>


<span class="sd">    Returns:</span>
<span class="sd">        `pyemu.Jco`: a jacobian matrix constructed from the run results and</span>
<span class="sd">        pest control file information.</span>


<span class="sd">    TODO:</span>
<span class="sd">        Check rnj file contains transformed par vals (i.e., in model input space)</span>

<span class="sd">        Currently only returns pyemu.Jco; doesn&#39;t write jco file due to memory</span>
<span class="sd">        issues associated with very large problems</span>

<span class="sd">        Compare rnj and jco from Freyberg problem in autotests</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">header_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s2">&quot;n_runs&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;run_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),(</span><span class="s2">&quot;p_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;o_name_size&quot;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)])</span>

    <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst_filename</span><span class="p">)</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="n">log_pars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">partrans</span><span class="o">==</span><span class="s2">&quot;log&quot;</span><span class="p">,</span><span class="s2">&quot;parnme&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rnj_filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">header_dtype</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">base_par</span><span class="p">,</span><span class="n">base_obs</span> <span class="o">=</span>  <span class="n">read_pestpp_runstorage</span><span class="p">(</span><span class="n">rnj_filename</span><span class="p">,</span><span class="n">irun</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t get base run...&quot;</span><span class="p">)</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">base_par</span><span class="o">.</span><span class="n">index</span><span class="p">,:]</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">base_par</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;partrans&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">base_par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
    <span class="n">jco_cols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">irun</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;n_runs&quot;</span><span class="p">])):</span>
        <span class="n">par_df</span><span class="p">,</span><span class="n">obs_df</span> <span class="o">=</span> <span class="n">read_pestpp_runstorage</span><span class="p">(</span><span class="n">rnj_filename</span><span class="p">,</span><span class="n">irun</span><span class="o">=</span><span class="n">irun</span><span class="p">)</span>
        <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
        <span class="n">obs_diff</span> <span class="o">=</span> <span class="n">base_obs</span> <span class="o">-</span> <span class="n">obs_df</span>
        <span class="n">par_diff</span> <span class="o">=</span> <span class="n">base_par</span> <span class="o">-</span> <span class="n">par_df</span>
        <span class="c1"># check only one non-zero element per col(par)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_diff</span><span class="p">[</span><span class="n">par_diff</span><span class="o">.</span><span class="n">parval1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;more than one par diff - looks like the file wasn&#39;t created during jco filling...&quot;</span><span class="p">)</span>
        <span class="n">parnme</span> <span class="o">=</span> <span class="n">par_diff</span><span class="p">[</span><span class="n">par_diff</span><span class="o">.</span><span class="n">parval1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parval</span> <span class="o">=</span> <span class="n">par_diff</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">parnme</span><span class="p">]</span>

        <span class="c1"># derivatives</span>
        <span class="n">jco_col</span> <span class="o">=</span> <span class="n">obs_diff</span> <span class="o">/</span> <span class="n">parval</span>
        <span class="c1"># some tracking, checks</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing par </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">irun</span><span class="p">,</span> <span class="n">parnme</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;%nzsens: </span><span class="si">{0}</span><span class="s2">%...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">jco_col</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">jco_col</span><span class="o">.</span><span class="n">obsval</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-8</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">jco_col</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">))</span>

        <span class="n">jco_cols</span><span class="p">[</span><span class="n">parnme</span><span class="p">]</span> <span class="o">=</span> <span class="n">jco_col</span><span class="o">.</span><span class="n">obsval</span>

    <span class="n">jco_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">jco_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">obs_diff</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

    <span class="n">jco_cols</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Jco</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">jco_cols</span><span class="p">)</span>
    
    <span class="c1"># write # memory considerations important here for very large matrices - break into chunks...</span>
    <span class="c1">#jco_fnam = &quot;{0}&quot;.format(filename[:-4]+&quot;.jco&quot;)</span>
    <span class="c1">#jco_cols.to_binary(filename=jco_fnam, droptol=None, chunk=None)</span>

    <span class="k">return</span> <span class="n">jco_cols</span></div>


<div class="viewcode-block" id="parse_dir_for_io_files"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.parse_dir_for_io_files">[docs]</a><span class="k">def</span> <span class="nf">parse_dir_for_io_files</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; find template/input file pairs and instruction file/output file</span>
<span class="sd">    pairs by extension.</span>

<span class="sd">    Args:</span>
<span class="sd">        d (`str`): directory to search for interface files</span>

<span class="sd">    Notes:</span>
<span class="sd">        the return values from this function can be passed straight to</span>
<span class="sd">        `pyemu.Pst.from_io_files()` classmethod constructor. Assumes the</span>
<span class="sd">        template file names are &lt;input_file&gt;.tpl and instruction file names</span>
<span class="sd">        are &lt;output_file&gt;.ins.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>

<span class="sd">        - **[`str`]**: list of template files in d</span>
<span class="sd">        - **[`str`]**: list of input files in d</span>
<span class="sd">        - **[`str`]**: list of instruction files in d</span>
<span class="sd">        - **[`str`]**: list of output files in d</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">tpl_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">)]</span>
    <span class="n">in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tpl_files</span><span class="p">]</span>
    <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">)]</span>
    <span class="n">out_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ins_files</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tpl_files</span><span class="p">,</span><span class="n">in_files</span><span class="p">,</span><span class="n">ins_files</span><span class="p">,</span><span class="n">out_files</span></div>


<div class="viewcode-block" id="pst_from_io_files"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.pst_from_io_files">[docs]</a><span class="k">def</span> <span class="nf">pst_from_io_files</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">,</span><span class="n">in_files</span><span class="p">,</span><span class="n">ins_files</span><span class="p">,</span><span class="n">out_files</span><span class="p">,</span><span class="n">pst_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; create a Pst instance from model interface files.</span>

<span class="sd">    Args:</span>
<span class="sd">        tpl_files ([`str`]): list of template file names</span>
<span class="sd">        in_files ([`str`]): list of model input file names (pairs with template files)</span>
<span class="sd">        ins_files ([`str`]): list of instruction file names</span>
<span class="sd">        out_files ([`str`]): list of model output file names (pairs with instruction files)</span>
<span class="sd">        pst_filename (`str`): name of control file to write.  If None, no file is written.</span>
<span class="sd">            Default is None</span>

<span class="sd">    Returns:</span>
<span class="sd">        `Pst`: new control file instance with parameter and observation names</span>
<span class="sd">        found in `tpl_files` and `ins_files`, repsectively.</span>

<span class="sd">    Notes:</span>
<span class="sd">        calls `pyemu.helpers.pst_from_io_files()`</span>

<span class="sd">        Assigns generic values for parameter info.  Tries to use INSCHEK</span>
<span class="sd">        to set somewhat meaningful observation values</span>

<span class="sd">        all file paths are relatively to where python is running.</span>

<span class="sd">    TODO:</span>
<span class="sd">        add pst_path option</span>
<span class="sd">        make in_files and out_files optional</span>

<span class="sd">    Example::</span>

<span class="sd">        tpl_files = [&quot;my.tpl&quot;]</span>
<span class="sd">        in_files = [&quot;my.in&quot;]</span>
<span class="sd">        ins_files = [&quot;my.ins&quot;]</span>
<span class="sd">        out_files = [&quot;my.out&quot;]</span>
<span class="sd">        pst = pyemu.Pst.from_io_files(tpl_files,in_files,ins_files,out_files)</span>
<span class="sd">        pst.control_data.noptmax = 0</span>
<span class="sd">        pst.write(&quot;my.pst)</span>



<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">par_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">tpl_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">tpl_files</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">in_files</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">),</span><span class="s2">&quot;len(in_files) != len(tpl_files)&quot;</span>

    <span class="k">for</span> <span class="n">tpl_file</span> <span class="ow">in</span> <span class="n">tpl_files</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">),</span><span class="s2">&quot;template file not found: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
        <span class="c1">#new_names = [name for name in pyemu.pst_utils.parse_tpl_file(tpl_file) if name not in par_names]</span>
        <span class="c1">#par_names.extend(new_names)</span>
        <span class="n">new_names</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">parse_tpl_file</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
        <span class="n">par_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ins_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">ins_files</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_files</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ins_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_files</span><span class="p">),</span><span class="s2">&quot;len(out_files) != len(out_files)&quot;</span>


    <span class="n">obs_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ins_file</span> <span class="ow">in</span> <span class="n">ins_files</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ins_file</span><span class="p">),</span><span class="s2">&quot;instruction file not found: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)</span>
        <span class="n">obs_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">parse_ins_file</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>

    <span class="n">new_pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">generic_pst</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">par_names</span><span class="p">),</span><span class="nb">list</span><span class="p">(</span><span class="n">obs_names</span><span class="p">))</span>

    <span class="n">new_pst</span><span class="o">.</span><span class="n">template_files</span> <span class="o">=</span> <span class="n">tpl_files</span>
    <span class="n">new_pst</span><span class="o">.</span><span class="n">input_files</span> <span class="o">=</span> <span class="n">in_files</span>
    <span class="n">new_pst</span><span class="o">.</span><span class="n">instruction_files</span> <span class="o">=</span> <span class="n">ins_files</span>
    <span class="n">new_pst</span><span class="o">.</span><span class="n">output_files</span> <span class="o">=</span> <span class="n">out_files</span>

    <span class="c1">#try to run inschek to find the observtion values</span>
    <span class="n">pyemu</span><span class="o">.</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">try_process_output_pst</span><span class="p">(</span><span class="n">new_pst</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pst_filename</span><span class="p">:</span>
        <span class="n">new_pst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pst_filename</span><span class="p">,</span><span class="n">update_regul</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_pst</span></div>


<span class="n">wildass_guess_par_bounds_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hk&quot;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span><span class="s2">&quot;vka&quot;</span><span class="p">:[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">10.0</span><span class="p">],</span>
                                   <span class="s2">&quot;sy&quot;</span><span class="p">:[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.75</span><span class="p">],</span><span class="s2">&quot;ss&quot;</span><span class="p">:[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">10.0</span><span class="p">],</span>
                                   <span class="s2">&quot;cond&quot;</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span><span class="s2">&quot;flux&quot;</span><span class="p">:[</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.75</span><span class="p">],</span>
                                   <span class="s2">&quot;rech&quot;</span><span class="p">:[</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">1.1</span><span class="p">],</span><span class="s2">&quot;stage&quot;</span><span class="p">:[</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">1.1</span><span class="p">],</span>
                                   <span class="p">}</span>

<div class="viewcode-block" id="PstFromFlopyModel"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.PstFromFlopyModel">[docs]</a><span class="k">class</span> <span class="nc">PstFromFlopyModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a monster helper class to setup a complex PEST interface around</span>
<span class="sd">    an existing MODFLOW-2005-family model.</span>


<span class="sd">    Args:</span>
<span class="sd">        model (`flopy.mbase`): a loaded flopy model instance. If model is an str, it is treated as a</span>
<span class="sd">            MODFLOW nam file (requires org_model_ws)</span>
<span class="sd">        new_model_ws (`str`): a directory where the new version of MODFLOW input files and PEST(++)</span>
<span class="sd">            files will be written</span>
<span class="sd">        org_model_ws (`str`): directory to existing MODFLOW model files.  Required if model argument</span>
<span class="sd">            is an str.  Default is None</span>
<span class="sd">        pp_props ([[`str`,[`int`]]]): pilot point multiplier parameters for grid-based properties.</span>
<span class="sd">            A nested list of grid-scale model properties to parameterize using</span>
<span class="sd">            name, iterable pairs.  For 3D properties, the iterable is zero-based</span>
<span class="sd">            layer indices.  For example, [&quot;lpf.hk&quot;,[0,1,2,]] would setup pilot point multiplier</span>
<span class="sd">            parameters for layer property file horizontal hydraulic conductivity for model</span>
<span class="sd">            layers 1,2, and 3.  For time-varying properties (e.g. recharge), the</span>
<span class="sd">            iterable is for zero-based stress period indices.  For example, [&quot;rch.rech&quot;,[0,4,10,15]]</span>
<span class="sd">            would setup pilot point multiplier parameters for recharge for stress</span>
<span class="sd">            period 1,5,11,and 16.</span>
<span class="sd">        const_props ([[`str`,[`int`]]]): constant (uniform) multiplier parameters for grid-based properties.</span>
<span class="sd">            A nested list of grid-scale model properties to parameterize using</span>
<span class="sd">            name, iterable pairs.  For 3D properties, the iterable is zero-based</span>
<span class="sd">            layer indices.  For example, [&quot;lpf.hk&quot;,[0,1,2,]] would setup constant (uniform) multiplier</span>
<span class="sd">            parameters for layer property file horizontal hydraulic conductivity for model</span>
<span class="sd">            layers 1,2, and 3.  For time-varying properties (e.g. recharge), the</span>
<span class="sd">            iterable is for zero-based stress period indices.  For example, [&quot;rch.rech&quot;,[0,4,10,15]]</span>
<span class="sd">            would setup constant (uniform) multiplier parameters for recharge for stress</span>
<span class="sd">            period 1,5,11,and 16.</span>
<span class="sd">        temporal_list_props ([[`str`,[`int`]]]): list-type input stress-period level multiplier parameters.</span>
<span class="sd">            A nested list of list-type input elements to parameterize using</span>
<span class="sd">            name, iterable pairs.  The iterable is zero-based stress-period indices.</span>
<span class="sd">            For example, to setup multipliers for WEL flux and for RIV conductance,</span>
<span class="sd">            temporal_list_props = [[&quot;wel.flux&quot;,[0,1,2]],[&quot;riv.cond&quot;,None]] would setup</span>
<span class="sd">            multiplier parameters for well flux for stress periods 1,2 and 3 and</span>
<span class="sd">            would setup one single river conductance multiplier parameter that is applied</span>
<span class="sd">            to all stress periods</span>
<span class="sd">        spatial_list_props ([[`str`,[`int`]]]):  list-type input for spatial multiplier parameters.</span>
<span class="sd">            A nested list of list-type elements to parameterize using</span>
<span class="sd">            names (e.g. [[&quot;riv.cond&quot;,0],[&quot;wel.flux&quot;,1] to setup up cell-based parameters for</span>
<span class="sd">            each list-type element listed.  These multiplier parameters are applied across</span>
<span class="sd">            all stress periods.  For this to work, there must be the same number of entries</span>
<span class="sd">            for all stress periods.  If more than one list element of the same type is in a single</span>
<span class="sd">            cell, only one parameter is used to multiply all lists in the same cell.</span>
<span class="sd">        grid_props ([[`str`,[`int`]]]): grid-based (every active model cell) multiplier parameters.</span>
<span class="sd">            A nested list of grid-scale model properties to parameterize using</span>
<span class="sd">            name, iterable pairs.  For 3D properties, the iterable is zero-based</span>
<span class="sd">            layer indices (e.g., [&quot;lpf.hk&quot;,[0,1,2,]] would setup a multiplier</span>
<span class="sd">            parameter for layer property file horizontal hydraulic conductivity for model</span>
<span class="sd">            layers 1,2, and 3 in every active model cell).  For time-varying properties (e.g. recharge), the</span>
<span class="sd">            iterable is for zero-based stress period indices.  For example, [&quot;rch.rech&quot;,[0,4,10,15]]</span>
<span class="sd">            would setup grid-based multiplier parameters in every active model cell</span>
<span class="sd">            for recharge for stress period 1,5,11,and 16.</span>
<span class="sd">        sfr_pars (`bool`): setup parameters for the stream flow routing modflow package.</span>
<span class="sd">            If list is passed it defines the parameters to set up.</span>
<span class="sd">        sfr_temporal_pars (`bool`)</span>
<span class="sd">            flag to include stress-period level spatially-global multipler parameters in addition to</span>
<span class="sd">            the spatially-discrete `sfr_pars`.  Requires `sfr_pars` to be passed.  Default is False</span>
<span class="sd">        grid_geostruct (`pyemu.geostats.GeoStruct`): the geostatistical structure to build the prior parameter covariance matrix</span>
<span class="sd">            elements for grid-based parameters.  If None, a generic GeoStruct is created</span>
<span class="sd">            using an &quot;a&quot; parameter that is 10 times the max cell size.  Default is None</span>
<span class="sd">        pp_space (`int`): number of grid cells between pilot points.  If None, use the default</span>
<span class="sd">            in pyemu.pp_utils.setup_pilot_points_grid.  Default is None</span>
<span class="sd">        zone_props ([[`str`,[`int`]]]): zone-based multiplier parameters.</span>
<span class="sd">            A nested list of zone-based model properties to parameterize using</span>
<span class="sd">            name, iterable pairs.  For 3D properties, the iterable is zero-based</span>
<span class="sd">            layer indices (e.g., [&quot;lpf.hk&quot;,[0,1,2,]] would setup a multiplier</span>
<span class="sd">            parameter for layer property file horizontal hydraulic conductivity for model</span>
<span class="sd">            layers 1,2, and 3 for unique zone values in the ibound array.</span>
<span class="sd">            For time-varying properties (e.g. recharge), the iterable is for</span>
<span class="sd">            zero-based stress period indices.  For example, [&quot;rch.rech&quot;,[0,4,10,15]]</span>
<span class="sd">            would setup zone-based multiplier parameters for recharge for stress</span>
<span class="sd">            period 1,5,11,and 16.</span>
<span class="sd">        pp_geostruct (`pyemu.geostats.GeoStruct`): the geostatistical structure to use for building the prior parameter</span>
<span class="sd">            covariance matrix for pilot point parameters.  If None, a generic</span>
<span class="sd">            GeoStruct is created using pp_space and grid-spacing information.</span>
<span class="sd">            Default is None</span>
<span class="sd">        par_bounds_dict (`dict`): a dictionary of model property/boundary condition name, upper-lower bound pairs.</span>
<span class="sd">            For example, par_bounds_dict = {&quot;hk&quot;:[0.01,100.0],&quot;flux&quot;:[0.5,2.0]} would</span>
<span class="sd">            set the bounds for horizontal hydraulic conductivity to</span>
<span class="sd">            0.001 and 100.0 and set the bounds for flux parameters to 0.5 and</span>
<span class="sd">            2.0.  For parameters not found in par_bounds_dict,</span>
<span class="sd">            `pyemu.helpers.wildass_guess_par_bounds_dict` is</span>
<span class="sd">            used to set somewhat meaningful bounds.  Default is None</span>
<span class="sd">        temporal_list_geostruct (`pyemu.geostats.GeoStruct`): the geostastical struture to</span>
<span class="sd">            build the prior parameter covariance matrix</span>
<span class="sd">            for time-varying list-type multiplier parameters.  This GeoStruct</span>
<span class="sd">            express the time correlation so that the &#39;a&#39; parameter is the length of</span>
<span class="sd">            time that boundary condition multiplier parameters are correlated across.</span>
<span class="sd">            If None, then a generic GeoStruct is created that uses an &#39;a&#39; parameter</span>
<span class="sd">            of 3 stress periods.  Default is None</span>
<span class="sd">        spatial_list_geostruct (`pyemu.geostats.GeoStruct`): the geostastical struture to</span>
<span class="sd">            build the prior parameter covariance matrix</span>
<span class="sd">            for spatially-varying list-type multiplier parameters.</span>
<span class="sd">            If None, a generic GeoStruct is created using an &quot;a&quot; parameter that</span>
<span class="sd">            is 10 times the max cell size.  Default is None.</span>
<span class="sd">        remove_existing (`bool`): a flag to remove an existing new_model_ws directory.  If False and</span>
<span class="sd">            new_model_ws exists, an exception is raised.  If True and new_model_ws</span>
<span class="sd">            exists, the directory is destroyed - user beware! Default is False.</span>
<span class="sd">        k_zone_dict (`dict`):  a dictionary of zero-based layer index, zone array pairs.</span>
<span class="sd">            e.g. {lay: np.2darray}  Used to</span>
<span class="sd">            override using ibound zones for zone-based parameterization.  If None,</span>
<span class="sd">            use ibound values greater than zero as zones. Alternatively a dictionary of dictionaries</span>
<span class="sd">            can be passed to allow different zones to be defined for different parameters.</span>
<span class="sd">            e.g. {&quot;upw.hk&quot; {lay: np.2darray}, &quot;extra.rc11&quot; {lay: np.2darray}}</span>
<span class="sd">            or {&quot;hk&quot; {lay: np.2darray}, &quot;rc11&quot; {lay: np.2darray}}</span>
<span class="sd">        use_pp_zones (`bool`): a flag to use ibound zones (or k_zone_dict, see above) as pilot</span>
<span class="sd">             point zones.  If False, ibound values greater than zero are treated as</span>
<span class="sd">             a single zone for pilot points.  Default is False</span>
<span class="sd">        obssim_smp_pairs ([[`str`,`str`]]: a list of observed-simulated PEST-type SMP file</span>
<span class="sd">            pairs to get observations</span>
<span class="sd">            from and include in the control file.  Default is []</span>
<span class="sd">        external_tpl_in_pairs ([[`str`,`str`]]: a list of existing template file, model input</span>
<span class="sd">            file pairs to parse parameters</span>
<span class="sd">            from and include in the control file.  Default is []</span>
<span class="sd">        external_ins_out_pairs ([[`str`,`str`]]: a list of existing instruction file,</span>
<span class="sd">            model output file pairs to parse</span>
<span class="sd">            observations from and include in the control file.  Default is []</span>
<span class="sd">        extra_pre_cmds ([`str`]): a list of preprocessing commands to add to the forward_run.py script</span>
<span class="sd">            commands are executed with os.system() within forward_run.py. Default is None.</span>
<span class="sd">        redirect_forward_output (`bool`): flag for whether to redirect forward model output to text files (True) or</span>
<span class="sd">            allow model output to be directed to the screen (False).  Default is True</span>
<span class="sd">        extra_post_cmds ([`str`]): a list of post-processing commands to add to the forward_run.py script.</span>
<span class="sd">            Commands are executed with os.system() within forward_run.py. Default is None.</span>
<span class="sd">        tmp_files ([`str`]): a list of temporary files that should be removed at the start of the forward</span>
<span class="sd">            run script.  Default is [].</span>
<span class="sd">        model_exe_name (`str`): binary name to run modflow.  If None, a default from flopy is used,</span>
<span class="sd">            which is dangerous because of the non-standard binary names</span>
<span class="sd">            (e.g. MODFLOW-NWT_x64, MODFLOWNWT, mfnwt, etc). Default is None.</span>
<span class="sd">        build_prior (`bool`): flag to build prior covariance matrix. Default is True</span>
<span class="sd">        sfr_obs (`bool`): flag to include observations of flow and aquifer exchange from</span>
<span class="sd">            the sfr ASCII output file</span>
<span class="sd">        hfb_pars (`bool`): add HFB parameters.  uses pyemu.gw_utils.write_hfb_template().  the resulting</span>
<span class="sd">            HFB pars have parval1 equal to the values in the original file and use the</span>
<span class="sd">            spatial_list_geostruct to build geostatistical covariates between parameters</span>
<span class="sd">        kl_props ([[`str`,[`int`]]]): karhunen-loeve based multiplier parameters.</span>
<span class="sd">            A nested list of KL-based model properties to parameterize using</span>
<span class="sd">            name, iterable pairs.  For 3D properties, the iterable is zero-based</span>
<span class="sd">            layer indices (e.g., [&quot;lpf.hk&quot;,[0,1,2,]] would setup a multiplier</span>
<span class="sd">            parameter for layer property file horizontal hydraulic conductivity for model</span>
<span class="sd">            layers 1,2, and 3 for unique zone values in the ibound array.</span>
<span class="sd">            For time-varying properties (e.g. recharge), the iterable is for</span>
<span class="sd">            zero-based stress period indices.  For example, [&quot;rch.rech&quot;,[0,4,10,15]]</span>
<span class="sd">            would setup zone-based multiplier parameters for recharge for stress</span>
<span class="sd">            period 1,5,11,and 16.</span>
<span class="sd">        kl_num_eig (`int`): the number of KL-based eigenvector multiplier parameters to use for each</span>
<span class="sd">            KL parameter set. default is 100</span>
<span class="sd">        kl_geostruct (`pyemu.geostats.Geostruct`): the geostatistical structure</span>
<span class="sd">            to build the prior parameter covariance matrix</span>
<span class="sd">            elements for KL-based parameters.  If None, a generic GeoStruct is created</span>
<span class="sd">            using an &quot;a&quot; parameter that is 10 times the max cell size.  Default is None</span>


<span class="sd">    Notes:</span>

<span class="sd">        Setup up multiplier parameters for an existing MODFLOW model.</span>

<span class="sd">        Does all kinds of coolness like building a</span>
<span class="sd">        meaningful prior, assigning somewhat meaningful parameter groups and</span>
<span class="sd">        bounds, writes a forward_run.py script with all the calls need to</span>
<span class="sd">        implement multiplier parameters, run MODFLOW and post-process.</span>

<span class="sd">        Works a lot better if TEMPCHEK, INSCHEK and PESTCHEK are available in the</span>
<span class="sd">        system path variable</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">new_model_ws</span><span class="p">,</span><span class="n">org_model_ws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pp_props</span><span class="o">=</span><span class="p">[],</span><span class="n">const_props</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">temporal_bc_props</span><span class="o">=</span><span class="p">[],</span><span class="n">temporal_list_props</span><span class="o">=</span><span class="p">[],</span><span class="n">grid_props</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">grid_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">zone_props</span><span class="o">=</span><span class="p">[],</span><span class="n">pp_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">par_bounds_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sfr_pars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">temporal_sfr_pars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">temporal_list_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">remove_existing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">k_zone_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mflist_waterbudget</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mfhyd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">hds_kperk</span><span class="o">=</span><span class="p">[],</span><span class="n">use_pp_zones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">obssim_smp_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">external_tpl_in_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">external_ins_out_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">extra_pre_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">extra_model_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">extra_post_cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">redirect_forward_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">tmp_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model_exe_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">build_prior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">sfr_obs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">spatial_bc_props</span><span class="o">=</span><span class="p">[],</span><span class="n">spatial_list_props</span><span class="o">=</span><span class="p">[],</span><span class="n">spatial_list_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">hfb_pars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kl_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">kl_num_eig</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">kl_geostruct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;PstFromFlopyModel.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span> <span class="o">=</span> <span class="s2">&quot;_zn&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="o">=</span> <span class="s2">&quot;_gr&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="o">=</span> <span class="s2">&quot;_pp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span> <span class="o">=</span> <span class="s2">&quot;_cn&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span> <span class="o">=</span> <span class="s2">&quot;_kl&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span> <span class="o">=</span> <span class="s2">&quot;arr_org&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span> <span class="o">=</span> <span class="s2">&quot;arr_mlt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_org</span> <span class="o">=</span> <span class="s2">&quot;list_org&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_mlt</span> <span class="o">=</span> <span class="s2">&quot;list_mlt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_run_file</span> <span class="o">=</span> <span class="s2">&quot;forward_run.py&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remove_existing</span> <span class="o">=</span> <span class="n">remove_existing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span> <span class="o">=</span> <span class="n">external_tpl_in_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span> <span class="o">=</span> <span class="n">external_ins_out_pairs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">org_model_ws</span><span class="p">,</span> <span class="n">new_model_ws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_external</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">arr_mult_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_bounds_dict</span> <span class="o">=</span> <span class="n">par_bounds_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span> <span class="o">=</span> <span class="n">pp_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span> <span class="o">=</span> <span class="n">pp_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span> <span class="o">=</span> <span class="n">pp_geostruct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pp_zones</span> <span class="o">=</span> <span class="n">use_pp_zones</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">const_props</span> <span class="o">=</span> <span class="n">const_props</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span> <span class="o">=</span> <span class="n">grid_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span> <span class="o">=</span> <span class="n">grid_geostruct</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zone_props</span> <span class="o">=</span> <span class="n">zone_props</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kl_props</span> <span class="o">=</span> <span class="n">kl_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_geostruct</span> <span class="o">=</span> <span class="n">kl_geostruct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_num_eig</span> <span class="o">=</span> <span class="n">kl_num_eig</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temporal_bc_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temporal_list_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;temporal_bc_props and temporal_list_props. &quot;</span><span class="o">+</span>\
                                   <span class="s2">&quot;temporal_bc_props is deprecated and replaced by temporal_list_props&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;temporal_bc_props is deprecated and replaced by temporal_list_props&quot;</span><span class="p">)</span>
            <span class="n">temporal_list_props</span> <span class="o">=</span> <span class="n">temporal_bc_props</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_bc_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_list_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;spatial_bc_props and spatial_list_props. &quot;</span><span class="o">+</span>\
                                   <span class="s2">&quot;spatial_bc_props is deprecated and replaced by spatial_list_props&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;spatial_bc_props is deprecated and replaced by spatial_list_props&quot;</span><span class="p">)</span>
            <span class="n">spatial_list_props</span> <span class="o">=</span> <span class="n">spatial_bc_props</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_props</span> <span class="o">=</span> <span class="n">temporal_list_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_geostruct</span> <span class="o">=</span> <span class="n">temporal_list_geostruct</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mf">180.0</span><span class="p">)</span> <span class="c1"># 180 correlation length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;temporal_list_geostruct&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_props</span> <span class="o">=</span> <span class="n">spatial_list_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_geostruct</span> <span class="o">=</span> <span class="n">spatial_list_geostruct</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;spatial_list_geostruct&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span> <span class="o">=</span> <span class="n">obssim_smp_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span> <span class="o">=</span> <span class="n">hds_kperk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sfr_obs</span> <span class="o">=</span> <span class="n">sfr_obs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_forward_imports</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">tmp_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp_files</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">tmp_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">tmp_files</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tmp_files</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k_zone_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check if k_zone_dict is a dictionary of dictionaries</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">k_zone_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
                <span class="c1"># loop over outer keys</span>
                <span class="k">for</span> <span class="n">par_key</span> <span class="ow">in</span> <span class="n">k_zone_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">k_zone_dict</span><span class="p">[</span><span class="n">par_key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;k_zone_dict for par </span><span class="si">{1}</span><span class="s2">, layer index not in nlay:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                                               <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">par_key</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;k_zone_dict arr for k </span><span class="si">{0}</span><span class="s2"> for par</span><span class="si">{2}</span><span class="s2"> has wrong shape:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                               <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">par_key</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">k_zone_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;k_zone_dict layer index not in nlay:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                                           <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;k_zone_dict arr for k </span><span class="si">{0}</span><span class="s2"> has wrong shape:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                           <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span> <span class="o">=</span> <span class="n">k_zone_dict</span>

        <span class="c1"># add any extra commands to the forward run lines</span>

        <span class="k">for</span> <span class="n">alist</span><span class="p">,</span><span class="n">ilist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="p">],</span>
                               <span class="p">[</span><span class="n">extra_pre_cmds</span><span class="p">,</span><span class="n">extra_model_cmds</span><span class="p">,</span><span class="n">extra_post_cmds</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">ilist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ilist</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">ilist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ilist</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">ilist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="n">alist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyemu.os_utils.run(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

        <span class="c1"># add the model call</span>

        <span class="k">if</span> <span class="n">model_exe_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_exe_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">exe_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;using flopy binary to execute the model:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">redirect_forward_output</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.os_utils.run(&#39;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> 1&gt;</span><span class="si">{1}</span><span class="s2">.stdout 2&gt;</span><span class="si">{1}</span><span class="s2">.stderr&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_exe_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">namefile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.os_utils.run(&#39;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> &#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_exe_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">namefile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">out_files</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_mult_dirs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mlt_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">org_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlt_dfs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_list_pars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_array_pars</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sfr_pars</span> <span class="ow">and</span> <span class="n">temporal_sfr_pars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;use of `temporal_sfr_pars` requires `sfr_pars`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sfr_pars</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sfr_pars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">sfr_pars</span> <span class="o">=</span> <span class="p">[</span><span class="n">sfr_pars</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sfr_pars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_sfr_pars</span><span class="p">(</span><span class="n">sfr_pars</span><span class="p">,</span> <span class="n">include_temporal_pars</span><span class="o">=</span><span class="n">temporal_sfr_pars</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_sfr_pars</span><span class="p">(</span><span class="n">include_temporal_pars</span><span class="o">=</span><span class="n">temporal_sfr_pars</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hfb_pars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_hfb_pars</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mflist_waterbudget</span> <span class="o">=</span> <span class="n">mflist_waterbudget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mfhyd</span> <span class="o">=</span> <span class="n">mfhyd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_observations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_pst</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">build_prior</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_prior</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parcov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;saving intermediate _setup_&lt;&gt; dfs into </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                 <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;_setup_par_</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">.csv&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;_setup_obs_</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">.csv&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;saving intermediate _setup_&lt;&gt; dfs into </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                 <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;all done&quot;</span><span class="p">)</span>





    <span class="k">def</span> <span class="nf">_setup_sfr_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setup sfr ASCII observations&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfr_obs</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;no sfr package found...&quot;</span><span class="p">)</span>
        <span class="n">org_sfr_out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.sfr.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_sfr_out_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;setup_sfr_obs() error: could not locate existing sfr out file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="n">org_sfr_out_file</span><span class="p">))</span>
        <span class="n">new_sfr_out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">org_sfr_out_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_sfr_out_file</span><span class="p">,</span><span class="n">new_sfr_out_file</span><span class="p">)</span>
        <span class="n">seg_group_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sfr_obs</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="n">seg_group_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfr_obs</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_sfr_obs</span><span class="p">(</span><span class="n">new_sfr_out_file</span><span class="p">,</span><span class="n">seg_group_dict</span><span class="o">=</span><span class="n">seg_group_dict</span><span class="p">,</span>
                                          <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span><span class="n">include_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyemu.gw_utils.apply_sfr_obs()&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_setup_sfr_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_temporal_pars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setup multiplier parameters for sfr segment data</span>
<span class="sd">        Adding support for reachinput (and isfropt = 1)&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;can&#39;t find sfr package...&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">par_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">par_cols</span><span class="p">]</span>
        <span class="n">reach_pars</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># default to False</span>
        <span class="n">seg_pars</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">par_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_sfr_seg_parameters</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">par_cols</span><span class="o">=</span><span class="n">par_cols</span><span class="p">,</span> 
            <span class="n">include_temporal_pars</span><span class="o">=</span><span class="n">include_temporal_pars</span><span class="p">)</span>  <span class="c1"># now just pass model</span>
        <span class="c1"># self.par_dfs[&quot;sfr&quot;] = df</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No sfr segment parameters have been set up&quot;</span><span class="p">,</span> <span class="n">PyemuWarning</span><span class="p">)</span>
            <span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">seg_pars</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">]</span>  <span class="c1"># may need df for both segs and reaches</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_seg_pars.dat.tpl&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_seg_pars.dat&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_temporal_pars</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_seg_temporal_pars.dat.tpl&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_seg_temporal_pars.dat&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">reachinput</span><span class="p">:</span>
            <span class="c1"># if include_temporal_pars:</span>
            <span class="c1">#     raise NotImplementedError(&quot;temporal pars is not set up for reach data style&quot;)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_sfr_reach_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">par_cols</span><span class="o">=</span><span class="n">par_cols</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No sfr reach parameters have been set up&quot;</span><span class="p">,</span> <span class="n">PyemuWarning</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_reach_pars.dat.tpl&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sfr_reach_pars.dat&quot;</span><span class="p">)</span>
                <span class="n">reach_pars</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;pyemu.gw_utils.apply_sfr_parameters(seg_pars=</span><span class="si">{0}</span><span class="s2">, reach_pars=</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seg_pars</span><span class="p">,</span> <span class="n">reach_pars</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No sfr parameters have been set up!&quot;</span><span class="p">,</span> <span class="n">PyemuWarning</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">_setup_hfb_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setup non-mult parameters for hfb (yuck!)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hfb6</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find hfb pak&quot;</span><span class="p">)</span>
        <span class="n">tpl_file</span><span class="p">,</span><span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">write_hfb_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tpl_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;hfb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_setup_mult_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup the directories to use for multiplier parameterization.  Directories</span>
<span class="sd">        are make within the PstFromFlopyModel.m.model_ws directory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># setup dirs to hold the original and multiplier model input quantities</span>
        <span class="n">set_dirs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#        if len(self.pp_props) &gt; 0 or len(self.zone_props) &gt; 0 or \</span>
<span class="c1">#                        len(self.grid_props) &gt; 0:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">zone_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">const_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">kl_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span><span class="p">)</span>
            <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span><span class="p">)</span>
 <span class="c1">#       if len(self.bc_props) &gt; 0:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_props</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_org</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_props</span><span class="p">):</span>
            <span class="n">set_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_mlt</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">set_dirs</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up &#39;</span><span class="si">{0}</span><span class="s2">&#39; dir&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_existing</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">onerror</span><span class="o">=</span><span class="n">remove_readonly</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;dir &#39;</span><span class="si">{0}</span><span class="s2">&#39; already exists&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up &#39;</span><span class="si">{0}</span><span class="s2">&#39; dir&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_setup_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">org_model_ws</span><span class="p">,</span> <span class="n">new_model_ws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup the flopy.mbase instance for use with multipler parameters.</span>
<span class="sd">        Changes model_ws, sets external_path and writes new MODFLOW input</span>
<span class="sd">        files</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">split_new_mws</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_new_mws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;new_model_ws can only be 1 folder-level deep:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">split_new_mws</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading flopy model&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">flopy</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;from_flopy_model() requires flopy&quot;</span><span class="p">)</span>
            <span class="c1"># prepare the flopy model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span> <span class="o">=</span> <span class="n">org_model_ws</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_model_ws</span> <span class="o">=</span> <span class="n">new_model_ws</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">model_ws</span><span class="o">=</span><span class="n">org_model_ws</span><span class="p">,</span>
                                                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">forgive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;loading flopy model&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_model_ws</span> <span class="o">=</span> <span class="n">new_model_ws</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;updating model attributes&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">array_free_format</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">free_format_input</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;updating model attributes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_existing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;&#39;new_model_ws&#39; already exists&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;removing existing &#39;new_model_ws&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">pyemu</span><span class="o">.</span><span class="n">os_utils</span><span class="o">.</span><span class="n">_remove_readonly</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">change_model_ws</span><span class="p">(</span><span class="n">new_model_ws</span><span class="p">,</span><span class="n">reset_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">exe_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">exe_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.exe&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">exe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing new modflow input files&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">write_input</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing new modflow input files&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get the latest counter for a certain parameter type.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlt_counter</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">#print(name,c)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">_prep_mlt_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  prepare multipler arrays.  Copies existing model input arrays and</span>
<span class="sd">        writes generic (ones) multiplier arrays</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">par_props</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">zone_props</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">const_props</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">kl_props</span><span class="p">]</span>
        <span class="n">par_suffixs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">]</span>

        <span class="c1"># Need to remove props and suffixes for which no info was provided (e.g. still None)</span>
        <span class="n">del_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">par_props</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">del_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">del_idx</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">del</span><span class="p">(</span><span class="n">par_props</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">del</span><span class="p">(</span><span class="n">par_suffixs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">mlt_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">par_prop</span><span class="p">,</span><span class="n">suffix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">par_props</span><span class="p">,</span><span class="n">par_suffixs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_prop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_prop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">par_prop</span> <span class="o">=</span> <span class="p">[</span><span class="n">par_prop</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_prop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">pakattr</span><span class="p">,</span><span class="n">k_org</span> <span class="ow">in</span> <span class="n">par_prop</span><span class="p">:</span>
                <span class="n">attr_name</span> <span class="o">=</span> <span class="n">pakattr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pak</span><span class="p">,</span><span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_pakattr</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
                <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Transient2d</span><span class="p">):</span>
                    <span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nper</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">k_parse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_k</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span> <span class="n">ks</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error parsing k </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">org</span><span class="p">,</span><span class="n">mlt</span><span class="p">,</span><span class="n">mod</span><span class="p">,</span><span class="n">layer</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_count</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
                <span class="n">mlt_prefix</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="n">mlt_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.dat</span><span class="si">{1}</span><span class="s2">&quot;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_prefix</span><span class="p">,</span><span class="n">suffix</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_parse</span><span class="p">:</span>
                    <span class="c1"># horrible kludge to avoid passing int64 to flopy</span>
                    <span class="c1"># this gift may give again...</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Util2d</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_u2d</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

                        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Util3d</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_u2d</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Transient2d</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_u2d</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">transient_2ds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#big assumption here</span>
                    <span class="n">mod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span><span class="p">,</span><span class="n">fname</span><span class="p">))</span>
                    <span class="n">mlt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlt_name</span><span class="p">)</span>
                    <span class="n">org</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span><span class="p">,</span><span class="n">fname</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;org_file&quot;</span><span class="p">:</span><span class="n">org</span><span class="p">,</span><span class="s2">&quot;mlt_file&quot;</span><span class="p">:</span><span class="n">mlt</span><span class="p">,</span><span class="s2">&quot;model_file&quot;</span><span class="p">:</span><span class="n">mod</span><span class="p">,</span><span class="s2">&quot;layer&quot;</span><span class="p">:</span><span class="n">layer</span><span class="p">})</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;suffix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suffix</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlt_prefix</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;attr_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_name</span>
                <span class="n">mlt_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlt_dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mlt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">mlt_dfs</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mlt_df</span>

    <span class="k">def</span> <span class="nf">_write_u2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u2d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a flopy.utils.Util2D instance to an ASCII text file using the</span>
<span class="sd">        Util2D filename</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">u2d</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_org</span><span class="p">,</span><span class="n">filename</span><span class="p">),</span>
                   <span class="n">u2d</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">_write_const_tpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">,</span> <span class="n">zn_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a template file a for a constant (uniform) multiplier parameter</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; 1.0  &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;zone pname too long for pest:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                        <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; ~   </span><span class="si">{0}</span><span class="s2">    ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">parnme</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
        <span class="c1">#df.loc[:,&quot;pargp&quot;] = &quot;{0}{1}&quot;.format(self.cn_suffixname)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="n">name</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_write_grid_tpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">,</span> <span class="n">zn_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write a template file a for grid-based multiplier parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parnme</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="p">[],[],[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">tpl_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s1">&#39; 1.0 &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1:03d}{2:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;grid pname too long for pest:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                        <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s1">&#39; ~     </span><span class="si">{0}</span><span class="s1">   ~ &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">parnme</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span><span class="n">name</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
        <span class="k">return</span> <span class="n">df</span>



    <span class="k">def</span> <span class="nf">_grid_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; prepare grid-based parameterizations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;grid_geostruct is None,&quot;</span>\
                  <span class="s2">&quot; using ExpVario with contribution=1 and a=(max(delc,delr)*10&quot;</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;grid_geostruct&quot;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pp_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mlt_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; prepare pilot point based parameterization</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pp_space is None, using 10...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span><span class="o">=</span><span class="mi">10</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pp_geostruct is None,&quot;</span>\
                  <span class="s2">&quot; using ExpVario with contribution=1 and a=(pp_space*max(delr,delc))&quot;</span><span class="p">)</span>
            <span class="n">pp_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">pp_dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;pp_geostruct&quot;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

        <span class="n">pp_df</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">,:]</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">pp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">layer</span><span class="o">==</span><span class="n">l</span><span class="p">,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">}</span>
        <span class="c1"># big assumption here - if prefix is listed more than once, use the lowest layer index</span>
        <span class="n">pp_dict_sort</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pp_dict</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">pp_dict_sort</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">pl</span>
            <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pp_dict</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pp</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">d</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">pp_dict_sort</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">pp_dict</span> <span class="o">=</span> <span class="n">pp_dict_sort</span>


        <span class="n">pp_array_file</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">m</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">pp_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;pp_dict: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pp_dict</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling setup_pilot_point_grid()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pp_zones</span><span class="p">:</span>
            <span class="c1"># check if k_zone_dict is a dictionary of dictionaries</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
                <span class="n">ib</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">k_dict</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">k_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">attr_name</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ib</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                        <span class="k">if</span> <span class="s1">&#39;general_zn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ib</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Dictionary of dictionaries passed as zones, </span><span class="si">{0}</span><span class="s2"> not in keys: </span><span class="si">{1}</span><span class="s2">. &quot;</span>
                                          <span class="s2">&quot;Will use ibound for zones&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ib</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">PyemuWarning</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span>
                                <span class="s2">&quot;Dictionary of dictionaries passed as pp zones, &quot;</span>
                                <span class="s2">&quot;using &#39;general_zn&#39; for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))</span>
                    <span class="k">if</span> <span class="s1">&#39;general_zn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ib</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">ib</span><span class="p">[</span><span class="s1">&#39;general_zn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">array</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ib</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;general_zn&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">a</span><span class="p">[</span><span class="n">a</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">ib</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="n">ib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">u</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">counts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">mx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0e+10</span>
                    <span class="n">imx</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">mx</span><span class="p">:</span>
                            <span class="n">mx</span> <span class="o">=</span> <span class="n">c</span>
                            <span class="n">imx</span> <span class="o">=</span> <span class="n">u</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;resetting negative ibound values for PP zone&quot;</span><span class="o">+</span> \
                                     <span class="s2">&quot;array in layer </span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">u</span><span class="p">))</span>
                    <span class="n">i</span><span class="p">[</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;general_zn&#39;</span><span class="p">:</span> <span class="n">ib</span><span class="p">}</span>
        <span class="n">pp_df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">pp_utils</span><span class="o">.</span><span class="n">setup_pilotpoints_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                                         <span class="n">ibound</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span>
                                         <span class="n">use_ibound_zones</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pp_zones</span><span class="p">,</span>
                                         <span class="n">prefix_dict</span><span class="o">=</span><span class="n">pp_dict</span><span class="p">,</span>
                                         <span class="n">every_n_cell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_space</span><span class="p">,</span>
                                         <span class="n">pp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                         <span class="n">tpl_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                         <span class="n">shapename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;pp.shp&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> pilot point parameters created&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;pilot point &#39;pargp&#39;:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling setup_pilot_point_grid()&quot;</span><span class="p">)</span>

        <span class="c1"># calc factors for each layer</span>
        <span class="n">pargp</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">pp_dfs_k</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fac_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pp_processed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="k">for</span> <span class="n">pg</span> <span class="ow">in</span> <span class="n">pargp</span><span class="p">:</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pg</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;something is wrong in fac calcs for par group </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pg</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ib</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>  <span class="c1"># check is dict of dicts</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">pg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ib</span><span class="o">.</span><span class="n">keys</span><span class="p">()]):</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ib</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">pg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                        <span class="c1"># get dict relating to parameter prefix</span>
                        <span class="n">ib_k</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="s1">&#39;general_zn&#39;</span>
                        <span class="n">ib_k</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ib_k</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># TODO</span>
                <span class="c1">#self.logger.lraise(&quot;something is wrong in fac calcs for par group {0}&quot;.format(pg))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;multiple k values for </span><span class="si">{0}</span><span class="s2">,forming composite zone array...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pg</span><span class="p">))</span>
                <span class="n">ib_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="s2">&quot;general_zn&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ib_k</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">kattr_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">kp_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kp_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp_dfs_k</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calculating factors for p=</span><span class="si">{0}</span><span class="s2">, k=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                <span class="n">fac_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;pp_k</span><span class="si">{0}</span><span class="s2">.fac&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kattr_id</span><span class="p">))</span>
                <span class="n">var_file</span> <span class="o">=</span> <span class="n">fac_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.fac&quot;</span><span class="p">,</span> <span class="s2">&quot;.var.dat&quot;</span><span class="p">)</span>
                <span class="n">pp_df_k</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span> <span class="o">==</span> <span class="n">pg</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">kattr_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp_processed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;saving krige variance file:</span><span class="si">{0}</span><span class="s2">&quot;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_file</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;saving krige factors file:</span><span class="si">{0}</span><span class="s2">&quot;</span>
                                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fac_file</span><span class="p">))</span>
                    <span class="n">ok_pp</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">OrdinaryKrige</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span><span class="p">,</span> <span class="n">pp_df_k</span><span class="p">)</span>
                    <span class="n">ok_pp</span><span class="o">.</span><span class="n">calc_factors_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span> <span class="n">var_filename</span><span class="o">=</span><span class="n">var_file</span><span class="p">,</span> <span class="n">zone_array</span><span class="o">=</span><span class="n">ib_k</span><span class="p">,</span><span class="n">num_threads</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">ok_pp</span><span class="o">.</span><span class="n">to_grid_factors_file</span><span class="p">(</span><span class="n">fac_file</span><span class="p">)</span>
                    <span class="n">pp_processed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">kattr_id</span><span class="p">)</span>
                <span class="n">fac_files</span><span class="p">[</span><span class="n">kp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calculating factors for p=</span><span class="si">{0}</span><span class="s2">, k=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                <span class="n">pp_dfs_k</span><span class="p">[</span><span class="n">kp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df_k</span>

        <span class="k">for</span> <span class="n">kp_id</span><span class="p">,</span> <span class="n">fac_file</span> <span class="ow">in</span> <span class="n">fac_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kp_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pp_prefix</span> <span class="o">=</span> <span class="n">kp_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#pp_files = pp_df.pp_filename.unique()</span>
            <span class="n">fac_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fac_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># pp_prefixes = pp_dict[k]</span>
            <span class="c1"># for pp_prefix in pp_prefixes:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing pp_prefix:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pp_prefix</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">pp_prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp_array_file</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> not in self.pp_array_file.keys()&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="o">.</span>
                                          <span class="n">join</span><span class="p">(</span><span class="n">pp_array_file</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>


            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arr_mlt</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pp_array_file</span><span class="p">[</span><span class="n">pp_prefix</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">pp_files</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pp_filename</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pp_prefix</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span><span class="s2">&quot;pp_filename&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pp_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of pp_files found:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pp_files</span><span class="p">)))</span>
            <span class="n">pp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pp_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_file</span>
            <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s2">&quot;pp_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_file</span>
            <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pp_prefix</span><span class="p">,</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_file</span>

        <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;pp_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">out_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span>
                    <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">)),</span><span class="s2">&quot;mlt_file&quot;</span><span class="p">]</span>
        <span class="c1">#mlt_df.loc[:,&quot;fac_file&quot;] = np.NaN</span>
        <span class="c1">#mlt_df.loc[:,&quot;pp_file&quot;] = np.NaN</span>
        <span class="k">for</span> <span class="n">out_file</span> <span class="ow">in</span> <span class="n">out_files</span><span class="p">:</span>
            <span class="n">pp_df_pf</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">out_file</span><span class="o">==</span><span class="n">out_file</span><span class="p">,:]</span>
            <span class="n">fac_files</span> <span class="o">=</span> <span class="n">pp_df_pf</span><span class="o">.</span><span class="n">fac_file</span>
            <span class="k">if</span> <span class="n">fac_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of fac files:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fac_files</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
            <span class="n">fac_file</span> <span class="o">=</span> <span class="n">fac_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pp_files</span> <span class="o">=</span> <span class="n">pp_df_pf</span><span class="o">.</span><span class="n">pp_file</span>
            <span class="k">if</span> <span class="n">pp_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of pp files:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pp_files</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
            <span class="n">pp_file</span> <span class="o">=</span> <span class="n">pp_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">out_file</span><span class="p">,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_file</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">out_file</span><span class="p">,</span><span class="s2">&quot;pp_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_df</span>

        <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>


    <span class="k">def</span> <span class="nf">_kl_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mlt_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; prepare KL based parameterizations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_geostruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;kl_geostruct is None,&quot;</span>\
                  <span class="s2">&quot; using ExpVario with contribution=1 and a=(10.0*max(delr,delc))&quot;</span><span class="p">)</span>
            <span class="n">kl_dist</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">ExpVario</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">kl_dist</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kl_geostruct</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">GeoStruct</span><span class="p">(</span><span class="n">variograms</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;kl_geostruct&quot;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

        <span class="n">kl_df</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">,:]</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">kl_df</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="c1">#kl_dict = {l:list(kl_df.loc[kl_df.layer==l,&quot;prefix&quot;].unique()) for l in layers}</span>
        <span class="c1"># big assumption here - if prefix is listed more than once, use the lowest layer index</span>
        <span class="c1">#for i,l in enumerate(layers):</span>
        <span class="c1">#    p = set(kl_dict[l])</span>
        <span class="c1">#    for ll in layers[i+1:]:</span>
        <span class="c1">#        pp = set(kl_dict[ll])</span>
        <span class="c1">#        d = pp - p</span>
        <span class="c1">#        kl_dict[ll] = list(d)</span>
        <span class="n">kl_prefix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kl_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;prefix&quot;</span><span class="p">])</span>

        <span class="n">kl_array_file</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">m</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kl_df</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span><span class="n">kl_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;kl_prefix: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kl_prefix</span><span class="p">)))</span>

        <span class="n">fac_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;kl.fac&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling kl_setup() with factors file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fac_file</span><span class="p">))</span>

        <span class="n">kl_df</span> <span class="o">=</span> <span class="n">kl_setup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_num_eig</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_geostruct</span><span class="p">,</span><span class="n">kl_prefix</span><span class="p">,</span>
                         <span class="n">factors_file</span><span class="o">=</span><span class="n">fac_file</span><span class="p">,</span><span class="n">basis_file</span><span class="o">=</span><span class="n">fac_file</span><span class="o">+</span><span class="s2">&quot;.basis.jcb&quot;</span><span class="p">,</span>
                         <span class="n">tpl_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> kl parameters created&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="n">kl_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;kl &#39;pargp&#39;:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kl_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;calling kl_setup() with factors file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fac_file</span><span class="p">))</span>
        <span class="n">kl_mlt_df</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">kl_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">prefix_df</span> <span class="o">=</span> <span class="n">kl_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kl_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,:]</span>
            <span class="n">in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prefix_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;in_file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;pp_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_file</span>
            <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">prefix</span><span class="o">==</span><span class="n">prefix</span><span class="p">,</span><span class="s2">&quot;fac_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fac_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">kl_mlt_df</span><span class="p">)</span>
        <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">,</span> <span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">kl_df</span>
        <span class="c1"># calc factors for each layer</span>


    <span class="k">def</span> <span class="nf">_setup_array_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; main entry point for setting up array multipler parameters</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mlt_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_mlt_arrays</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mlt_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.tpl&quot;</span><span class="p">)</span>
        <span class="c1">#mlt_df.loc[mlt_df.tpl_file.apply(lambda x:pd.notnull(x.pp_file)),&quot;tpl_file&quot;] = np.NaN</span>
        <span class="n">mlt_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="c1">#for suffix,tpl_file,layer,name in zip(self.mlt_df.suffix,</span>
        <span class="c1">#                                 self.mlt_df.tpl,self.mlt_df.layer,</span>
        <span class="c1">#                                     self.mlt_df.prefix):</span>
        <span class="n">par_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mlt_file</span> <span class="ow">in</span> <span class="n">mlt_files</span><span class="p">:</span>
            <span class="n">suffixes</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;suffix&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">suffixes</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of suffixes for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffixes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">tpl_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of tpl_files for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span>
            <span class="c1">#if layers.unique().shape[0] != 1:</span>
            <span class="c1">#    self.logger.lraise(&quot;wrong number of layers for {0}&quot;\</span>
            <span class="c1">#                       .format(mlt_file))</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">==</span><span class="n">mlt_file</span><span class="p">,</span><span class="s2">&quot;prefix&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">names</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of names for </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">attr_names</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span> <span class="o">==</span> <span class="n">mlt_file</span><span class="p">,</span> <span class="s2">&quot;attr_name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attr_names</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of attr_names for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">attr_name</span> <span class="o">=</span> <span class="n">attr_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1">#ib = self.k_zone_dict[layer]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing const tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="c1">#df = self.write_const_tpl(name,tpl_file,self.m.bas6.ibound[layer].array)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">write_const_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn_suffix</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error writing const template: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing const tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing grid tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="c1">#df = self.write_grid_tpl(name,tpl_file,self.m.bas6.ibound[layer].array)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">write_grid_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">ibound</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error writing grid template: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing grid tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">suffix</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing zone tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>  <span class="c1"># check is dict of dicts</span>
                    <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                        <span class="n">k_zone_dict</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">k_dict</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">k_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                           <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr_name</span><span class="p">)</span>  <span class="c1"># get dict relating to parameter prefix</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="s1">&#39;general_zn&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> \
                            <span class="s2">&quot;Neither </span><span class="si">{0}</span><span class="s2"> nor &#39;general_zn&#39; are in k_zone_dict keys: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span>
                                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="n">k_zone_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span><span class="p">[</span><span class="s1">&#39;general_zn&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">k_zone_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_zone_dict</span>
                <span class="c1">#df = self.write_zone_tpl(self.m, name, tpl_file, self.k_zone_dict[layer], self.zn_suffix, self.logger)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">write_zone_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">zn_suffix</span><span class="p">,</span>
                                        <span class="n">k_zone_dict</span><span class="p">[</span><span class="n">layer</span><span class="p">],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error writing zone template: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing zone tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par_dfs</span><span class="p">:</span>
                <span class="n">par_dfs</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">par_dfs</span><span class="p">[</span><span class="n">suffix</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">suf</span><span class="p">,</span><span class="n">dfs</span> <span class="ow">in</span> <span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="n">suf</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up pilot point process&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pp_prep</span><span class="p">(</span><span class="n">mlt_df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up pilot point process&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up grid process&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_grid_prep</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up grid process&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_suffix</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up kl process&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kl_prep</span><span class="p">(</span><span class="n">mlt_df</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;setting up kl process&quot;</span><span class="p">)</span>

        <span class="n">mlt_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;arr_pars.csv&quot;</span><span class="p">))</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">mlt_file</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;save test mlt array </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">mlt_file</span><span class="p">),</span>
                       <span class="n">ones</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;save test mlt array </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">tpl_files</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mlt_df</span><span class="o">.</span><span class="n">mlt_file</span> <span class="o">==</span> <span class="n">mlt_file</span><span class="p">,</span> <span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;wrong number of tpl_files for </span><span class="si">{0}</span><span class="s2">&quot;</span> \
                                   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">))</span>
            <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">tpl_files</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlt_file</span><span class="p">)</span>

        <span class="c1"># for tpl_file,mlt_file in zip(mlt_df.tpl_file,mlt_df.mlt_file):</span>
        <span class="c1">#     if pd.isnull(tpl_file):</span>
        <span class="c1">#         continue</span>
        <span class="c1">#     self.tpl_files.append(tpl_file)</span>
        <span class="c1">#     self.in_files.append(mlt_file)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apply_array_pars</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error test running apply_array_pars():</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.helpers.apply_array_pars()</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; main entry point for setting up observations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs_methods</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_setup_water_budget_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_hyd</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_setup_smp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_hob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_hds</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_setup_sfr_obs</span><span class="p">]</span>
        <span class="n">obs_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mflist water budget obs&quot;</span><span class="p">,</span><span class="s2">&quot;hyd file&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;external obs-sim smp files&quot;</span><span class="p">,</span><span class="s2">&quot;hob&quot;</span><span class="p">,</span><span class="s2">&quot;hds&quot;</span><span class="p">,</span><span class="s2">&quot;sfr&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">obs_method</span><span class="p">,</span> <span class="n">obs_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_methods</span><span class="p">,</span><span class="n">obs_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing obs type </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_type</span><span class="p">))</span>
            <span class="n">obs_method</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing obs type </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_type</span><span class="p">))</span>



<div class="viewcode-block" id="PstFromFlopyModel.draw"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.PstFromFlopyModel.draw">[docs]</a>    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_reals</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">sigma_range</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">use_specsim</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; draw from the geostatistically-implied parameter covariance matrix</span>

<span class="sd">        Args:</span>
<span class="sd">            num_reals (`int`): number of realizations to generate. Default is 100</span>
<span class="sd">            sigma_range (`float`): number of standard deviations represented by</span>
<span class="sd">                the parameter bounds.  Default is 6.</span>
<span class="sd">            use_specsim (`bool`): flag to use spectral simulation for grid-based</span>
<span class="sd">                parameters.  Requires a regular grid but is wicked fast.  Default is False</span>

<span class="sd">        Notes:</span>
<span class="sd">            operates on parameters by groups to avoid having to construct a very large</span>
<span class="sd">            covariance matrix for problems with more the 30K parameters.</span>

<span class="sd">            uses `helpers.geostatitical_draw()`</span>

<span class="sd">        Returns:</span>
<span class="sd">            `pyemu.ParameterEnsemble`: The realized parameter ensemble</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;drawing realizations&quot;</span><span class="p">)</span>
        <span class="n">struct_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">gr_par_pe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">]</span>
            <span class="n">pp_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="n">pp_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#pp_dfs = [pp_df.loc[pp_df.pargp==pargp,:].copy() for pargp in pp_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_dfs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">gr_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_specsim</span><span class="p">:</span>
                <span class="n">gr_dfs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                    <span class="n">gp_df</span> <span class="o">=</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                    <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                    <span class="n">gr_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
                <span class="c1">#gr_dfs = [gr_df.loc[gr_df.pargp==pargp,:].copy() for pargp in gr_df.pargp.unique()]</span>
                <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">gr_dfs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">SpecSim2d</span><span class="o">.</span><span class="n">grid_is_regular</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;draw() error: can&#39;t use spectral simulation with irregular grid&quot;</span><span class="p">)</span>
                <span class="n">gr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;i&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">gr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;j&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]))</span>
                <span class="k">if</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;draw(): error parsing grid par names for &#39;i&#39; index&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">j</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">j</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;draw(): error parsing grid par names for &#39;j&#39; index&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;spectral simulation for grid-scale pars&quot;</span><span class="p">)</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">SpecSim2d</span><span class="p">(</span><span class="n">delx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delr</span><span class="o">.</span><span class="n">array</span><span class="p">,</span><span class="n">dely</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">delc</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
                                              <span class="n">geostruct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span><span class="p">)</span>
                <span class="n">gr_par_pe</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">grid_par_ensemble_helper</span><span class="p">(</span><span class="n">pst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span><span class="n">gr_df</span><span class="o">=</span><span class="n">gr_df</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="n">num_reals</span><span class="p">,</span>
                                                        <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">,</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;spectral simulation for grid-scale pars&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;temporal_list&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;temporal_list&quot;</span><span class="p">]</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">timedelta</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
            <span class="n">bc_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="c1">#print(p_df)</span>
                <span class="n">bc_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#bc_dfs = [bc_df.loc[bc_df.pargp==pargp,:].copy() for pargp in bc_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;spatial_list&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;spatial_list&quot;</span><span class="p">]</span>
            <span class="n">bc_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="c1">#p_df = gp_df.drop_duplicates(subset=&quot;parnme&quot;)</span>
                <span class="c1">#print(p_df)</span>
                <span class="n">bc_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gp_df</span><span class="p">)</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_dfs</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">geostatistical_draws</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span><span class="n">struct_dict</span><span class="o">=</span><span class="n">struct_dict</span><span class="p">,</span><span class="n">num_reals</span><span class="o">=</span><span class="n">num_reals</span><span class="p">,</span>
                             <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gr_par_pe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pe</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">gr_par_pe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">gr_par_pe</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;drawing realizations&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pe</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.build_prior"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.PstFromFlopyModel.build_prior">[docs]</a>    <span class="k">def</span> <span class="nf">build_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">droptol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">sigma_range</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; build and optionally save the prior parameter covariance matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            fmt (`str`, optional): the format to save the cov matrix.  Options are &quot;ascii&quot;,&quot;binary&quot;,&quot;uncfile&quot;, &quot;coo&quot;.</span>
<span class="sd">                Default is &quot;ascii&quot;.  If &quot;none&quot; (lower case string, not None), then no file is created.</span>
<span class="sd">            filename (`str`, optional): the filename to save the prior cov matrix to.  If None, the name is formed using</span>
<span class="sd">                model nam_file name.  Default is None.</span>
<span class="sd">            droptol (`float`, optional): tolerance for dropping near-zero values when writing compressed binary.</span>
<span class="sd">                Default is None.</span>
<span class="sd">            chunk (`int`, optional): chunk size to write in a single pass - for binary only.  Default</span>
<span class="sd">                is None (no chunking).</span>
<span class="sd">            sigma_range (`float`): number of standard deviations represented by the parameter bounds.  Default</span>
<span class="sd">                is 6.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `pyemu.Cov`: the full prior parameter covariance matrix, generated by processing parameters by</span>
<span class="sd">            groups</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">acc_fmts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span><span class="s2">&quot;uncfile&quot;</span><span class="p">,</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="s2">&quot;coo&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acc_fmts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;unrecognized prior save &#39;fmt&#39;:</span><span class="si">{0}</span><span class="s2">, options are: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                               <span class="nb">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">acc_fmts</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building prior covariance matrix&quot;</span><span class="p">)</span>
        <span class="n">struct_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">pp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_suffix</span><span class="p">]</span>
            <span class="n">pp_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">pp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pp_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="n">pp_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#pp_dfs = [pp_df.loc[pp_df.pargp==pargp,:].copy() for pargp in pp_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pp_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_dfs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">gr_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gr_suffix</span><span class="p">]</span>
            <span class="n">gr_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">gr_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gr_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="n">gr_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#gr_dfs = [gr_df.loc[gr_df.pargp==pargp,:].copy() for pargp in gr_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">gr_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;temporal_list&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;temporal_list&quot;</span><span class="p">]</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">timedelta</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
            <span class="n">bc_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="n">p_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;parnme&quot;</span><span class="p">)</span>
                <span class="c1">#print(p_df)</span>
                <span class="n">bc_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_df</span><span class="p">)</span>
            <span class="c1">#bc_dfs = [bc_df.loc[bc_df.pargp==pargp,:].copy() for pargp in bc_df.pargp.unique()]</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;spatial_list&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bc_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;spatial_list&quot;</span><span class="p">]</span>
            <span class="n">bc_dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pargp</span> <span class="ow">in</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">gp_df</span> <span class="o">=</span> <span class="n">bc_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bc_df</span><span class="o">.</span><span class="n">pargp</span><span class="o">==</span><span class="n">pargp</span><span class="p">,:]</span>
                <span class="c1">#p_df = gp_df.drop_duplicates(subset=&quot;parnme&quot;)</span>
                <span class="c1">#print(p_df)</span>
                <span class="n">bc_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gp_df</span><span class="p">)</span>
            <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_dfs</span>
        <span class="k">if</span> <span class="s2">&quot;hfb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_geostruct</span> <span class="ow">in</span> <span class="n">struct_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_geostruct</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;hfb&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">struct_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_geostruct</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;hfb&quot;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="s2">&quot;sfr&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;geospatial prior not implemented for SFR pars&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">geostatistical_prior_builder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span>
                                                             <span class="n">struct_dict</span><span class="o">=</span><span class="n">struct_dict</span><span class="p">,</span>
                                                             <span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Cov</span><span class="o">.</span><span class="n">from_parameter_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst</span><span class="p">,</span><span class="n">sigma_range</span><span class="o">=</span><span class="n">sigma_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="o">+</span><span class="s2">&quot;.prior.cov&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;saving prior covariance matrix to file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;ascii&#39;</span><span class="p">:</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">to_ascii</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">to_binary</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">droptol</span><span class="o">=</span><span class="n">droptol</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;uncfile&#39;</span><span class="p">:</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">to_uncfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;coo&#39;</span><span class="p">:</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">to_coo</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">droptol</span><span class="o">=</span><span class="n">droptol</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;building prior covariance matrix&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cov</span></div>

<div class="viewcode-block" id="PstFromFlopyModel.build_pst"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.PstFromFlopyModel.build_pst">[docs]</a>    <span class="k">def</span> <span class="nf">build_pst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; build the pest control file using the parameters and</span>
<span class="sd">        observations.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (`str`): the filename to save the contorl file to.  If None, the</span>
<span class="sd">                name if formed from the model namfile name.  Default is None.  The control</span>
<span class="sd">                is saved in the `PstFromFlopy.m.model_ws` directory.</span>
<span class="sd">        Notes:</span>

<span class="sd">            calls pyemu.Pst.from_io_files</span>

<span class="sd">            calls PESTCHEK</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;changing dir in to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="n">tpl_files</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">)</span>
        <span class="n">in_files</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">new_tpl_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tpl_files</span><span class="p">]</span>
            <span class="n">new_in_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tpl&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">new_tpl_files</span><span class="p">]</span>
            <span class="n">tpl_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_tpl_files</span><span class="p">)</span>
            <span class="n">in_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_in_files</span><span class="p">)</span>
            <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">)]</span>
            <span class="n">out_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ins&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ins_files</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tpl_file</span><span class="p">,</span><span class="n">in_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tpl_files</span><span class="p">,</span><span class="n">in_files</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tpl_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ins_file</span><span class="p">,</span><span class="n">out_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ins_files</span><span class="p">,</span><span class="n">out_files</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;instantiating control file from i/o files&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;tpl files: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;ins files: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">)))</span>
            <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="o">.</span><span class="n">from_io_files</span><span class="p">(</span><span class="n">tpl_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="p">,</span>
                                          <span class="n">in_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span>
                                          <span class="n">ins_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ins_files</span><span class="p">,</span>
                                          <span class="n">out_files</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_files</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;instantiating control file from i/o files&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error build Pst:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
        <span class="c1"># more customization here</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;parnme&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span>

        <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span>
        <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;parnme&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;parubnd&quot;</span><span class="p">,</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">tag</span><span class="p">,[</span><span class="n">lw</span><span class="p">,</span><span class="n">up</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wildass_guess_par_bounds_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span>
            <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lw</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_bounds_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,[</span><span class="n">lw</span><span class="p">,</span><span class="n">up</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_bounds_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">up</span>
                <span class="n">par</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)),</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lw</span>



        <span class="n">obs</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">observation_data</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;obsnme&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.pst&quot;</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">model_command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;python forward_run.py&quot;</span><span class="p">]</span>
        <span class="n">pst</span><span class="o">.</span><span class="n">control_data</span><span class="o">.</span><span class="n">noptmax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing forward_run.py&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_forward_run</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;writing forward_run.py&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;writing pst </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">pst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pst</span> <span class="o">=</span> <span class="n">pst</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;running pestchek on </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pyemu</span><span class="o">.</span><span class="n">os_utils</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;pestchek </span><span class="si">{0}</span><span class="s2"> &gt;pestchek.stdout&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;error running pestchek:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;pestchek.stdout&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;pestcheck:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;running pestchek on </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pst_name</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_add_external</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; add external (existing) template files and/or instruction files to the</span>
<span class="sd">        Pst instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">external_tpl_in_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tpl_file</span><span class="p">,</span><span class="n">in_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_tpl_in_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find external tpl file:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                       <span class="nb">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;external tpl:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">))</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">in_file</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">external_ins_out_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ins_file</span><span class="p">,</span><span class="n">out_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_ins_out_pairs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ins_file</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find external ins file:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                       <span class="nb">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;external ins:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                   <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;obs listed in </span><span class="si">{0}</span><span class="s2"> will have values listed in </span><span class="si">{1}</span><span class="s2">&quot;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="n">out_file</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;obs listed in </span><span class="si">{0}</span><span class="s2"> will have generic values&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="PstFromFlopyModel.write_forward_run"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.PstFromFlopyModel.write_forward_run">[docs]</a>    <span class="k">def</span> <span class="nf">write_forward_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write the forward run script forward_run.py</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method can be called repeatedly, especially after any</span>
<span class="sd">            changed to the pre- and/or post-processing routines.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_run_file</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;import os</span><span class="se">\n</span><span class="s2">import numpy as np</span><span class="se">\n</span><span class="s2">import pandas as pd</span><span class="se">\n</span><span class="s2">import flopy</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;import pyemu</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ex_imp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_forward_imports</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;import </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex_imp</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">tmp_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;try:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   os.remove(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;except Exception as e:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;   print(&#39;error removing tmp file:</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frun_model_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_parse_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; parse the iterable from a property or boundary condition argument</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">,</span><span class="s2">&quot;k </span><span class="si">{0}</span><span class="s2"> not in vals&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error slicing vals with </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                                <span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">k_vals</span>

    <span class="k">def</span> <span class="nf">_parse_pakattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pakattr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; parse package-iterable pairs from a property or boundary condition</span>
<span class="sd">        argument</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">raw</span> <span class="o">=</span> <span class="n">pakattr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;pakattr is wrong:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pakattr</span><span class="p">))</span>
        <span class="n">pakname</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">attrname</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="n">pakname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pak</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pakname</span> <span class="o">==</span> <span class="s2">&quot;extra&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;&#39;extra&#39; pak detected:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pakattr</span><span class="p">))</span>
                <span class="n">ud</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Util3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="n">attrname</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;extra&quot;</span><span class="p">,</span><span class="n">ud</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;pak </span><span class="si">{0}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pakname</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="n">attrname</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="n">attrname</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pak</span><span class="p">,</span><span class="n">attr</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="s2">&quot;stress_period_data&quot;</span><span class="p">):</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">stress_period_data</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">if</span> <span class="n">attrname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;attr </span><span class="si">{0}</span><span class="s2"> not found in dtype.names for </span><span class="si">{1}</span><span class="s2">.stress_period_data&quot;</span><span class="o">.</span>\
                                  <span class="nb">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span><span class="n">pakname</span><span class="p">))</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">stress_period_data</span>
            <span class="k">return</span> <span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">attrname</span>
        <span class="c1"># elif hasattr(pak,&#39;hfb_data&#39;):</span>
        <span class="c1">#     dtype = pak.hfb_data.dtype</span>
        <span class="c1">#     if attrname not in dtype.names:</span>
        <span class="c1">#         self.logger.lraise(&#39;attr {0} not found in dtypes.names for {1}.hfb_data. Thanks for playing.&#39;.\</span>
        <span class="c1">#                            format(attrname,pakname))</span>
        <span class="c1">#     attr = pak.hfb_data</span>
        <span class="c1">#     return pak, attr, attrname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;unrecognized attr:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attrname</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">_setup_list_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; main entry point for setting up list multiplier</span>
<span class="sd">                parameters</span>

<span class="sd">                &quot;&quot;&quot;</span>
        <span class="n">tdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_temporal_list_pars</span><span class="p">()</span>
        <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_spatial_list_pars</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tdf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apply_list_pars</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;error test running apply_list_pars():</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.helpers.apply_list_pars()</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_pre_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_temporal_list_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing temporal_list_props&quot;</span><span class="p">)</span>
        <span class="n">bc_filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_pak</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_k</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_dtype_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_props</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_props</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_props</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pakattr</span><span class="p">,</span><span class="n">k_org</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_list_props</span><span class="p">:</span>
            <span class="n">pak</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_pakattr</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
            <span class="n">k_parse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_k</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nper</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_count</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_parse</span><span class="p">:</span>
                <span class="n">bc_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_helper</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pak</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
                <span class="n">bc_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">pak_name</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">bc_pak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pak_name</span><span class="p">)</span>
                <span class="n">bc_k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">bc_dtype_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>

                <span class="n">bc_parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">_</span><span class="si">{2:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak_name</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span><span class="n">bc_filenames</span><span class="p">,</span><span class="s2">&quot;col&quot;</span><span class="p">:</span><span class="n">bc_cols</span><span class="p">,</span>
                           <span class="s2">&quot;kper&quot;</span><span class="p">:</span><span class="n">bc_k</span><span class="p">,</span><span class="s2">&quot;pak&quot;</span><span class="p">:</span><span class="n">bc_pak</span><span class="p">,</span>
                           <span class="s2">&quot;dtype_names&quot;</span><span class="p">:</span><span class="n">bc_dtype_names</span><span class="p">,</span>
                          <span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">bc_parnme</span><span class="p">})</span>
        <span class="n">tds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">perlen</span><span class="o">.</span><span class="n">array</span><span class="p">),</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">dts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">_start_datetime</span><span class="p">)</span> <span class="o">+</span> <span class="n">tds</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dts</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;timedelta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tds</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1">#df.loc[:,&quot;kper&quot;] = df.kper.apply(np.int)</span>
        <span class="c1">#df.loc[:,&quot;parnme&quot;] = df.apply(lambda x: &quot;{0}{1}_{2:03d}&quot;.format(x.pak,x.col,x.kper),axis=1)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;~   </span><span class="si">{0}</span><span class="s2">   ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;list_org&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_org</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;model_ext_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span><span class="s2">&quot;dtype_names&quot;</span><span class="p">,</span><span class="s2">&quot;list_org&quot;</span><span class="p">,</span><span class="s2">&quot;model_ext_path&quot;</span><span class="p">,</span><span class="s2">&quot;col&quot;</span><span class="p">,</span><span class="s2">&quot;kper&quot;</span><span class="p">,</span><span class="s2">&quot;pak&quot;</span><span class="p">,</span><span class="s2">&quot;val&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">names</span><span class="p">]</span><span class="o">.</span>\
            <span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;temporal_list_pars.dat&quot;</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tpl_str</span>
        <span class="n">tpl_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s1">&#39;temporal_list_pars.dat.tpl&#39;</span><span class="p">)</span>
        <span class="c1">#f_tpl =  open(tpl_name,&#39;w&#39;)</span>
        <span class="c1">#f_tpl.write(&quot;ptf ~\n&quot;)</span>
        <span class="c1">#f_tpl.flush()</span>
        <span class="c1"># df.loc[:,names].to_csv(f_tpl,sep=&#39; &#39;,quotechar=&#39; &#39;)</span>
        <span class="c1">#f_tpl.write(&quot;index &quot;)</span>
        <span class="c1">#f_tpl.write(df.loc[:,names].to_string(index_names=True))</span>
        <span class="c1">#f_tpl.close()</span>
        <span class="n">_write_df_tpl</span><span class="p">(</span><span class="n">tpl_name</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">names</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;temporal_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing temporal_list_props&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_setup_spatial_list_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing spatial_list_props&quot;</span><span class="p">)</span>

        <span class="n">bc_filenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_pak</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_k</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_dtype_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bc_parnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_props</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_props</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_props</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pakattr</span><span class="p">,</span> <span class="n">k_org</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_list_props</span><span class="p">:</span>
            <span class="n">pak</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_pakattr</span><span class="p">(</span><span class="n">pakattr</span><span class="p">)</span>
            <span class="n">k_parse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_k</span><span class="p">(</span><span class="n">k_org</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nlay</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_parse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;spatial_list_pars error: each set of spatial list pars can only be applied &quot;</span><span class="o">+</span>\
                                   <span class="s2">&quot;to a single layer (e.g. [wel.flux,0].</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span>\
                                   <span class="s2">&quot;You passed [</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">], implying broadcasting to layers </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">pakattr</span><span class="p">,</span><span class="n">k_org</span><span class="p">,</span><span class="n">k_parse</span><span class="p">))</span>
            <span class="c1"># # horrible special case for HFB since it cannot vary over time</span>
            <span class="c1">#if type(pak) != flopy.modflow.mfhfb.ModflowHfb:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">nper</span><span class="p">):</span>
                <span class="n">bc_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_helper</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">pak</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
                <span class="n">bc_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">pak_name</span> <span class="o">=</span> <span class="n">pak</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">bc_pak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pak_name</span><span class="p">)</span>
                <span class="n">bc_k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_parse</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">bc_dtype_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>


        <span class="n">info_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">bc_filenames</span><span class="p">,</span> <span class="s2">&quot;col&quot;</span><span class="p">:</span> <span class="n">bc_cols</span><span class="p">,</span>
                           <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">bc_k</span><span class="p">,</span> <span class="s2">&quot;pak&quot;</span><span class="p">:</span> <span class="n">bc_pak</span><span class="p">,</span>
                           <span class="s2">&quot;dtype_names&quot;</span><span class="p">:</span> <span class="n">bc_dtype_names</span><span class="p">})</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;list_mlt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_mlt</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;list_org&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_org</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;model_ext_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span>

        <span class="c1"># check that all files for a given package have the same number of entries</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;itmp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">pak_dfs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pak</span> <span class="ow">in</span> <span class="n">info_df</span><span class="o">.</span><span class="n">pak</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">df_pak</span> <span class="o">=</span> <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">info_df</span><span class="o">.</span><span class="n">pak</span><span class="o">==</span><span class="n">pak</span><span class="p">,:]</span>
            <span class="n">itmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">df_pak</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">df_pak</span><span class="o">.</span><span class="n">dtype_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="c1">#mif pak != &#39;hfb6&#39;:</span>
                <span class="n">fdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span>
                                  <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;j&#39;</span><span class="p">]:</span>
                    <span class="n">fdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="c1"># else:</span>
                <span class="c1">#     # need to navigate the HFB file to skip both comments and header line</span>
                <span class="c1">#     skiprows = sum(</span>
                <span class="c1">#         [1 if i.strip().startswith(&#39;#&#39;) else 0</span>
                <span class="c1">#          for i in open(os.path.join(self.m.model_ws, filename), &#39;r&#39;).readlines()]) + 1</span>
                <span class="c1">#     fdf = pd.read_csv(os.path.join(self.m.model_ws, filename),</span>
                <span class="c1">#                       delim_whitespace=True, header=None, names=names, skiprows=skiprows  ).dropna()</span>
                <span class="c1">#</span>
                <span class="c1">#     for c in [&#39;k&#39;, &#39;irow1&#39;,&#39;icol1&#39;,&#39;irow2&#39;,&#39;icol2&#39;]:</span>
                <span class="c1">#         fdf.loc[:, c] -= 1</span>

                <span class="n">itmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">pak_dfs</span><span class="p">[</span><span class="n">pak</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdf</span>
            <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">info_df</span><span class="o">.</span><span class="n">pak</span><span class="o">==</span><span class="n">pak</span><span class="p">,</span><span class="s2">&quot;itmp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">itmp</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">itmp</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">info_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;spatial_list_trouble.csv&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;spatial_list_pars() error: must have same number of &quot;</span><span class="o">+</span>\
                                   <span class="s2">&quot;entries for every stress period for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">))</span>

        <span class="c1"># make the pak dfs have unique model indices</span>
        <span class="k">for</span> <span class="n">pak</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">pak_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#if pak != &#39;hfb6&#39;:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:02.0f}{1:04.0f}{2:04.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     df.loc[:, &quot;idx&quot;] = df.apply(lambda x: &quot;{0:02.0f}{1:04.0f}{2:04.0f}{2:04.0f}{2:04.0f}&quot;.format(x.k, x.irow1, x.icol1,</span>
            <span class="c1">#                                                                                                  x.irow2, x.icol2), axis=1)</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;duplicate entries in list pak </span><span class="si">{0}</span><span class="s2">...collapsing&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">))</span>
                <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">idx</span>
            <span class="n">pak_dfs</span><span class="p">[</span><span class="n">pak</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="c1"># write template files - find which cols are parameterized...</span>
        <span class="n">par_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pak</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">pak_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pak_df</span> <span class="o">=</span> <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">info_df</span><span class="o">.</span><span class="n">pak</span><span class="o">==</span><span class="n">pak</span><span class="p">,:]</span>
            <span class="c1"># reset all non-index cols to 1.0</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;j&#39;</span><span class="p">,</span><span class="s1">&#39;inode&#39;</span><span class="p">,</span> <span class="s1">&#39;irow1&#39;</span><span class="p">,</span><span class="s1">&#39;icol1&#39;</span><span class="p">,</span><span class="s1">&#39;irow2&#39;</span><span class="p">,</span><span class="s1">&#39;icol2&#39;</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_mlt</span><span class="p">,</span><span class="n">pak</span><span class="o">+</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
            <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pak</span> <span class="o">+</span> <span class="s2">&quot;.csv.tpl&quot;</span><span class="p">)</span>
            <span class="c1"># save an all &quot;ones&quot; mult df for testing</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">in_file</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">parnme</span><span class="p">,</span><span class="n">pargp</span> <span class="o">=</span> <span class="p">[],[]</span>
            <span class="c1">#if pak != &#39;hfb6&#39;:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># else:</span>
            <span class="c1">#     # note -- for HFB6, only row and col for node 1</span>
            <span class="c1">#     x = df.apply(lambda x: self.m.sr.xcentergrid[int(x.irow1),int(x.icol1)],axis=1).values</span>
            <span class="c1">#     y = df.apply(lambda x: self.m.sr.ycentergrid[int(x.irow1),int(x.icol1)],axis=1).values</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pak_df</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">col_df</span> <span class="o">=</span> <span class="n">pak_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pak_df</span><span class="o">.</span><span class="n">col</span><span class="o">==</span><span class="n">col</span><span class="p">]</span>
                <span class="n">k_vals</span> <span class="o">=</span> <span class="n">col_df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="n">npar</span> <span class="o">=</span> <span class="n">col_df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">k_vals</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">npar</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0}{1}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">))</span>

                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;~   </span><span class="si">{0}</span><span class="s2">   ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k_vals</span><span class="p">),</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">par_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">:</span><span class="n">df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">values</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
                <span class="n">par_df</span> <span class="o">=</span> <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par_df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">k_vals</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">par_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;no parameters found for spatial list k,pak,attr </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span>
                                       <span class="nb">format</span><span class="p">(</span><span class="n">k_vals</span><span class="p">,</span><span class="n">pak</span><span class="p">,</span><span class="n">col</span><span class="p">))</span>

                <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">_k</span><span class="si">{2:02.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="o">.</span><span class="n">values</span>
                <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
                <span class="n">par_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;in_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_file</span>
                <span class="n">par_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_df</span><span class="p">)</span>


            <span class="c1">#with open(os.path.join(self.m.model_ws,tpl_file),&#39;w&#39;) as f:</span>
            <span class="c1">#    f.write(&quot;ptf ~\n&quot;)</span>
                <span class="c1">#f.flush()</span>
                <span class="c1">#df.to_csv(f)</span>
            <span class="c1">#    f.write(&quot;index &quot;)</span>
            <span class="c1">#    f.write(df.to_string(index_names=False)+&#39;\n&#39;)</span>
            <span class="n">_write_df_tpl</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">),</span> <span class="n">df</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tpl_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>

        <span class="n">par_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">par_dfs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par_dfs</span><span class="p">[</span><span class="s2">&quot;spatial_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_df</span>
        <span class="n">info_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;spatial_list_pars.dat&quot;</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing spatial_list_props&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">_list_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">pak</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; helper to setup list multiplier parameters for a given</span>
<span class="sd">        k, pak, attr set.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># special case for horrible HFB6 exception</span>
        <span class="c1"># if type(pak) == flopy.modflow.mfhfb.ModflowHfb:</span>
        <span class="c1">#     filename = pak.file_name[0]</span>
        <span class="c1"># else:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">filename_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">external_path</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">filename_model</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">list_org</span><span class="p">,</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filename_model</span>


    <span class="k">def</span> <span class="nf">_setup_hds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup modflow head save file observations for given kper (zero-based</span>
<span class="sd">        stress period index) and k (zero-based layer index) pairs using the</span>
<span class="sd">        kperk argument.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="kn">from</span> <span class="nn">.gw_utils</span> <span class="k">import</span> <span class="n">setup_hds_obs</span>
        <span class="c1"># if len(self.hds_kperk) == 2:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         if len(self.hds_kperk[0] == 2):</span>
        <span class="c1">#             pass</span>
        <span class="c1">#     except:</span>
        <span class="c1">#         self.hds_kperk = [self.hds_kperk]</span>
        <span class="n">oc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="s2">&quot;OC&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;can&#39;t find OC package in model to setup hds grid obs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">oc</span><span class="o">.</span><span class="n">savehead</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;OC not saving hds, can&#39;t setup grid obs&quot;</span><span class="p">)</span>
        <span class="n">hds_unit</span> <span class="o">=</span> <span class="n">oc</span><span class="o">.</span><span class="n">iuhead</span>
        <span class="n">hds_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">hds_unit</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">)),</span>\
        <span class="s2">&quot;couldn&#39;t find existing hds file </span><span class="si">{0}</span><span class="s2"> in org_model_ws&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">))</span>
        <span class="n">inact</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lpf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lpf</span><span class="o">.</span><span class="n">hdry</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">upw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">upw</span><span class="o">.</span><span class="n">hdry</span>
        <span class="k">if</span> <span class="n">inact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">hnoflo</span> <span class="k">else</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">bas6</span><span class="o">.</span><span class="n">hnoflo</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">==</span> <span class="n">inact</span> <span class="k">else</span> <span class="n">x</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">)</span>
        <span class="n">frun_line</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="n">setup_hds_obs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">hds_file</span><span class="p">),</span>
                      <span class="n">kperk_pairs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hds_kperk</span><span class="p">,</span><span class="n">skip</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;hds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pyemu.gw_utils.apply_hds_obs(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hds_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_smp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup observations from PEST-style SMP file pairs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">obs_smp</span><span class="p">,</span><span class="n">sim_smp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obssim_smp_pairs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;processing </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> smp files&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">,</span><span class="n">sim_smp</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find obs smp: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find sim smp: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">))</span>
            <span class="n">new_obs_smp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">obs_smp</span><span class="p">,</span><span class="n">new_obs_smp</span><span class="p">)</span>
            <span class="n">new_sim_smp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">sim_smp</span><span class="p">,</span><span class="n">new_sim_smp</span><span class="p">)</span>
            <span class="n">pyemu</span><span class="o">.</span><span class="n">smp_utils</span><span class="o">.</span><span class="n">smp_to_ins</span><span class="p">(</span><span class="n">new_sim_smp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_hob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup observations from the MODFLOW HOB package</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hob</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">hob_out_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hob</span><span class="o">.</span><span class="n">iuhobsv</span>
        <span class="n">new_hob_out_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_output_attribute</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">hob_out_unit</span><span class="p">))</span>
        <span class="n">org_hob_out_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">get_output_attribute</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">hob_out_unit</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_hob_out_fname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;could not find hob out file: </span><span class="si">{0}</span><span class="s2">...skipping&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hob_out_fname</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_hob_out_fname</span><span class="p">,</span><span class="n">new_hob_out_fname</span><span class="p">)</span>
        <span class="n">hob_df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">modflow_hob_to_instruction_file</span><span class="p">(</span><span class="n">new_hob_out_fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;hob&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hob_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hob_out_fname</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_setup_hyd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup observations from the MODFLOW HYDMOD package</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">hyd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mfhyd</span><span class="p">:</span>
            <span class="n">org_hyd_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.hyd.bin&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;can&#39;t find existing hyd out file:</span><span class="si">{0}</span><span class="s2">...skipping&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="n">new_hyd_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_hyd_out</span><span class="p">,</span><span class="n">new_hyd_out</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">modflow_hydmod_to_instruction_file</span><span class="p">(</span><span class="n">new_hyd_out</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils.modflow_read_hydmod_file(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_hyd_out</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;hyd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_hyd_out</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_setup_water_budget_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup observations from the MODFLOW list file for</span>
<span class="sd">        volume and flux water buget information</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mflist_waterbudget</span><span class="p">:</span>
            <span class="n">org_listfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lst</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_listfile</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_listfile</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lst</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;can&#39;t find existing list file:</span><span class="si">{0}</span><span class="s2">...skipping&quot;</span><span class="o">.</span>
                                   <span class="nb">format</span><span class="p">(</span><span class="n">org_listfile</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="n">list_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">lst</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">flx_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;flux.dat&quot;</span><span class="p">)</span>
            <span class="n">vol_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;vol.dat&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">gw_utils</span><span class="o">.</span><span class="n">setup_mflist_budget_obs</span><span class="p">(</span><span class="n">list_file</span><span class="p">,</span>
                                                                <span class="n">flx_filename</span><span class="o">=</span><span class="n">flx_file</span><span class="p">,</span>
                                                                <span class="n">vol_filename</span><span class="o">=</span><span class="n">vol_file</span><span class="p">,</span>
                                                                <span class="n">start_datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obs_dfs</span><span class="p">[</span><span class="s2">&quot;wb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
            <span class="c1">#line = &quot;try:\n    os.remove(&#39;{0}&#39;)\nexcept:\n    pass&quot;.format(os.path.split(list_file)[-1])</span>
            <span class="c1">#self.logger.statement(&quot;forward_run line:{0}&quot;.format(line))</span>
            <span class="c1">#self.frun_pre_lines.append(line)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">list_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils.apply_mflist_budget_obs(&#39;</span><span class="si">{0}</span><span class="s2">&#39;,flx_filename=&#39;</span><span class="si">{1}</span><span class="s2">&#39;,vol_filename=&#39;</span><span class="si">{2}</span><span class="s2">&#39;,start_datetime=&#39;</span><span class="si">{3}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">list_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">flx_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">vol_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s2">&quot;forward_run line:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frun_post_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="apply_array_pars"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.apply_array_pars">[docs]</a><span class="k">def</span> <span class="nf">apply_array_pars</span><span class="p">(</span><span class="n">arr_par_file</span><span class="o">=</span><span class="s2">&quot;arr_pars.csv&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a function to apply array-based multipler parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        arr_par_file (`str`): path to csv file detailing parameter array multipliers.</span>
<span class="sd">            This file is written by PstFromFlopy.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Used to implement the parameterization constructed by</span>
<span class="sd">        PstFromFlopyModel during a forward run</span>

<span class="sd">        This function should be added to the forward_run.py script but can</span>
<span class="sd">        be called on any correctly formatted csv</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">arr_par_file</span><span class="p">)</span>
    <span class="c1"># for fname in df.model_file:</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         os.remove(fname)</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         print(&quot;error removing mult array:{0}&quot;.format(fname))</span>

    <span class="k">if</span> <span class="s1">&#39;pp_file&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pp_file</span><span class="p">,</span><span class="n">fac_file</span><span class="p">,</span><span class="n">mlt_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pp_file</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">fac_file</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">pp_file</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">pyemu</span><span class="o">.</span><span class="n">geostats</span><span class="o">.</span><span class="n">fac2real</span><span class="p">(</span><span class="n">pp_file</span><span class="o">=</span><span class="n">pp_file</span><span class="p">,</span><span class="n">factors_file</span><span class="o">=</span><span class="n">fac_file</span><span class="p">,</span>
                                    <span class="n">out_file</span><span class="o">=</span><span class="n">mlt_file</span><span class="p">,</span><span class="n">lower_lim</span><span class="o">=</span><span class="mf">1.0e-10</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">model_file</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">model_file</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="c1"># find all mults that need to be applied to this array</span>
        <span class="n">df_mf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">model_file</span><span class="o">==</span><span class="n">model_file</span><span class="p">,:]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">org_file</span> <span class="o">=</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">org_file</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">org_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;wrong number of org_files for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>
                            <span class="nb">format</span><span class="p">(</span><span class="n">model_file</span><span class="p">))</span>
        <span class="n">org_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">org_file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">mlt</span> <span class="ow">in</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">mlt_file</span><span class="p">:</span>
            <span class="n">org_arr</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">mlt</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;upper_bound&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">ub_vals</span> <span class="o">=</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">upper_bound</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ub_vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ub_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;different upper bound values for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">org_file</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ub_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">org_arr</span><span class="p">[</span><span class="n">org_arr</span><span class="o">&gt;</span><span class="n">ub</span><span class="p">]</span> <span class="o">=</span> <span class="n">ub</span>
        <span class="k">if</span> <span class="s2">&quot;lower_bound&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">lb_vals</span> <span class="o">=</span> <span class="n">df_mf</span><span class="o">.</span><span class="n">lower_bound</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lb_vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lb_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;different lower bound values for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">org_file</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lb_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">org_arr</span><span class="p">[</span><span class="n">org_arr</span> <span class="o">&lt;</span> <span class="n">lb</span><span class="p">]</span> <span class="o">=</span> <span class="n">lb</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">org_arr</span><span class="p">),</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="apply_list_pars"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.apply_list_pars">[docs]</a><span class="k">def</span> <span class="nf">apply_list_pars</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; a function to apply boundary condition multiplier parameters.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Used to implement the parameterization constructed by</span>
<span class="sd">        PstFromFlopyModel during a forward run</span>

<span class="sd">        Requires either &quot;temporal_list_pars.csv&quot; or &quot;spatial_list_pars.csv&quot;</span>

<span class="sd">        Should be added to the forward_run.py script</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_file</span> <span class="o">=</span> <span class="s2">&quot;temporal_list_pars.dat&quot;</span>
    <span class="n">spat_file</span> <span class="o">=</span> <span class="s2">&quot;spatial_list_pars.dat&quot;</span>

    <span class="n">temp_df</span><span class="p">,</span><span class="n">spat_df</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_file</span><span class="p">):</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;split_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">org_dir</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">list_org</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">model_ext_path</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">model_ext_path</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">spat_file</span><span class="p">):</span>
        <span class="n">spat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">spat_file</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">spat_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;split_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mlt_dir</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">list_mlt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">org_dir</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">list_org</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">model_ext_path</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">model_ext_path</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">temp_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">spat_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;apply_list_pars() - no key dfs found, nothing to do...&quot;</span><span class="p">)</span>
    <span class="c1"># load the spatial mult dfs</span>
    <span class="n">sp_mlts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">spat_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mlt_dir</span><span class="p">):</span>
            <span class="n">pak</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mlt_dir</span><span class="p">,</span><span class="n">f</span><span class="p">),</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#if pak != &#39;hfb6&#39;:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:02.0f}{1:04.0f}{2:04.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     df.index = df.apply(lambda x: &quot;{0:02.0f}{1:04.0f}{2:04.0f}{2:04.0f}{2:04.0f}&quot;.format(x.k, x.irow1, x.icol1,</span>
            <span class="c1">#                                                                      x.irow2, x.icol2), axis = 1)</span>
            <span class="k">if</span> <span class="n">pak</span> <span class="ow">in</span> <span class="n">sp_mlts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;duplicate multplier csv for pak </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pak</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;empty dataframe for spatial list file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">sp_mlts</span><span class="p">[</span><span class="n">pak</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

    <span class="n">org_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">org_dir</span><span class="p">)</span>
    <span class="c1">#for fname in df.filename.unique():</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">org_files</span><span class="p">:</span>
        <span class="c1"># need to get the PAK name to handle stupid horrible expceptions for HFB...</span>
        <span class="c1"># try:</span>
        <span class="c1">#     pakspat = sum([True if fname in i else False for i in spat_df.filename])</span>
        <span class="c1">#     if pakspat:</span>
        <span class="c1">#         pak = spat_df.loc[spat_df.filename.str.contains(fname)].pak.values[0]</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         pak = &#39;notHFB&#39;</span>
        <span class="c1"># except:</span>
        <span class="c1">#     pak = &quot;notHFB&quot;</span>

        <span class="n">names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">temp_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">split_filename</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">temp_df_fname</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temp_df</span><span class="o">.</span><span class="n">split_filename</span><span class="o">==</span><span class="n">fname</span><span class="p">,:]</span>
            <span class="k">if</span> <span class="n">temp_df_fname</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">temp_df_fname</span><span class="o">.</span><span class="n">dtype_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spat_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">split_filename</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">spat_df_fname</span> <span class="o">=</span> <span class="n">spat_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spat_df</span><span class="o">.</span><span class="n">split_filename</span> <span class="o">==</span> <span class="n">fname</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">spat_df_fname</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">spat_df_fname</span><span class="o">.</span><span class="n">dtype_names</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">df_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">org_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                                  <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:02.0f}{1:04.0f}{2:04.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


            <span class="n">df_list</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_list</span><span class="o">.</span><span class="n">idx</span>
            <span class="n">pak_name</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pak_name</span> <span class="ow">in</span> <span class="n">sp_mlts</span><span class="p">:</span>
                <span class="n">mlt_df</span> <span class="o">=</span> <span class="n">sp_mlts</span><span class="p">[</span><span class="n">pak_name</span><span class="p">]</span>
                <span class="n">mlt_df_ri</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_list</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_list</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="s2">&quot;j&quot;</span><span class="p">,</span><span class="s2">&quot;inode&quot;</span><span class="p">,</span><span class="s1">&#39;irow1&#39;</span><span class="p">,</span><span class="s1">&#39;icol1&#39;</span><span class="p">,</span><span class="s1">&#39;irow2&#39;</span><span class="p">,</span><span class="s1">&#39;icol2&#39;</span><span class="p">,</span><span class="s1">&#39;idx&#39;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                       <span class="c1"># print(mlt_df.loc[mlt_df.index.duplicated(),:])</span>
                       <span class="c1"># print(df_list.loc[df_list.index.duplicated(),:])</span>
                        <span class="n">df_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">mlt_df_ri</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="k">if</span> <span class="n">temp_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">split_filename</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">temp_df_fname</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temp_df</span><span class="o">.</span><span class="n">split_filename</span> <span class="o">==</span> <span class="n">fname</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">temp_df_fname</span><span class="o">.</span><span class="n">col</span><span class="p">,</span><span class="n">temp_df_fname</span><span class="o">.</span><span class="n">val</span><span class="p">):</span>
                     <span class="n">df_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">val</span>
            <span class="n">fmts</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="s2">&quot;j&quot;</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">,</span><span class="s2">&quot;inode&quot;</span><span class="p">,</span><span class="s1">&#39;irow1&#39;</span><span class="p">,</span><span class="s1">&#39;icol1&#39;</span><span class="p">,</span><span class="s1">&#39;irow2&#39;</span><span class="p">,</span><span class="s1">&#39;icol2&#39;</span><span class="p">]:</span>
                    <span class="n">fmts</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%9d</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fmts</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%9G</span><span class="s2">&quot;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ext_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">df_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmts</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_const_tpl"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.write_const_tpl">[docs]</a><span class="k">def</span> <span class="nf">write_const_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">zn_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">longnames</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; write a constant (uniform) template file for a 2-D array</span>

<span class="sd">    Args:</span>
<span class="sd">        name (`str`): the base parameter name</span>
<span class="sd">        tpl_file (`str`): the template file to write</span>
<span class="sd">        zn_array (`numpy.ndarray`, optional): an array used to skip inactive cells,</span>
<span class="sd">            and optionally get shape info.</span>
<span class="sd">        shape (`tuple`): tuple nrow and ncol.  Either `zn_array` or `shape`</span>
<span class="sd">            must be passed</span>
<span class="sd">        longnames (`bool`): flag to use longer names that exceed 12 chars in length.</span>
<span class="sd">            Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `pandas.DataFrame`: a dataframe with parameter information</span>


<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zn_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;must pass either zn_array or shape&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">zn_array</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">parnme</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">zn_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; 1.0  &quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">longnames</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;const_</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">suffix</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;zone pname too long for pest:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span> \
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                    <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; ~   </span><span class="si">{0}</span><span class="s2">    ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span> <span class="n">parnme</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
    <span class="c1"># df.loc[:,&quot;pargp&quot;] = &quot;{0}{1}&quot;.format(self.cn_suffixname)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;tpl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="write_grid_tpl"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.write_grid_tpl">[docs]</a><span class="k">def</span> <span class="nf">write_grid_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">zn_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">spatial_reference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">longnames</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; write a grid-based template file for a 2-D array</span>

<span class="sd">    Args:</span>
<span class="sd">        name (`str`): the base parameter name</span>
<span class="sd">        tpl_file (`str`): the template file to write - include path</span>
<span class="sd">        zn_array (`numpy.ndarray`, optional): zone array to identify</span>
<span class="sd">            inactive cells.  Default is None</span>
<span class="sd">        shape (`tuple`, optional): a length-two tuple of nrow and ncol.  Either</span>
<span class="sd">            `zn_array` or `shape` must be passed.</span>
<span class="sd">        spatial_reference (`flopy.utils.SpatialReference`): a spatial reference instance.</span>
<span class="sd">            If `longnames` is True, then `spatial_reference` is used to add spatial info</span>
<span class="sd">            to the parameter names.</span>
<span class="sd">        longnames (`bool`): flag to use longer names that exceed 12 chars in length.</span>
<span class="sd">            Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `pandas.DataFrame`: a dataframe with parameter information</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zn_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;must pass either zn_array or shape&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">zn_array</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">parnme</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">zn_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="s1">&#39; 1.0 &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">longnames</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_i:</span><span class="si">{0}</span><span class="s2">_j:</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">suffix</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">spatial_reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">pname</span> <span class="o">+=</span> <span class="s2">&quot;_x:</span><span class="si">{0:10.2E}</span><span class="s2">_y:</span><span class="si">{1:10.2E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span>
                                                                       <span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1:03d}{2:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;grid pname too long for pest:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span> \
                                               <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                    <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="s1">&#39; ~     </span><span class="si">{0}</span><span class="s1">   ~ &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">spatial_reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">xcentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
                        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">ycentergrid</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span> <span class="n">parnme</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spatial_reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;tpl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpl_file</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="write_zone_tpl"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.write_zone_tpl">[docs]</a><span class="k">def</span> <span class="nf">write_zone_tpl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tpl_file</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">zn_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">longnames</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; write a zone-based template file for a 2-D array</span>

<span class="sd">    Args:</span>
<span class="sd">        name (`str`): the base parameter name</span>
<span class="sd">        tpl_file (`str`): the template file to write</span>
<span class="sd">        zn_array (`numpy.ndarray`, optional): an array used to skip inactive cells,</span>
<span class="sd">            and optionally get shape info.</span>
<span class="sd">        shape (`tuple`): tuple nrow and ncol.  Either `zn_array` or `shape`</span>
<span class="sd">            must be passed</span>
<span class="sd">        longnames (`bool`): flag to use longer names that exceed 12 chars in length.</span>
<span class="sd">            Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `pandas.DataFrame`: a dataframe with parameter information</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zn_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;must pass either zn_array or shape&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">zn_array</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">parnme</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">zn_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; 1.0  &quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">zval</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">zn_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">zval</span> <span class="o">=</span> <span class="n">zn_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">longnames</span><span class="p">:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_zone:</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">zval</span><span class="p">,</span><span class="n">suffix</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>

                        <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_zn</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">zval</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;zone pname too long for pest:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span> \
                                              <span class="nb">format</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span>
                    <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="s2">&quot; ~   </span><span class="si">{0}</span><span class="s2">    ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span> <span class="n">parnme</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="build_jac_test_csv"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.build_jac_test_csv">[docs]</a><span class="k">def</span> <span class="nf">build_jac_test_csv</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">num_steps</span><span class="p">,</span><span class="n">par_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; build a dataframe of jactest inputs for use with sweep</span>

<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): existing control file</span>
<span class="sd">        num_steps (`int`): number of pertubation steps for each parameter</span>
<span class="sd">        par_names [`str`]: list of parameter names of pars to test.</span>
<span class="sd">            If None, all adjustable pars are used. Default is None</span>
<span class="sd">        forward (`bool`): flag to start with forward pertubations.</span>
<span class="sd">            Default is True</span>

<span class="sd">    Returns:</span>
<span class="sd">        `pandas.DataFrame`: the sequence of model runs to evaluate</span>
<span class="sd">        for the jactesting.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">pst</span> <span class="o">=</span> <span class="n">pyemu</span><span class="o">.</span><span class="n">Pst</span><span class="p">(</span><span class="n">pst</span><span class="p">)</span>
    <span class="c1">#pst.add_transform_columns()</span>
    <span class="n">pst</span><span class="o">.</span><span class="n">build_increments</span><span class="p">()</span>
    <span class="n">incr</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span><span class="o">.</span><span class="n">increment</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">irow</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">parameter_data</span>
    <span class="k">if</span> <span class="n">par_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">par_names</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="n">adj_par_names</span>
    <span class="n">total_runs</span> <span class="o">=</span> <span class="n">num_steps</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="n">par_names</span><span class="p">:</span>
        <span class="n">idx</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_name</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pst</span><span class="o">.</span><span class="n">par_names</span><span class="p">)</span>
    <span class="n">li</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">partrans</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span>
    <span class="n">lbnd</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parlbnd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ubnd</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parubnd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">lbnd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbnd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
    <span class="n">ubnd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">ubnd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
    <span class="n">lbnd</span> <span class="o">=</span> <span class="n">lbnd</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">ubnd</span> <span class="o">=</span> <span class="n">ubnd</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="n">org_vals</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">org_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="n">org_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">forward</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="c1"># base case goes in as first row, no perturbations</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">,</span><span class="n">pst</span><span class="o">.</span><span class="n">par_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">irow</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">full_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">jcol</span><span class="p">,</span> <span class="n">par_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">par_names</span><span class="p">):</span>
        <span class="n">org_val</span> <span class="o">=</span> <span class="n">org_vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span>
        <span class="n">last_val</span> <span class="o">=</span> <span class="n">org_val</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">org_vals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">incr</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span>


            <span class="n">val</span> <span class="o">=</span> <span class="n">last_val</span> <span class="o">+</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">incr</span><span class="p">[</span><span class="n">par_name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">ubnd</span><span class="p">[</span><span class="n">par_name</span><span class="p">]:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">org_val</span> <span class="o">+</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">incr</span><span class="p">[</span><span class="n">par_name</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">lbnd</span><span class="p">[</span><span class="n">par_name</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;parameter </span><span class="si">{0}</span><span class="s2"> went out of bounds&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="n">par_name</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">lbnd</span><span class="p">[</span><span class="n">par_name</span><span class="p">]:</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">org_val</span> <span class="o">+</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">incr</span><span class="p">[</span><span class="n">par_name</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">ubnd</span><span class="p">[</span><span class="n">par_name</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;parameter </span><span class="si">{0}</span><span class="s2"> went out of bounds&quot;</span><span class="o">.</span>
                                    <span class="nb">format</span><span class="p">(</span><span class="n">par_name</span><span class="p">))</span>

            <span class="n">vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">li</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">irow</span><span class="p">],</span><span class="n">pst</span><span class="o">.</span><span class="n">par_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
            <span class="n">full_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1:&lt;15.6E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_name</span><span class="p">,</span><span class="n">vals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">par_name</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">irow</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">last_val</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">full_names</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="k">def</span> <span class="nf">_write_df_tpl</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">tpl_marker</span><span class="o">=</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;function write a pandas dataframe to a template file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;line_terminator&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;win&quot;</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;line_terminator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpl_marker</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="setup_fake_forward_run"><a class="viewcode-back" href="../../../index.html#pyemu.utils.helpers.setup_fake_forward_run">[docs]</a><span class="k">def</span> <span class="nf">setup_fake_forward_run</span><span class="p">(</span><span class="n">pst</span><span class="p">,</span><span class="n">new_pst_name</span><span class="p">,</span><span class="n">org_cwd</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">bak_suffix</span><span class="o">=</span><span class="s2">&quot;._bak&quot;</span><span class="p">,</span><span class="n">new_cwd</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup a fake forward run for a pst.</span>

<span class="sd">    Args:</span>
<span class="sd">        pst (`pyemu.Pst`): existing control file</span>
<span class="sd">        new_pst_name (`str`): new control file to write</span>
<span class="sd">        org_cwd (`str`): existing working dir.  Default is &quot;.&quot;</span>
<span class="sd">        bak_suffix (`str`, optional): suffix to add to existing</span>
<span class="sd">            model output files when making backup copies.</span>
<span class="sd">        new_cwd (`str`): new working dir.  Default is &quot;.&quot;.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The fake forward run simply copies existing backup versions of</span>
<span class="sd">        model output files to the outfiles pest(pp) is looking</span>
<span class="sd">        for.  This is really a development option for debugging</span>
<span class="sd">        PEST++ issues.</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">if</span> <span class="n">new_cwd</span> <span class="o">!=</span> <span class="n">org_cwd</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">)</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">output_files</span><span class="p">:</span>
        <span class="n">org_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">org_cwd</span><span class="p">,</span><span class="n">output_file</span><span class="p">)</span>
        <span class="n">new_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">output_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_pth</span><span class="p">),</span><span class="n">org_pth</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_pth</span><span class="p">,</span><span class="n">new_pth</span><span class="o">+</span><span class="n">bak_suffix</span><span class="p">)</span>
        <span class="n">pairs</span><span class="p">[</span><span class="n">output_file</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">output_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bak_suffix</span>

    <span class="k">if</span> <span class="n">new_cwd</span> <span class="o">!=</span> <span class="n">org_cwd</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pst</span><span class="o">.</span><span class="n">template_files</span><span class="p">,</span><span class="n">pst</span><span class="o">.</span><span class="n">instruction_files</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">raw</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span><span class="n">pth</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pth</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>

                <span class="n">org_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">org_cwd</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">new_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_pth</span><span class="p">),</span> <span class="n">org_pth</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_pth</span><span class="p">,</span><span class="n">new_pth</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">input_files</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">raw</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span> <span class="n">pth</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pth</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="n">pst</span><span class="o">.</span><span class="n">pestpp_options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">continue</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">raw</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span> <span class="n">pth</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pth</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
            <span class="n">org_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">org_cwd</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">new_pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">org_pth</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">org_pth</span><span class="p">,</span><span class="n">new_pth</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span><span class="s2">&quot;fake_forward_run.py&quot;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;import os</span><span class="se">\n</span><span class="s2">import shutil</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">org</span><span class="p">,</span><span class="n">bak</span> <span class="ow">in</span> <span class="n">pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;shutil.copy2(&#39;</span><span class="si">{0}</span><span class="s2">&#39;,&#39;</span><span class="si">{1}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bak</span><span class="p">,</span><span class="n">org</span><span class="p">))</span>
    <span class="n">pst</span><span class="o">.</span><span class="n">model_command</span> <span class="o">=</span> <span class="s2">&quot;python fake_forward_run.py&quot;</span>
    <span class="n">pst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_cwd</span><span class="p">,</span><span class="n">new_pst_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pst</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, pyEMU development team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>