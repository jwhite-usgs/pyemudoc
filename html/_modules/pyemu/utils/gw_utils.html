

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyemu.utils.gw_utils &mdash; pyEMU 0.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyEMU
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.Matrix.html">pyemu.Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.Cov.html">pyemu.Cov</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.Schur.html">pyemu.Schur</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.ErrVar.html">pyemu.ErrVar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.ObservationEnsemble.html">pyemu.ObservationEnsemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.ParameterEnsemble.html">pyemu.ParameterEnsemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.helpers.html">pyemu.helpers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.geostats.html">pyemu.geostats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.gw_utils.html">pyemu.gw_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.pp_utils.html">pyemu.pp_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.smp_utils.html">pyemu.smp_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.plot_utils.html">pyemu.plot_utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pyemu.pst_utils.html">pyemu.pst_utils</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyEMU</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyemu.utils.gw_utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyemu.utils.gw_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;MODFLOW support utilities&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_colwidth</span> <span class="o">=</span> <span class="mi">100</span>
<span class="kn">from</span> <span class="nn">pyemu.pst.pst_utils</span> <span class="k">import</span> <span class="n">SFMT</span><span class="p">,</span><span class="n">IFMT</span><span class="p">,</span><span class="n">FFMT</span><span class="p">,</span><span class="n">pst_config</span><span class="p">,</span>\
    <span class="n">parse_tpl_file</span><span class="p">,</span><span class="n">try_process_output_file</span>
<span class="kn">from</span> <span class="nn">pyemu.utils.os_utils</span> <span class="k">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">pyemu.utils.helpers</span> <span class="k">import</span> <span class="n">_write_df_tpl</span>
<span class="kn">from</span> <span class="nn">..pyemu_warnings</span> <span class="k">import</span> <span class="n">PyemuWarning</span>
<span class="n">PP_FMT</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">SFMT</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">FFMT</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">FFMT</span><span class="p">,</span> <span class="s2">&quot;zone&quot;</span><span class="p">:</span> <span class="n">IFMT</span><span class="p">,</span> <span class="s2">&quot;tpl&quot;</span><span class="p">:</span> <span class="n">SFMT</span><span class="p">,</span>
          <span class="s2">&quot;parval1&quot;</span><span class="p">:</span> <span class="n">FFMT</span><span class="p">}</span>
<span class="n">PP_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;zone&quot;</span><span class="p">,</span><span class="s2">&quot;parval1&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="modflow_pval_to_template_file"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.modflow_pval_to_template_file">[docs]</a><span class="k">def</span> <span class="nf">modflow_pval_to_template_file</span><span class="p">(</span><span class="n">pval_file</span><span class="p">,</span><span class="n">tpl_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;write a template file for a modflow parameter value file.</span>

<span class="sd">    Args:</span>
<span class="sd">        pval_file (`str`): the path and name of the existing modflow pval file</span>
<span class="sd">        tpl_file (`str`, optional):  template file to write. If None, use</span>
<span class="sd">            `pval_file` +&quot;.tpl&quot;. Default is None</span>
<span class="sd">    Note:</span>
<span class="sd">        Uses names in the first column in the pval file as par names.</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataFrame with control file parameter information</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">tpl_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">pval_file</span> <span class="o">+</span> <span class="s2">&quot;.tpl&quot;</span>
    <span class="n">pval_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pval_file</span><span class="p">,</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                          <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parnme&quot;</span><span class="p">,</span><span class="s2">&quot;parval1&quot;</span><span class="p">])</span>
    <span class="n">pval_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pval_df</span><span class="o">.</span><span class="n">parnme</span>
    <span class="n">pval_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pval_df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot; ~   </span><span class="si">{0:15s}</span><span class="s2">   ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">#pval template file from pyemu</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:10d}</span><span class="s2"> #NP</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pval_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pval_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s2">&quot;parnme&quot;</span><span class="p">,</span><span class="s2">&quot;tpl&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">col_space</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">formatters</span><span class="o">=</span><span class="p">[</span><span class="n">SFMT</span><span class="p">,</span><span class="n">SFMT</span><span class="p">],</span>
                                                          <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                          <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                          <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pval_df</span></div>

<div class="viewcode-block" id="modflow_hob_to_instruction_file"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.modflow_hob_to_instruction_file">[docs]</a><span class="k">def</span> <span class="nf">modflow_hob_to_instruction_file</span><span class="p">(</span><span class="n">hob_file</span><span class="p">,</span> <span class="n">ins_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;write an instruction file for a modflow head observation file</span>

<span class="sd">    Args:</span>
<span class="sd">        hob_file (`str`): the path and name of the existing modflow hob file</span>
<span class="sd">        ins_file (`str`, optional): the name of the instruction file to write.</span>
<span class="sd">            If `None`, `hob_file` +&quot;.ins&quot; is used.  Default is `None`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataFrame with control file observation information</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hob_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">hob_file</span><span class="p">,</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;simval&quot;</span><span class="p">,</span><span class="s2">&quot;obsval&quot;</span><span class="p">,</span><span class="s2">&quot;obsnme&quot;</span><span class="p">])</span>

    <span class="n">hob_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hob_df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
    <span class="n">hob_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;ins_line&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hob_df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s2">&quot;l1 !</span><span class="si">{0:s}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">hob_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;ins_line&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hob_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;ins_line&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span><span class="s1">&#39;l2&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ins_file</span> <span class="o">=</span> <span class="n">hob_file</span> <span class="o">+</span> <span class="s2">&quot;.ins&quot;</span>
    <span class="n">f_ins</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f_ins</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pif ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">f_ins</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">hob_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s2">&quot;ins_line&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">col_space</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ins_line&quot;</span><span class="p">],</span>
                                                     <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">formatters</span><span class="o">=</span><span class="p">[</span><span class="n">SFMT</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">hob_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">hob_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;obgnme&quot;</span>
    <span class="n">f_ins</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">hob_df</span></div>

<div class="viewcode-block" id="modflow_hydmod_to_instruction_file"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.modflow_hydmod_to_instruction_file">[docs]</a><span class="k">def</span> <span class="nf">modflow_hydmod_to_instruction_file</span><span class="p">(</span><span class="n">hydmod_file</span><span class="p">,</span> <span class="n">ins_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;write an instruction file for a modflow hydmod file</span>

<span class="sd">    Args:</span>
<span class="sd">        hydmod_file (`str`): the path and name of the existing modflow hob file</span>
<span class="sd">        ins_file (`str`, optional): the name of the instruction file to write.</span>
<span class="sd">            If `None`, `hydmod_file` +&quot;.ins&quot; is used.  Default is `None`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataFrame with control file observation information</span>

<span class="sd">    Note:</span>
<span class="sd">        calls `pyemu.gw_utils.modflow_read_hydmod_file()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hydmod_df</span><span class="p">,</span> <span class="n">hydmod_outfile</span> <span class="o">=</span> <span class="n">modflow_read_hydmod_file</span><span class="p">(</span><span class="n">hydmod_file</span><span class="p">)</span>
    <span class="n">hydmod_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;ins_line&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hydmod_df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="s2">&quot;l1 w !</span><span class="si">{0:s}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ins_file</span> <span class="o">=</span> <span class="n">hydmod_outfile</span> <span class="o">+</span> <span class="s2">&quot;.ins&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_ins</span><span class="p">:</span>
        <span class="n">f_ins</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pif ~</span><span class="se">\n</span><span class="s2">l1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f_ins</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">hydmod_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s2">&quot;ins_line&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">col_space</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                     <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ins_line&quot;</span><span class="p">],</span>
                                                     <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">formatters</span><span class="o">=</span><span class="p">[</span><span class="n">SFMT</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">hydmod_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">hydmod_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;obgnme&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">hydmod_outfile</span><span class="o">+</span><span class="s2">&quot;.ins&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;_setup_&quot;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hydmod_outfile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">return</span> <span class="n">hydmod_df</span></div>

<div class="viewcode-block" id="modflow_read_hydmod_file"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.modflow_read_hydmod_file">[docs]</a><span class="k">def</span> <span class="nf">modflow_read_hydmod_file</span><span class="p">(</span><span class="n">hydmod_file</span><span class="p">,</span> <span class="n">hydmod_outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; read a binary hydmod file and return a dataframe of the results</span>

<span class="sd">    Args:</span>
<span class="sd">        hydmod_file (`str`): The path and name of the existing modflow hydmod binary file</span>
<span class="sd">        hydmod_outfile (`str`, optional): output file to write.  If `None`, use `hydmod_file` +&quot;.dat&quot;.</span>
<span class="sd">            Default is `None`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataFrame with hymod_file values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy.utils</span> <span class="k">as</span> <span class="nn">fu</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flopy is not installed - cannot read </span><span class="si">{0}</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hydmod_file</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">fu</span><span class="o">.</span><span class="n">HydmodObs</span><span class="p">(</span><span class="n">hydmod_file</span><span class="p">)</span>
    <span class="n">hyd_df</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">()</span>

    <span class="n">hyd_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;totim&#39;</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hyd_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="c1">#hyd_df.loc[:,&quot;datetime&quot;] = hyd_df.index</span>
    <span class="n">hyd_df</span><span class="p">[</span><span class="s1">&#39;totim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hyd_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="n">hyd_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;totim&#39;</span><span class="p">:</span> <span class="s1">&#39;datestamp&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="c1"># reshape into a single column</span>
    <span class="n">hyd_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">hyd_df</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;datestamp&#39;</span><span class="p">)</span>

    <span class="n">hyd_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;obsval&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">hyd_df</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">j</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hyd_df</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span> <span class="n">hyd_df</span><span class="o">.</span><span class="n">datestamp</span><span class="p">)]</span>

    <span class="n">vc</span> <span class="o">=</span> <span class="n">hyd_df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
    <span class="n">vc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">vc</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hyd_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;hyd_df.duplciates.csv&quot;</span><span class="p">)</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;hyd_org.duplicates.csv&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;duplicates in obsnme:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
    <span class="c1">#assert hyd_df.obsnme.value_counts().max() == 1,&quot;duplicates in obsnme&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">hydmod_outfile</span><span class="p">:</span>
        <span class="n">hydmod_outfile</span> <span class="o">=</span> <span class="n">hydmod_file</span> <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span>
    <span class="n">hyd_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">hydmod_outfile</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span><span class="s1">&#39;obsval&#39;</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1">#hyd_df = hyd_df[[&#39;obsnme&#39;,&#39;obsval&#39;]]</span>
    <span class="k">return</span> <span class="n">hyd_df</span><span class="p">[[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span><span class="s1">&#39;obsval&#39;</span><span class="p">]],</span> <span class="n">hydmod_outfile</span></div>


<div class="viewcode-block" id="setup_mtlist_budget_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_mtlist_budget_obs">[docs]</a><span class="k">def</span> <span class="nf">setup_mtlist_budget_obs</span><span class="p">(</span><span class="n">list_filename</span><span class="p">,</span><span class="n">gw_filename</span><span class="o">=</span><span class="s2">&quot;mtlist_gw.dat&quot;</span><span class="p">,</span><span class="n">sw_filename</span><span class="o">=</span><span class="s2">&quot;mtlist_sw.dat&quot;</span><span class="p">,</span>
                            <span class="n">start_datetime</span><span class="o">=</span><span class="s2">&quot;1-1-1970&quot;</span><span class="p">,</span><span class="n">gw_prefix</span><span class="o">=</span><span class="s1">&#39;gw&#39;</span><span class="p">,</span><span class="n">sw_prefix</span><span class="o">=</span><span class="s2">&quot;sw&quot;</span><span class="p">,</span>
                            <span class="n">save_setup_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; setup observations of gw (and optionally sw) mass budgets from mt3dusgs list file.</span>

<span class="sd">    Args:</span>
<span class="sd">        list_filename (`str`): path and name of existing modflow list file</span>
<span class="sd">        gw_filename (`str`, optional): output filename that will contain the gw budget</span>
<span class="sd">            observations. Default is &quot;mtlist_gw.dat&quot;</span>
<span class="sd">        sw_filename (`str`, optional): output filename that will contain the sw budget</span>
<span class="sd">            observations. Default is &quot;mtlist_sw.dat&quot;</span>
<span class="sd">        start_datetime (`str`, optional):  an str that can be parsed into a `pandas.TimeStamp`.</span>
<span class="sd">            used to give budget observations meaningful names.  Default is &quot;1-1-1970&quot;.</span>
<span class="sd">        gw_prefix (`str`, optional): a prefix to add to the GW budget observations.</span>
<span class="sd">            Useful if processing more than one list file as part of the forward run process.</span>
<span class="sd">            Default is &#39;gw&#39;.</span>
<span class="sd">        sw_prefix (`str`, optional): a prefix to add to the SW budget observations.  Useful</span>
<span class="sd">            if processing more than one list file as part of the forward run process.</span>
<span class="sd">            Default is &#39;sw&#39;.</span>
<span class="sd">        save_setup_file (`bool`, optional): a flag to save &quot;_setup_&quot;+ `list_filename` +&quot;.csv&quot; file</span>
<span class="sd">            that contains useful control file information.  Default is `False`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>

<span class="sd">        - **str**:  the command to add to the forward run script</span>
<span class="sd">        - **str**: the names of the instruction files that were created</span>
<span class="sd">        - **pandas.DataFrame**: a dataframe with information for constructing a control file</span>


<span class="sd">    Note:</span>
<span class="sd">        writes an instruction file and also a _setup_.csv to use when constructing a pest</span>
<span class="sd">            control file</span>

<span class="sd">        the instruction files are named `out_filename` +&quot;.ins&quot;</span>

<span class="sd">        It is recommended to use the default value for `gw_filename` or `sw_filename`.</span>

<span class="sd">        This is the companion function of `gw_utils.apply_mtlist_budget_obs()`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">gw</span><span class="p">,</span><span class="n">sw</span> <span class="o">=</span> <span class="n">apply_mtlist_budget_obs</span><span class="p">(</span><span class="n">list_filename</span><span class="p">,</span> <span class="n">gw_filename</span><span class="p">,</span> <span class="n">sw_filename</span><span class="p">,</span> <span class="n">start_datetime</span><span class="p">)</span>
    <span class="n">gw_ins</span> <span class="o">=</span> <span class="n">gw_filename</span> <span class="o">+</span> <span class="s2">&quot;.ins&quot;</span>
    <span class="n">_write_mtlist_ins</span><span class="p">(</span><span class="n">gw_ins</span><span class="p">,</span> <span class="n">gw</span><span class="p">,</span> <span class="n">gw_prefix</span><span class="p">)</span>
    <span class="n">ins_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">gw_ins</span><span class="p">]</span>

    <span class="n">df_gw</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">gw_ins</span><span class="p">,</span><span class="n">gw_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df_gw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error processing groundwater instruction file&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sw_ins</span> <span class="o">=</span> <span class="n">sw_filename</span> <span class="o">+</span> <span class="s2">&quot;.ins&quot;</span>
        <span class="n">_write_mtlist_ins</span><span class="p">(</span><span class="n">sw_ins</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">sw_prefix</span><span class="p">)</span>
        <span class="n">ins_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sw_ins</span><span class="p">)</span>

        <span class="n">df_sw</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">sw_ins</span><span class="p">,</span><span class="n">sw_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_sw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error processing surface water instruction file&quot;</span><span class="p">)</span>
        <span class="n">df_gw</span> <span class="o">=</span> <span class="n">df_gw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_sw</span><span class="p">)</span>
        <span class="n">df_gw</span><span class="o">.</span><span class="n">obsnme</span> <span class="o">=</span> <span class="n">df_gw</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">save_setup_file</span><span class="p">:</span>
        <span class="n">df_gw</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;_setup_&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">list_filename</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">frun_line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils.apply_mtlist_budget_obs(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">list_filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frun_line</span><span class="p">,</span><span class="n">ins_files</span><span class="p">,</span><span class="n">df_gw</span></div>

<span class="k">def</span> <span class="nf">_write_mtlist_ins</span><span class="p">(</span><span class="n">ins_filename</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; write an instruction file for a MT3D-USGS list file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dt_str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">dt_str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:08.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1"># if prefix == &#39;&#39;:</span>
    <span class="c1">#     name_len = 11</span>
    <span class="c1"># else:</span>
    <span class="c1">#     name_len = 11 - (len(prefix)+1)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pif ~</span><span class="se">\n</span><span class="s1">l1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_str</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;l1 &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">r</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]])[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">raw</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#raw[0] = raw[0][:6]</span>
                <span class="c1">#name = &#39;&#39;.join(raw)</span>
                <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">obsnme</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">obsnme</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; w !</span><span class="si">{0}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obsnme</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="apply_mtlist_budget_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_mtlist_budget_obs">[docs]</a><span class="k">def</span> <span class="nf">apply_mtlist_budget_obs</span><span class="p">(</span><span class="n">list_filename</span><span class="p">,</span><span class="n">gw_filename</span><span class="o">=</span><span class="s2">&quot;mtlist_gw.dat&quot;</span><span class="p">,</span>
                            <span class="n">sw_filename</span><span class="o">=</span><span class="s2">&quot;mtlist_sw.dat&quot;</span><span class="p">,</span>
                            <span class="n">start_datetime</span><span class="o">=</span><span class="s2">&quot;1-1-1970&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; process an MT3D-USGS list file to extract mass budget entries.</span>

<span class="sd">    Args:</span>
<span class="sd">        list_filename (`str`): the path and name of an existing MT3D-USGS list file</span>
<span class="sd">        gw_filename (`str`, optional): the name of the output file with gw mass</span>
<span class="sd">            budget information. Default is &quot;mtlist_gw.dat&quot;</span>
<span class="sd">        sw_filename (`str`): the name of the output file with sw mass budget information.</span>
<span class="sd">            Default is &quot;mtlist_sw.dat&quot;</span>
<span class="sd">        start_datatime (`str`): an str that can be cast to a pandas.TimeStamp.  Used to give</span>
<span class="sd">            observations a meaningful name</span>

<span class="sd">    Returns:</span>
<span class="sd">        2-element tuple containing</span>

<span class="sd">        - **pandas.DataFrame**: the gw mass budget dataframe</span>
<span class="sd">        - **pandas.DataFrame**: (optional) the sw mass budget dataframe.</span>
<span class="sd">          If the SFT process is not active, this returned value is `None`.</span>

<span class="sd">    Note:</span>
<span class="sd">        this is the companion function of `gw_utils.setup_mtlist_budget_obs()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error import flopy: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MtListBudget</span><span class="p">(</span><span class="n">list_filename</span><span class="p">)</span>
    <span class="n">gw</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">start_datetime</span><span class="o">=</span><span class="n">start_datetime</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gw</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gw</span><span class="o">.</span><span class="n">columns</span>
                  <span class="k">for</span> <span class="n">drop_col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kper&quot;</span><span class="p">,</span> <span class="s2">&quot;kstp&quot;</span><span class="p">,</span> <span class="s2">&quot;tkstp&quot;</span><span class="p">]</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">drop_col</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gw</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">gw_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sw</span> <span class="o">=</span> <span class="n">sw</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">sw</span><span class="o">.</span><span class="n">columns</span>
                      <span class="k">for</span> <span class="n">drop_col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;kper&quot;</span><span class="p">,</span> <span class="s2">&quot;kstp&quot;</span><span class="p">,</span> <span class="s2">&quot;tkstp&quot;</span><span class="p">]</span>
                      <span class="k">if</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">drop_col</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sw</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sw_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gw</span><span class="p">,</span> <span class="n">sw</span></div>

<div class="viewcode-block" id="setup_mflist_budget_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_mflist_budget_obs">[docs]</a><span class="k">def</span> <span class="nf">setup_mflist_budget_obs</span><span class="p">(</span><span class="n">list_filename</span><span class="p">,</span><span class="n">flx_filename</span><span class="o">=</span><span class="s2">&quot;flux.dat&quot;</span><span class="p">,</span>
                            <span class="n">vol_filename</span><span class="o">=</span><span class="s2">&quot;vol.dat&quot;</span><span class="p">,</span><span class="n">start_datetime</span><span class="o">=</span><span class="s2">&quot;1-1&#39;1970&quot;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="n">save_setup_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; setup observations of budget volume and flux from modflow list file.</span>

<span class="sd">    Args:</span>
<span class="sd">        list_filename (`str`): path and name of the existing modflow list file</span>
<span class="sd">        flx_filename (`str`, optional): output filename that will contain the budget flux</span>
<span class="sd">            observations. Default is &quot;flux.dat&quot;</span>
<span class="sd">        vol_filename (`str`, optional): output filename that will contain the budget volume</span>
<span class="sd">            observations.  Default is &quot;vol.dat&quot;</span>
<span class="sd">        start_datetime (`str`, optional): a string that can be parsed into a pandas.TimeStamp.</span>
<span class="sd">            This is used to give budget observations meaningful names.  Default is &quot;1-1-1970&quot;.</span>
<span class="sd">        prefix (`str`, optional): a prefix to add to the water budget observations.  Useful if</span>
<span class="sd">            processing more than one list file as part of the forward run process. Default is &#39;&#39;.</span>
<span class="sd">        save_setup_file (`bool`): a flag to save &quot;_setup_&quot;+ `list_filename` +&quot;.csv&quot; file that contains useful</span>
<span class="sd">            control file information</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataframe with information for constructing a control file.</span>

<span class="sd">    Note:</span>
<span class="sd">        This method writes instruction files and also a _setup_.csv to use when constructing a pest</span>
<span class="sd">        control file.  The instruction files are named &lt;flux_file&gt;.ins and &lt;vol_file&gt;.ins, respectively</span>

<span class="sd">        It is recommended to use the default values for flux_file and vol_file.</span>

<span class="sd">        This is the companion function of `gw_utils.setup_mflist_budget_obs()`.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flx</span><span class="p">,</span><span class="n">vol</span> <span class="o">=</span> <span class="n">apply_mflist_budget_obs</span><span class="p">(</span><span class="n">list_filename</span><span class="p">,</span><span class="n">flx_filename</span><span class="p">,</span><span class="n">vol_filename</span><span class="p">,</span>
                                      <span class="n">start_datetime</span><span class="p">)</span>
    <span class="n">_write_mflist_ins</span><span class="p">(</span><span class="n">flx_filename</span><span class="o">+</span><span class="s2">&quot;.ins&quot;</span><span class="p">,</span><span class="n">flx</span><span class="p">,</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;flx&quot;</span><span class="p">)</span>
    <span class="n">_write_mflist_ins</span><span class="p">(</span><span class="n">vol_filename</span><span class="o">+</span><span class="s2">&quot;.ins&quot;</span><span class="p">,</span><span class="n">vol</span><span class="p">,</span> <span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;vol&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">flx_filename</span><span class="o">+</span><span class="s2">&quot;.ins&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error processing flux instruction file&quot;</span><span class="p">)</span>

    <span class="n">df2</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">vol_filename</span><span class="o">+</span><span class="s2">&quot;.ins&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error processing volume instruction file&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">save_setup_file</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;_setup_&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">list_filename</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="apply_mflist_budget_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_mflist_budget_obs">[docs]</a><span class="k">def</span> <span class="nf">apply_mflist_budget_obs</span><span class="p">(</span><span class="n">list_filename</span><span class="p">,</span><span class="n">flx_filename</span><span class="o">=</span><span class="s2">&quot;flux.dat&quot;</span><span class="p">,</span>
                            <span class="n">vol_filename</span><span class="o">=</span><span class="s2">&quot;vol.dat&quot;</span><span class="p">,</span>
                            <span class="n">start_datetime</span><span class="o">=</span><span class="s2">&quot;1-1-1970&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; process a MODFLOW list file to extract flux and volume water budget entries.</span>

<span class="sd">   Args:</span>
<span class="sd">        list_filename (`str`): path and name of the existing modflow list file</span>
<span class="sd">        flx_filename (`str`, optional): output filename that will contain the budget flux</span>
<span class="sd">            observations. Default is &quot;flux.dat&quot;</span>
<span class="sd">        vol_filename (`str`, optional): output filename that will contain the budget volume</span>
<span class="sd">            observations.  Default is &quot;vol.dat&quot;</span>
<span class="sd">        start_datetime (`str`, optional): a string that can be parsed into a pandas.TimeStamp.</span>
<span class="sd">            This is used to give budget observations meaningful names.  Default is &quot;1-1-1970&quot;.</span>
<span class="sd">        prefix (`str`, optional): a prefix to add to the water budget observations.  Useful if</span>
<span class="sd">            processing more than one list file as part of the forward run process. Default is &#39;&#39;.</span>
<span class="sd">        save_setup_file (`bool`): a flag to save _setup_&lt;list_filename&gt;.csv file that contains useful</span>
<span class="sd">            control file information</span>

<span class="sd">    Note:</span>
<span class="sd">        this is the companion function of `gw_utils.setup_mflist_budget_obs()`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>


<span class="sd">        - **pandas.DataFrame**: a dataframe with flux budget information</span>
<span class="sd">        - **pandas.DataFrame**: a dataframe with cumulative budget information</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error import flopy: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="n">mlf</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MfListBudget</span><span class="p">(</span><span class="n">list_filename</span><span class="p">)</span>
    <span class="n">flx</span><span class="p">,</span><span class="n">vol</span> <span class="o">=</span> <span class="n">mlf</span><span class="o">.</span><span class="n">get_dataframes</span><span class="p">(</span><span class="n">start_datetime</span><span class="o">=</span><span class="n">start_datetime</span><span class="p">,</span><span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">flx</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">flx_filename</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">vol</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">vol_filename</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">index_label</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span><span class="n">date_format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flx</span><span class="p">,</span><span class="n">vol</span></div>


<span class="k">def</span> <span class="nf">_write_mflist_ins</span><span class="p">(</span><span class="n">ins_filename</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; write an instruction file for a MODFLOW list file</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dt_str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pif ~</span><span class="se">\n</span><span class="s1">l1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_str</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;l1 &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">obsnme</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; w !</span><span class="si">{0}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obsnme</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="setup_hds_timeseries"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_hds_timeseries">[docs]</a><span class="k">def</span> <span class="nf">setup_hds_timeseries</span><span class="p">(</span><span class="n">hds_file</span><span class="p">,</span><span class="n">kij_dict</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">include_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">postprocess_inact</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a function to setup a forward process to extract time-series style values</span>
<span class="sd">    from a binary modflow head save (or equivalent format - ucn, sub, etc).</span>

<span class="sd">    Args:</span>
<span class="sd">        hds_file (`str`): path and name of existing modflow head-save format binary file</span>
<span class="sd">        kij_dict (`dict`): dictionary of site_name: [k,i,j] pairs. For example: `{&quot;wel1&quot;:[0,1,1]}`.</span>
<span class="sd">        prefix (`str`, optional): string to prepend to site_name when forming observation names.  Default is None</span>
<span class="sd">        include_path (`bool`, optional): flag to setup the binary file processing in directory where the hds_file</span>
<span class="sd">        is located (if different from where python is running).  This is useful for setting up</span>
<span class="sd">            the process in separate directory for where python is running.</span>
<span class="sd">        model (`flopy.mbase`, optional): a `flopy.basemodel` instance.  If passed, the observation names will</span>
<span class="sd">            have the datetime of the observation appended to them (using the flopy `start_datetime` attribute.</span>
<span class="sd">            If None, the observation names will have the zero-based stress period appended to them. Default is None.</span>
<span class="sd">        postprocess_inact (`float`, optional): Inactive value in heads/ucn file e.g. mt.btn.cinit.  If `None`, no</span>
<span class="sd">            inactive value processing happens.  Default is `None`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>

<span class="sd">        - **str**: the forward run command to execute the binary file process during model runs.</span>

<span class="sd">        - **pandas.DataFrame**: a dataframe of observation information for use in the pest control file</span>

<span class="sd">    Note:</span>

<span class="sd">        This function writes hds_timeseries.config that must be in the same</span>
<span class="sd">        dir where `apply_hds_timeseries()` is called during the forward run</span>

<span class="sd">        Assumes model time units are days</span>

<span class="sd">        this is the companion function of `gw_utils.apply_hds_timeseries()`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error importing flopy, returning </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hds_file</span><span class="p">),</span><span class="s2">&quot;head save file not found&quot;</span>
    <span class="k">if</span> <span class="n">hds_file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ucn&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">UcnFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error instantiating UcnFile:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">HeadFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error instantiating HeadFile:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

    <span class="n">nlay</span><span class="p">,</span><span class="n">nrow</span><span class="p">,</span><span class="n">ncol</span> <span class="o">=</span> <span class="n">hds</span><span class="o">.</span><span class="n">nlay</span><span class="p">,</span><span class="n">hds</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span><span class="n">hds</span><span class="o">.</span><span class="n">ncol</span>

    <span class="c1">#if include_path:</span>
    <span class="c1">#    pth = os.path.join(*[p for p in os.path.split(hds_file)[:-1]])</span>
    <span class="c1">#    config_file = os.path.join(pth,&quot;{0}_timeseries.config&quot;.format(hds_file))</span>
    <span class="c1">#else:</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_timeseries.config&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing config file to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>

    <span class="n">f_config</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">itmuni</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;setup_hds_timeseries only supports &#39;days&#39; time units...&quot;</span><span class="p">,</span><span class="n">PyemuWarning</span><span class="p">)</span>
        <span class="n">f_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">,d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">model</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">))</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">,none,none</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">f_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;site,k,i,j</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">site</span><span class="p">,(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kij_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nlay</span><span class="p">,</span> <span class="n">k</span>
        <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">i</span>
        <span class="k">assert</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">j</span>
        <span class="n">site</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hds</span><span class="o">.</span><span class="n">get_ts</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;totim&quot;</span><span class="p">,</span><span class="n">site</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dts</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">totim</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;totim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dts</span>
        <span class="c1">#print(df)</span>
        <span class="n">f_config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">,</span><span class="si">{2}</span><span class="s2">,</span><span class="si">{3}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;totim&quot;</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">f_config</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">hds_file</span><span class="o">+</span><span class="s2">&quot;_timeseries.processed&quot;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:08.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">ins_file</span> <span class="o">=</span> <span class="n">hds_file</span><span class="o">+</span><span class="s2">&quot;_timeseries.processed.ins&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing instruction file to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pif ~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;l1 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_str</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;l1 w &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">obsnme</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">site</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">obsnme</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; !</span><span class="si">{0}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obsnme</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">postprocess_inact</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_setup_postprocess_hds_timeseries</span><span class="p">(</span><span class="n">hds_file</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">config_file</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
    <span class="n">bd</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">if</span> <span class="n">include_path</span><span class="p">:</span>
        <span class="n">bd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">config_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">apply_hds_timeseries</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">postprocess_inact</span><span class="o">=</span><span class="n">postprocess_inact</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bd</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error in apply_hds_timeseries(): </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bd</span><span class="p">)</span>


    <span class="n">df</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error processing </span><span class="si">{0}</span><span class="s2"> instruction file&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">frun_line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils.apply_hds_timeseries(&#39;</span><span class="si">{0}</span><span class="s2">&#39;,</span><span class="si">{1}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">postprocess_inact</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frun_line</span><span class="p">,</span><span class="n">df</span></div>


<div class="viewcode-block" id="apply_hds_timeseries"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_hds_timeseries">[docs]</a><span class="k">def</span> <span class="nf">apply_hds_timeseries</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">postprocess_inact</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;process a modflow headsave format binary file using a previously written</span>
<span class="sd">    configuration file</span>

<span class="sd">    Args:</span>
<span class="sd">        config_file (`str`, optional): configuration file written by `pyemu.gw_utils.setup_hds_timeseries`.</span>
<span class="sd">            If `None`, looks for `hds_timeseries.config`</span>
<span class="sd">        postprocess_inact (`float`, optional): Inactive value in heads/ucn file e.g. mt.btn.cinit.  If `None`, no</span>
<span class="sd">            inactive value processing happens.  Default is `None`.</span>

<span class="sd">    Note:</span>
<span class="sd">        this is the companion function of `gw_utils.setup_hds_timeseries()`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">flopy</span>

    <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;hds_timeseries.config&quot;</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_file</span><span class="p">),</span> <span class="n">config_file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">hds_file</span><span class="p">,</span><span class="n">start_datetime</span><span class="p">,</span><span class="n">time_units</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">site_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1">#print(site_df)</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hds_file</span><span class="p">),</span> <span class="s2">&quot;head save file not found&quot;</span>
    <span class="k">if</span> <span class="n">hds_file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ucn&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">UcnFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error instantiating UcnFile:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">HeadFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error instantiating HeadFile:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

    <span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">hds</span><span class="o">.</span><span class="n">nlay</span><span class="p">,</span> <span class="n">hds</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="n">hds</span><span class="o">.</span><span class="n">ncol</span>

    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">site</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">site_df</span><span class="o">.</span><span class="n">site</span><span class="p">,</span><span class="n">site_df</span><span class="o">.</span><span class="n">k</span><span class="p">,</span><span class="n">site_df</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">site_df</span><span class="o">.</span><span class="n">j</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nlay</span>
        <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrow</span>
        <span class="k">assert</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ncol</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hds</span><span class="o">.</span><span class="n">get_ts</span><span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;totim&quot;</span><span class="p">,</span><span class="n">site</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;totim&quot;</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#print(df)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">hds_file</span><span class="o">+</span><span class="s2">&quot;_timeseries.processed&quot;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">postprocess_inact</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_apply_postprocess_hds_timeseries</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="n">postprocess_inact</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="k">def</span> <span class="nf">_setup_postprocess_hds_timeseries</span><span class="p">(</span><span class="n">hds_file</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">config_file</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dirty function to setup post processing concentrations in inactive/dry cells&quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;Setting up post processing of hds or ucn timeseries obs. &quot;</span>
        <span class="s2">&quot;Prepending &#39;pp&#39; to obs name may cause length to exceed 20 chars&quot;</span><span class="p">,</span> <span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:08.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;pp</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;pp&quot;</span>
    <span class="n">ins_file</span> <span class="o">=</span> <span class="n">hds_file</span><span class="o">+</span><span class="s2">&quot;_timeseries.post_processed.ins&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing instruction file to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins_file</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pif ~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;l1 </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_str</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;l1 w &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">obsnme</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; !</span><span class="si">{0}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obsnme</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">frun_line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils._apply_postprocess_hds_timeseries(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frun_line</span>


<span class="k">def</span> <span class="nf">_apply_postprocess_hds_timeseries</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cinact</span><span class="o">=</span><span class="mf">1e30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;private function to post processing binary files&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">flopy</span>

    <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;hds_timeseries.config&quot;</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_file</span><span class="p">),</span> <span class="n">config_file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">hds_file</span><span class="p">,</span><span class="n">start_datetime</span><span class="p">,</span><span class="n">time_units</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">site_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1">#print(site_df)</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hds_file</span><span class="p">),</span> <span class="s2">&quot;head save file not found&quot;</span>
    <span class="k">if</span> <span class="n">hds_file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ucn&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">UcnFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error instantiating UcnFile:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">HeadFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error instantiating HeadFile:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

    <span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">hds</span><span class="o">.</span><span class="n">nlay</span><span class="p">,</span> <span class="n">hds</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="n">hds</span><span class="o">.</span><span class="n">ncol</span>

    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">site</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">site_df</span><span class="o">.</span><span class="n">site</span><span class="p">,</span> <span class="n">site_df</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">site_df</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">site_df</span><span class="o">.</span><span class="n">j</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nlay</span>
        <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrow</span>
        <span class="k">assert</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ncol</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hds</span><span class="o">.</span><span class="n">get_ts</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;totim&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;totim&quot;</span><span class="p">)</span>
        <span class="n">inact_obs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cinact</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">inact_obs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">nlay</span><span class="p">,</span> <span class="s2">&quot;Inactive observation in lowest layer&quot;</span>
            <span class="n">df_lower</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hds</span><span class="o">.</span><span class="n">get_ts</span><span class="p">((</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;totim&quot;</span><span class="p">,</span> <span class="n">site</span><span class="p">])</span>
            <span class="n">df_lower</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_lower</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;totim&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inact_obs</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lower</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inact_obs</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> observation(s) post-processed for site </span><span class="si">{1}</span><span class="s2"> at kij (</span><span class="si">{2}</span><span class="s2">,</span><span class="si">{3}</span><span class="s2">,</span><span class="si">{4}</span><span class="s2">)&quot;</span><span class="o">.</span>
                  <span class="nb">format</span><span class="p">(</span><span class="n">inact_obs</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">site</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#print(df)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">hds_file</span><span class="o">+</span><span class="s2">&quot;_timeseries.post_processed&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="setup_hds_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_hds_obs">[docs]</a><span class="k">def</span> <span class="nf">setup_hds_obs</span><span class="p">(</span><span class="n">hds_file</span><span class="p">,</span><span class="n">kperk_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;hds&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a function to setup using all values from a layer-stress period</span>
<span class="sd">    pair for observations.</span>

<span class="sd">    Args:</span>
<span class="sd">        hds_file (`str`): path and name of an existing MODFLOW head-save file.</span>
<span class="sd">            If the hds_file endswith &#39;ucn&#39;, then the file is treated as a UcnFile type.</span>
<span class="sd">        kperk_pairs ([(int,int)]): a list of len two tuples which are pairs of kper</span>
<span class="sd">            (zero-based stress period index) and k (zero-based layer index) to</span>
<span class="sd">            setup observations for.  If None, then all layers and stress period records</span>
<span class="sd">            found in the file will be used.  Caution: a shit-ton of observations may be produced!</span>
<span class="sd">        skip (variable): a value or function used to determine which values</span>
<span class="sd">            to skip when setting up observations.  If np.scalar(skip)</span>
<span class="sd">            is True, then values equal to skip will not be used.</span>
<span class="sd">            If skip can also be a np.ndarry with dimensions equal to the model.</span>
<span class="sd">            Observations are set up only for cells with Non-zero values in the array.</span>
<span class="sd">            If not np.ndarray or np.scalar(skip), then skip will be treated as a lambda function that</span>
<span class="sd">            returns np.NaN if the value should be skipped.</span>
<span class="sd">        prefix (`str`): the prefix to use for the observation names. default is &quot;hds&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>

<span class="sd">        - **str**: the forward run script line needed to execute the headsave file observation</span>
<span class="sd">          operation</span>
<span class="sd">        - **pandas.DataFrame**: a dataframe of pest control file information</span>

<span class="sd">    Note:</span>
<span class="sd">        Writes an instruction file and a _setup_ csv used construct a control file.</span>

<span class="sd">        This is the companion function to `gw_utils.apply_hds_obs()`.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error importing flopy, returning </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">return</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hds_file</span><span class="p">),</span><span class="s2">&quot;head save file not found&quot;</span>
    <span class="k">if</span> <span class="n">hds_file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.ucn&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">UcnFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error instantiating UcnFile:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">HeadFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error instantiating HeadFile:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">kperk_pairs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kperk_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kstp</span><span class="p">,</span><span class="n">kper</span> <span class="ow">in</span> <span class="n">hds</span><span class="o">.</span><span class="n">kstpkper</span><span class="p">:</span>
            <span class="n">kperk_pairs</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">kper</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hds</span><span class="o">.</span><span class="n">nlay</span><span class="p">)])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kperk_pairs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kperk_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">kperk_pairs</span> <span class="o">=</span> <span class="p">[</span><span class="n">kperk_pairs</span><span class="p">]</span>

    <span class="c1">#if start_datetime is not None:</span>
    <span class="c1">#    start_datetime = pd.to_datetime(start_datetime)</span>
    <span class="c1">#    dts = start_datetime + pd.to_timedelta(hds.times,unit=&#39;d&#39;)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">kpers</span> <span class="o">=</span> <span class="p">[</span><span class="n">kper</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">kstp</span><span class="p">,</span><span class="n">kper</span> <span class="ow">in</span> <span class="n">hds</span><span class="o">.</span><span class="n">kstpkper</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">kperk_pair</span> <span class="ow">in</span> <span class="n">kperk_pairs</span><span class="p">:</span>
        <span class="n">kper</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">kperk_pair</span>
        <span class="k">assert</span> <span class="n">kper</span> <span class="ow">in</span> <span class="n">kpers</span><span class="p">,</span> <span class="s2">&quot;kper not in hds:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kper</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hds</span><span class="o">.</span><span class="n">nlay</span><span class="p">),</span> <span class="s2">&quot;k not in hds:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">kstp</span> <span class="o">=</span> <span class="n">last_kstp_from_kper</span><span class="p">(</span><span class="n">hds</span><span class="p">,</span><span class="n">kper</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">hds</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">kstpkper</span><span class="o">=</span><span class="p">(</span><span class="n">kstp</span><span class="p">,</span><span class="n">kper</span><span class="p">))[</span><span class="n">k</span><span class="p">,:,:]</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kper</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="c1">#data[(kper,k)] = d.flatten()</span>
    <span class="n">idx</span><span class="p">,</span><span class="n">iidx</span><span class="p">,</span><span class="n">jidx</span> <span class="o">=</span> <span class="p">[],[],[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hds</span><span class="o">.</span><span class="n">nrow</span><span class="p">):</span>
            <span class="n">iidx</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hds</span><span class="o">.</span><span class="n">ncol</span><span class="p">)])</span>
            <span class="n">jidx</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hds</span><span class="o">.</span><span class="n">ncol</span><span class="p">)])</span>
            <span class="n">idx</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;i</span><span class="si">{0:04d}</span><span class="s2">_j</span><span class="si">{1:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hds</span><span class="o">.</span><span class="n">ncol</span><span class="p">)])</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">hds</span><span class="o">.</span><span class="n">nrow</span><span class="o">*</span><span class="n">hds</span><span class="o">.</span><span class="n">ncol</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">data_cols</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c1">#df.loc[:,&quot;iidx&quot;] = iidx</span>
    <span class="c1">#df.loc[:,&quot;jidx&quot;] = jidx</span>
    <span class="k">if</span> <span class="n">skip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">skip</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span><span class="o">==</span><span class="n">skip</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">skip</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;skip passed as </span><span class="si">{}</span><span class="s2">D array, At least 2D (&lt;= 4D) array required&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">skip</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">skip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">hds</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="n">hds</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span> \
                    <span class="s2">&quot;Array dimensions of arg. skip needs to match model dimensions (</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">). (</span><span class="si">{2}</span><span class="s2">,</span><span class="si">{3}</span><span class="s2">) passed&quot;</span><span class="o">.</span>\
                        <span class="nb">format</span><span class="p">(</span><span class="n">hds</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span> <span class="n">hds</span><span class="o">.</span><span class="n">ncol</span><span class="p">,</span> <span class="n">skip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">skip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">skip</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2D array passed for skip, assuming constant for all layers and kper&quot;</span><span class="p">)</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kpers</span><span class="p">),</span> <span class="n">hds</span><span class="o">.</span><span class="n">nlay</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">skip</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3D array passed for skip, assuming constant for all kper&quot;</span><span class="p">)</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">skip</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kpers</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">kper</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">skip</span><span class="p">[</span><span class="n">kper</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">))]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span>

    <span class="c1"># melt to long form</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;kperk&quot;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;obsval&quot;</span><span class="p">)</span>
    <span class="c1"># set row and col identifies</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;iidx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iidx</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;jidx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jidx</span>
    <span class="c1">#drop nans from skip</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="c1">#set some additional identifiers</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;kper&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kperk</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;kidx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;kperk&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="c1"># form obs names</span>
    <span class="c1">#def get_kper_str(kper):</span>
    <span class="c1">#    if start_datetime is not None:</span>
    <span class="c1">#        return  dts[int(kper)].strftime(&quot;%Y%m%d&quot;)</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        return &quot;kper{0:04.0f}&quot;.format(kper)</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_</span><span class="si">{0:02.0f}</span><span class="s2">_</span><span class="si">{1:03.0f}</span><span class="s2">_</span><span class="si">{2:03.0f}</span><span class="s2">_</span><span class="si">{3:03.0f}</span><span class="s2">&quot;</span>
    <span class="c1"># df.loc[:,&quot;obsnme&quot;] = df.apply(lambda x: fmt.format(x.kidx,x.iidx,x.jidx,</span>
    <span class="c1">#                                                   get_kper_str(x.kper)),axis=1)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">kidx</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">iidx</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">jidx</span><span class="p">,</span>
                                                      <span class="n">x</span><span class="o">.</span><span class="n">kper</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;ins_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;l1 w !</span><span class="si">{0}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span>
    <span class="c1">#write the instruction file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hds_file</span><span class="o">+</span><span class="s2">&quot;.dat.ins&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pif ~</span><span class="se">\n</span><span class="s2">l1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">ins_str</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#write the corresponding output file</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s2">&quot;obsnme&quot;</span><span class="p">,</span><span class="s2">&quot;obsval&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">hds_file</span><span class="o">+</span><span class="s2">&quot;.dat&quot;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">hds_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
    <span class="n">setup_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hds_path</span><span class="p">,</span><span class="s2">&quot;_setup_</span><span class="si">{0}</span><span class="s2">.csv&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">setup_file</span><span class="p">)</span>
    <span class="n">fwd_run_line</span> <span class="o">=</span> <span class="s2">&quot;pyemu.gw_utils.apply_hds_obs(&#39;</span><span class="si">{0}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span>
    <span class="k">return</span> <span class="n">fwd_run_line</span><span class="p">,</span> <span class="n">df</span></div>


<div class="viewcode-block" id="last_kstp_from_kper"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.last_kstp_from_kper">[docs]</a><span class="k">def</span> <span class="nf">last_kstp_from_kper</span><span class="p">(</span><span class="n">hds</span><span class="p">,</span><span class="n">kper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; function to find the last time step (kstp) for a</span>
<span class="sd">    give stress period (kper) in a modflow head save file.</span>

<span class="sd">    Args:</span>
<span class="sd">        hds (`flopy.utils.HeadFile`): head save file</span>

<span class="sd">        kper (`int`): the zero-index stress period number</span>

<span class="sd">    Returns:</span>
<span class="sd">        **int**: the zero-based last time step during stress period</span>
<span class="sd">        kper in the head save file</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#find the last kstp with this kper</span>
    <span class="n">kstp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">kkstp</span><span class="p">,</span><span class="n">kkper</span> <span class="ow">in</span> <span class="n">hds</span><span class="o">.</span><span class="n">kstpkper</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kkper</span> <span class="o">==</span> <span class="n">kper</span><span class="o">+</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">kkstp</span> <span class="o">&gt;</span> <span class="n">kstp</span><span class="p">:</span>
            <span class="n">kstp</span> <span class="o">=</span> <span class="n">kkstp</span>
    <span class="k">if</span> <span class="n">kstp</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;kstp not found for kper </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kper</span><span class="p">))</span>
    <span class="n">kstp</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">kstp</span></div>


<div class="viewcode-block" id="apply_hds_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_hds_obs">[docs]</a><span class="k">def</span> <span class="nf">apply_hds_obs</span><span class="p">(</span><span class="n">hds_file</span><span class="p">,</span> <span class="n">inact_abs_val</span><span class="o">=</span><span class="mf">1.0e+20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; process a modflow head save file.  A companion function to</span>
<span class="sd">    `gw_utils.setup_hds_obsI()` that is called during the forward run process</span>

<span class="sd">    Args:</span>
<span class="sd">        hds_file (`str`): a modflow head save filename. if hds_file ends with &#39;ucn&#39;,</span>
<span class="sd">            then the file is treated as a UcnFile type.</span>
<span class="sd">        inact_abs_val (`float`, optional): the value that marks the mininum and maximum</span>
<span class="sd">            active value.  values in the headsave file greater than `inact_abs_val` or less</span>
<span class="sd">            than -`inact_abs_val` are reset to `inact_abs_val`</span>
<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataframe with extracted simulated values.</span>
<span class="sd">    Note:</span>
<span class="sd">        This is the companion function to `gw_utils.setup_hds_obs()`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;apply_hds_obs(): error importing flopy: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                        <span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">pst_utils</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">hds_file</span><span class="o">+</span><span class="s2">&quot;.dat&quot;</span>
    <span class="n">ins_file</span> <span class="o">=</span> <span class="n">out_file</span> <span class="o">+</span> <span class="s2">&quot;.ins&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;obsnme&quot;</span><span class="p">:</span><span class="n">pst_utils</span><span class="o">.</span><span class="n">parse_ins_file</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span>

    <span class="c1"># populate metdata</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span><span class="s2">&quot;i&quot;</span><span class="p">,</span><span class="s2">&quot;j&quot;</span><span class="p">,</span><span class="s2">&quot;kper&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">hds_file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ucn&#39;</span><span class="p">):</span>
        <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">UcnFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">HeadFile</span><span class="p">(</span><span class="n">hds_file</span><span class="p">)</span>
    <span class="n">kpers</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obsval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="k">for</span> <span class="n">kper</span> <span class="ow">in</span> <span class="n">kpers</span><span class="p">:</span>
        <span class="n">kstp</span> <span class="o">=</span> <span class="n">last_kstp_from_kper</span><span class="p">(</span><span class="n">hds</span><span class="p">,</span><span class="n">kper</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hds</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">kstpkper</span><span class="o">=</span><span class="p">(</span><span class="n">kstp</span><span class="p">,</span><span class="n">kper</span><span class="p">))</span>
        <span class="c1">#jwhite 15jan2018 fix for really large values that are getting some</span>
        <span class="c1">#trash added to them...</span>
        <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inact_abs_val</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inact_abs_val</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">&lt;-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inact_abs_val</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inact_abs_val</span><span class="p">)</span>
        <span class="n">df_kper</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">==</span><span class="n">kper</span><span class="p">,:]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_kper</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="s2">&quot;obsval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">df_kper</span><span class="o">.</span><span class="n">k</span><span class="p">,</span><span class="n">df_kper</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">df_kper</span><span class="o">.</span><span class="n">j</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s2">&quot;obsnme&quot;</span><span class="p">,</span><span class="s2">&quot;obsval&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="setup_sft_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_sft_obs">[docs]</a><span class="k">def</span> <span class="nf">setup_sft_obs</span><span class="p">(</span><span class="n">sft_file</span><span class="p">,</span><span class="n">ins_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">start_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ncomp</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;writes a post-processor and instruction file for a mt3d-usgs sft output file</span>

<span class="sd">    Args:</span>
<span class="sd">        sft_file (`str`): path and name of an existing sft output file (ASCII)</span>
<span class="sd">        ins_file (`str`, optional): the name of the instruction file to create.</span>
<span class="sd">            If None, the name is `sft_file`+&quot;.ins&quot;.  Default is `None`.</span>
<span class="sd">        start_datetime (`str`): a pandas.to_datetime() compatible str.  If not None,</span>
<span class="sd">            then the resulting observation names have the datetime</span>
<span class="sd">            suffix.  If None, the suffix is the output totim.  Default</span>
<span class="sd">            is `None`.</span>
<span class="sd">        times ([`float`]): a list of times to make observations for.  If None, all times</span>
<span class="sd">            found in the file are used. Default is None.</span>
<span class="sd">        ncomp (`int`): number of components in transport model. Default is 1.</span>

<span class="sd">    Note:</span>
<span class="sd">        this is the companion function to `gw_utils.apply_sft_obs()`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataframe with observation names and values for the sft simulated</span>
<span class="sd">        concentrations.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sft_file</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">utimes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">utimes</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;the following times are missing:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sft_obs.config&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sft_file</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:15.6E}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">apply_sft_obs</span><span class="p">()</span>
    <span class="n">utimes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">utimes</span><span class="p">,</span><span class="s2">&quot;time </span><span class="si">{0}</span><span class="s2"> missing in processed dataframe&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">times</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_datetime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_datetime</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_datetime</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time_str</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:08.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;ins_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;l1</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="c1"># check for multiple components</span>
    <span class="n">df_times</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;icomp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">icomp_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;icomp&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
        <span class="n">df_time</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">==</span><span class="n">t</span><span class="p">,:]</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="n">df_time</span><span class="o">.</span><span class="n">sfr_node</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">ncomp</span> <span class="o">=</span> <span class="n">vc</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">vc</span><span class="o">.</span><span class="n">values</span><span class="o">==</span><span class="n">ncomp</span><span class="p">)</span>
        <span class="n">nstrm</span> <span class="o">=</span> <span class="n">df_time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">ncomp</span>
        <span class="k">for</span> <span class="n">icomp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncomp</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nstrm</span><span class="o">*</span><span class="p">(</span><span class="n">icomp</span><span class="p">))</span>
            <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nstrm</span><span class="o">*</span><span class="p">(</span><span class="n">icomp</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">df_time</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span>
            <span class="c1">#df_time.iloc[nstrm*(icomp):nstrm*(icomp+1),icomp_idx.loc[&quot;icomp&quot;] = int(icomp+1)</span>
            <span class="n">df_time</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idxs</span><span class="p">,</span><span class="s2">&quot;icomp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">icomp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#df.loc[df_time.index,&quot;ins_str&quot;] = df_time.apply(lambda x: &quot;l1 w w !sfrc{0}_{1}_{2}! !swgw{0}_{1}_{2}! !gwcn{0}_{1}_{2}!\n&quot;.\</span>
        <span class="c1">#                                 format(x.sfr_node,x.icomp,x.time_str),axis=1)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_time</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;ins_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;l1 w w !sfrc</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">sfr_node</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">icomp</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">time_str</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ins_file</span> <span class="o">=</span> <span class="n">sft_file</span><span class="o">+</span><span class="s2">&quot;.processed.ins&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pif ~</span><span class="se">\n</span><span class="s2">l1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ins_str</span><span class="p">]</span>
    <span class="c1">#df = try_process_ins_file(ins_file,sft_file+&quot;.processed&quot;)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="n">sft_file</span><span class="o">+</span><span class="s2">&quot;.processed&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="apply_sft_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_sft_obs">[docs]</a><span class="k">def</span> <span class="nf">apply_sft_obs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;process an mt3d-usgs sft ASCII output file using a previous-written</span>
<span class="sd">    config file</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataframe of extracted simulated outputs</span>

<span class="sd">    Note:</span>
<span class="sd">        this is the companion function to `gw_utils.setup_sft_obs()`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this is for dealing with the missing &#39;e&#39; problem</span>
    <span class="k">def</span> <span class="nf">try_cast</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sft_obs.config&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">sft_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sft_file</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="c1">#,nrows=10000000)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">times</span><span class="p">),</span> <span class="p">:]</span>
    <span class="c1">#print(df.dtypes)</span>
    <span class="c1">#normalize</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1">#print(c)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;node&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">try_cast</span><span class="p">)</span>
        <span class="c1">#print(df.loc[df.loc[:,c].apply(lambda x : type(x) == str),:])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">&lt;</span><span class="mf">1e-30</span><span class="p">),</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e+30</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e+30</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;sfr_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sfr_node</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sft_file</span><span class="o">+</span><span class="s2">&quot;.processed&quot;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="setup_sfr_seg_parameters"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_sfr_seg_parameters">[docs]</a><span class="k">def</span> <span class="nf">setup_sfr_seg_parameters</span><span class="p">(</span><span class="n">nam_file</span><span class="p">,</span> <span class="n">model_ws</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">par_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">tie_hcond</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_temporal_pars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setup multiplier parameters for SFR segment data.</span>

<span class="sd">    Args:</span>
<span class="sd">        nam_file (`str`): MODFLOw name file.  DIS, BAS, and SFR must be</span>
<span class="sd">            available as pathed in the nam_file.  Optionally, `nam_file` can be</span>
<span class="sd">            an existing `flopy.modflow.Modflow`.</span>
<span class="sd">        model_ws (`str`): model workspace for flopy to load the MODFLOW model from</span>
<span class="sd">        par_cols ([`str`]): a list of segment data entires to parameterize</span>
<span class="sd">        tie_hcond (`bool`):  flag to use same mult par for hcond1 and hcond2 for a</span>
<span class="sd">            given segment.  Default is `True`.</span>
<span class="sd">        include_temporal_pars ([`str`]):  list of spatially-global multipliers to set up for</span>
<span class="sd">            each stress period.  Default is None</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataframe with useful parameter setup information</span>

<span class="sd">    Note:</span>
<span class="sd">         This function handles the standard input case, not all the cryptic SFR options.  Loads the</span>
<span class="sd">            dis, bas, and sfr files with flopy using model_ws.</span>

<span class="sd">        This is the companion function to `gw_utils.apply_sfr_seg_parameters()` .</span>

<span class="sd">        The number (and numbering) of segment data entries must consistent across</span>
<span class="sd">            all stress periods.</span>

<span class="sd">        Writes `nam_file` +&quot;_backup_.sfr&quot; as the backup of the original sfr file</span>

<span class="sd">        Skips values = 0.0 since multipliers don&#39;t work for these</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">par_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">par_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">,</span> <span class="s2">&quot;runoff&quot;</span><span class="p">,</span> <span class="s2">&quot;hcond1&quot;</span><span class="p">,</span> <span class="s2">&quot;pptsw&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tie_hcond</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;hcond1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par_cols</span> <span class="ow">or</span> <span class="s2">&quot;hcond2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par_cols</span><span class="p">:</span>
            <span class="n">tie_hcond</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nam_file</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">Modflow</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nam_file</span><span class="o">.</span><span class="n">sfr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">nam_file</span>
        <span class="n">nam_file</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">namefile</span>
        <span class="n">model_ws</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">model_ws</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># load MODFLOW model # is this needed? could we just pass the model if it has already been read in?</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nam_file</span><span class="p">,</span><span class="n">load_only</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">],</span><span class="n">model_ws</span><span class="o">=</span><span class="n">model_ws</span><span class="p">,</span><span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">forgive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_temporal_pars</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">include_temporal_pars</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">tmp_par_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">nper</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">par_cols</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">include_temporal_pars</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">tmp_par_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">include_temporal_pars</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">nper</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">include_temporal_pars</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">tmp_par_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">nper</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">include_temporal_pars</span><span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">include_temporal_pars</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">tmp_par_cols</span> <span class="o">=</span> <span class="n">include_temporal_pars</span>
        <span class="n">include_temporal_pars</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp_par_cols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">include_temporal_pars</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1">#make backup copy of sfr file</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span><span class="n">nam_file</span><span class="o">+</span><span class="s2">&quot;_backup_.sfr&quot;</span><span class="p">))</span>

    <span class="c1">#get the segment data (dict)</span>
    <span class="n">segment_data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">segment_data</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">segment_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">segment_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># check</span>
    <span class="k">for</span> <span class="n">kper</span><span class="p">,</span><span class="n">seg_data</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">segment_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">seg_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shape</span><span class="p">,</span><span class="s2">&quot;cannot use: seg data must have the same number of entires for all kpers&quot;</span>
    <span class="n">seg_data_col_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">seg_data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
    <span class="c1"># convert segment_data dictionary to multi index df - this could get ugly</span>
    <span class="n">reform</span> <span class="o">=</span> <span class="p">{(</span><span class="n">k</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span> <span class="n">segment_data</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">segment_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">segment_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">}</span>
    <span class="n">seg_data_all_kper</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">reform</span><span class="p">)</span>
    <span class="n">seg_data_all_kper</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;kper&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">]</span>

    <span class="c1"># extract the first seg data kper to a dataframe</span>
    <span class="n">seg_data</span> <span class="o">=</span> <span class="n">seg_data_all_kper</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># pd.DataFrame.from_records(seg_data)</span>

    <span class="c1">#make sure all par cols are found and search of any data in kpers</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">par_cols</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">par_cols</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_par_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
        <span class="k">if</span> <span class="n">par_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seg_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cols</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par_col</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="n">tmp_par_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">tmp_par_cols</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">par_col</span><span class="p">)</span>
        <span class="c1"># look across all kper in multiindex df to check for values entry - fill with absmax should capture entries</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seg_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">par_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_data_all_kper</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">par_col</span><span class="p">)]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the following par_cols were not found in segment data: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)),</span> <span class="n">PyemuWarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_cols</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;None of the passed par_cols (</span><span class="si">{0}</span><span class="s2">) were found in segment data.&quot;</span><span class="o">.</span>
                          <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">par_cols</span><span class="p">)),</span> <span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="n">seg_data</span> <span class="o">=</span> <span class="n">seg_data</span><span class="p">[</span><span class="n">seg_data_col_order</span><span class="p">]</span>  <span class="c1"># reset column orders to inital</span>
    <span class="n">seg_data_org</span> <span class="o">=</span> <span class="n">seg_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">seg_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;sfr_seg_pars.dat&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="c1">#the data cols not to parameterize</span>
    <span class="c1"># better than a column indexer as pandas can change column orders</span>
    <span class="n">idx_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nseg&#39;</span><span class="p">,</span> <span class="s1">&#39;icalc&#39;</span><span class="p">,</span> <span class="s1">&#39;outseg&#39;</span><span class="p">,</span> <span class="s1">&#39;iupseg&#39;</span><span class="p">,</span> <span class="s1">&#39;iprior&#39;</span><span class="p">,</span> <span class="s1">&#39;nstrpts&#39;</span><span class="p">]</span>
    <span class="n">notpar_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">seg_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="o">+</span><span class="n">idx_cols</span><span class="p">]</span>

    <span class="c1">#process par cols</span>
    <span class="n">tpl_str</span><span class="p">,</span> <span class="n">pvals</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include_temporal_pars</span><span class="p">:</span>
        <span class="n">tmp_pnames</span><span class="p">,</span> <span class="n">tmp_tpl_str</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tmp_par_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span>
                              <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">segment_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">tmp_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tmp_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;sfr_seg_temporal_pars.dat&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp_par_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">par_col</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">par_col</span>
        <span class="k">if</span> <span class="n">tie_hcond</span> <span class="ow">and</span> <span class="n">par_col</span> <span class="o">==</span> <span class="s1">&#39;hcond2&#39;</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;hcond1&#39;</span>
        <span class="k">if</span> <span class="n">seg_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">par_col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;all zeros for </span><span class="si">{0}</span><span class="s2">...skipping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_col</span><span class="p">))</span>
            <span class="c1">#seg_data.loc[:,par_col] = 1</span>
            <span class="c1"># all zero so no need to set up</span>
            <span class="k">if</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="c1"># - add to notpar</span>
                <span class="n">notpar_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cols</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par_col</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="n">tmp_par_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">tmp_par_cols</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">par_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">seg_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">par_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;~    </span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1:04d}</span><span class="s2">   ~&quot;</span><span class="o">.</span>
                                                      <span class="nb">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">nseg</span><span class="p">))</span> <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">par_col</span><span class="p">])</span> <span class="o">!=</span> <span class="mf">0.0</span>
                                                      <span class="k">else</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">org_vals</span> <span class="o">=</span> <span class="n">seg_data_org</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg_data_org</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">par_col</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">par_col</span><span class="p">]</span>
            <span class="n">pnames</span> <span class="o">=</span> <span class="n">seg_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">org_vals</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">par_col</span><span class="p">]</span>
            <span class="n">pvals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">org_vals</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="n">tpl_str</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pnames</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="n">tmp_par_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">parnme</span> <span class="o">=</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1:04d}</span><span class="s2">_tmp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_col</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tmp_par_cols</span><span class="p">[</span><span class="n">par_col</span><span class="p">]</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">parnme</span> <span class="o">!=</span> <span class="mf">1.0</span>
            <span class="n">tmp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="n">par_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">parnme</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;~   </span><span class="si">{0}</span><span class="s2">  ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">tmp_tpl_str</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tmp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="n">par_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="n">tmp_pnames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">parnme</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="n">pnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tpl_str</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">pnames</span><span class="p">,</span><span class="s2">&quot;org_value&quot;</span><span class="p">:</span><span class="n">pvals</span><span class="p">,</span><span class="s2">&quot;tpl_str&quot;</span><span class="p">:</span><span class="n">tpl_str</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">pnames</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No spatial sfr segment parameters have been set up, &quot;</span>
                      <span class="s2">&quot;either none of </span><span class="si">{0}</span><span class="s2"> were found or all were zero.&quot;</span><span class="o">.</span>
                      <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">par_cols</span><span class="p">)),</span> <span class="n">PyemuWarning</span><span class="p">)</span>
        <span class="c1"># return df</span>
    <span class="c1"># set not par cols to 1.0</span>
    <span class="n">seg_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">notpar_cols</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>

    <span class="c1">#write the template file</span>
    <span class="n">_write_df_tpl</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;sfr_seg_pars.dat.tpl&quot;</span><span class="p">),</span> <span class="n">seg_data</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="c1">#make sure the tpl file exists and has the same num of pars</span>
    <span class="n">parnme</span> <span class="o">=</span> <span class="n">parse_tpl_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span><span class="s2">&quot;sfr_seg_pars.dat.tpl&quot;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parnme</span><span class="p">)</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">#set some useful par info</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">include_temporal_pars</span><span class="p">:</span>
        <span class="n">_write_df_tpl</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;sfr_seg_temporal_pars.dat.tpl&quot;</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">tmp_df</span><span class="p">)</span>
        <span class="n">pargp</span> <span class="o">=</span> <span class="p">[</span><span class="n">pname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_tmp&quot;</span> <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">tmp_pnames</span><span class="p">]</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">tmp_pnames</span><span class="p">,</span><span class="s2">&quot;pargp&quot;</span><span class="p">:</span><span class="n">pargp</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">tmp_pnames</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">tmp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;org_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">tmp_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;tpl_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_tpl_str</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No sfr segment parameters have been set up, &quot;</span>
                      <span class="s2">&quot;either none of </span><span class="si">{0}</span><span class="s2"> were found or all were zero.&quot;</span><span class="o">.</span>
                      <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">par_cols</span> <span class="o">+</span> 
                                          <span class="nb">list</span><span class="p">(</span><span class="n">tmp_par_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">())))),</span>
                      <span class="n">PyemuWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># write the config file used by apply_sfr_pars()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;sfr_seg_pars.config&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;nam_file </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nam_file</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;model_ws </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_ws</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mult_file sfr_seg_pars.dat</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sfr_filename </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">include_temporal_pars</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;time_mult_file sfr_seg_temporal_pars.dat</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># set some useful par info</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.25</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">hpars</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;hcond&quot;</span><span class="p">)),</span> <span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hpars</span><span class="p">,</span> <span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hpars</span><span class="p">,</span> <span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="setup_sfr_reach_parameters"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_sfr_reach_parameters">[docs]</a><span class="k">def</span> <span class="nf">setup_sfr_reach_parameters</span><span class="p">(</span><span class="n">nam_file</span><span class="p">,</span><span class="n">model_ws</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">par_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;strhc1&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Setup multiplier paramters for reach data, when reachinput option is specififed in sfr.</span>


<span class="sd">    Args:</span>
<span class="sd">        nam_file (`str`): MODFLOw name file.  DIS, BAS, and SFR must be</span>
<span class="sd">            available as pathed in the nam_file.  Optionally, `nam_file` can be</span>
<span class="sd">            an existing `flopy.modflow.Modflow`.</span>
<span class="sd">        model_ws (`str`): model workspace for flopy to load the MODFLOW model from</span>
<span class="sd">        par_cols ([`str`]): a list of segment data entires to parameterize</span>
<span class="sd">        tie_hcond (`bool`):  flag to use same mult par for hcond1 and hcond2 for a</span>
<span class="sd">            given segment.  Default is `True`.</span>
<span class="sd">        include_temporal_pars ([`str`]):  list of spatially-global multipliers to set up for</span>
<span class="sd">            each stress period.  Default is None</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataframe with useful parameter setup information</span>

<span class="sd">    Note:</span>
<span class="sd">        Similar to `gw_utils.setup_sfr_seg_parameters()`, method will apply params to sfr reachdata</span>

<span class="sd">        Can load the dis, bas, and sfr files with flopy using model_ws. Or can pass a model object</span>
<span class="sd">            (SFR loading can be slow)</span>

<span class="sd">        This is the companion function of `gw_utils.apply_sfr_reach_parameters()`</span>

<span class="sd">        Skips values = 0.0 since multipliers don&#39;t work for these</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">par_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">par_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;strhc1&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nam_file</span><span class="p">,</span><span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">mf</span><span class="o">.</span><span class="n">Modflow</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nam_file</span><span class="o">.</span><span class="n">sfr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># flopy MODFLOW model has been passed and has SFR loaded</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">nam_file</span>
        <span class="n">nam_file</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">namefile</span>
        <span class="n">model_ws</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">model_ws</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if model has not been passed or SFR not loaded # load MODFLOW model</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nam_file</span><span class="p">,</span> <span class="n">load_only</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sfr&quot;</span><span class="p">],</span> <span class="n">model_ws</span><span class="o">=</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forgive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># get reachdata as dataframe</span>
    <span class="n">reach_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">reach_data</span><span class="p">)</span>
    <span class="c1"># write inital reach_data as csv</span>
    <span class="n">reach_data_orig</span> <span class="o">=</span> <span class="n">reach_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">reach_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;sfr_reach_pars.dat&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="c1"># generate template file with pars in par_cols</span>
    <span class="c1">#process par cols</span>
    <span class="n">tpl_str</span><span class="p">,</span><span class="n">pvals</span> <span class="o">=</span> <span class="p">[],[]</span>
    <span class="c1"># par_cols=[&quot;strhc1&quot;]</span>
    <span class="n">idx_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;iseg&quot;</span><span class="p">,</span> <span class="s2">&quot;ireach&quot;</span><span class="p">,</span> <span class="s2">&quot;reachID&quot;</span><span class="p">,</span> <span class="s2">&quot;outreach&quot;</span><span class="p">]</span>
    <span class="c1">#the data cols not to parameterize</span>
    <span class="n">notpar_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">reach_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">par_cols</span><span class="o">+</span><span class="n">idx_cols</span><span class="p">]</span>
    <span class="c1"># make sure all par cols are found and search of any data in kpers</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">par_cols</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="n">par_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">par_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reach_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_col</span><span class="p">)</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">par_col</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;the following par_cols were not found in reach data: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)),</span>
                      <span class="n">PyemuWarning</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_cols</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;None of the passed par_cols (</span><span class="si">{0}</span><span class="s2">) were found in reach data.&quot;</span><span class="o">.</span>
                          <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">par_cols</span><span class="p">)),</span> <span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">par_col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">par_col</span> <span class="o">==</span> <span class="s2">&quot;strhc1&quot;</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;strk&#39;</span>  <span class="c1"># shorten par</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">par_col</span>
        <span class="n">reach_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">par_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">reach_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;~    </span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1:04d}</span><span class="s2">   ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reachID</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">par_col</span><span class="p">])</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">org_vals</span> <span class="o">=</span> <span class="n">reach_data_orig</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reach_data_orig</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">par_col</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">par_col</span><span class="p">]</span>
        <span class="n">pnames</span> <span class="o">=</span> <span class="n">reach_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">org_vals</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">par_col</span><span class="p">]</span>
        <span class="n">pvals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">org_vals</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">tpl_str</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pnames</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="n">pnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tpl_str</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">pnames</span><span class="p">,</span><span class="s2">&quot;org_value&quot;</span><span class="p">:</span><span class="n">pvals</span><span class="p">,</span><span class="s2">&quot;tpl_str&quot;</span><span class="p">:</span><span class="n">tpl_str</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">pnames</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No sfr reach parameters have been set up, either none of </span><span class="si">{0}</span><span class="s2"> were found or all were zero.&quot;</span><span class="o">.</span>
                      <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">par_cols</span><span class="p">)),</span> <span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># set not par cols to 1.0</span>
        <span class="n">reach_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">notpar_cols</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>

        <span class="c1"># write the template file</span>
        <span class="n">_write_df_tpl</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;sfr_reach_pars.dat.tpl&quot;</span><span class="p">),</span> <span class="n">reach_data</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="c1"># write the config file used by apply_sfr_pars()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;sfr_reach_pars.config&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;nam_file </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nam_file</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;model_ws </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_ws</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;mult_file sfr_reach_pars.dat</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;sfr_filename </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># make sure the tpl file exists and has the same num of pars</span>
        <span class="n">parnme</span> <span class="o">=</span> <span class="n">parse_tpl_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;sfr_reach_pars.dat.tpl&quot;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parnme</span><span class="p">)</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># set some useful par info</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.25</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.75</span>
        <span class="n">hpars</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">pargp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;strk&quot;</span><span class="p">)),</span> <span class="s2">&quot;parnme&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hpars</span><span class="p">,</span> <span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hpars</span><span class="p">,</span> <span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="apply_sfr_seg_parameters"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_sfr_seg_parameters">[docs]</a><span class="k">def</span> <span class="nf">apply_sfr_seg_parameters</span><span class="p">(</span><span class="n">seg_pars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reach_pars</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;apply the SFR segement multiplier parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        seg_pars (`bool`, optional): flag to apply segment-based parameters.</span>
<span class="sd">            Default is True</span>
<span class="sd">        reach_pars (`bool`, optional): flag to apply reach-based parameters.</span>
<span class="sd">            Default is False</span>

<span class="sd">    Returns:</span>
<span class="sd">        **flopy.modflow.ModflowSfr**: the modified SFR package instance</span>

<span class="sd">    Note:</span>
<span class="sd">        expects &quot;sfr_seg_pars.config&quot; to exist</span>

<span class="sd">        expects `nam_file` +&quot;_backup_.sfr&quot; to exist</span>



<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">seg_pars</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reach_pars</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;gw_utils.apply_sfr_pars() error: both seg_pars and reach_pars are False&quot;</span><span class="p">)</span>
    <span class="c1">#if seg_pars and reach_pars:</span>
    <span class="c1">#    raise Exception(&quot;gw_utils.apply_sfr_pars() error: both seg_pars and reach_pars are True&quot;)</span>

    <span class="kn">import</span> <span class="nn">flopy</span>
    <span class="n">bak_sfr_file</span><span class="p">,</span><span class="n">pars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>

    <span class="k">if</span> <span class="n">seg_pars</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sfr_seg_pars.config&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sfr_seg_pars.config&quot;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">pars</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">bak_sfr_file</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;nam_file&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_backup_.sfr&quot;</span>
        <span class="c1">#m = flopy.modflow.Modflow.load(pars[&quot;nam_file&quot;],model_ws=pars[&quot;model_ws&quot;],load_only=[&quot;sfr&quot;],check=False)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;nam_file&quot;</span><span class="p">],</span> <span class="n">load_only</span><span class="o">=</span><span class="p">[],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sfr</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">ModflowSfr2</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bak_sfr_file</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">sfrfile</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;sfr_filename&quot;</span><span class="p">]</span>
        <span class="n">mlt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;mult_file&quot;</span><span class="p">],</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># time_mlt_df = None</span>
        <span class="c1"># if &quot;time_mult_file&quot; in pars:</span>
        <span class="c1">#     time_mult_file = pars[&quot;time_mult_file&quot;]</span>
        <span class="c1">#     time_mlt_df = pd.read_csv(pars[&quot;time_mult_file&quot;], delim_whitespace=False,index_col=0)</span>

        <span class="n">idx_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nseg&#39;</span><span class="p">,</span> <span class="s1">&#39;icalc&#39;</span><span class="p">,</span> <span class="s1">&#39;outseg&#39;</span><span class="p">,</span> <span class="s1">&#39;iupseg&#39;</span><span class="p">,</span> <span class="s1">&#39;iprior&#39;</span><span class="p">,</span> <span class="s1">&#39;nstrpts&#39;</span><span class="p">]</span>
        <span class="n">present_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">idx_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">mlt_cols</span> <span class="o">=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">present_cols</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">segment_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mlt_cols</span><span class="p">]</span> <span class="o">*=</span> <span class="n">mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">mlt_cols</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_records</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sfr</span><span class="o">.</span><span class="n">segment_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">if</span> <span class="n">reach_pars</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sfr_reach_pars.config&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sfr_reach_pars.config&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">r_pars</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">r_pars</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bak_sfr_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># will be the case is seg_pars is false</span>
            <span class="n">bak_sfr_file</span> <span class="o">=</span> <span class="n">r_pars</span><span class="p">[</span><span class="s2">&quot;nam_file&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_backup_.sfr&quot;</span>
            <span class="c1">#m = flopy.modflow.Modflow.load(pars[&quot;nam_file&quot;],model_ws=pars[&quot;model_ws&quot;],load_only=[&quot;sfr&quot;],check=False)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">Modflow</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">r_pars</span><span class="p">[</span><span class="s2">&quot;nam_file&quot;</span><span class="p">],</span> <span class="n">load_only</span><span class="o">=</span><span class="p">[],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sfr</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modflow</span><span class="o">.</span><span class="n">ModflowSfr2</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bak_sfr_file</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span>
            <span class="n">sfrfile</span> <span class="o">=</span> <span class="n">r_pars</span><span class="p">[</span><span class="s2">&quot;sfr_filename&quot;</span><span class="p">]</span>
        <span class="n">r_mlt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">r_pars</span><span class="p">[</span><span class="s2">&quot;mult_file&quot;</span><span class="p">],</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">r_idx_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;iseg&quot;</span><span class="p">,</span> <span class="s2">&quot;ireach&quot;</span><span class="p">,</span> <span class="s2">&quot;reachID&quot;</span><span class="p">,</span> <span class="s2">&quot;outreach&quot;</span><span class="p">]</span>
        <span class="n">r_mlt_cols</span> <span class="o">=</span> <span class="n">r_mlt_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">r_idx_cols</span><span class="p">)</span>
        <span class="n">r_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">reach_data</span><span class="p">)</span>
        <span class="n">r_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">r_mlt_cols</span><span class="p">]</span> <span class="o">*=</span> <span class="n">r_mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">r_mlt_cols</span><span class="p">]</span>
        <span class="n">sfr</span><span class="o">.</span><span class="n">reach_data</span> <span class="o">=</span> <span class="n">r_df</span><span class="o">.</span><span class="n">to_records</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="c1">#m.remove_package(&quot;sfr&quot;)</span>
    <span class="k">if</span> <span class="n">pars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;time_mult_file&quot;</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">:</span>
        <span class="n">time_mult_file</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;time_mult_file&quot;</span><span class="p">]</span>
        <span class="n">time_mlt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">time_mult_file</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">kper</span><span class="p">,</span> <span class="n">sdata</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">sfr</span><span class="o">.</span><span class="n">segment_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">kper</span> <span class="ow">in</span> <span class="n">time_mlt_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;gw_utils.apply_sfr_seg_parameters() error: kper &quot;</span> <span class="o">+</span> \
                                              <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> not in time_mlt_df index&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kper</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">time_mlt_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">sdata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">time_mlt_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">kper</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>

    <span class="n">sfr</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">sfrfile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sfr</span></div>

<div class="viewcode-block" id="apply_sfr_parameters"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_sfr_parameters">[docs]</a><span class="k">def</span> <span class="nf">apply_sfr_parameters</span><span class="p">(</span><span class="n">seg_pars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reach_pars</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;thin wrapper around `gw_utils.apply_sfr_seg_parameters()`</span>

<span class="sd">    Args:</span>
<span class="sd">        seg_pars (`bool`, optional): flag to apply segment-based parameters.</span>
<span class="sd">            Default is True</span>
<span class="sd">        reach_pars (`bool`, optional): flag to apply reach-based parameters.</span>
<span class="sd">            Default is False</span>

<span class="sd">    Returns:</span>
<span class="sd">        **flopy.modflow.ModflowSfr**: the modified SFR package instance</span>

<span class="sd">    Note:</span>
<span class="sd">        expects &quot;sfr_seg_pars.config&quot; to exist</span>

<span class="sd">        expects `nam_file` +&quot;_backup_.sfr&quot; to exist</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sfr</span> <span class="o">=</span> <span class="n">apply_sfr_seg_parameters</span><span class="p">(</span><span class="n">seg_pars</span><span class="o">=</span><span class="n">seg_pars</span><span class="p">,</span> <span class="n">reach_pars</span><span class="o">=</span><span class="n">reach_pars</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sfr</span></div>


<div class="viewcode-block" id="setup_sfr_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_sfr_obs">[docs]</a><span class="k">def</span> <span class="nf">setup_sfr_obs</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">,</span><span class="n">seg_group_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ins_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">include_path</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup observations using the sfr ASCII output file.  Setups</span>
<span class="sd">    the ability to aggregate flows for groups of segments.  Applies</span>
<span class="sd">    only flow to aquier and flow out.</span>

<span class="sd">    Args:</span>
<span class="sd">        sft_out_file (`str`): the name and path to an existing SFR output file</span>
<span class="sd">        seg_group_dict (`dict`): a dictionary of SFR segements to aggregate together for a single obs.</span>
<span class="sd">            the key value in the dict is the base observation name. If None, all segments</span>
<span class="sd">            are used as individual observations. Default is None</span>
<span class="sd">        model (`flopy.mbase`): a flopy model.  If passed, the observation names will have</span>
<span class="sd">            the datetime of the observation appended to them.  If None, the observation names</span>
<span class="sd">            will have the stress period appended to them. Default is None.</span>
<span class="sd">        include_path (`bool`): flag to prepend sfr_out_file path to sfr_obs.config.  Useful for setting up</span>
<span class="sd">            process in separate directory for where python is running.</span>


<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: dataframe of observation name, simulated value and group.</span>

<span class="sd">    Note:</span>
<span class="sd">        This is the companion function of `gw_utils.apply_sfr_obs()`.</span>

<span class="sd">        This function writes &quot;sfr_obs.config&quot; which must be kept in the dir where</span>
<span class="sd">        &quot;gw_utils.apply_sfr_obs()&quot; is being called during the forward run</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sfr_dict</span> <span class="o">=</span> <span class="n">load_sfr_out</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">)</span>
    <span class="n">kpers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sfr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">kpers</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">seg_group_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seg_group_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;seg</span><span class="si">{0:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">):</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sfr_dict</span><span class="p">[</span><span class="n">kpers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">segment</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Flow out (flout) of grouped segments will be aggregated... &quot;</span><span class="p">,</span> <span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="n">sfr_segs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sfr_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">sfr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">segment</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sfr_out_file&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">include_path</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">sfr_out_file</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">oname</span><span class="p">,</span><span class="n">segs</span> <span class="ow">in</span> <span class="n">seg_group_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">segs</span><span class="p">):</span>
            <span class="n">segs_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">segs</span><span class="p">}</span>
            <span class="n">segs</span> <span class="o">=</span> <span class="p">[</span><span class="n">segs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">segs_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">segs</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">segs_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">sfr_segs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;the following segs listed with oname </span><span class="si">{0}</span><span class="s2"> where not found: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                            <span class="nb">format</span><span class="p">(</span><span class="n">oname</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">segs</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oname</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span>

    <span class="n">df_key</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;obs_base&quot;</span><span class="p">:</span><span class="n">keys</span><span class="p">,</span><span class="s2">&quot;segment&quot;</span><span class="p">:</span><span class="n">values</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">include_path</span><span class="p">:</span>
        <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span><span class="s2">&quot;sfr_obs.config&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;sfr_obs.config&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing &#39;sfr_obs.config&#39; to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
    <span class="n">df_key</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

    <span class="n">bd</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">if</span> <span class="n">include_path</span><span class="p">:</span>
        <span class="n">bd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">apply_sfr_obs</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bd</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error in apply_sfr_obs(): </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dts</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">perlen</span><span class="o">.</span><span class="n">array</span><span class="p">),</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">date</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dts</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;flaqx_obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;fa&quot;</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">obs_base</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">time_str</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;flout_obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;fo&quot;</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">obs_base</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">time_str</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ins_file</span> <span class="o">=</span> <span class="n">sfr_out_file</span> <span class="o">+</span> <span class="s2">&quot;.processed.ins&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pif ~</span><span class="se">\n</span><span class="s2">l1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fla</span><span class="p">,</span><span class="n">flo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">flaqx_obsnme</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">flout_obsnme</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;l1 w w !</span><span class="si">{0}</span><span class="s2">! !</span><span class="si">{1}</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fla</span><span class="p">,</span><span class="n">flo</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">pth</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pth</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">pth</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="n">bd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="o">+</span><span class="s2">&quot;.processed&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;flaqx&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fa&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;flout&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="apply_sfr_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_sfr_obs">[docs]</a><span class="k">def</span> <span class="nf">apply_sfr_obs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;apply the sfr observation process</span>

<span class="sd">    Note:</span>
<span class="sd">        This is the companion function of `gw_utils.setup_sfr_obs()`.</span>

<span class="sd">        requires `sfr_obs.config`.</span>

<span class="sd">        Writes `sfr_out_file`+&quot;.processed&quot;, where `sfr_out_file` is defined in &quot;sfr_obs.config&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        **pandas.DataFrame**: a dataframe of aggregrated sfr segment aquifer and outflow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sfr_obs.config&quot;</span><span class="p">)</span>
    <span class="n">df_key</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;sfr_obs.config&quot;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">df_key</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sfr_out_file&quot;</span><span class="p">,</span><span class="n">df_key</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="n">sfr_out_file</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">df_key</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span>
    <span class="n">df_key</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;segment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">df_key</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">segment</span>
    <span class="n">seg_group_dict</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df_key</span><span class="o">.</span><span class="n">obs_base</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>

    <span class="n">sfr_kper</span> <span class="o">=</span> <span class="n">load_sfr_out</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">)</span>
    <span class="n">kpers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sfr_kper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">kpers</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c1">#results = {o:[] for o in seg_group_dict.keys()}</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">kper</span> <span class="ow">in</span> <span class="n">kpers</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sfr_kper</span><span class="p">[</span><span class="n">kper</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">obs_base</span><span class="p">,</span><span class="n">segs</span> <span class="ow">in</span> <span class="n">seg_group_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segs</span><span class="o">.</span><span class="n">values</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># still agg flout where seg groups are passed!</span>
            <span class="c1">#print(obs_base,agg)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">kper</span><span class="p">,</span><span class="n">obs_base</span><span class="p">,</span><span class="n">agg</span><span class="p">[</span><span class="s2">&quot;flaqx&quot;</span><span class="p">],</span><span class="n">agg</span><span class="p">[</span><span class="s2">&quot;flout&quot;</span><span class="p">]])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;kper&quot;</span><span class="p">,</span><span class="s2">&quot;obs_base&quot;</span><span class="p">,</span><span class="s2">&quot;flaqx&quot;</span><span class="p">,</span><span class="s2">&quot;flout&quot;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;kper&quot;</span><span class="p">,</span><span class="s2">&quot;obs_base&quot;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="o">+</span><span class="s2">&quot;.processed&quot;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="load_sfr_out"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.load_sfr_out">[docs]</a><span class="k">def</span> <span class="nf">load_sfr_out</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;load an ASCII SFR output file into a dictionary of kper: dataframes.</span>

<span class="sd">    Args:</span>
<span class="sd">        sfr_out_file (`str`): SFR ASCII output file</span>
<span class="sd">        selection (`pandas.DataFrame`): a dataframe of `reach` and `segment` pairs to</span>
<span class="sd">            load.  If `None`, all reach-segment pairs are loaded.  Default is `None`.</span>

<span class="sd">    Note:</span>
<span class="sd">        aggregates flow to aquifer for segments and returns and flow out at</span>
<span class="sd">        downstream end of segment.</span>

<span class="sd">    Returns:</span>
<span class="sd">        **dict**: dictionary of {kper:`pandas.DataFrame`} of SFR output.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">),</span><span class="s2">&quot;couldn&#39;t find sfr out file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
        <span class="nb">format</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">)</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot; stream listing&quot;</span>
    <span class="n">lcount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sfr_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> \
            <span class="s2">&quot;If string passed as selection only &#39;all&#39; allowed: &quot;</span> \
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> \
            <span class="s2">&quot;&#39;selection needs to be pandas Dataframe. &quot;</span> \
            <span class="s2">&quot;Type </span><span class="si">{}</span><span class="s2"> passed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">sr</span> <span class="ow">in</span> <span class="n">selection</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">,</span> <span class="s1">&#39;reach&#39;</span><span class="p">]]</span>
                      <span class="p">),</span> <span class="s2">&quot;Either &#39;segment&#39; or &#39;reach&#39; not in selection columns&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">lcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">kper</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">kstp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="c1">#skip to where the data starts</span>
                <span class="n">lcount</span> <span class="o">+=</span> <span class="mi">4</span>
                <span class="n">dlines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">dline</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="n">lcount</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">dline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">draw</span> <span class="o">=</span> <span class="n">dline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">dlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">draw</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dlines</span><span class="p">))</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]]</span>
                <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;segment&quot;</span><span class="p">,</span> <span class="s2">&quot;reach&quot;</span><span class="p">,</span> <span class="s2">&quot;flaqx&quot;</span><span class="p">,</span> <span class="s2">&quot;flout&quot;</span><span class="p">]</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;segment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;reach&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reach</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;flaqx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">flaqx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;flout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">flout</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0:03d}</span><span class="s2">_</span><span class="si">{1:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">reach</span><span class="o">.</span><span class="n">values</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>
                <span class="c1"># df.index = df.apply(</span>
                <span class="c1"># lambda x: &quot;{0:03d}_{1:03d}&quot;.format(</span>
                <span class="c1"># int(x.segment), int(x.reach)), axis=1)</span>
                <span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># setup for all segs, aggregate</span>
                    <span class="n">gp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">segment</span><span class="p">)</span>
                    <span class="n">bot_reaches</span> <span class="o">=</span> <span class="n">gp</span><span class="p">[[</span><span class="s1">&#39;reach&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:03d}</span><span class="s2">_</span><span class="si">{1:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reach</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># only sum distributed output # take flow out of seg</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;flaqx&#39;</span><span class="p">:</span><span class="n">gp</span><span class="o">.</span><span class="n">flaqx</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                         <span class="s1">&#39;flout&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bot_reaches</span><span class="p">,</span> <span class="s1">&#39;flout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">gp</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="c1"># df = df.groupby(df.segment).sum()</span>
                    <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;segment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seg_reach_id</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:03d}</span><span class="s2">_</span><span class="si">{1:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">segment</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reach</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="n">seg_reach_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                            <span class="n">s</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                                <span class="s2">&quot;Requested segment reach pair (</span><span class="si">{0}</span><span class="s2">,</span><span class="si">{1}</span><span class="s2">) &quot;</span>
                                <span class="s2">&quot;is not in sfr output. Dropping...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)),</span> <span class="n">PyemuWarning</span><span class="p">)</span>
                            <span class="n">seg_reach_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                                <span class="n">seg_reach_id</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">seg_reach_id</span> <span class="o">==</span> <span class="n">sr</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg_reach_id</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">kper</span> <span class="ow">in</span> <span class="n">sfr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;multiple entries found for kper </span><span class="si">{0}</span><span class="s2">, &quot;</span>
                          <span class="s2">&quot;replacing...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kper</span><span class="p">))</span>
                <span class="n">sfr_dict</span><span class="p">[</span><span class="n">kper</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span>
    <span class="k">return</span> <span class="n">sfr_dict</span></div>


<div class="viewcode-block" id="setup_sfr_reach_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_sfr_reach_obs">[docs]</a><span class="k">def</span> <span class="nf">setup_sfr_reach_obs</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">,</span><span class="n">seg_reach</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ins_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">include_path</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup observations using the sfr ASCII output file.  Setups</span>
<span class="sd">    sfr point observations using segment and reach numbers.</span>

<span class="sd">    Args:</span>
<span class="sd">        sft_out_file (`str`): the path and name of an existing SFR output file</span>
<span class="sd">        seg_reach (varies): a dict, or list of SFR [segment,reach] pairs identifying</span>
<span class="sd">            locations of interest.  If `dict`, the key value in the dict is the base</span>
<span class="sd">            observation name. If None, all reaches are used as individual observations.</span>
<span class="sd">            Default is None - THIS MAY SET UP A LOT OF OBS!</span>
<span class="sd">        model (`flopy.mbase`): a flopy model.  If passed, the observation names will</span>
<span class="sd">            have the datetime of the observation appended to them.  If None, the</span>
<span class="sd">            observation names will have the stress period appended to them. Default is None.</span>
<span class="sd">        include_path (`bool`): a flag to prepend sfr_out_file path to sfr_obs.config.  Useful</span>
<span class="sd">            for setting up process in separate directory for where python is running.</span>


<span class="sd">    Returns:</span>
<span class="sd">        `pd.DataFrame`: a dataframe of observation names, values, and groups</span>

<span class="sd">    Note:</span>
<span class="sd">        This is the companion function of `gw_utils.apply_sfr_reach_obs()`.</span>

<span class="sd">        This function writes &quot;sfr_reach_obs.config&quot; which must be kept in the dir where</span>
<span class="sd">        &quot;apply_sfr_reach_obs()&quot; is being called during the forward run</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seg_reach</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Obs will be set up for every reach&quot;</span><span class="p">,</span> <span class="n">PyemuWarning</span><span class="p">)</span>
        <span class="n">seg_reach</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seg_reach</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seg_reach</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">seg_reach</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">seg_reach</span> <span class="o">=</span> <span class="p">[</span><span class="n">seg_reach</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span>
            <span class="n">seg_reach</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;varible seg_reach expected shape (n,2), received </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">seg_reach</span><span class="p">))</span>
        <span class="n">seg_reach</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">seg_reach</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">,</span> <span class="s1">&#39;reach&#39;</span><span class="p">])</span>
        <span class="n">seg_reach</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">seg_reach</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;s</span><span class="si">{0:03d}</span><span class="s2">r</span><span class="si">{1:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">segment</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reach</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seg_reach</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">seg_reach</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">seg_reach</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">,</span> <span class="s1">&#39;reach&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">seg_reach</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">),</span> <span class="s2">&quot;&#39;selection needs to be pandas Dataframe. Type </span><span class="si">{}</span><span class="s2"> passed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">seg_reach</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">sr</span> <span class="ow">in</span> <span class="n">seg_reach</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">,</span> <span class="s1">&#39;reach&#39;</span><span class="p">]]</span>
                      <span class="p">),</span> <span class="s2">&quot;Either &#39;segment&#39; or &#39;reach&#39; not in selection columns&quot;</span>

    <span class="n">sfr_dict</span> <span class="o">=</span> <span class="n">load_sfr_out</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="n">seg_reach</span><span class="p">)</span>
    <span class="n">kpers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sfr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">kpers</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seg_reach</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">seg_reach</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">seg_reach</span> <span class="o">=</span> <span class="n">sfr_dict</span><span class="p">[</span><span class="n">kpers</span><span class="p">[</span><span class="mi">0</span><span class="p">]][[</span><span class="s1">&#39;segment&#39;</span><span class="p">,</span> <span class="s1">&#39;reach&#39;</span><span class="p">]]</span>
        <span class="n">seg_reach</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">seg_reach</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;s</span><span class="si">{0:03d}</span><span class="s2">r</span><span class="si">{1:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">segment</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reach</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sfr_out_file&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">include_path</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">sfr_out_file</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">seg_reach</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seg_reach</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:03d}</span><span class="s2">_</span><span class="si">{1:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">segment</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reach</span><span class="p">))</span>
                                         <span class="ow">not</span> <span class="ow">in</span> <span class="n">sfr_dict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">sfr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="n">diff</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;segs,reach pair listed with onames </span><span class="si">{0}</span><span class="s2"> was not found: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>
                          <span class="nb">format</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span> <span class="n">ob</span><span class="o">.</span><span class="n">reach</span><span class="p">)),</span> <span class="n">PyemuWarning</span><span class="p">)</span>
    <span class="n">seg_reach</span> <span class="o">=</span> <span class="n">seg_reach</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">seg_reach</span><span class="p">[</span><span class="s1">&#39;obs_base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_reach</span><span class="o">.</span><span class="n">index</span>
    <span class="n">df_key</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;obs_base&quot;</span><span class="p">:</span> <span class="n">keys</span><span class="p">,</span> <span class="s2">&quot;segment&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;reach&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">})</span>
    <span class="n">df_key</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_key</span><span class="p">,</span> <span class="n">seg_reach</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">include_path</span><span class="p">:</span>
        <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span><span class="s2">&quot;sfr_reach_obs.config&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;sfr_reach_obs.config&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;writing &#39;sfr_reach_obs.config&#39; to </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
    <span class="n">df_key</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

    <span class="n">bd</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">if</span> <span class="n">include_path</span><span class="p">:</span>
        <span class="n">bd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">apply_sfr_reach_obs</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bd</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error in apply_sfr_reach_obs(): </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dts</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">perlen</span><span class="o">.</span><span class="n">array</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">date</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dts</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">kper</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;flaqx_obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;fa&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">obs_base</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">time_str</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;flout_obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;fo&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">obs_base</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">time_str</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ins_file</span> <span class="o">=</span> <span class="n">sfr_out_file</span> <span class="o">+</span> <span class="s2">&quot;.reach_processed.ins&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pif ~</span><span class="se">\n</span><span class="s2">l1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fla</span><span class="p">,</span> <span class="n">flo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">flaqx_obsnme</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">flout_obsnme</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;l1 w w !</span><span class="si">{0}</span><span class="s2">! !</span><span class="si">{1}</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fla</span><span class="p">,</span> <span class="n">flo</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">pth</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pth</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">pth</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="n">bd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ins_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="o">+</span><span class="s2">&quot;.processed&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;obsnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;obgnme&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;flaqx&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fa&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;flout&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="apply_sfr_reach_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_sfr_reach_obs">[docs]</a><span class="k">def</span> <span class="nf">apply_sfr_reach_obs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;apply the sfr reach observation process.</span>

<span class="sd">    Note:</span>
<span class="sd">        This is the companion function of `gw_utils.setup_sfr_reach_obs()`.</span>

<span class="sd">        Requires sfr_reach_obs.config.</span>

<span class="sd">        Writes &lt;sfr_out_file&gt;.processed, where &lt;sfr_out_file&gt; is defined in</span>
<span class="sd">        &quot;sfr_reach_obs.config&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        `pd.DataFrame`: a dataframe of sfr aquifer and outflow ad segment,reach locations</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sfr_reach_obs.config&quot;</span><span class="p">)</span>
    <span class="n">df_key</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;sfr_reach_obs.config&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">df_key</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sfr_out_file&quot;</span><span class="p">,</span> <span class="n">df_key</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">sfr_out_file</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reach</span>
    <span class="n">df_key</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_key</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;segment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">segment</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">df_key</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;reach&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">reach</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">df_key</span> <span class="o">=</span> <span class="n">df_key</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;obs_base&#39;</span><span class="p">)</span>

    <span class="n">sfr_kper</span> <span class="o">=</span> <span class="n">load_sfr_out</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="p">,</span> <span class="n">df_key</span><span class="p">)</span>
    <span class="n">kpers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sfr_kper</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">kpers</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">kper</span> <span class="ow">in</span> <span class="n">kpers</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sfr_kper</span><span class="p">[</span><span class="n">kper</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">sr</span> <span class="ow">in</span> <span class="n">df_key</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">{0:03d}</span><span class="s2">_</span><span class="si">{1:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sr</span><span class="o">.</span><span class="n">segment</span><span class="p">,</span> <span class="n">sr</span><span class="o">.</span><span class="n">reach</span><span class="p">),</span> <span class="p">:]</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">kper</span><span class="p">,</span> <span class="n">sr</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;flaqx&quot;</span><span class="p">],</span> <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;flout&quot;</span><span class="p">]])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;kper&quot;</span><span class="p">,</span> <span class="s2">&quot;obs_base&quot;</span><span class="p">,</span> <span class="s2">&quot;flaqx&quot;</span><span class="p">,</span> <span class="s2">&quot;flout&quot;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;kper&quot;</span><span class="p">,</span> <span class="s2">&quot;obs_base&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sfr_out_file</span><span class="o">+</span><span class="s2">&quot;.reach_processed&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="modflow_sfr_gag_to_instruction_file"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.modflow_sfr_gag_to_instruction_file">[docs]</a><span class="k">def</span> <span class="nf">modflow_sfr_gag_to_instruction_file</span><span class="p">(</span><span class="n">gage_output_file</span><span class="p">,</span> <span class="n">ins_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_filename</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;writes an instruction file for an SFR gage output file to read Flow only at all times</span>

<span class="sd">    Args:</span>
<span class="sd">        gage_output_file (`str`): the gage output filename (ASCII).</span>

<span class="sd">        ins_file (`str`, optional): the name of the instruction file to</span>
<span class="sd">            create.  If None, the name is `gage_output_file` +&quot;.ins&quot;.</span>
<span class="sd">            Default is None</span>

<span class="sd">        parse_filename (`bool`): if True, get the gage_num parameter by</span>
<span class="sd">            parsing the gage output file filename if False, get the gage</span>
<span class="sd">            number from the file itself</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>

<span class="sd">        - **pandas.DataFrame**: a dataframe with obsnme and obsval for the sfr simulated flows.</span>
<span class="sd">        - **str**: file name of instructions file relating to gage output.</span>
<span class="sd">        - **str**: file name of processed gage output for all times</span>

<span class="sd">    Note:</span>
<span class="sd">        sets up observations for gage outputs only for the Flow column.</span>

<span class="sd">        If `parse_namefile` is true, only text up to first &#39;.&#39; is used as the gage_num</span>

<span class="sd">    TODO:</span>
<span class="sd">        allow other observation types and align explicitly with times - now returns all values</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ins_file</span> <span class="o">=</span> <span class="n">gage_output_file</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span>

    <span class="c1"># navigate the file to be sure the header makes sense</span>
    <span class="n">indat</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">gage_output_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indat</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)]</span>
    <span class="c1"># yank out the gage number to identify the observation names</span>
    <span class="k">if</span> <span class="n">parse_filename</span><span class="p">:</span>
        <span class="n">gage_num</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">gage_output_file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gage_num</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">indat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;gage no.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># get the column names</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">header</span> <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="c1"># make sure &quot;Flow&quot; is included in the columns</span>
    <span class="k">if</span> <span class="s1">&#39;flow&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Requested field &quot;Flow&quot; not in gage output columns&#39;</span><span class="p">)</span>

    <span class="c1"># find which column is for  &quot;Flow&quot;</span>
    <span class="n">flowidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;flow&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># write out the instruction file lines</span>
    <span class="n">inslines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l1 &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">flowidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;w &#39;</span> <span class="o">+</span> <span class="s1">&#39;!g</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:d}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gage_num</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indat</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">))]</span>
    <span class="n">inslines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inslines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># write the instruction file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofp</span><span class="p">:</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pif ~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">inslines</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span> <span class="n">gage_output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">ins_file</span><span class="p">,</span> <span class="n">gage_output_file</span></div>

<div class="viewcode-block" id="setup_gage_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.setup_gage_obs">[docs]</a><span class="k">def</span> <span class="nf">setup_gage_obs</span><span class="p">(</span><span class="n">gage_file</span><span class="p">,</span><span class="n">ins_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">start_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup a forward run post processor routine for the modflow gage file</span>

<span class="sd">    Args:</span>
<span class="sd">        gage_file (`str`): the gage output file (ASCII)</span>
<span class="sd">        ins_file (`str`, optional): the name of the instruction file to create.  If None, the name</span>
<span class="sd">            is `gage_file`+&quot;.processed.ins&quot;.  Default is `None`</span>
<span class="sd">        start_datetime (`str`): a `pandas.to_datetime()` compatible `str`.  If not `None`,</span>
<span class="sd">            then the resulting observation names have the datetime suffix.  If `None`,</span>
<span class="sd">            the suffix is the output totim.  Default is `None`.</span>
<span class="sd">        times ([`float`]):  a container of times to make observations for.  If None,</span>
<span class="sd">            all times are used. Default is None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>

<span class="sd">        - **pandas.DataFrame**: a dataframe with observation name and simulated values for the</span>
<span class="sd">          values in the gage file.</span>
<span class="sd">        - **str**: file name of instructions file that was created relating to gage output.</span>
<span class="sd">        - **str**: file name of processed gage output (processed according to times passed above.)</span>


<span class="sd">    Note:</span>
<span class="sd">         setups up observations for gage outputs (all columns).</span>

<span class="sd">         This is the companion function of `gw_utils.apply_gage_obs()`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gage_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">line1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">gage_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;GAGE No.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">gage_type</span> <span class="o">=</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;GAGE No.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">obj_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">line2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="c1"># get unique observation ids</span>
    <span class="n">obs_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]}</span> <span class="c1"># empty dictionary for observation ids</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span> <span class="c1"># exclude column 1 (TIME)</span>
        <span class="n">colspl</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colspl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># obs name built out of &quot;g&quot;(for gage) &quot;s&quot; or &quot;l&quot;(for gage type) 2 chars from column name - date added later</span>
            <span class="n">obs_ids</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;g</span><span class="si">{0}{1}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gage_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colspl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">colspl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs_ids</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;g</span><span class="si">{0}{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gage_type</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;_gage_obs_ids.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="c1"># write file relating obs names to meaningfull keys!</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">,</span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">obs</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="c1"># find passed times in df</span>
    <span class="k">if</span> <span class="n">times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">utimes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">utimes</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;the following times are missing:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>
    <span class="c1"># write output times to config file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gage_obs.config&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">gage_file</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:15.10E}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">]</span>
    <span class="c1"># extract data for times: returns dataframe and saves a processed df - read by pest</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">obs_file</span> <span class="o">=</span> <span class="n">apply_gage_obs</span><span class="p">(</span><span class="n">return_obs_file</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">utimes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">utimes</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="s2">&quot;time </span><span class="si">{0}</span><span class="s2"> missing in processed dataframe&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>  <span class="c1"># boolean selector of desired times in df</span>
    <span class="k">if</span> <span class="n">start_datetime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># convert times to usable observation times</span>
        <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_datetime</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_datetime</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time_str</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;time_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:08.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="c1"># set up instructions (line feed for lines without obs (not in time)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;ins_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;l1</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">df_times</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Slice by desired times</span>
    <span class="c1"># TODO include GAGE No. in obs name (if permissible)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_times</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;ins_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_times</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;l1 w </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39; w &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;!</span><span class="si">{0}{1}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">time_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ins_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ins_file</span> <span class="o">=</span> <span class="n">gage_file</span><span class="o">+</span><span class="s2">&quot;.processed.ins&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;pif ~</span><span class="se">\n</span><span class="s2">l1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ins_str</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">try_process_output_file</span><span class="p">(</span><span class="n">ins_file</span><span class="p">,</span> <span class="n">gage_file</span><span class="o">+</span><span class="s2">&quot;.processed&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">ins_file</span><span class="p">,</span> <span class="n">obs_file</span></div>


<div class="viewcode-block" id="apply_gage_obs"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_gage_obs">[docs]</a><span class="k">def</span> <span class="nf">apply_gage_obs</span><span class="p">(</span><span class="n">return_obs_file</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;apply the modflow gage obs post-processor</span>

<span class="sd">    Args:</span>
<span class="sd">        return_obs_file (`bool`): flag to return the processed</span>
<span class="sd">            observation file.  Default is `False`.</span>

<span class="sd">    Note:</span>
<span class="sd">        This is the companion function of `gw_utils.setup_gage_obs()`</span>



<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gage_obs.config&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">gage_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="n">obs_file</span> <span class="o">=</span> <span class="n">gage_file</span><span class="o">+</span><span class="s2">&quot;.processed&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gage_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">line1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">gage_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;GAGE No.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">gage_type</span> <span class="o">=</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;GAGE No.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">obj_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">line2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()),</span> <span class="p">:]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">obs_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_obs_file</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">obs_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="apply_hfb_pars"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.apply_hfb_pars">[docs]</a><span class="k">def</span> <span class="nf">apply_hfb_pars</span><span class="p">(</span><span class="n">par_file</span><span class="o">=</span><span class="s1">&#39;hfb6_pars.csv&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a function to apply HFB multiplier parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        par_file (`str`): the HFB parameter info file.</span>
<span class="sd">            Default is `hfb_pars.csv`</span>

<span class="sd">    Note:</span>
<span class="sd">        This is the companion function to</span>
<span class="sd">        `gw_utils.write_hfb_zone_multipliers_template()`</span>

<span class="sd">        This is to account for the horrible HFB6 format that differs from other</span>
<span class="sd">        BCs making this a special case</span>

<span class="sd">        Requires &quot;hfb_pars.csv&quot;</span>

<span class="sd">        Should be added to the forward_run.py script</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hfb_pars</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">par_file</span><span class="p">)</span>

    <span class="n">hfb_mults_contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">hfb_pars</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">skiprows</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hfb_mults_contents</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hfb_mults_contents</span><span class="p">[:</span><span class="n">skiprows</span><span class="p">]</span>

    <span class="c1"># read in the multipliers</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lay&#39;</span><span class="p">,</span> <span class="s1">&#39;irow1&#39;</span><span class="p">,</span><span class="s1">&#39;icol1&#39;</span><span class="p">,</span><span class="s1">&#39;irow2&#39;</span><span class="p">,</span><span class="s1">&#39;icol2&#39;</span><span class="p">,</span> <span class="s1">&#39;hydchr&#39;</span><span class="p">]</span>
    <span class="n">hfb_mults</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">hfb_pars</span><span class="o">.</span><span class="n">mlt_file</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">skiprows</span><span class="p">,</span>
                            <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># read in the original file</span>
    <span class="n">hfb_org</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">hfb_pars</span><span class="o">.</span><span class="n">org_file</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">skiprows</span><span class="p">,</span>
                          <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># multiply it out</span>
    <span class="n">hfb_org</span><span class="o">.</span><span class="n">hydchr</span> <span class="o">*=</span> <span class="n">hfb_mults</span><span class="o">.</span><span class="n">hydchr</span>

    <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">hfb_mults</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="o">=</span> <span class="n">hfb_mults</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
        <span class="n">hfb_org</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="o">=</span> <span class="n">hfb_org</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="c1"># write the results</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hfb_pars</span><span class="o">.</span><span class="n">model_file</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofp</span><span class="p">:</span>
        <span class="p">[</span><span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">hfb_org</span><span class="p">[[</span><span class="s1">&#39;lay&#39;</span><span class="p">,</span> <span class="s1">&#39;irow1&#39;</span><span class="p">,</span> <span class="s1">&#39;icol1&#39;</span><span class="p">,</span> <span class="s1">&#39;irow2&#39;</span><span class="p">,</span> <span class="s1">&#39;icol2&#39;</span><span class="p">,</span> <span class="s1">&#39;hydchr&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">ofp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_hfb_zone_multipliers_template"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.write_hfb_zone_multipliers_template">[docs]</a><span class="k">def</span> <span class="nf">write_hfb_zone_multipliers_template</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;write a template file for an hfb using multipliers per zone (double yuck!)</span>

<span class="sd">    Args:</span>
<span class="sd">        m (`flopy.modflow.Modflow`): a model instance with an HFB package</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>

<span class="sd">        - **dict**: a dictionary with original unique HFB conductivity values and their</span>
<span class="sd">          corresponding parameter names</span>
<span class="sd">        - **str**: the template filename that was created</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">hfb6</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no HFB package found&quot;</span><span class="p">)</span>
    <span class="c1"># find the model file</span>
    <span class="n">hfb_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">hfb6</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># this will use multipliers, so need to copy down the original</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s1">&#39;hfb6_org&#39;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s1">&#39;hfb6_org&#39;</span><span class="p">))</span>
    <span class="c1"># copy down the original file</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">hfb6</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="s1">&#39;hfb6_org&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">hfb6</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s1">&#39;hfb6_mlt&#39;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s1">&#39;hfb6_mlt&#39;</span><span class="p">))</span>

    <span class="c1"># read in the model file</span>
    <span class="n">hfb_file_contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">hfb_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># navigate the header</span>
    <span class="n">skiprows</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hfb_file_contents</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hfb_file_contents</span><span class="p">[:</span><span class="n">skiprows</span><span class="p">]</span>

    <span class="c1"># read in the data</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lay&#39;</span><span class="p">,</span> <span class="s1">&#39;irow1&#39;</span><span class="p">,</span> <span class="s1">&#39;icol1&#39;</span><span class="p">,</span> <span class="s1">&#39;irow2&#39;</span><span class="p">,</span> <span class="s1">&#39;icol2&#39;</span><span class="p">,</span> <span class="s1">&#39;hydchr&#39;</span><span class="p">]</span>
    <span class="n">hfb_in</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">hfb_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">skiprows</span><span class="p">,</span>
                         <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">hfb_in</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="o">=</span> <span class="n">hfb_in</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

    <span class="c1"># set up a multiplier for each unique conductivity value</span>
    <span class="n">unique_cond</span> <span class="o">=</span> <span class="n">hfb_in</span><span class="o">.</span><span class="n">hydchr</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">hfb_mults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_cond</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hbz_</span><span class="si">{0:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_cond</span><span class="p">))]))</span>
    <span class="c1"># set up the TPL line for each parameter and assign</span>
    <span class="n">hfb_in</span><span class="p">[</span><span class="s1">&#39;tpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;blank&#39;</span>
    <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">hfb_in</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;hydchr&#39;</span><span class="p">):</span>
        <span class="n">hfb_in</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hfb_in</span><span class="o">.</span><span class="n">hydchr</span> <span class="o">==</span> <span class="n">cn</span><span class="p">,</span> <span class="s1">&#39;tpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;~</span><span class="si">{0:^10s}</span><span class="s1">~&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">hfb_mults</span><span class="p">[</span><span class="n">cn</span><span class="p">])</span>

    <span class="k">assert</span> <span class="s1">&#39;blank&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hfb_in</span><span class="o">.</span><span class="n">tpl</span>

    <span class="c1"># write out the TPL file</span>
    <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s2">&quot;hfb6.mlt.tpl&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofp</span><span class="p">:</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ptf ~</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">header</span><span class="p">]</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">hfb_in</span><span class="p">[[</span><span class="s1">&#39;lay&#39;</span><span class="p">,</span> <span class="s1">&#39;irow1&#39;</span><span class="p">,</span> <span class="s1">&#39;icol1&#39;</span><span class="p">,</span> <span class="s1">&#39;irow2&#39;</span><span class="p">,</span> <span class="s1">&#39;icol2&#39;</span><span class="p">,</span> <span class="s1">&#39;tpl&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">ofp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="c1"># make a lookup for lining up the necessary files to</span>
    <span class="c1"># perform multiplication with the helpers.apply_hfb_pars() function</span>
    <span class="c1"># which must be added to the forward run script</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s1">&#39;hfb6_pars.csv&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofp</span><span class="p">:</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;org_file,mlt_file,model_file</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">,</span><span class="si">{1}</span><span class="s1">,</span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s1">&#39;hfb6_org&#39;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">hfb6</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span> <span class="s1">&#39;hfb6_mlt&#39;</span><span class="p">,</span>
                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tpl&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
            <span class="n">hfb_file</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">hfb_mults</span><span class="p">,</span> <span class="n">tpl_file</span></div>


<div class="viewcode-block" id="write_hfb_template"><a class="viewcode-back" href="../../../index.html#pyemu.utils.gw_utils.write_hfb_template">[docs]</a><span class="k">def</span> <span class="nf">write_hfb_template</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;write a template file for an hfb (yuck!)</span>

<span class="sd">   Args:</span>
<span class="sd">        m (`flopy.modflow.Modflow`): a model instance with an HFB package</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple containing</span>

<span class="sd">        - **str**: name of the template file that was created</span>

<span class="sd">        - **pandas.DataFrame**: a dataframe with use control file info for the</span>
<span class="sd">          HFB parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">m</span><span class="o">.</span><span class="n">hfb6</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">hfb_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">model_ws</span><span class="p">,</span><span class="n">m</span><span class="o">.</span><span class="n">hfb6</span><span class="o">.</span><span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hfb_file</span><span class="p">),</span><span class="s2">&quot;couldn&#39;t find hfb_file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hfb_file</span><span class="p">)</span>
    <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">hfb_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">tpl_file</span> <span class="o">=</span> <span class="n">hfb_file</span><span class="o">+</span><span class="s2">&quot;.tpl&quot;</span>
    <span class="n">f_tpl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tpl_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f_tpl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ptf ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">parnme</span><span class="p">,</span><span class="n">parval1</span><span class="p">,</span><span class="n">xs</span><span class="p">,</span><span class="n">ys</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
    <span class="n">iis</span><span class="p">,</span><span class="n">jjs</span><span class="p">,</span><span class="n">kks</span> <span class="o">=</span> <span class="p">[],[],[]</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">xcentergrid</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">sr</span><span class="o">.</span><span class="n">ycentergrid</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f_in</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">f_tpl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">nphfb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mxfb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">nhfbnp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">nphfb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">mxfb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;not supporting terrible HFB pars&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhfbnp</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f_in</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;EOF&quot;</span><span class="p">)</span>
                <span class="n">raw</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">pn</span> <span class="o">=</span> <span class="s2">&quot;hb</span><span class="si">{0:02}{1:04d}{2:04}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="n">pv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">raw</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;~ </span><span class="si">{0}</span><span class="s2">  ~&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pn</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">f_tpl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">parnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pn</span><span class="p">)</span>
                <span class="n">parval1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pv</span><span class="p">)</span>
                <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                <span class="n">iis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">jjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">kks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

            <span class="k">break</span>

    <span class="n">f_tpl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;parnme&quot;</span><span class="p">:</span><span class="n">parnme</span><span class="p">,</span><span class="s2">&quot;parval1&quot;</span><span class="p">:</span><span class="n">parval1</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">xs</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">ys</span><span class="p">,</span>
                       <span class="s2">&quot;i&quot;</span><span class="p">:</span><span class="n">iis</span><span class="p">,</span><span class="s2">&quot;j&quot;</span><span class="p">:</span><span class="n">jjs</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">:</span><span class="n">kks</span><span class="p">},</span><span class="n">index</span><span class="o">=</span><span class="n">parnme</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;pargp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;hfb_hydfac&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parubnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">10.0</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;parlbnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">parval1</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.1</span>
    <span class="k">return</span> <span class="n">tpl_file</span><span class="p">,</span><span class="n">df</span></div>


</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, pyEMU development team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>